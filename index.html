<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="mobile-web-app-capable" content="yes">
    <title>Essential Life Skills Guide</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
		body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', system-ui, sans-serif; background: transparent; min-height: 100vh; padding: 0 0 60px 0; margin: 0; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; touch-action: pan-y; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-user-select: none; }
		.add-category-tab { background: #f59e0b !important; color: white !important; font-weight: bold; border-bottom: none !important; padding: 15px 20px !important; font-size: 18px !important; }
		.add-category-tab:hover { background: #d97706 !important; }
		.add-item-btn { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-size: 13px; font-weight: 500; display: none; width: 100%; transition: all 0.2s ease; }
		.add-item-btn:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
		.add-skill-btn { background: #8b5cf6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; width: auto; margin: 20px auto; transition: all 0.2s ease; display: none; }
		.add-skill-btn:hover { background: #7c3aed; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); }
		.wallpaper-menu { display: none; background: #f8f9fa; border-radius: 0; padding: 15px; margin: 0; position: relative; box-shadow: none; width: 100%; border-top: 1px solid #e9ecef; }
		.wallpaper-menu h3 { margin: 0 0 10px 0; font-size: 12px; color: #6c757d; font-weight: normal; }
		.wallpaper-menu.show { display: block; }
		/* Bottom Navigation Bar */
		.bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: 60px; background: white; display: flex; justify-content: space-around; align-items: center; box-shadow: 0 -2px 12px rgba(0,0,0,0.1); z-index: 10000; padding-bottom: max(env(safe-area-inset-bottom), 0); }
		.bottom-nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; cursor: pointer; padding: 8px 20px; transition: all 0.2s ease; flex: 1; -webkit-tap-highlight-color: transparent; }
		.bottom-nav-item:active { transform: scale(0.95); }
		.bottom-nav-item svg { width: 24px; height: 24px; stroke: #95a5a6; stroke-width: 2; fill: none; transition: stroke 0.2s ease; margin-bottom: 4px; }
		.bottom-nav-item span { font-size: 11px; color: #95a5a6; font-weight: 500; transition: color 0.2s ease; }
		.bottom-nav-item.active svg { stroke: var(--primary-color); }
		.bottom-nav-item.active span { color: var(--primary-color); font-weight: 600; }
		.category { display: none; }
		.category.active { display: block; }
		.checkbox { width: 20px; height: 20px; border: 2px solid #d0d7de; border-radius: 5px; flex-shrink: 0; margin-top: 2px; cursor: pointer; transition: all 0.2s ease; background: white; }
		.checkbox:hover { border-color: var(--primary-color, #3498db); }
		.checkbox-menu { display: none; position: absolute; top: 100%; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 200px; z-index: 1001; margin-top: 4px; }
		.checkbox-menu button { width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
		.checkbox-menu button:last-child { border-bottom: none; }
		.checkbox-menu button:hover { background: #f8f9fa; }
		.checkbox-menu.show { display: block; }.checklist-item { display: flex; align-items: flex-start; gap: 14px; padding: 14px 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 12px; cursor: default; transition: all 0.2s ease; border: 1px solid transparent; position: relative; -webkit-tap-highlight-color: transparent; will-change: transform; }
		.checklist-item:active { transform: scale(0.98); background: #e8f4f8; }
		.checklist-item.checked { opacity: 0.7; }
		.checklist-item.checked .checkbox { background: var(--secondary-color, #27ae60); border-color: var(--secondary-color, #27ae60); position: relative; }
		.checklist-item.checked .checkbox:after { content: "✓"; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }
		.checklist-item:hover { background: #e8f4f8; border-color: var(--primary-color, #3498db); }
		.checklist-text { flex: 1; font-size: 14px; line-height: 1.5; color: #495057; }
		.collapse-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s ease; width: 20px; height: 20px; display: none; }
		.collapse-btn:hover { background: #ecf0f1; transform: scale(1.1); }
		.collapse-btn svg { width: 100%; height: 100%; stroke: #95a5a6; transition: stroke 0.2s ease; }
		.collapse-btn:hover svg { stroke: #2c3e50; }
		.color-option { width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
		.color-option:hover { transform: scale(1.1); border-color: #2c3e50; }
		.color-option.selected { border-color: #2c3e50; border-width: 3px; }
		.color-options { display: flex; flex-wrap: wrap; gap: 8px; }
		.color-picker-menu { display: none; background: #f8f9fa; border-radius: 0; padding: 15px; margin: 0; position: relative; box-shadow: none; width: 100%; border-top: 1px solid #e9ecef; }
		.color-picker-menu h3 { margin: 0 0 10px 0; font-size: 12px; color: #6c757d; font-weight: normal; }
		.color-picker-menu.show { display: block; }
		.color-picker-canvas { position: relative; width: 100%; height: 200px; border-radius: 8px; cursor: crosshair; margin-bottom: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 100%), linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); }
		.hue-slider { width: 100%; height: 20px; border-radius: 10px; background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%); cursor: pointer; position: relative; margin-bottom: 15px; }
		.picker-indicator { position: absolute; width: 16px; height: 16px; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); pointer-events: none; transform: translate(-50%, -50%); }
		.hue-indicator { position: absolute; width: 8px; height: 24px; background: white; border: 2px solid #2c3e50; border-radius: 4px; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
		.container { max-width: 100%; width: 100%; margin: 0; padding: 0; background: transparent; border-radius: 0; box-shadow: none; overflow: visible; opacity: 1; min-height: 100vh; }
		.content-area { padding: 0 12px 140px; background: transparent; min-height: calc(100vh - 250px); position: relative; }
		.content-area::before { content: ''; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background-size: cover; background-position: center; background-repeat: no-repeat; background-attachment: fixed; z-index: -1; opacity: 0; transition: opacity 0.3s ease; }
		.content-area.has-background::before { opacity: 1; }
		.delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: transparent; color: #6b7280; border: none; border-radius: 6px; font-size: 18px; font-weight: normal; display: none; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 10; transition: all 0.2s ease; padding: 0; }
		.delete-btn:hover { background: rgba(220, 38, 38, 0.1); color: #dc2626; transform: scale(1.1); }
		.delete-tab-btn { width: 22px; height: 22px; background: transparent; color: #9ca3af; border: none; border-radius: 50%; font-size: 18px; font-weight: 600; margin-left: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; }
		.delete-tab-btn:hover { background: #fee2e2; color: #dc2626; transform: scale(1.05); }
		.dropdown-menu { display: none; position: absolute; top: 45px; right: 0; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); min-width: 200px; z-index: 1000; overflow-y: auto; max-height: calc(100vh - 140px); border: 1px solid #e8eaed; }
		.dropdown-menu button { width: 100%; padding: 14px 20px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; color: #1f2937; transition: background 0.2s; font-weight: 500; }
		.dropdown-menu button:hover { background: #f3f4f6; }
		.dropdown-menu button:first-child { border-radius: 8px 8px 0 0; }
		.dropdown-menu button:last-child { border-radius: 0 0 8px 8px; }
		.dropdown-menu.show { display: block; }
		.edit-btn { background: none; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 28px; font-weight: 600; transition: all 0.3s ease; line-height: 1; }
		.edit-btn:hover { opacity: 0.7; }
		.edit-mode .add-item-btn { display: block; }
		.edit-mode .add-skill-btn { display: block; }
		.edit-mode .delete-btn { display: inline-flex; }
		.edit-mode .nav-tab .tab-name[contenteditable="true"] { user-select: text !important; -webkit-user-select: text !important; cursor: text !important;}
		.edit-mode-active .floating-layout-btn { display: none; }
		.edit-toggle { position: absolute; top: 10px; right: 10px; }
		.editable { cursor: text; padding: 2px 4px; border-radius: 4px; transition: all 0.2s ease; }
		.editable:hover { background: rgba(52, 152, 219, 0.1); }
		.editable:focus { outline: 2px solid var(--primary-color, #3498db); background: white; }
		.emoji-picker { position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 8px; display: grid; grid-template-columns: repeat(8, 30px); gap: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto; }
		.emoji-picker button { font-size: 20px; background: none; border: none; cursor: pointer; transition: transform 0.2s; }
		.emoji-picker button:hover { transform: scale(1.2); }
		.emoji-remove-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #e74c3c; color: white; border: 2px solid white; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 10; transition: all 0.2s ease; }
		.emoji-remove-btn:hover { background: #c0392b; transform: scale(1.1); }
		.editable-icon { position: relative; display: inline-block; }
		.floating-layout-btn { position: fixed; bottom: calc(60px + max(env(safe-area-inset-bottom), 24px)); right: 24px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--secondary-color); opacity: 0.9; color: white; font-size: 24px; border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s ease; z-index: 100; display: none; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
		.floating-layout-btn:active { transform: scale(0.9); }
		.floating-layout-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); opacity: 1; }
		.container[style*="display: block"] ~ .floating-layout-btn { display: flex !important; }
		.home-page ~ .floating-layout-btn { display: none !important; }
		.templates-page ~ .floating-layout-btn { display: none !important; }
		.profile-page ~ .floating-layout-btn { display: none !important; }
		.settings-page ~ .floating-layout-btn { display: none !important; }
		body.viewing-guide .floating-layout-btn { display: flex !important; align-items: center; justify-content: center;}
		.header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: max(env(safe-area-inset-top), 20px) 20px 20px; text-align: center; position: relative; box-shadow: 0 2px 12px rgba(0,0,0,0.15); border-radius: 0; z-index: 98; }
		.header h1 { font-size: 24px; margin-bottom: 6px; font-weight: 700; letter-spacing: -0.5px; }
		.header p { opacity: 0.95; font-size: 13px; font-weight: 400; }
		.header .editable:focus { outline: 2px solid #fff; background: rgba(255, 255, 255, 0.2); color: #fff; }
		.header .editable-icon { cursor: pointer; margin-right: 8px; font-size: 24px; }
		.header-wrapper { position: sticky; top: 0; z-index: 9; background: transparent; padding-bottom: 0; }
		.nav-tab { padding: 6px 16px; cursor: pointer; border: none; background: none; font-size: 15px; font-weight: 500; color: #5f6368; transition: all 0.3s ease; white-space: nowrap; border-radius: 12px 12px 0 0; flex-shrink: 0; position: relative; margin: 0 4px; -webkit-tap-highlight-color: transparent; }
		.nav-tab:hover { color: var(--primary-color); background: rgba(52, 152, 219, 0.1); }
		.nav-tab.active { color: var(--tab-active-color, var(--primary-color)); background: white; font-weight: 600; box-shadow: 0 -8px 24px rgba(0,0,0,0.2), 0 6px 16px rgba(0,0,0,0.15), 0 0 0 1px rgba(0,0,0,0.08); z-index: 11; padding: 12px 20px; margin-top: -10px; }
		/* Only disable pointer events when NOT in edit mode */
		body:not(.edit-mode-active) .nav-tab * { pointer-events: none; }
		body:not(.edit-mode-active) .nav-tab { pointer-events: auto; }
		/* In edit mode, allow interactions */
		.edit-mode-active .nav-tab .tab-icon { cursor: pointer; pointer-events: auto; }
		.edit-mode-active .nav-tab .tab-name { cursor: text; pointer-events: auto; }
		.edit-mode-active .nav-tab .emoji-remove-btn { pointer-events: auto; }
		.nav-tab .tab-name:hover { background: rgba(255, 255, 255, 0.1); padding: 2px 4px; border-radius: 4px; }
		.nav-tab .tab-name:focus { outline: 2px solid var(--primary-color, #3498db); background: white; color: #2c3e50; padding: 2px 4px; border-radius: 4px; }	
		.nav-tabs { display: flex; background: white; border-bottom: none; overflow-x: auto; overflow-y: hidden; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; position: relative; z-index: 10; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 0 0 16px 16px; padding: 8px calc(50% - 100px) 0; margin-bottom: 12px; }
		.nav-tabs::-webkit-scrollbar { display: none; }
		.nav-tabs::-webkit-scrollbar-track { background: transparent; }
		.nav-tabs::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; min-width: 10px; max-width: 10px; }
		.nav-tabs::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
		.save-btn { position: absolute; top: 5px; right: 5px; background: transparent; color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 6px 16px; cursor: pointer; font-size: 14px; font-weight: 600; border-radius: 6px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(255, 255, 255, 0.1); transition: all 0.2s ease; display: none; z-index: 10; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
		.save-btn:hover { background: rgba(255, 255, 255, 0.1); box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(255, 255, 255, 0.2); }
		.save-btn:active { box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.4); transform: translateY(1px); }
		.skill-card { background: white; border-radius: 4px; padding: 24px; border-left: 4px solid var(--primary-color); border-bottom: 1px solid #e8eaed; box-shadow: 0 4px 8px var(--shadow-color); transition: all 0.3s ease; position: relative; margin-bottom: 16px; }
		.skill-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
		.skill-card.expanded .collapse-btn { display: block; }
		.skill-grid { display: flex; flex-direction: column; gap: 32px; margin-top: 0; padding: 16px 0 0 0; transition: all 0.3s ease; }
		.skill-grid.horizontal { display: flex; flex-direction: row; overflow-x: auto; overflow-y: hidden; scroll-snap-type: none; padding: 30px 30px 30px 16px; gap: 32px; }
		.skill-grid.horizontal .skill-card { min-width: 85vw; max-width: 400px; scroll-snap-align: start; flex-shrink: 0; border-radius: 0; border-bottom: 1px solid #e8eaed; box-shadow: 0 4px 8px var(--shadow-color); }
		.skill-title { font-size: 17px; font-weight: 600; color: #1f2937; margin-bottom: 16px; letter-spacing: -0.2px; line-height: 1.4; }
		.tab-wrapper { display: flex; align-items: center; gap: 5px; }
		.checklist-item:has(.delete-btn:hover) { background: #fee2e2 !important; border-color: #fca5a5 !important; }
		.skill-card:has(> .skill-title .delete-btn:hover) { background: #fee2e2 !important; border-left-color: #dc2626 !important; }
		.tab-wrapper:has(.delete-tab-btn:hover) .nav-tab { background: #fee2e2 !important; color: #dc2626 !important; border-color: #fca5a5 !important; }
		@keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
		.refresh-spinner { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10001; display: none; }
		.refresh-spinner.show { display: block; }
		.refresh-spinner svg { width: 48px; height: 48px; animation: spin 1s linear infinite; }
		@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
		@media (max-width: 768px) { .skill-grid { grid-template-columns: 1fr; } }
		@supports (-webkit-touch-callout: none) { /* iOS specific - use native emoji keyboard */ input[type="text"].emoji-input {  font-size: 32px; } }
    	@supports (-webkit-overflow-scrolling: touch) { body { overscroll-behavior-y: contain; } }
		.guide-item { cursor: move; }
		.guide-item.dragging { opacity: 0.5; }
		.guide-item.drag-over { border-top: 3px solid var(--primary-color, #3498db); }
		.drag-handle { position: absolute; left: 8px; top: 0; bottom: 0; display: flex; align-items: center; cursor: grab; padding: 0 4px; color: rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 1; user-select: none; transition: all 0.2s; font-weight: normal; text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.8); letter-spacing: -2px; }
		.drag-handle:hover { color: rgba(0, 0, 0, 0.25); text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.9); }
		.drag-handle:active { cursor: grabbing; }
		.skill-card.dragging { opacity: 0.5; background: #f3f4f6; }
		.skill-card.drag-over { border-top: 3px solid var(--primary-color, #3498db); }
		.checklist-item .bullet-number { width: 20px; height: 20px; border-radius: 50%; background: #d1d5db; color: white; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
		.checklist-item .bullet-square { flex-shrink: 0; margin-top: 2px; font-size: 20px; line-height: 1; color: var(--primary-color, #3498db); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
		.checklist-item .bullet-circle { flex-shrink: 0; margin-top: 2px; font-size: 20px; line-height: 1; color: var(--primary-color, #3498db); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
		.checklist-item .bullet-none { width: 0px; height: 20px; flex-shrink: 0; margin-top: 2px; }
		.checklist-item.dragging { opacity: 0.5; background: #f3f4f6; }
		.checklist-item.drag-over { border-top: 3px solid var(--primary-color); }
		.checklist-text[contenteditable="true"],
		.skill-title span[contenteditable="true"],
		.tab-name-display[contenteditable="true"] {user-select: text !important; -webkit-user-select: text !important;   cursor: text !important;}
		.skill-card-controls { position: absolute; top: 8px; right: 8px; display: flex; gap: 0; align-items: center; padding: 0; background: transparent; pointer-events: none; z-index: 5; }
		.skill-card-controls.show { pointer-events: auto; }
		.edit-mode .skill-card-controls { pointer-events: auto; }
		body:not(.edit-mode-active) .skill-card-controls.show { pointer-events: auto; }
		.skill-control-btn { background: none; border: none; color: var(--primary-color, #3498db); opacity: 0; cursor: pointer; padding: 6px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; font-size: 20px; font-weight: normal; pointer-events: auto !important; position: absolute; right: 0; top: 0; transition: all 0.3s ease; }
		.skill-card-controls.show .skill-control-btn { opacity: 0.6; }
		.skill-card-controls.show .skill-control-btn:nth-child(1) { transform: translateX(-36px); transition-delay: 0.05s; }
		.skill-card-controls.show .skill-control-btn:nth-child(2) { transform: translateX(-72px); transition-delay: 0.1s; }
		.skill-card-controls.show .skill-control-btn:nth-child(3) { transform: translateX(-108px); transition-delay: 0.15s; }
		.skill-card-controls.show .skill-control-btn:nth-child(4) { transform: translateX(-144px); transition-delay: 0.2s; }
		.skill-control-btn:hover { opacity: 1 !important; color: #6b7280; }
		.skill-control-btn.delete-control:hover { color: #dc2626; }
		.skill-card-controls.show .skill-control-btn:nth-child(1):hover { transform: translateX(-36px) scale(1.1); }
		.skill-card-controls.show .skill-control-btn:nth-child(2):hover { transform: translateX(-72px) scale(1.1); }
		.skill-card-controls.show .skill-control-btn:nth-child(3):hover { transform: translateX(-108px) scale(1.1); }
		.skill-card-controls.show .skill-control-btn:nth-child(4):hover { transform: translateX(-144px) scale(1.1); }
		/* Hide all scrollbars but keep scroll functionality */
		* { scrollbar-width: none; -ms-overflow-style: none; }
		*::-webkit-scrollbar { display: none; }
		#loginScreen { opacity: 0; transition: opacity 0.3s ease-in-out; }
		#loginScreen.show { opacity: 1; }
		.logout-menu { display: none; position: fixed; bottom: 70px; left: 10px; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); overflow: hidden; z-index: 2002; min-width: 150px; }
		.logout-menu button { width: 100%; padding: 12px 16px; border: none; background: white; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
		.logout-menu button:last-child { border-bottom: none; }
		.logout-menu button:hover { background: #f8f9fa; }
		.logout-menu button.danger { color: #dc2626; }
		.logout-menu button.danger:hover { background: #fee2e2; }
		.logout-menu.show { display: block; }
		.header-image-menu { display: none; background: #f8f9fa; border-radius: 0; padding: 15px; margin: 0; position: relative; box-shadow: none; width: 100%; border-top: 1px solid #e9ecef; }
		.header-image-menu h3 { margin: 0 0 10px 0; font-size: 12px; color: #6c757d; font-weight: normal; }
		.header-image-menu.show { display: block; }
		/* Custom Dialog Overlay */ 
		.custom-dialog-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0, 0, 0, 0.4); display: flex; align-items: center; justify-content: center; z-index: 10000; opacity: 0; transition: opacity 0.2s ease; backdrop-filter: blur(4px); -webkit-backdrop-filter: blur(4px); padding: 20px; }
		.custom-dialog-overlay.show { opacity: 1; }
		.custom-dialog { background: white; border-radius: 12px; min-width: 280px; max-width: 400px; width: 90%; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2); overflow: hidden; transform: scale(0.95); transition: transform 0.2s ease; padding: 24px; }
		.custom-dialog-overlay.show .custom-dialog { transform: scale(1); }
		.custom-dialog-title { margin: 0 0 16px 0; text-align: left; font-size: 18px; font-weight: 600; color: #2c3e50; line-height: 1.3; }
		.custom-dialog-message { margin: 0 0 20px 0; text-align: left; font-size: 15px; color: #6b7280; line-height: 1.5; font-weight: 400; }
		.custom-dialog-input { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-bottom: 16px; font-family: inherit; }
		.custom-dialog-input:focus { outline: none; border-color: var(--primary-color, #3498db); }
		.custom-dialog-link { display: block; text-align: center; margin-bottom: 16px; font-size: 14px; color: var(--primary-color, #3498db); text-decoration: underline; cursor: pointer; font-weight: 500; }
		.custom-dialog-link:hover { opacity: 0.8; }
		.custom-dialog-buttons { display: flex; gap: 8px; }
		.custom-dialog-button { flex: 1; padding: 10px 16px; background: #e5e7eb; border: none; border-radius: 8px; font-size: 14px; cursor: pointer; transition: all 0.2s ease; font-weight: 600; color: #6b7280; font-family: inherit; }
		.custom-dialog-button:hover { background: #d1d5db; }
		.custom-dialog-button:active { transform: scale(0.98); }
		.custom-dialog-button.primary { background: var(--primary-color, #3498db); color: white; }
		.custom-dialog-button.primary:hover { opacity: 0.9; }
		.custom-dialog-button.danger, .custom-dialog-button.destructive { background: #ef4444; color: white; }
		.custom-dialog-button.danger:hover, .custom-dialog-button.destructive:hover { background: #dc2626; }
		.custom-dialog-buttons.single-button { display: flex; justify-content: center; }
		.custom-dialog-buttons.single-button .custom-dialog-button { max-width: 200px; }
		.profile-page { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: #f0f2f5; z-index: 99; overflow-y: auto; }
		.profile-page.active { display: block; }
		.profile-container { max-width: 600px; margin: 0 auto; padding: 24px 20px; }
		.profile-header { background: white; border-radius: 12px; padding: 24px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
		.profile-email-label { font-size: 13px; color: #6b7280; font-weight: 500; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 0.5px; }
		.profile-email { font-size: 16px; color: #2c3e50; font-weight: 600; }
		.profile-divider { height: 1px; background: #e5e7eb; margin: 20px 0; }
		.profile-options { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
		.profile-option-btn { width: 100%; padding: 16px 20px; border: none; background: white; text-align: left; cursor: pointer; font-size: 15px; color: #2c3e50; transition: background 0.2s; font-weight: 500; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f0f0f0; }
		.profile-option-btn:last-child { border-bottom: none; }
		.profile-option-btn:hover { background: #f8f9fa; }
		.profile-option-btn.danger { color: #dc2626; }
		.profile-option-btn.danger:hover { background: #fee2e2; }
		.profile-option-icon { width: 20px; height: 20px; }
		@keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
		@keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
		@keyframes slideIn { from { opacity: 0; transform: translateX(-30px); } to { opacity: 1; transform: translateX(0); } }
		.guide-list-card.entering { animation: slideIn 0.5s ease-out; }
		.reminder-toggle-btn { background: none; border: none; padding: 8px; cursor: pointer; color: #6b7280; transition: all 0.2s ease; }
		.reminder-toggle-btn:hover { color: var(--primary-color); }
		.reminder-toggle-btn.active { color: #f59e0b; }
		.reminder-icon { display: inline-flex; align-items: center; justify-content: center; width: 24px; height: 24px; margin-left: 8px; cursor: pointer; opacity: 0.4; transition: all 0.2s ease; color: #9ca3af; }
		.reminder-icon:hover { opacity: 1; color: #f59e0b; transform: scale(1.1); }
		.reminder-icon.has-reminder { opacity: 1; color: #f59e0b; animation: pulse 2s ease-in-out infinite; }
		@keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.6; } }
		.reminder-time-picker { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 24px; border-radius: 12px; box-shadow: 0 8px 32px rgba(0,0,0,0.2); z-index: 10000; min-width: 300px; }
		.reminder-time-picker.show { display: block; }
		.reminder-time-picker h3 { margin: 0 0 16px 0; font-size: 18px; color: #2c3e50; }
		.reminder-time-picker input[type="time"] { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-bottom: 16px; }
		.reminder-time-picker .button-group { display: flex; gap: 8px; }
		.reminder-time-picker button { flex: 1; padding: 10px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.2s ease; }
		.reminder-time-picker .save-reminder { background: var(--primary-color, #3498db); color: white; }
		.reminder-time-picker .save-reminder:hover { opacity: 0.9; }
		.reminder-time-picker .cancel-reminder { background: #e5e7eb; color: #6b7280; }
		.reminder-time-picker .cancel-reminder:hover { background: #d1d5db; }
		.reminder-time-picker .delete-reminder { background: #ef4444; color: white; margin-top: 8px; width: 100%; }
		.reminder-time-picker .delete-reminder:hover { background: #dc2626; }
		.home-page { position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: white; display: none; overflow-y: auto; z-index: 100; }
		.home-page.active { display: block; }
		.home-container { padding-bottom: 80px; }
		.home-header { padding: max(env(safe-area-inset-top), 20px) 20px 20px; display: flex; align-items: center; justify-content: space-between; }
		.home-title { font-size: 28px; font-weight: 700; color: #2c3e50; }
		.home-header-actions { display: flex; align-items: center; gap: 12px; }
		.home-header-icon-btn { width: 36px; height: 36px; border-radius: 8px; border: none; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s ease; }
		.home-header-icon-btn:hover { background: #e5e7eb; }
		.home-header-icon-btn:active { transform: scale(0.95); }
		.home-divider { height: 1px; background: #e5e7eb; margin: 0 20px; }
		.home-presets { padding: 20px 20px 16px; display: flex; flex-direction: column; gap: 16px; }
		.home-preset-item { display: flex; align-items: center; gap: 12px; padding: 0; background: none; border: none; cursor: pointer; color: #2c3e50; font-size: 15px; font-weight: 500; transition: all 0.2s ease; }
		.home-preset-item:hover { color: var(--primary-color, #3498db); }
		.home-preset-item:active { transform: scale(0.98); }
		.home-preset-icon { flex-shrink: 0; color: #9ca3af; transition: color 0.2s ease; }
		.home-preset-item:hover .home-preset-icon { color: var(--primary-color, #3498db); }
		.home-filter-nav { padding: 16px 20px; display: flex; gap: 20px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; }
		.home-filter-nav::-webkit-scrollbar { display: none; }
		.home-filter-item { font-size: 14px; font-weight: 500; color: #6b7280; cursor: pointer; padding: 6px 0; border-bottom: 2px solid transparent; transition: all 0.2s ease; flex-shrink: 0; }
		.home-filter-item:hover { color: #2c3e50; }
		.home-filter-item.active { color: var(--primary-color, #3498db); border-bottom-color: var(--primary-color, #3498db); }
		.home-guides-list { padding: 0 20px 20px; }
		.home-guide-item { background: transparent; border-radius: 0; padding: 16px 0; margin-bottom: 0; cursor: pointer; transition: all 0.2s ease; border: none; border-bottom: 1px solid #f3f4f6; display: flex; align-items: center; gap: 12px; box-shadow: none; position: relative; }
		.home-guide-item:hover { background: #f9fafb; }
		.home-guide-item:last-child { border-bottom: none; }
		.home-guide-item.current { background: transparent; border-bottom-color: #f3f4f6; }
		.home-guide-icon { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0; }
		.home-guide-title { font-size: 15px; font-weight: 500; color: #2c3e50; margin-bottom: 2px; }
		.home-guide-meta { font-size: 12px; color: #9ca3af; }
		.home-search-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: white; z-index: 1000; display: none; }
		.home-search-overlay.show { display: block; }
		.home-search-container { height: 100%; display: flex; flex-direction: column; }
		.home-search-header { padding: max(env(safe-area-inset-top), 20px) 20px 20px; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #e5e7eb; }
		.home-search-input-full { flex: 1; border: none; font-size: 16px; color: #2c3e50; outline: none; }
		.home-search-close { width: 36px; height: 36px; border-radius: 8px; border: none; background: #f3f4f6; color: #6b7280; display: flex; align-items: center; justify-content: center; cursor: pointer; flex-shrink: 0; }
		.home-search-results { flex: 1; overflow-y: auto; padding: 20px; }
		.home-folder { background: white; border-radius: 12px; margin-bottom: 12px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); overflow: hidden; }
		.home-folder-header { padding: 16px; cursor: pointer; display: flex; align-items: center; gap: 12px; transition: background 0.2s ease; }
		.home-folder-header:hover { background: #f8f9fa; }
		.home-folder-icon { width: 48px; height: 48px; background: linear-gradient(135deg, #f59e0b, #d97706); border-radius: 12px; display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
		.home-folder-icon svg { width: 24px; height: 24px; }
		.home-folder-info { flex: 1; min-width: 0; }
		.home-folder-name { font-size: 15px; font-weight: 600; color: #2c3e50; margin-bottom: 2px; }
		.home-folder-count { font-size: 12px; color: #9ca3af; }
		.home-folder-arrow { color: #d1d5db; transition: transform 0.2s ease; }
		.home-folder.expanded .home-folder-arrow { transform: rotate(90deg); }
		.home-folder-guides { display: none; padding: 0 16px 12px; }
		.home-folder.expanded .home-folder-guides { display: block; }
		.home-folder-guide-item { background: transparent; border-radius: 8px; padding: 12px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; gap: 12px; position: relative; }
		.home-folder-guide-item:hover { background: #f8f9fa; transform: translateX(4px); }
		.home-folder-guide-item:last-child { margin-bottom: 0; }
		.home-folder-guide-icon { width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0; }
		.home-folder-guide-title { font-size: 14px; font-weight: 500; color: #2c3e50; flex: 1; }
		.home-guide-checkbox { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 24px; height: 24px; border: 2px solid #d1d5db; border-radius: 6px; background: white; display: none; cursor: pointer; transition: all 0.2s ease; z-index: 100; }
		.home-guide-checkbox.show { display: flex !important; align-items: center; justify-content: center; }
		.home-guide-checkbox.checked { background: var(--primary-color, #3498db); border-color: var(--primary-color, #3498db); }
		.home-guide-checkbox.checked::after { content: '✓'; color: white; font-size: 16px; font-weight: bold; }
		.home-guide-item.select-mode { padding-left: 56px; }
		.home-guide-item.select-mode .home-guide-icon { margin-left: 40px; }
		.home-folder-guide-item.select-mode { padding-left: 48px; }
		.home-folder-guide-checkbox { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; border: 2px solid #d1d5db; border-radius: 5px; background: white; display: none; cursor: pointer; transition: all 0.2s ease; z-index: 2; }
		.home-folder-guide-checkbox.show { display: flex; align-items: center; justify-content: center; }
		.home-folder-guide-checkbox.checked { background: var(--primary-color, #3498db); border-color: var(--primary-color, #3498db); }
		.home-folder-guide-checkbox.checked::after { content: '✓'; color: white; font-size: 12px; font-weight: bold; }
		.home-actions-bar { position: fixed; bottom: 60px; left: 0; right: 0; background: white; padding: 12px 20px; box-shadow: 0 -2px 12px rgba(0,0,0,0.1); z-index: 9999; display: none; gap: 12px; }
		.home-actions-bar.show { display: flex; }
		.home-actions-bar button { flex: 1; padding: 12px 16px; border: none; border-radius: 10px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; gap: 8px; }
		.home-action-move { background: var(--primary-color, #3498db); color: white; }
		.home-action-move:hover { opacity: 0.9; }
		.home-action-delete { background: #fee2e2; color: #dc2626; }
		.home-action-delete:hover { background: #fecaca; }
		.home-empty { text-align: center; padding: 80px 20px; color: #9ca3af; }
		.home-empty-icon { font-size: 64px; margin-bottom: 16px; opacity: 0.5; }
		.home-empty-text { font-size: 16px; font-weight: 600; margin-bottom: 8px; color: #6b7280; }
		.home-empty-subtext { font-size: 14px; color: #9ca3af; }
		.home-dropdown-menu { display: none; position: absolute; top: 50px; right: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); min-width: 200px; z-index: 1001; overflow: hidden; border: 1px solid #e8eaed; }
		.home-dropdown-menu.show { display: block; }
		.home-dropdown-menu button { width: 100%; padding: 14px 20px; border: none; background: white; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: all 0.2s ease; font-weight: 500; display: flex; align-items: center; gap: 12px; border-bottom: 1px solid #f3f4f6; }
		.home-dropdown-menu button:last-child { border-bottom: none; }
		.home-dropdown-menu button:hover { background: #f8f9fa; }
		.home-dropdown-menu button svg { width: 18px; height: 18px; flex-shrink: 0; }
		.header-back-btn { position: absolute; left: 20px; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.2); border: none; width: 32px; height: 32px; border-radius: 8px; display: flex; align-items: center; justify-content: center; cursor: pointer; color: white; transition: all 0.2s ease; z-index: 100; }
		.header-back-btn:hover { background: rgba(255,255,255,0.3); }
		.header-back-btn:active { transform: translateY(-50%) scale(0.95); }
		/* Templates Page */
		.templates-page { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: white; z-index: 99; overflow-y: auto; }
		.templates-page.active { display: block; }
		.templates-container { padding-bottom: 80px; }
		.templates-header { padding: max(env(safe-area-inset-top), 20px) 20px 20px; }
		.templates-title { font-size: 24px; font-weight: 700; color: #2c3e50; }
		.templates-presets { padding: 20px 20px 16px; display: flex; flex-direction: column; gap: 16px; }
		.template-preset-item { display: flex; align-items: center; gap: 12px; padding: 0; background: none; border: none; cursor: pointer; color: #2c3e50; font-size: 15px; font-weight: 500; transition: all 0.2s ease; }
		.template-preset-item:hover { color: var(--primary-color, #3498db); }
		.template-preset-item:active { transform: scale(0.98); }
		.template-preset-icon { flex-shrink: 0; color: #9ca3af; transition: color 0.2s ease; }
		.template-preset-item:hover .template-preset-icon { color: var(--primary-color, #3498db); }
		.templates-custom { padding: 20px; }
		.template-custom-btn { width: 100%; display: flex; align-items: center; justify-content: center; gap: 12px; padding: 16px; background: var(--primary-color, #3498db); color: white; border: none; border-radius: 12px; font-size: 15px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; }
		.template-custom-btn:hover { opacity: 0.9; transform: translateY(-1px); }
		.template-custom-btn:active { transform: translateY(0); }
		.template-custom-btn svg { flex-shrink: 0; }
		
		/* Updated Profile Page */
		.profile-page { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: white; z-index: 99; overflow-y: auto; }
		.profile-page.active { display: block; }
		.profile-container { padding-bottom: 80px; }
		.profile-header { padding: max(env(safe-area-inset-top), 20px) 20px 20px; }
		.profile-title { font-size: 24px; font-weight: 700; color: #2c3e50; }
		.profile-info-section { padding: 0 20px; }
		.profile-label { font-size: 13px; color: #9ca3af; font-weight: 500; margin-bottom: 8px; }
		.profile-value { font-size: 15px; color: #2c3e50; font-weight: 500; }
		.profile-actions { padding: 0 20px; display: flex; flex-direction: column; gap: 0; }
		.profile-action-item { width: 100%; display: flex; align-items: center; gap: 12px; padding: 16px 0; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer; color: #2c3e50; font-size: 15px; font-weight: 500; transition: all 0.2s ease; text-align: left; }
		.profile-action-item:last-child { border-bottom: none; }
		.profile-action-item:hover { color: var(--primary-color, #3498db); }
		.profile-action-item:active { transform: scale(0.98); }
		.profile-action-item svg { flex-shrink: 0; color: #9ca3af; transition: color 0.2s ease; }
		.profile-action-item:hover svg { color: var(--primary-color, #3498db); }
		.profile-action-item.danger { color: #dc2626; }
		.profile-action-item.danger svg { color: #dc2626; }
		.profile-action-item.danger:hover { color: #b91c1c; background: #fee2e2; }
		.profile-action-item.danger:hover svg { color: #b91c1c; }
		
		/* Settings Page */
		.settings-page { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 60px; background: white; z-index: 99; overflow-y: auto; }
		.settings-page.active { display: block; }
		.settings-container { padding-bottom: 80px; }
		.settings-header { padding: max(env(safe-area-inset-top), 20px) 20px 20px; }
		.settings-title { font-size: 24px; font-weight: 700; color: #2c3e50; }
		.settings-actions { padding: 0 20px; display: flex; flex-direction: column; gap: 0; }
		.settings-action-item { width: 100%; display: flex; align-items: center; gap: 12px; padding: 16px 0; background: none; border: none; border-bottom: 1px solid #f3f4f6; cursor: pointer; color: #2c3e50; font-size: 15px; font-weight: 500; transition: all 0.2s ease; text-align: left; }
		.settings-action-item:last-child { border-bottom: none; }
		.settings-action-item:hover { color: var(--primary-color, #3498db); }
		.settings-action-item:active { transform: scale(0.98); }
		.settings-action-item svg { flex-shrink: 0; color: #9ca3af; transition: color 0.2s ease; }
		.settings-action-item:hover svg { color: var(--primary-color, #3498db); }
		
		/* Collections Navigation */
		.home-collections-nav { padding: 16px 20px; display: flex; gap: 16px; overflow-x: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; min-height: 40px; }
		.home-collections-nav::-webkit-scrollbar { display: none; }
		.home-collections-nav:empty { display: none; }
		.home-collection-item { display: flex; align-items: center; gap: 8px; cursor: pointer; flex-shrink: 0; padding: 8px 12px; border-radius: 20px; background: #f3f4f6; transition: all 0.2s ease; }
		.home-collection-item:hover { background: #e5e7eb; }
		.home-collection-item.active { background: var(--primary-color, #3498db); color: white; }
		.home-collection-circle { width: 16px; height: 16px; border-radius: 50%; border: 2px solid #9ca3af; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; }
		.home-collection-item.active .home-collection-circle { border-color: white; }
		.home-collection-circle-dot { width: 8px; height: 8px; border-radius: 50%; background: #9ca3af; display: none; }
		.home-collection-item.active .home-collection-circle-dot { display: block; background: white; }
		.home-collection-name { font-size: 14px; font-weight: 500; color: #2c3e50; }
		.home-collection-item.active .home-collection-name { color: white; }
		
	</style>
    </head>
<body>
	
	<div id="refreshSpinner" class="refresh-spinner show">
	    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
	        <path d="M21 12a9 9 0 1 1-6.219-8.56" stroke-linecap="round"/>
	    </svg>
	</div>
    <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Welcome Back</h2>
        
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <button id="loginBtn" style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Login</button>
        
        <button id="googleBtn" style="width: 100%; padding: 14px; background: white; color: #333; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Continue with Google
        </button>
        
        <div style="text-align: center; margin-top: 20px;">
            <span style="color: #666;">Don't have an account?</span>
            <button id="signupBtn" style="background: none; border: none; color: #667eea; font-weight: 600; cursor: pointer; margin-left: 5px;">Sign Up</button>
        </div>
    </div>
</div>
    <div id="signupScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Create Account</h2>
        
        <input type="email" id="signupEmail" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <button id="signupSubmitBtn" style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Create Account</button>
        
        <button id="googleSignupBtn" style="width: 100%; padding: 14px; background: white; color: #333; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Sign up with Google
        </button>
        
        <div style="text-align: center; margin-top: 20px;">
            <span style="color: #666;">Already have an account?</span>
            <button id="backToLoginBtn" style="background: none; border: none; color: #667eea; font-weight: 600; cursor: pointer; margin-left: 5px;">Login</button>
        </div>
    </div>
</div>
    <div class="container" id="app" style="display: none;">
    <div class="header-wrapper">
        <div class="header">
            <div class="edit-toggle"><button class="edit-btn" id="editModeBtn" onclick="toggleEditMode()">Edit</button></div>
            <h1>📚 Personal Notebook</h1>
            <p>note description</p>
        </div>
        <div class="nav-tabs" id="navTabs"></div>
    </div>
    <div class="content-area" id="contentArea"></div>
</div>
<script type="module">
	import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
	import { getDatabase, ref, set, get, update, remove, onValue, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
	import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
	
	// Initialize Firebase
	const firebaseConfig = {
	  apiKey: "AIzaSyA5k5pOZjWTrV3b1f51-aWH2AgDUY-p5hE",
	  authDomain: "life-akuk095.firebaseapp.com",
	  databaseURL: "https://life-akuk095-default-rtdb.europe-west1.firebasedatabase.app",
	  projectId: "life-akuk095",
	  storageBucket: "life-akuk095.firebasestorage.app",
	  messagingSenderId: "80383828301",
	  appId: "1:80383828301:web:7c001b7375f63fc5055704",
	};

	// Custom dialog functions to replace alert, confirm, and prompt
function customAlert(message, title = '') {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-dialog-overlay';
        
        const dialog = document.createElement('div');
        dialog.className = 'custom-dialog';
        
        let html = '';
        if (title) {
            html += `<div class="custom-dialog-title">${title}</div>`;
        }
        html += `<div class="custom-dialog-message">${message}</div>`;
        html += `<div class="custom-dialog-buttons">
            <button class="custom-dialog-button primary">OK</button>
        </div>`;
        
        dialog.innerHTML = html;
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        setTimeout(() => overlay.classList.add('show'), 10);
        
        const closeDialog = () => {
            overlay.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(overlay);
                resolve();
            }, 200);
        };
        
        dialog.querySelector('.custom-dialog-button').addEventListener('click', closeDialog);
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeDialog();
        });
    });
}

function customConfirm(message, title = '', confirmText = 'OK') {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-dialog-overlay';
        
        const dialog = document.createElement('div');
        dialog.className = 'custom-dialog';
        
        let html = '';
        if (title) {
            html += `<div class="custom-dialog-title">${title}</div>`;
        }
        html += `<div class="custom-dialog-message">${message}</div>`;
        
        // Use destructive class only if confirmText suggests danger
        const isDangerous = confirmText.toLowerCase().includes('delete') || confirmText.toLowerCase().includes('remove');
        const buttonClass = isDangerous ? 'destructive' : 'primary';
        
        html += `<div class="custom-dialog-buttons">
            <button class="custom-dialog-button" data-result="false">Cancel</button>
            <button class="custom-dialog-button ${buttonClass}" data-result="true">${confirmText}</button>
        </div>`;
        
        dialog.innerHTML = html;
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        setTimeout(() => overlay.classList.add('show'), 10);
        
        const closeDialog = (result) => {
            overlay.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(overlay);
                resolve(result);
            }, 200);
        };
        
        dialog.querySelectorAll('.custom-dialog-button').forEach(btn => {
            btn.addEventListener('click', () => {
                closeDialog(btn.dataset.result === 'true');
            });
        });
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeDialog(false);
        });
    });
}

function customPrompt(message, defaultValue = '', title = '') {
    return new Promise((resolve) => {
        const overlay = document.createElement('div');
        overlay.className = 'custom-dialog-overlay';
        
        const dialog = document.createElement('div');
        dialog.className = 'custom-dialog';
        
        let html = '';
        if (title) {
            html += `<div class="custom-dialog-title">${title}</div>`;
        }
        html += `<div class="custom-dialog-message">${message}</div>`;
        html += `<input type="text" class="custom-dialog-input" value="${defaultValue}" placeholder="${defaultValue}">`;
        html += `<div class="custom-dialog-buttons">
            <button class="custom-dialog-button" data-result="cancel">Cancel</button>
            <button class="custom-dialog-button primary" data-result="ok">OK</button>
        </div>`;
        
        dialog.innerHTML = html;
        overlay.appendChild(dialog);
        document.body.appendChild(overlay);
        
        const input = dialog.querySelector('.custom-dialog-input');
        
        setTimeout(() => {
            overlay.classList.add('show');
            input.focus();
            input.select();
        }, 10);
        
        const closeDialog = (result) => {
            overlay.classList.remove('show');
            setTimeout(() => {
                document.body.removeChild(overlay);
                resolve(result);
            }, 200);
        };
        
        dialog.querySelectorAll('.custom-dialog-button').forEach(btn => {
            btn.addEventListener('click', () => {
                if (btn.dataset.result === 'ok') {
                    closeDialog(input.value || null);
                } else {
                    closeDialog(null);
                }
            });
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                closeDialog(input.value || null);
            } else if (e.key === 'Escape') {
                closeDialog(null);
            }
        });
        
        overlay.addEventListener('click', (e) => {
            if (e.target === overlay) closeDialog(null);
        });
    });
}
	const app = initializeApp(firebaseConfig);
	const database = getDatabase(app);
	const auth = getAuth(app);
	let currentUser = null;
	let currentGuideId = localStorage.getItem('currentGuideId') || null;
	let skillReminders = {}; // Format: { 'catIndex-skillIndex': { enabled: true, items: { 'itemIndex': 'HH:MM' } } }
	
	// Default data structure
	let categories = [
	    {
	        name: "Health & Body", 
	        icon: "💪", 
	        skills: [
	            {
	                title: "Basic Hygiene", 
	                icon: "🧼", 
					bulletStyle: "checkbox",
	                items: ["Brush teeth twice daily", "Shower regularly", "Wash hands before eating"]
	            }
	        ]
	    },
	    {
        name: "Daily Living", 
        icon: "🏡", 
        skills: [
            {
                title: "Household Basics", 
                icon: "🧹", 
                items: ["Do laundry", "Clean regularly", "Take out trash"]
            }
        ]
    }
];
// Check if user is logged in
onAuthStateChanged(auth, (user) => {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    const appContainer = document.getElementById('app');
    
    if (user) {
        currentUser = user;
        
        // Hide both auth screens
        loginScreen.classList.remove('show');
        signupScreen.classList.remove('show');
        
        setTimeout(() => {
            loginScreen.style.display = 'none';
            signupScreen.style.display = 'none';
            appContainer.style.display = 'block';
            setTimeout(() => appContainer.classList.add('show'), 10);
        }, 300);
        
        loadUserData(user.uid);
        
// Restore last active page from localStorage, default to home
        const lastPage = localStorage.getItem('currentPage') || 'guides';
        const homePage = document.getElementById('homePage');
        const templatesPage = document.getElementById('templatesPage');
        const profilePage = document.getElementById('profilePage');
        const settingsPage = document.getElementById('settingsPage');
        const mainContainer = document.querySelector('.container');
        const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
        
        // Remove all active states
        bottomNavItems.forEach(nav => nav.classList.remove('active'));
        
        // Hide all pages first
        mainContainer.style.display = 'none';
        if (homePage) homePage.classList.remove('active');
        if (templatesPage) templatesPage.classList.remove('active');
        if (profilePage) profilePage.classList.remove('active');
        if (settingsPage) settingsPage.classList.remove('active');
        
        if (lastPage === 'guides') {
            // Show home page with guides list
            if (homePage) {
                homePage.classList.add('active');
                populateHomePage();
            }
            bottomNavItems[0]?.classList.add('active');
        } else if (lastPage === 'templates') {
            if (templatesPage) {
                templatesPage.classList.add('active');
            }
            bottomNavItems[1]?.classList.add('active');
        } else if (lastPage === 'profile') {
            if (profilePage) {
                profilePage.classList.add('active');
                const profileEmail = document.getElementById('profileEmail');
                if (profileEmail && currentUser) {
                    profileEmail.textContent = currentUser.email;
                }
            }
            bottomNavItems[2]?.classList.add('active');
        } else if (lastPage === 'settings') {
            if (settingsPage) {
                settingsPage.classList.add('active');
            }
            bottomNavItems[3]?.classList.add('active');
        } else {
            // Fallback: go to home page
            if (homePage) {
                homePage.classList.add('active');
                populateHomePage();
            }
            bottomNavItems[0]?.classList.add('active');
        }
    } else {
        // User is NOT logged in
        currentUser = null;
        appContainer.classList.remove('show');
        appContainer.style.display = 'none';
        
        // Show login screen
        loginScreen.style.display = 'flex';
        setTimeout(() => loginScreen.classList.add('show'), 10);
    }
});

let checkedItems = {};
let editMode = false;
let activeTabIndex = 0;
let appIcon = "📚"; 
let appTitle = "Short note";
let appSubtitle = "Double tap to add description";
let themeColor = '#607d8b'; // Default grey
let layoutMode = 'vertical'; // 'vertical', 'horizontal', or 'headings'
let autoRefreshEnabled = false;
let autoRefreshTime = "00:00"; // Default midnight
let headerImage = null; 
let wallpaperUrl = '';
let selectedCollection = null; // Currently selected collection ID
let selectedFilter = 'all'; // Currently selected filter (all, short-notes, etc.)
	
// Drag and drop state
let draggedCard = null;
let draggedCatIndex = null;
let draggedSkillIndex = null;
let draggedElement = null;
let placeholder = null;
let draggedTab = null;
let draggedTabIndex = null;
	
const colorThemes = [
    { name: 'Soft Cream', primary: '#F5F7D9', secondary: '#E1E3C1' },
	{ name: 'Warm Sand', primary: '#E5D4B0', secondary: '#DAC898' },
	{ name: 'Dusty Rose', primary: '#C9A0A0', secondary: '#A88080' },
    { name: 'Rose Clay', primary: '#D98C8C', secondary: '#A96565' },
	{ name: 'Elegant Burgundy', primary: '#8B4359', secondary: '#6B3349' },
    { name: 'Deep Teal', primary: '#4A7C7E', secondary: '#355E60' },
	{ name: 'Forest Deep', primary: '#3A5A4A', secondary: '#22342D' },
	{ name: 'Elegant Navy', primary: '#1E3A5F', secondary: '#2C5F8D' },
    { name: 'Ocean Blue', primary: '#5B8FA3', secondary: '#407084' },
    { name: 'Stormy Blue', primary: '#6A8CA5', secondary: '#456274' },
	{ name: 'Slate Blue', primary: '#6B7C93', secondary: '#4A5F7F' },
    { name: 'Steel Blue', primary: '#607D8B', secondary: '#455A64' },
	{ name: 'Charcoal', primary: '#5C6B73', secondary: '#3D4A52' },
	{ name: 'Dark', primary: '#0A0A0A', secondary: '#000000' }
];

		const svgIcons = [
    { name: 'Night', bg: '#6B7C9E', path: 'M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z' },
    { name: 'Water', bg: '#5B8FA3', path: 'M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z' },
    { name: 'Location', bg: '#7C9B6E', path: 'M12 2C8 2 5 5.13 5 9c0 5 7 13 7 13s7-8 7-13c0-3.87-3-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z' },
    
    // Productivity
    { name: 'Reading', bg: '#9B7C6E', path: 'M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z' },
    { name: 'Planning', bg: '#7B8B9E', path: 'M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z' },
    { name: 'Focus', bg: '#9E7B7C', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-12c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z' },
    { name: 'Goals', bg: '#7C9E8B', path: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' },
    
    // Learning & Growth
    { name: 'Study', bg: '#6E7C9B', path: 'M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z' },
    { name: 'Gift', bg: '#9B8B6E', path: 'M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z' },
    { name: 'Research', bg: '#9E8B7C', path: 'M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z' },
    { name: 'Skills', bg: '#7C8B9E', path: 'M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z' },
    
    // Work & Career
    { name: 'Work', bg: '#6B7C8B', path: 'M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z' },
    { name: 'Meeting', bg: '#8B7C99', path: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z' },
    { name: 'Email', bg: '#7B9E8B', path: 'M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z' },
    { name: 'Call', bg: '#9E7B8B', path: 'M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z' },
    { name: 'Presentation', bg: '#7C9B8B', path: 'M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z' },
    
    // Social & Relationships
    { name: 'Family', bg: '#9B7C8B', path: 'M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63C19.68 7.55 18.92 7 18.06 7h-.12c-.86 0-1.62.55-1.9 1.37L13.5 16H16v6h4zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z' },
    { name: 'Friends', bg: '#7B8B9E', path: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z' },
    { name: 'Communication', bg: '#8B9E7C', path: 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z' },
    { name: 'Date', bg: '#9E7B7C', path: 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' },
    { name: 'Community', bg: '#7C9E9B', path: 'M12 12.75c1.63 0 3.07.39 4.24.9 1.08.48 1.76 1.56 1.76 2.73V18H6v-1.61c0-1.18.68-2.26 1.76-2.73 1.17-.52 2.61-.91 4.24-.91zM4 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm1.13 1.1c-.37-.06-.74-.1-1.13-.1-.99 0-1.93.21-2.78.58C.48 14.9 0 15.62 0 16.43V18h4.5v-1.61c0-.83.23-1.61.63-2.29zM20 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4 3.43c0-.81-.48-1.53-1.22-1.85-.85-.37-1.79-.58-2.78-.58-.39 0-.76.04-1.13.1.4.68.63 1.46.63 2.29V18H24v-1.57zM12 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z' },
    
    // Finance
    { name: 'Budget', bg: '#7B9B8B', path: 'M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z' },
    { name: 'Investment', bg: '#6B8B9E', path: 'M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z' },
    { name: 'Shopping', bg: '#9B7B8B', path: 'M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z' },
    { name: 'Bills', bg: '#7C8B7B', path: 'M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z' },
    
    // Home & Living
    { name: 'Cleaning', bg: '#7B9E9B', path: 'M16 11h-1V3c0-1.1-.9-2-2-2h-2c-1.1 0-2 .9-2 2v8H8c-2.76 0-5 2.24-5 5v7h18v-7c0-2.76-2.24-5-5-5zm3 10h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3H9v-3c0-.55-.45-1-1-1s-1 .45-1 1v3H5v-5c0-1.65 1.35-3 3-3h8c1.65 0 3 1.35 3 3v5z' },
    { name: 'Cooking', bg: '#9B8B7C', path: 'M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z' },
    { name: 'Gardening', bg: '#7C9B7C', path: 'M12 22c4.97 0 9-4.03 9-9-4.97 0-9 4.03-9 9zM5.6 10.25c0 1.38 1.12 2.5 2.5 2.5.53 0 1.01-.16 1.42-.44l-.02.19c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5l-.02-.19c.4.28.89.44 1.42.44 1.38 0 2.5-1.12 2.5-2.5 0-1-.59-1.85-1.43-2.25.84-.4 1.43-1.25 1.43-2.25 0-1.38-1.12-2.5-2.5-2.5-.53 0-1.01.16-1.42.44l.02-.19C14.5 2.12 13.38 1 12 1S9.5 2.12 9.5 3.5l.02.19c-.4-.28-.89-.44-1.42-.44-1.38 0-2.5 1.12-2.5 2.5 0 1 .59 1.85 1.43 2.25-.84.4-1.43 1.25-1.43 2.25zM12 5.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5S9.5 9.38 9.5 8s1.12-2.5 2.5-2.5zM3 13c0 4.97 4.03 9 9 9 0-4.97-4.03-9-9-9z' },
    { name: 'Laundry', bg: '#6B7C9B', path: 'M9.17 16.83L14.83 11.17L13.41 9.76L9.17 14L7.76 12.59L6.34 14L9.17 16.83M18 2.01L6 2C4.89 2 4 2.89 4 4V20C4 21.1 4.89 22 6 22H18C19.1 22 20 21.1 20 20V4C20 2.89 19.1 2.01 18 2.01M18 20H6L6.01 4H18V20Z' },
    { name: 'Organization', bg: '#9E7B9B', path: 'M10 3H4c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 8H4V5h6v6zm10-8h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 8h-6V5h6v6zM10 13H4c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2zm0 8H4v-6h6v6zm10-8h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2zm0 8h-6v-6h6v6z' },
    
    // Transportation
    { name: 'Driving', bg: '#8B7C99', path: 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z' },
    { name: 'Walking', bg: '#8B9E7C', path: 'M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7z' },
    { name: 'Public Transit', bg: '#9B7C7C', path: 'M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zm0 2c3.51 0 4.96.48 5.57 1H6.43c.61-.52 2.06-1 5.57-1zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-6H6V8h5v3zm5.5 6c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6h-5V8h5v3z' },
    { name: 'Travel', bg: '#7C9B9E', path: 'M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z' },
    
    // Entertainment & Hobbies
    { name: 'Music', bg: '#9E7B9B', path: 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z' },
    { name: 'Gaming', bg: '#7B8B9E', path: 'M21.58 16.09l-1.09-7.66C20.21 6.46 18.52 5 16.53 5H7.47C5.48 5 3.79 6.46 3.51 8.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19c.68 0 1.32-.27 1.8-.75L9 16h6l2.25 2.25c.48.48 1.13.75 1.8.75 1.56 0 2.75-1.37 2.53-2.91zM11 11H9v2H8v-2H6v-1h2V8h1v2h2v1zm4-1c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2 3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z' },
    { name: 'Movies', bg: '#9B8B7C', path: 'M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z' },
    { name: 'Photography', bg: '#7C9E9B', path: 'M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z' },
    { name: 'Art', bg: '#9E8B9B', path: 'M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z' },
    
    // Self-Care & Wellness
    { name: 'Yoga', bg: '#7C9B9E', path: 'M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z' },
    { name: 'Skincare', bg: '#9E8B8B', path: 'M12 2C9.24 2 7 4.24 7 7c0 1.77.94 3.31 2.34 4.16L8.5 13h7l-.84-1.84C16.06 10.31 17 8.77 17 7c0-2.76-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm-1 4h2v8h-2v-8z' },
    
    // Mind & Creativity
    { name: 'Journal', bg: '#9E9B8B', path: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z' },
    { name: 'Drawing', bg: '#7C8B9B', path: 'M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z' },
    { name: 'Brainstorm', bg: '#9B9E7C', path: 'M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z' },
    { name: 'Ideas', bg: '#9E7C8B', path: 'M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z' },
    
    // Digital Life
    { name: 'Video Call', bg: '#9B8B9E', path: 'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z' },
    { name: 'World', bg: '#8B7C9E', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z' },
  
    // Nature & Environment
    { name: 'Outdoors', bg: '#7B9B7C', path: 'M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z' },
    
    // Time Management
    { name: 'Time', bg: '#8B7C9B', path: 'M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z' },
    { name: 'Timer', bg: '#7B8B8B', path: 'M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z' },
    { name: 'Routine', bg: '#9B9E8B', path: 'M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm4.2 14.2L11 13V7h1.5v5.2l4.5 2.7-.8 1.3z' },
    { name: 'Morning', bg: '#9E9B7B', path: 'M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95z' },
    
    // Health Tracking
    { name: 'Weight', bg: '#8B7C9E', path: 'M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z' },
    { name: 'Mood', bg: '#7C9E9E', path: 'M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z' },
    
    // Food & Nutrition
    { name: 'Coffee', bg: '#8B7C8B', path: 'M2 21h18v-2H2v2zm2-8h14v-2H4v2zm18.5-5H20V4h1.5c.83 0 1.5.67 1.5 1.5v1c0 .83-.67 1.5-1.5 1.5zM4 4h14v4c0 2.21-1.79 4-4 4H8c-2.21 0-4-1.79-4-4V4z' },
    
    // Mental Health
    { name: 'Abort', bg: '#7C8B8B', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-1.85.63-3.55 1.69-4.9L16.9 18.31C15.55 19.37 13.85 20 12 20zm6.31-3.1L7.1 5.69C8.45 4.63 10.15 4 12 4c4.42 0 8 3.58 8 8 0 1.85-.63 3.55-1.69 4.9z' },
    
    // Miscellaneous Life Actions
    { name: 'Thumbs-up', bg: '#9E9B9E', path: 'M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z' },
    { name: 'Sleep', bg: '#8B9E8B', path: 'M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3zm0-4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm12-3h-8v8H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z' },
    { name: 'Connect', bg: '#9E7C9E', path: 'M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z' }
  ];


// Skill card drag start
document.addEventListener('dragstart', (e) => {
    // Prevent dragging if any element is being edited
    if (document.querySelector('[contenteditable="true"]')) {
        e.preventDefault();
        return false;
    }
    
    if (e.target.classList.contains('skill-card') && !editMode && layoutMode === 'headings') {
        draggedCard = e.target;
        draggedCatIndex = parseInt(e.target.dataset.catIndex);
        draggedSkillIndex = parseInt(e.target.dataset.skillIndex);
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        
        const rect = e.target.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;
        e.dataTransfer.setDragImage(e.target, offsetX, offsetY);
    }
    
    // Tab drag start
    if (e.target.classList.contains('nav-tab') && !editMode && e.target.draggable) {
        // Prevent dragging if any element is being edited
        if (document.querySelector('[contenteditable="true"]')) {
            e.preventDefault();
            return false;
        }
        
        draggedTab = e.target;
        draggedTabIndex = parseInt(e.target.dataset.catIndex);
        e.target.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
    }
});

// Combined drag end
document.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('skill-card')) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.skill-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        draggedCard = null;
    }
    
    if (e.target.classList.contains('nav-tab')) {
        e.target.style.opacity = '';
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.style.borderLeft = '';
        });
        draggedTab = null;
    }
});

// Combined drag over
document.addEventListener('dragover', (e) => {
    e.preventDefault();
    
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            e.dataTransfer.dropEffect = 'move';
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            e.dataTransfer.dropEffect = 'move';
        }
    }
});

// Combined drag enter
document.addEventListener('dragenter', (e) => {
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            target.classList.add('drag-over');
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            target.style.borderLeft = '3px solid var(--primary-color)';
        }
    }
});

// Combined drag leave
document.addEventListener('dragleave', (e) => {
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target) {
            target.classList.remove('drag-over');
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target) {
            target.style.borderLeft = '';
        }
    }
});

// Combined drop
document.addEventListener('drop', (e) => {
    e.preventDefault();
    
    // Skill cards drop
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            const targetCatIndex = parseInt(target.dataset.catIndex);
            const targetSkillIndex = parseInt(target.dataset.skillIndex);
            
            const [movedSkill] = categories[draggedCatIndex].skills.splice(draggedSkillIndex, 1);
            categories[targetCatIndex].skills.splice(targetSkillIndex, 0, movedSkill);
            
            saveCategories();
            renderContent();
        }
    }
    
    // Tabs drop
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            const targetIndex = parseInt(target.dataset.catIndex);
            
            const [movedCategory] = categories.splice(draggedTabIndex, 1);
            categories.splice(targetIndex, 0, movedCategory);
            
            if (activeTabIndex === draggedTabIndex) {
                activeTabIndex = targetIndex;
            } else if (draggedTabIndex < activeTabIndex && targetIndex >= activeTabIndex) {
                activeTabIndex--;
            } else if (draggedTabIndex > activeTabIndex && targetIndex <= activeTabIndex) {
                activeTabIndex++;
            }
            
            saveCategories();
            renderTabs();
            renderContent();
        }
    }
});

		
async function loadUserData(userId) {
    // Hide container initially
    document.querySelector('.container').classList.remove('loaded');
	document.querySelector('.container').style.opacity = '0';
    
    // Check if guide exists for this user
    get(ref(database, `users/${userId}/guides/${currentGuideId}`)).then((snapshot) => {
        if (!snapshot.exists()) {
            set(ref(database, `users/${userId}/guides/${currentGuideId}`), {
                appTitle, appSubtitle, appIcon, categories, checkedItems, themeColor
            });
        }
    });
    
	    // Use Promise.all to wait for all data to load
	    Promise.all([
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/categories`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/checkedItems`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/appTitle`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/appSubtitle`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/appIcon`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/themeColor`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/layoutMode`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/autoRefreshEnabled`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/autoRefreshTime`)),
	        get(ref(database, `users/${userId}/guides/${currentGuideId}/lastRefreshDate`)),
			get(ref(database, `users/${userId}/guides/${currentGuideId}/headerImage`)),
			get(ref(database, `users/${userId}/guides/${currentGuideId}/wallpaper`)),
			get(ref(database, `users/${userId}/guides/${currentGuideId}/skillReminders`)),
	    ]).then(([categoriesSnap, checkedSnap, titleSnap, subtitleSnap, iconSnap, themeSnap, layoutSnap, autoRefreshEnabledSnap, autoRefreshTimeSnap, lastRefreshSnap, headerImageSnap, wallpaperSnap, remindersSnap]) => {

			
		// Load categories
        if (categoriesSnap.val()) {
            categories = categoriesSnap.val();
        }
        
        // Load checked items
        if (checkedSnap.val()) {
            checkedItems = checkedSnap.val();
        }
        
        // Load app title
        if (titleSnap.val()) {
            appTitle = titleSnap.val();
        }
        
        // Load app subtitle
        if (subtitleSnap.val()) {
            appSubtitle = subtitleSnap.val();
        }
        
        // Load app icon
        if (iconSnap.val() !== null) {
            appIcon = iconSnap.val();
        }
        
        // Load theme color
        if (themeSnap.val()) {
            themeColor = themeSnap.val();
        } else {
            themeColor = '#607d8b';
        }
        
        // Load layout mode
        if (layoutSnap.val()) {
            layoutMode = layoutSnap.val();
        }
             
        // Load auto-refresh settings
        if (autoRefreshEnabledSnap.val() !== null) {
            autoRefreshEnabled = autoRefreshEnabledSnap.val();
        }
        if (autoRefreshTimeSnap.val()) {
            autoRefreshTime = autoRefreshTimeSnap.val();
        }

		// Load header image BEFORE applying theme
		if (headerImageSnap.val()) {
		    headerImage = headerImageSnap.val();
		    console.log('Header image loaded from Firebase, length:', headerImage.length);
		} else {
		    headerImage = null;
		    console.log('No header image in Firebase');
		}
		
		// Load wallpaper BEFORE applying theme
		if (wallpaperSnap.exists()) {
		    wallpaperUrl = wallpaperSnap.val();
		    console.log('Wallpaper loaded from Firebase, length:', wallpaperUrl.length);
		} else {
		    wallpaperUrl = '';
		    console.log('No wallpaper in Firebase');
		}

		// Load skill reminders
		if (remindersSnap.val()) {
		    skillReminders = remindersSnap.val();
		}
		// Check if we need to auto-refresh
		checkAndAutoRefresh(lastRefreshSnap.val());
		
		// Apply theme (now knows if headerImage and wallpaper exist)
		applyTheme();
		
		// Render everything
		renderHeader();
		renderTabs();
		renderContent();
		updateLayoutButton();
		
		// Apply header image AFTER header is rendered
		setTimeout(() => applyHeaderImage(), 50);
		
		// Apply wallpaper AFTER content area is rendered
		setTimeout(() => applyWallpaper(), 50);

		// Show container with loaded data
		setTimeout(() => {
		    document.querySelector('.container').style.opacity = '1';
		}, 100);
			
        // Hide spinner
		const spinner = document.getElementById('refreshSpinner');
		if (spinner) spinner.classList.remove('show');
    	}).catch(async (error) => {
    	console.error('Error loading user data:', error);
        
        // Show error message to user
        await customAlert('Failed to load your data. Please check your internet connection and try refreshing the page.', 'Connection Error');
        
        // Still try to show the app with default data
        applyTheme();
        renderHeader();
        renderTabs();
        renderContent();
        updateLayoutButton();
        setTimeout(() => applyHeaderImage(), 50);
        document.querySelector('.container').classList.add('loaded');
    });
}

function switchGuide(guideId) {
    currentGuideId = guideId;
    localStorage.setItem('currentGuideId', guideId);
    localStorage.setItem('currentPage', 'guides'); // Keep as 'guides' so home stays active
    loadUserData(currentUser.uid);
    
    // Show back button when viewing a guide
    setTimeout(() => {
        const backBtn = document.getElementById('headerBackBtn');
        if (backBtn) {
            backBtn.style.display = 'flex';
        }
    }, 100);
}
	
function applyTheme() {
    const theme = colorThemes.find(t => t.primary === themeColor);
    let primaryColor, secondaryColor;
    
    if (theme) {
        // Use preset theme
        primaryColor = theme.primary;
        secondaryColor = theme.secondary;
    } else {
        // Custom color - calculate darker shade
        primaryColor = themeColor;
        const hex = themeColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
    }
    
    // Determine if the theme is light
    const isLight = isLightColor(primaryColor);
    
    // For light themes, make secondary much darker for better contrast
    if (isLight) {
        const hex = primaryColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, Math.floor(r * 0.7));
        const darkerG = Math.max(0, Math.floor(g * 0.7));
        const darkerB = Math.max(0, Math.floor(b * 0.7));
        
        secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
    }
    
    // Set CSS variables
    document.documentElement.style.setProperty('--primary-color', primaryColor);
    document.documentElement.style.setProperty('--secondary-color', secondaryColor);
	// Set shadow with secondary color at 30% opacity
const hex = secondaryColor.replace('#', '');
const r = parseInt(hex.substr(0, 2), 16);
const g = parseInt(hex.substr(2, 2), 16);
const b = parseInt(hex.substr(4, 2), 16);
document.documentElement.style.setProperty('--shadow-color', `rgba(${r}, ${g}, ${b}, 0.3)`);
    
    // Set tab active color - use secondary for light themes
    document.documentElement.style.setProperty('--tab-active-color', isLight ? secondaryColor : primaryColor);

	// Set save button color - use secondary for light themes
    document.documentElement.style.setProperty('--save-btn-color', isLight ? secondaryColor : primaryColor);
	
    // Apply background color only if no wallpaper exists
    if (!wallpaperUrl) {
        document.body.style.background = '#f0f2f5';
    } else {
        // Keep transparent background when wallpaper is active
        document.body.style.background = 'transparent';
    }        
       
    // Adjust floating button
    const floatingBtn = document.getElementById('layoutBtn');
    if (floatingBtn) {
        floatingBtn.style.backgroundColor = secondaryColor;
    }
    
    // Apply header styling - but skip gradient if image exists
    const header = document.querySelector('.header');
    if (header) {
        if (!headerImage) {
            // No image - apply gradient
            header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${primaryColor} 100%)`;
        }
        // Always set text colors
        header.style.color = isLight ? '#2c3e50' : 'white';
        
        // Adjust all text elements in header
        const headerTexts = header.querySelectorAll('h1, p, .editable');
        headerTexts.forEach(el => {
            el.style.color = isLight ? '#2c3e50' : 'white';
        });
        
        // Adjust button colors in header
        const headerButtons = header.querySelectorAll('.edit-btn, .guide-menu-btn');
        headerButtons.forEach(btn => {
            btn.style.color = isLight ? '#2c3e50' : 'white';
        });
    }
}
function toggleColorPicker(e) {
    e.stopPropagation();
    const picker = document.getElementById('colorPickerMenu');
    picker.classList.toggle('show');
    
    if (picker.classList.contains('show')) {
        setTimeout(() => initColorPicker(), 10);
    }
}

function selectColor(color) {
    themeColor = color;
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/themeColor`), themeColor);
    applyTheme();
    renderHeader();
    
    // Close both color picker and dropdown menu
    document.getElementById('colorPickerMenu').classList.remove('show');
    document.getElementById('dropdownMenu').classList.remove('show');
}

function initColorPicker() {
    const canvas = document.getElementById('colorCanvas');
    const hueSlider = document.getElementById('hueSlider');
    const canvasIndicator = document.getElementById('canvasIndicator');
    const hueIndicator = document.getElementById('hueIndicator');
    const hexInput = document.getElementById('hexInput');
    const colorPreview = document.getElementById('colorPreview');
    
    if (!canvas || !hueSlider) return;
    
    let currentHue = 0;
    let currentSaturation = 100;
    let currentLightness = 50;
    
    // Convert current themeColor to HSL
    const rgb = hexToRgb(themeColor);
    if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentHue = hsl.h;
        currentSaturation = hsl.s;
        currentLightness = hsl.l;
        
        // Set initial positions
        hueIndicator.style.left = (currentHue / 360 * 100) + '%';
        
		// Calculate correct canvas position based on HSL
        // X-axis: Saturation (0 = left/white, 100 = right/full color)
        // Y-axis: Brightness (0 = top/bright, 100 = bottom/dark)
        const xPos = currentSaturation;
        const yPos = (1 - (currentLightness / 100)) * 100;
        
        canvasIndicator.style.left = Math.max(0, Math.min(100, xPos)) + '%';
        canvasIndicator.style.top = Math.max(0, Math.min(100, yPos)) + '%';
        canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
    }
    
// Hue slider interaction
function updateHue(clientX) {
        const rect = hueSlider.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const huePercent = (x / rect.width) * 100;
        currentHue = (huePercent / 100) * 360;
        
        hueIndicator.style.left = huePercent + '%';
        canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
        updateColor();
    }
    
    let hueActive = false;
    
    // Mouse events for hue slider
    hueSlider.addEventListener('mousedown', (e) => {
        hueActive = true;
        updateHue(e.clientX);
    });
    
    // Touch events for hue slider
    hueSlider.addEventListener('touchstart', (e) => {
        e.preventDefault();
        hueActive = true;
        updateHue(e.touches[0].clientX);
    });
    
    // Canvas interaction
    let canvasActive = false;
    
    function updateCanvas(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const y = Math.max(0, Math.min(clientY - rect.top, rect.height));
        
        const xPercent = (x / rect.width) * 100;
        const yPercent = (y / rect.height) * 100;
        
        currentSaturation = xPercent;
        currentLightness = 50 - (yPercent - 50) * (50 / 50);
        
        canvasIndicator.style.left = xPercent + '%';
        canvasIndicator.style.top = yPercent + '%';
        updateColor();
    }
    
    // Mouse events for canvas
    canvas.addEventListener('mousedown', (e) => {
        canvasActive = true;
        updateCanvas(e.clientX, e.clientY);
    });
    
    // Touch events for canvas
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        canvasActive = true;
        updateCanvas(e.touches[0].clientX, e.touches[0].clientY);
    });
    
    // Global mouse move and up
    document.addEventListener('mousemove', (e) => {
        if (hueActive) updateHue(e.clientX);
        if (canvasActive) updateCanvas(e.clientX, e.clientY);
    });
    
    document.addEventListener('mouseup', () => {
        hueActive = false;
        canvasActive = false;
    });
    
    // Global touch move and end
    document.addEventListener('touchmove', (e) => {
        if (hueActive) {
            e.preventDefault();
            updateHue(e.touches[0].clientX);
        }
        if (canvasActive) {
            e.preventDefault();
            updateCanvas(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false });
    
    document.addEventListener('touchend', () => {
        hueActive = false;
        canvasActive = false;
    });
    
    function updateColor() {
        const color = hslToHex(currentHue, currentSaturation, currentLightness);
        hexInput.value = color;
        colorPreview.style.backgroundColor = color;
    }
    
    // Hex input
    hexInput.addEventListener('input', (e) => {
        let value = e.target.value;
        if (!value.startsWith('#')) value = '#' + value;
        
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
            colorPreview.style.backgroundColor = value;
            const rgb = hexToRgb(value);
            if (rgb) {
                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                currentHue = hsl.h;
                currentSaturation = hsl.s;
                currentLightness = hsl.l;
                
                hueIndicator.style.left = (currentHue / 360 * 100) + '%';
                canvasIndicator.style.left = currentSaturation + '%';
                canvasIndicator.style.top = (100 - currentLightness * 2) + '%';
                canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
            }
        }
    });
    
    hexInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            applyCustomColor();
        }
    });
}

// Helper functions
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;
    
    if (max === min) {
        h = s = 0;
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
            case g: h = ((b - r) / d + 2) / 6; break;
            case b: h = ((r - g) / d + 4) / 6; break;
        }
    }
    
    return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToHex(h, s, l) {
    s /= 100; l /= 100;
    const c = (1 - Math.abs(2 * l - 1)) * s;
    const x = c * (1 - Math.abs((h / 60) % 2 - 1));
    const m = l - c / 2;
    let r = 0, g = 0, b = 0;
    
    if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
    else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
    else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
    else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
    else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
    else if (h >= 300 && h < 360) { r = c; g = 0; b = x; }
    
    const toHex = (n) => {
        const hex = Math.round((n + m) * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    };
    
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

function isLightColor(hex) {
    const rgb = hexToRgb(hex);
    if (!rgb) return false;
    
    // Calculate relative luminance
    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    return luminance > 0.6; // Returns true if color is light
}


function selectCustomColor(color) {
    // Find the closest matching theme or create a gradient
    const selectedTheme = colorThemes.find(t => t.primary === color);
    
    if (selectedTheme) {
        themeColor = selectedTheme.primary;
        applyTheme();
    } else {
        // Create a custom theme with a slightly darker shade for secondary
        themeColor = color;
        
        // Calculate a darker secondary color
        const hex = color.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        const secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
        
        // Update CSS variables directly for custom color
        document.documentElement.style.setProperty('--primary-color', color);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        
        // Update backgrounds
        document.body.style.background = `linear-gradient(135deg, ${secondaryColor}CC 0%, ${color}CC 100%)`;
        const header = document.querySelector('.header');
        if (header) {
            header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${color} 100%)`;
        }
    }
    
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/themeColor`), themeColor);
}


async function applyCustomColor() {
    const hexInput = document.getElementById('hexInput');
    const color = hexInput.value;
    
    if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
        selectCustomColor(color);
        // Close the color picker
        document.getElementById('colorPickerMenu').classList.remove('show');
        document.getElementById('dropdownMenu').classList.remove('show');
    } else {
        await customAlert('Please enter a valid color code (e.g., #FF0000)');
    }
}

function saveHeaderImage() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/headerImage`), headerImage);
}

function applyHeaderImage() {
    const header = document.querySelector('.header');
    if (!header) {
        console.log('Header not found, cannot apply image');
        return;
    }
      
    if (headerImage) {
        console.log('Applying header image');
        // Apply image as background (replaces theme gradient)
        header.style.backgroundImage = `url("${headerImage}")`;
        header.style.backgroundSize = 'cover';
        header.style.backgroundPosition = 'center';
        header.style.backgroundRepeat = 'no-repeat';
        
        // Detect image brightness and set text color
	detectImageBrightness(headerImage, (isLight, avgR, avgG, avgB) => {
    console.log('Image is', isLight ? 'LIGHT' : 'DARK');
    const textColor = isLight ? '#2c3e50' : 'white';
    const scrimColor = isLight ? 'rgba(255, 255, 255, 0.15)' : 'rgba(0, 0, 0, 0.5)';
    const r = avgR || 0;
    const g = avgG || 0;
    const b = avgB || 0;
    
    // Apply background directly to text elements
    const h1 = header.querySelector('h1');
    const p = header.querySelector('p');
    
    if (h1) {
        h1.style.cssText = `
            position: relative;
            z-index: 1;
            color: ${textColor};
            background: radial-gradient(ellipse at center, 
                rgba(${r}, ${g}, ${b}, 0.5) 0%, 
                rgba(${r}, ${g}, ${b}, 0.5) 50%, 
                transparent 100%);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            padding: 4px 12px;
            border-radius: 10px;
            display: block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 2px;
            font-size: 20px;
        `;
    }
    
    if (p) {
        p.style.cssText = `
            position: relative;
            z-index: 1;
            color: ${textColor};
            background: radial-gradient(ellipse at center, 
                rgba(${r}, ${g}, ${b}, 0.5) 0%, 
                rgba(${r}, ${g}, ${b}, 0.5) 50%, 
                transparent 100%);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 6px 20px;
            border-radius: 8px;
            display: block;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-top: 2px;
            font-size: 12px;
        `;
    }
    
    // Keep buttons visible with correct color
    const menuBtn = header.querySelector('.edit-btn, #menuBtn');
    const guideMenuBtn = header.querySelector('.guide-menu-btn');
    const saveBtn = header.querySelector('.save-btn');
    
    if (menuBtn) {
        menuBtn.style.color = textColor;
        menuBtn.style.zIndex = '100';
    }
    if (guideMenuBtn) {
        guideMenuBtn.style.color = textColor;
        guideMenuBtn.style.zIndex = '100';
    }
    if (saveBtn) {
        saveBtn.style.color = textColor;
        saveBtn.style.zIndex = '100';
    }
});
    } else {
        console.log('Removing header image, reverting to theme');
        // Remove image background and revert to theme gradient
        header.style.backgroundImage = '';
        header.style.backgroundSize = '';
        header.style.backgroundPosition = '';
        header.style.backgroundRepeat = '';
        
        // Reset text styles completely
        const h1 = header.querySelector('h1');
        const p = header.querySelector('p');
        if (h1) {
            h1.style.cssText = '';
        }
        if (p) {
            p.style.cssText = '';
        }
        
        // Reapply theme gradient
        applyTheme();
    }
}
function detectImageBrightness(imageSrc, callback) {
    const img = new Image();
    img.crossOrigin = 'Anonymous';
    img.src = imageSrc;
    
    img.onload = function() {
        // Create canvas to analyze image
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        
        // Use smaller size for faster processing
        canvas.width = 100;
        canvas.height = 100;
        
        ctx.drawImage(img, 0, 0, 100, 100);
        
        // Get center area of image (where text typically is)
        const imageData = ctx.getImageData(25, 25, 50, 50);
        const data = imageData.data;
        
        let totalR = 0, totalG = 0, totalB = 0;
        let brightness = 0;
        
        for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i + 1];
            const b = data[i + 2];
            
            totalR += r;
            totalG += g;
            totalB += b;
            
            // Calculate perceived brightness
            brightness += (0.299 * r + 0.587 * g + 0.114 * b);
        }
        
        const pixelCount = data.length / 4;
        brightness = brightness / pixelCount;
        
        // Calculate average RGB values
        const avgR = Math.round(totalR / pixelCount);
        const avgG = Math.round(totalG / pixelCount);
        const avgB = Math.round(totalB / pixelCount);
        
        console.log('Detected brightness:', brightness);
        
        // If brightness > 128, image is light, use dark text
        const isLight = brightness > 128;
        callback(isLight, avgR, avgG, avgB);
    };
    
    img.onerror = function() {
        console.log('Image failed to load for brightness detection');
        // If image fails to load, default to dark text with neutral gray
        callback(true, 128, 128, 128);
    };
}
// Wallpaper Management
function saveWallpaper() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/wallpaper`), wallpaperUrl);
}

function applyWallpaper() {
    const contentArea = document.querySelector('.content-area');
    if (!contentArea) {
        console.log('Content area not found, cannot apply wallpaper');
        return;
    }
      
if (wallpaperUrl) {
    console.log('Applying wallpaper');
    contentArea.classList.add('has-background');
    
    // Apply wallpaper through style tag
    let styleTag = document.getElementById('dynamic-bg-style');
    if (!styleTag) {
        styleTag = document.createElement('style');
        styleTag.id = 'dynamic-bg-style';
        document.head.appendChild(styleTag);
    }
    styleTag.textContent = `.content-area::before { background-image: url("${wallpaperUrl}"); }`;
    
    // Hide overlay when wallpaper is active
    let overlay = document.querySelector('.content-area-overlay');
    if (!overlay) {
        overlay = document.createElement('div');
        overlay.className = 'content-area-overlay';
        document.body.appendChild(overlay);
    }
    overlay.style.opacity = '0';
} else {
    console.log('Removing wallpaper');
    contentArea.classList.remove('has-background');
    const styleTag = document.getElementById('dynamic-bg-style');
    if (styleTag) styleTag.textContent = '';
    
    // Show overlay when wallpaper is removed
    const overlay = document.querySelector('.content-area-overlay');
    if (overlay) {
        overlay.style.opacity = '1';
    }
}
}
		
function closeDrawer() {
    // This is now just for closing any leftover menus
    document.body.style.overflow = '';
}

// Touch swipe to close drawer
let touchStartX = 0;
let touchCurrentX = 0;
let isDragging = false;

// Swipe to delete checklist items (horizontal only)
let itemTouchStartX = 0;
let itemTouchStartY = 0;
let itemTouchCurrentX = 0;
let itemTouchCurrentY = 0;
let isItemDragging = false;
let currentSwipedItem = null;

// Swipe diagonal to delete skill cards (down-left angle)
let cardTouchStartX = 0;
let cardTouchStartY = 0;
let cardTouchCurrentX = 0;
let cardTouchCurrentY = 0;
let isCardDragging = false;
let currentSwipedCard = null;

document.addEventListener('touchstart', (e) => {
    const item = e.target.closest('.checklist-item');
    if (!item || editMode) return;
    
    // Don't interfere with checkbox clicks
    if (e.target.closest('.checkbox') || e.target.closest('.bullet-number') || 
        e.target.closest('.bullet-square') || e.target.closest('.bullet-circle')) {
        return;
    }
    
    itemTouchStartX = e.touches[0].clientX;
    itemTouchStartY = e.touches[0].clientY;  // FIXED: Added this
    itemTouchCurrentX = itemTouchStartX;
    itemTouchCurrentY = itemTouchStartY;  // FIXED: Added this
    isItemDragging = false;  // FIXED: Changed from true to false
    currentSwipedItem = item;
    item.style.transition = 'none';
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    if (!currentSwipedItem) return;
    
    itemTouchCurrentX = e.touches[0].clientX;
    itemTouchCurrentY = e.touches[0].clientY;
    const deltaX = itemTouchCurrentX - itemTouchStartX;
    const deltaY = itemTouchCurrentY - itemTouchStartY;
    
    // Dead zone - ignore first 30px of movement
    if (!isItemDragging && Math.abs(deltaX) < 30) {
        return;
    }
    
    // Only start swiping if movement is STRICTLY HORIZONTAL (within ±20 degrees)
    if (!isItemDragging) {
        const angle = Math.abs(Math.atan2(deltaY, deltaX) * 180 / Math.PI);
        const isHorizontal = angle < 20 || angle > 160; // Within 20 degrees of horizontal
        
        if (isHorizontal && Math.abs(deltaX) > 30) {
            isItemDragging = true;
        } else if (Math.abs(deltaY) > 15 || !isHorizontal) {
            // Vertical scroll or diagonal swipe detected - cancel
            currentSwipedItem.style.transition = '';
            currentSwipedItem.style.transform = '';
            currentSwipedItem.style.background = '';
            currentSwipedItem = null;
            return;
        }
    }
    
    if (!isItemDragging) return;
    
    // Only allow swiping left (negative delta)
    if (deltaX < 0) {
        // Subtract dead zone from visual movement for smoother feel
        const adjustedDelta = deltaX + 30;
        currentSwipedItem.style.transform = `translateX(${adjustedDelta}px)`;
        
        // Show delete button background as user swipes - MORE OPAQUE
        const maxSwipe = 100;
        const swipeProgress = Math.min(Math.abs(adjustedDelta) / maxSwipe, 1);
        currentSwipedItem.style.background = `linear-gradient(90deg, #f8f9fa ${100 - (swipeProgress * 100)}%, #dc2626 100%)`;
    }
});

document.addEventListener('touchend', async (e) => {
    if (!currentSwipedItem) return;
    
    const deltaX = itemTouchCurrentX - itemTouchStartX;
    const threshold = 100;
    
    currentSwipedItem.style.transition = 'all 0.3s ease';
    
    if (isItemDragging && deltaX < 0 && Math.abs(deltaX) > threshold) {
        // Get the data immediately before animation
        const catIndex = parseInt(currentSwipedItem.dataset.catIndex);
        const skillIndex = parseInt(currentSwipedItem.dataset.skillIndex);
        const itemIndex = parseInt(currentSwipedItem.dataset.itemIndex);
        
        // Delete the item with animation - NO CONFIRMATION HERE
        currentSwipedItem.style.transform = 'translateX(-100%)';
        currentSwipedItem.style.opacity = '0';
        
        setTimeout(() => {
            // Call the deleteItem function which has its own confirmation
            deleteItem(catIndex, skillIndex, itemIndex);
        }, 300);
    } else {
        // Not enough swipe - snap back
        currentSwipedItem.style.transform = 'translateX(0)';
        currentSwipedItem.style.background = '#f8f9fa';
    }
    
    isItemDragging = false;
    currentSwipedItem = null;
});

// Swipe right to cycle bullet styles
let rightSwipeTouchStartX = 0;
let rightSwipeTouchStartY = 0;
let rightSwipeTouchCurrentX = 0;
let rightSwipeTouchCurrentY = 0;
let isRightSwiping = false;
let currentRightSwipeItem = null;

document.addEventListener('touchstart', (e) => {
    const item = e.target.closest('.checklist-item');
    if (!item || editMode) return;
    
    // Don't interfere with checkbox clicks
    if (e.target.closest('.checkbox') || e.target.closest('.bullet-number') || 
        e.target.closest('.bullet-square') || e.target.closest('.bullet-circle')) {
        return;
    }
    
    rightSwipeTouchStartX = e.touches[0].clientX;
    rightSwipeTouchStartY = e.touches[0].clientY;
    rightSwipeTouchCurrentX = rightSwipeTouchStartX;
    rightSwipeTouchCurrentY = rightSwipeTouchStartY;
    isRightSwiping = false;
    currentRightSwipeItem = item;
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    if (!currentRightSwipeItem) return;
    
    rightSwipeTouchCurrentX = e.touches[0].clientX;
    rightSwipeTouchCurrentY = e.touches[0].clientY;
    const deltaX = rightSwipeTouchCurrentX - rightSwipeTouchStartX;
    const deltaY = rightSwipeTouchCurrentY - rightSwipeTouchStartY;
    
    // Dead zone - ignore first 20px
    if (!isRightSwiping && Math.abs(deltaX) < 20) {
        return;
    }
    
    // Only start if horizontal movement is greater than vertical AND swiping RIGHT
    if (!isRightSwiping) {
        if (deltaX > 20 && Math.abs(deltaX) > Math.abs(deltaY)) {
            isRightSwiping = true;
            e.preventDefault(); // Prevent scrolling
        } else if (Math.abs(deltaY) > 15) {
            // Vertical scroll - cancel
            currentRightSwipeItem = null;
            return;
        }
    }
    
    if (!isRightSwiping) return;
    
    // Visual feedback - animate the checkbox/bullet
    if (deltaX > 0) {
        const adjustedDelta = Math.min(deltaX - 20, 60); // Max 60px movement
        const progress = adjustedDelta / 60;
        
        // Find the checkbox or bullet element
        const bullet = currentRightSwipeItem.querySelector('.checkbox, .bullet-number, .bullet-square, .bullet-circle');
        if (bullet) {
            // Pulse and scale animation
            bullet.style.transform = `scale(${1 + progress * 0.5}) rotate(${progress * 360}deg)`;
            bullet.style.transition = 'none';
            
            // Color change based on next bullet type
            const catIndex = parseInt(currentRightSwipeItem.dataset.catIndex);
            const skillIndex = parseInt(currentRightSwipeItem.dataset.skillIndex);
            const currentStyle = categories[catIndex].skills[skillIndex].bulletStyle || 'checkbox';
            const styles = ['checkbox', 'number', 'square', 'circle', 'none'];
            const currentIndex = styles.indexOf(currentStyle);
            const nextIndex = (currentIndex + 1) % styles.length;
            
            // Show preview color based on next type
            const colors = {
                'checkbox': '#10b981',
                'number': '#3b82f6', 
                'square': '#8b5cf6',
                'circle': '#f59e0b',
                'none': '#6b7280'
            };
            bullet.style.background = colors[styles[nextIndex]];
        }
        
        // Subtle background gradient
        currentRightSwipeItem.style.background = `linear-gradient(90deg, #f8f9fa 0%, #dbeafe ${adjustedDelta}%)`; 
        currentRightSwipeItem.style.transition = 'none';
    }
});

document.addEventListener('touchend', (e) => {
    if (!currentRightSwipeItem) return;
    
    const deltaX = rightSwipeTouchCurrentX - rightSwipeTouchStartX;
    const threshold = 50; // Minimum swipe distance
    
    currentRightSwipeItem.style.transition = 'all 0.3s ease';
    
    if (isRightSwiping && deltaX > threshold) {
        // Get the data
        const catIndex = parseInt(currentRightSwipeItem.dataset.catIndex);
        const skillIndex = parseInt(currentRightSwipeItem.dataset.skillIndex);
        
        if (!isNaN(catIndex) && !isNaN(skillIndex)) {
            // Flash animation
            currentRightSwipeItem.style.transform = 'translateX(0)';
            currentRightSwipeItem.style.background = '#dbeafe'; // Light blue flash
            
            setTimeout(() => {
                // Get current bullet style
                const currentStyle = categories[catIndex].skills[skillIndex].bulletStyle || 'checkbox';
                
                // Cycle through styles
                const styles = ['checkbox', 'number', 'square', 'circle', 'none'];
                const currentIndex = styles.indexOf(currentStyle);
                const nextIndex = (currentIndex + 1) % styles.length;
                const nextStyle = styles[nextIndex];
                
                // Update the bullet style
                categories[catIndex].skills[skillIndex].bulletStyle = nextStyle;
                saveCategories();
                renderContent();
            }, 200);
        }
    } else {
        // Not enough swipe - snap back
        currentRightSwipeItem.style.transform = 'translateX(0)';
        currentRightSwipeItem.style.background = '#f8f9fa';
    }
    
    isRightSwiping = false;
    currentRightSwipeItem = null;
});

// Diagonal swipe (down-left) to delete skill cards - captures anywhere on card
document.addEventListener('touchstart', (e) => {
    // Check if touch is on or inside a skill card
    const card = e.target.closest('.skill-card');
    if (!card || editMode) return;
    
    // Don't interfere with card control buttons
    if (e.target.closest('.skill-control-btn') || 
        e.target.closest('.add-item-btn')) {
        return;
    }
    
    cardTouchStartX = e.touches[0].clientX;
    cardTouchStartY = e.touches[0].clientY;
    cardTouchCurrentX = cardTouchStartX;
    cardTouchCurrentY = cardTouchStartY;
    isCardDragging = false;
    currentSwipedCard = card;
    card.style.transition = 'none';
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    if (!currentSwipedCard) return;
    
    cardTouchCurrentX = e.touches[0].clientX;
    cardTouchCurrentY = e.touches[0].clientY;
    const deltaX = cardTouchCurrentX - cardTouchStartX;
    const deltaY = cardTouchCurrentY - cardTouchStartY;
    
    // Dead zone - ignore first 30px of movement
    if (!isCardDragging && (Math.abs(deltaX) < 30 && Math.abs(deltaY) < 30)) {
        return;
    }
    
    // Check if swipe is diagonal down-left
    if (!isCardDragging) {
        const angle = Math.atan2(deltaY, deltaX) * 180 / Math.PI;
        // Down-left: angle between 120° and 170° (going down and to the left)
        const isDiagonalDownLeft = deltaX < 0 && deltaY > 0 && angle > 120 && angle < 170;
        
        if (isDiagonalDownLeft && Math.abs(deltaX) > 30 && Math.abs(deltaY) > 20) {
            isCardDragging = true;
            e.preventDefault(); // Prevent scrolling and item swipes
            
            // Cancel any active item swipe
            if (currentSwipedItem) {
                currentSwipedItem.style.transition = '';
                currentSwipedItem.style.transform = '';
                currentSwipedItem.style.background = '';
                currentSwipedItem = null;
                isItemDragging = false;
            }
        } else if ((Math.abs(deltaX) > 40 && Math.abs(deltaY) < 20) || Math.abs(deltaY) > 50) {
            // Horizontal swipe (for items) or vertical scroll - cancel card swipe
            currentSwipedCard.style.transition = '';
            currentSwipedCard.style.transform = '';
            currentSwipedCard.style.background = '';
            currentSwipedCard.style.boxShadow = '';
            currentSwipedCard = null;
            return;
        }
    }
    
    if (!isCardDragging) return;
    
    // Prevent item swipes while card is being swiped
    if (currentSwipedItem) {
        currentSwipedItem.style.transition = '';
        currentSwipedItem.style.transform = '';
        currentSwipedItem.style.background = '';
        currentSwipedItem = null;
        isItemDragging = false;
    }
    
    // Apply diagonal movement with visual feedback
    if (deltaX < 0 && deltaY > 0) {
        const adjustedDeltaX = deltaX + 30;
        const adjustedDeltaY = deltaY - 20;
        currentSwipedCard.style.transform = `translate(${adjustedDeltaX}px, ${adjustedDeltaY}px) rotate(-5deg)`;
        currentSwipedCard.style.boxShadow = '0 8px 24px rgba(220, 38, 38, 0.4)';
        
        // Show delete background with gradient
        const maxSwipe = 120;
        const swipeProgress = Math.min(Math.sqrt(adjustedDeltaX * adjustedDeltaX + adjustedDeltaY * adjustedDeltaY) / maxSwipe, 1);
        currentSwipedCard.style.background = `linear-gradient(135deg, #fee2e2 ${100 - (swipeProgress * 100)}%, #dc2626 100%)`;
        currentSwipedCard.style.borderLeftColor = '#dc2626';
    }
});

document.addEventListener('touchend', async (e) => {
    if (!currentSwipedCard) return;
    
    const deltaX = cardTouchCurrentX - cardTouchStartX;
    const deltaY = cardTouchCurrentY - cardTouchStartY;
    const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
    const threshold = 100;
    
    currentSwipedCard.style.transition = 'all 0.3s ease';
    
    if (isCardDragging && distance > threshold) {
        // Get the data immediately before animation
        const catIndex = parseInt(currentSwipedCard.dataset.catIndex);
        const skillIndex = parseInt(currentSwipedCard.dataset.skillIndex);
        
        // Delete the card with animation - NO CONFIRMATION HERE
        currentSwipedCard.style.transform = 'translate(-150%, 100%) rotate(-15deg)';
        currentSwipedCard.style.opacity = '0';
        
        setTimeout(() => {
            // Call the deleteSkill function which has its own confirmation
            deleteSkill(catIndex, skillIndex);
        }, 300);
    } else {
        // Not enough swipe - snap back
        currentSwipedCard.style.transform = '';
        currentSwipedCard.style.background = '';
        currentSwipedCard.style.boxShadow = '';
        currentSwipedCard.style.borderLeftColor = '';
    }
    
    isCardDragging = false;
    currentSwipedCard = null;
});

function createNewGuide() {
    if (!currentUser) return;
    const timestamp = Date.now();
    const newId = `guide_${timestamp}`;
    
    const newGuideData = {
        appTitle: 'New Guide',
        appSubtitle: 'Tap to add description',
        appIcon: '📝',
        categories: [],
        themeColor: '#3498db',
        checkedItems: {}
    };
    
    set(ref(database, `users/${currentUser.uid}/guides/${newId}`), newGuideData).then(() => {
        currentGuideId = newId;
        localStorage.setItem('currentGuideId', newId);
        localStorage.setItem('currentPage', 'guides'); // Changed to 'guides'
        loadUserData(currentUser.uid);
        
        // Switch to main view
        document.getElementById('homePage')?.classList.remove('active');
        document.querySelector('.container').style.display = 'block';
        
        // Keep Home button active
        document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelectorAll('.bottom-nav-item')[0]?.classList.add('active'); // Home button
        
        // Show back button
        setTimeout(() => {
            const backBtn = document.getElementById('headerBackBtn');
            if (backBtn) {
                backBtn.style.display = 'flex';
            }
        }, 100);
    });
}

function createGuideFromTemplate(templateType) {
    if (!currentUser) return;
    const timestamp = Date.now();
    const newId = `guide_${timestamp}`;
    
    let templateData = {
        appTitle: 'New Guide',
        appSubtitle: 'Tap to add description',
        appIcon: '📝',
        categories: [],
        themeColor: '#3498db',
        checkedItems: {},
        templateType: templateType 
    };
    
    
    // Customize based on template type
    switch(templateType) {
        case 'short-notes':
            templateData.appTitle = 'Short Notes';
            templateData.appSubtitle = 'Quick notes and ideas';
            templateData.appIcon = '📝';
            templateData.categories = [
                {
                    name: "Notes",
                    icon: "📄",
                    skills: [
                        {
                            title: "Ideas",
                            icon: "💡",
                            bulletStyle: "bullet",
                            items: []
                        }
                    ]
                }
            ];
            break;
        case 'reminders':
            templateData.appTitle = 'Reminders';
            templateData.appSubtitle = 'Things to remember';
            templateData.appIcon = '🔔';
            templateData.categories = [
                {
                    name: "To Do",
                    icon: "✅",
                    skills: [
                        {
                            title: "Today",
                            icon: "📌",
                            bulletStyle: "checkbox",
                            items: []
                        }
                    ]
                }
            ];
            break;
        case 'trackers':
            templateData.appTitle = 'Trackers';
            templateData.appSubtitle = 'Track your progress';
            templateData.appIcon = '📊';
            templateData.categories = [
                {
                    name: "Habits",
                    icon: "🎯",
                    skills: [
                        {
                            title: "Daily Habits",
                            icon: "✨",
                            bulletStyle: "checkbox",
                            items: []
                        }
                    ]
                }
            ];
            break;
        case 'routines':
            templateData.appTitle = 'Routines';
            templateData.appSubtitle = 'Daily routines';
            templateData.appIcon = '🔄';
            templateData.categories = [
                {
                    name: "Morning",
                    icon: "🌅",
                    skills: [
                        {
                            title: "Morning Routine",
                            icon: "☀️",
                            bulletStyle: "checkbox",
                            items: []
                        }
                    ]
                }
            ];
            break;
        case 'journals':
            templateData.appTitle = 'Journal';
            templateData.appSubtitle = 'Daily thoughts and reflections';
            templateData.appIcon = '📖';
            templateData.categories = [
                {
                    name: "Entries",
                    icon: "📝",
                    skills: [
                        {
                            title: "Today",
                            icon: "✍️",
                            bulletStyle: "bullet",
                            items: []
                        }
                    ]
                }
            ];
            break;
    }
    
    set(ref(database, `users/${currentUser.uid}/guides/${newId}`), templateData).then(() => {
        currentGuideId = newId;
        localStorage.setItem('currentGuideId', newId);
        localStorage.setItem('currentPage', 'guides'); // Changed to 'guides' so home stays active
        
        // Load the user data for the new guide
        loadUserData(currentUser.uid);
        
        // Switch to main view
        document.getElementById('homePage')?.classList.remove('active');
        document.getElementById('templatesPage')?.classList.remove('active');
        document.querySelector('.container').style.display = 'block';
        
        // Keep Home button active since guides are part of home
        document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
        document.querySelectorAll('.bottom-nav-item')[0]?.classList.add('active'); // Home button
        
        // Show back button
        setTimeout(() => {
            const backBtn = document.getElementById('headerBackBtn');
            if (backBtn) {
                backBtn.style.display = 'flex';
            }
        }, 100);
    }).catch((error) => {
        console.error('Error creating template:', error);
        customAlert('Failed to create guide: ' + error.message, 'Error');
    });
}


	// Create new collection
async function createNewCollection() {
    const collectionName = await customPrompt('Enter collection name:', 'New Collection', 'Create Collection');
    if (!collectionName || !currentUser) return;
    
    const timestamp = Date.now();
    const collectionId = `collection_${timestamp}`;
    
    await set(ref(database, `users/${currentUser.uid}/collections/${collectionId}`), {
        name: collectionName,
        createdAt: timestamp
    });
    
    populateHomePage();
}

// Populate collections navigation
async function populateCollections() {
    if (!currentUser) return;
    
    const collectionsNav = document.getElementById('homeCollectionsNav');
    if (!collectionsNav) return;
    
    const collectionsSnapshot = await get(ref(database, `users/${currentUser.uid}/collections`));
    const collections = collectionsSnapshot.val() || {};
    
    const collectionsArray = Object.keys(collections).map(id => ({
        id: id,
        name: collections[id].name || 'Untitled Collection',
        createdAt: collections[id].createdAt || 0
    })).sort((a, b) => a.createdAt - b.createdAt);
    
    if (collectionsArray.length === 0) {
        collectionsNav.innerHTML = '';
        return;
    }
    
    collectionsNav.innerHTML = collectionsArray.map(collection => `
        <div class="home-collection-item ${selectedCollection === collection.id ? 'active' : ''}" data-collection-id="${collection.id}">
            <div class="home-collection-circle">
                <div class="home-collection-circle-dot"></div>
            </div>
            <span class="home-collection-name">${collection.name}</span>
        </div>
    `).join('');
    
    // Add click handlers
    document.querySelectorAll('.home-collection-item').forEach(item => {
        item.addEventListener('click', () => {
            const collectionId = item.dataset.collectionId;
            
            if (selectedCollection === collectionId) {
                // Deselect if clicking on already selected collection
                selectedCollection = null;
            } else {
                selectedCollection = collectionId;
            }
            
            populateHomePage();
        });

        // Long press to delete collection
        let longPressTimer;
        let longPressTriggered = false;
        
        item.addEventListener('touchstart', (e) => {
            longPressTriggered = false;
            longPressTimer = setTimeout(async () => {
                longPressTriggered = true;
                e.preventDefault();
                const collectionId = item.dataset.collectionId;
                const collectionName = item.querySelector('.home-collection-name').textContent;
                
                if (await customConfirm(`Delete collection "${collectionName}"? The guides inside will not be deleted.`, 'Delete Collection', 'Delete')) {
                    await remove(ref(database, `users/${currentUser.uid}/collections/${collectionId}`));
                    
                    // Remove collection reference from guides
                    const guidesSnapshot = await get(ref(database, `users/${currentUser.uid}/guides`));
                    const guides = guidesSnapshot.val() || {};
                    
                    for (const guideId in guides) {
                        if (guides[guideId].collectionId === collectionId) {
                            await remove(ref(database, `users/${currentUser.uid}/guides/${guideId}/collectionId`));
                        }
                    }
                    
                    selectedCollection = null;
                    populateHomePage();
                }
            }, 500);
        });
        
        item.addEventListener('touchend', () => {
		    clearTimeout(longPressTimer);
		}, { passive: true });  
		
		item.addEventListener('touchmove', () => {
		    clearTimeout(longPressTimer);
		}, { passive: true });
        
        item.addEventListener('mousedown', (e) => {
            longPressTriggered = false;
            longPressTimer = setTimeout(async () => {
                longPressTriggered = true;
                e.preventDefault();
                const collectionId = item.dataset.collectionId;
                const collectionName = item.querySelector('.home-collection-name').textContent;
                
                if (await customConfirm(`Delete collection "${collectionName}"? The guides inside will not be deleted.`, 'Delete Collection', 'Delete')) {
                    await remove(ref(database, `users/${currentUser.uid}/collections/${collectionId}`));
                    
                    // Remove collection reference from guides
                    const guidesSnapshot = await get(ref(database, `users/${currentUser.uid}/guides`));
                    const guides = guidesSnapshot.val() || {};
                    
                    for (const guideId in guides) {
                        if (guides[guideId].collectionId === collectionId) {
                            await remove(ref(database, `users/${currentUser.uid}/guides/${guideId}/collectionId`));
                        }
                    }
                    
                    selectedCollection = null;
                    populateHomePage();
                }
            }, 500);
        });
        
        item.addEventListener('mouseup', () => {
		    clearTimeout(longPressTimer);
		}, { passive: true }); 
		
		item.addEventListener('mouseleave', () => {
		    clearTimeout(longPressTimer);
		}, { passive: true });
		
        
    });
}  


        
function toggleMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById('dropdownMenu');
    const floatingBtn = document.getElementById('layoutBtn');
    const isCurrentlyShown = menu.classList.contains('show');
    
    menu.classList.toggle('show');
    
    // Hide/show floating button based on menu state
    if (floatingBtn) {
        if (menu.classList.contains('show')) {
            floatingBtn.style.display = 'none';
        } else {
            floatingBtn.style.display = 'flex';
        }
    }
    
    // Close other menus
    const guideMenu = document.getElementById('guideDropdown');
    if (guideMenu) guideMenu.classList.remove('show');
    
    // If we just closed it, trigger a re-render to reset button state
    if (isCurrentlyShown) {
        // Force button to lose focus
        e.target.blur();
    }
}

// Authentication functions
async function login(email, password) {
    try {
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        loadUserData(currentUser.uid);
    } catch (error) {
        await customAlert(error.message, 'Login Failed');
    }
}


async function signup(email, password) {
    try {
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        currentUser = userCredential.user;
        loadUserData(currentUser.uid);
    } catch (error) {
        await customAlert(error.message, 'Signup Failed');
    }
}

async function loginWithGoogle() {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
        prompt: 'select_account'
    });
    
    try {
        const result = await signInWithPopup(auth, provider);
        currentUser = result.user;
        loadUserData(currentUser.uid);
    } catch (error) {
        console.error('Google login error:', error);
        await customAlert('Google login failed: ' + error.message);
    }
}

function logout() {
    signOut(auth).then(() => {
        currentUser = null;
        categories = [];
    });
}

function showSignup() {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    
    loginScreen.classList.remove('show');
    setTimeout(() => {
        loginScreen.style.display = 'none';
        signupScreen.style.display = 'flex';
        setTimeout(() => signupScreen.classList.add('show'), 10);
    }, 300);
}
async function processSignup() {
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupPasswordConfirm').value;
    
    if (!email || !password) {
        await customAlert('Please enter your email and password', 'Missing Information');
        return;
    }
    
    if (password.length < 6) {
        await customAlert('Password must be at least 6 characters long', 'Invalid Password');
        return;
    }
    
    if (password !== confirmPassword) {
        await customAlert('The passwords you entered do not match', 'Password Mismatch');
        return;
    }
    
    signup(email, password);
}

function backToLogin() {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    
    signupScreen.classList.remove('show');
    setTimeout(() => {
        signupScreen.style.display = 'none';
        loginScreen.style.display = 'flex';
        setTimeout(() => loginScreen.classList.add('show'), 10);
    }, 300);
}

async function deleteAccount() {
    if (!currentUser) return;
    const user = currentUser;
    const userId = user.uid;
    
    try {
        // Delete all user data from database
        await remove(ref(database, `users/${userId}`));
        
        // Delete the authentication account
        await user.delete();
        
        await customAlert('Your account has been permanently deleted.', 'Account Deleted');
        currentUser = null;
    } catch (error) {
        await customAlert(error.message, 'Error Deleting Account');
    }
}
	
function duplicateGuide() {
    if (!currentUser) return;
    const timestamp = Date.now();
    const newId = `${currentGuideId}_copy_${timestamp}`;
    
    get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}`)).then((snapshot) => {
        const data = snapshot.val();
        if (data.appTitle) {
            data.appTitle = data.appTitle + ' (Copy)';
        }
        set(ref(database, `users/${currentUser.uid}/guides/${newId}`), data).then(() => {
            currentGuideId = newId;
            localStorage.setItem('currentGuideId', newId);
            loadUserData(currentUser.uid);
        });
    });
}

async function deleteGuide() {
    if (!currentUser) return;
    if (currentGuideId === 'defaultGuide') {
        await customAlert("The default guide cannot be deleted.", "Cannot Delete");
        return;
    }
    if (await customConfirm("This will permanently delete this guide and all its content. This cannot be undone.", "Delete Guide")) {
        remove(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}`));
        currentGuideId = 'defaultGuide';
        localStorage.setItem('currentGuideId', 'defaultGuide');
        loadUserData(currentUser.uid);
    }
}
	
function saveHeader() {
  if (!currentUser) return;
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appTitle`), appTitle);
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appSubtitle`), appSubtitle);
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appIcon`), appIcon);
  renderHeader();
  
}

async function renderHeader() {
    const header = document.querySelector('.header');
    
    // Generate color options HTML
    let colorOptionsHTML = '';
    colorThemes.forEach(theme => {
        const isSelected = theme.primary === themeColor ? 'selected' : '';
        colorOptionsHTML += `
            <div class="color-option ${isSelected}" 
                 style="background: linear-gradient(135deg, ${theme.secondary} 0%, ${theme.primary} 100%);"
                 data-color="${theme.primary}"
                 title="${theme.name}">
            </div>
        `;
    });
    const backButton = `
        <button class="header-back-btn" id="headerBackBtn" style="display: none;">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="15 18 9 12 15 6"></polyline>
            </svg>
        </button>
    `;
        header.innerHTML = `
        ${backButton}
	
	<div class="edit-toggle">
	    <button class="save-btn" id="saveBtn" style="display: none;">Done</button>
	    <button class="edit-btn" id="menuBtn" style="display: block;">⋮</button>
	    <div class="dropdown-menu" id="dropdownMenu">
	        <button id="editModeMenuBtn">Edit</button>
	        <button id="duplicateGuideBtn">Duplicate</button>
	        <button id="deleteGuideBtn">Delete</button>
	        <button id="headerImageBtn">Header Image</button>
	        <div class="header-image-menu" id="headerImageMenu">
	            <h3>Header Background</h3>
	            <input type="file" id="headerImageInput" accept="image/*" style="display: none;">
	            <button id="uploadHeaderImageBtn" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; font-weight: 500;">Upload Image</button>
	            <button id="removeHeaderImageBtn" style="width: 100%; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Remove Image</button>
	        </div>
	        <button id="wallpaperBtn">Wallpaper</button>
	        <div class="wallpaper-menu" id="wallpaperMenu">
	            <h3>Wallpaper</h3>
	            <input type="file" id="wallpaperInput" accept="image/*" style="display: none;">
	            <button id="uploadWallpaperBtn" style="width: 100%; padding: 10px; background: #3498db; color: white; border: none; border-radius: 6px; cursor: pointer; margin-bottom: 10px; font-weight: 500;">Upload Image</button>
	            <button id="removeWallpaperBtn" style="width: 100%; padding: 10px; background: #e74c3c; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 500;">Remove Image</button>
	        </div>
	        <button id="toggleColorBtn">Theme</button>
	        <div class="color-picker-menu" id="colorPickerMenu">
	            <h3>Preset Themes</h3>
	            <div class="color-options" id="colorOptionsContainer" style="margin-bottom: 15px;">
	                ${colorOptionsHTML}
	            </div>
	            <h3>Custom Color</h3>
	            <div style="margin-bottom: 15px;">
	                <div id="colorCanvas" class="color-picker-canvas" style="background-color: hsl(0, 100%, 50%);">
	                    <div class="picker-indicator" id="canvasIndicator" style="left: 100%; top: 0%;"></div>
	                </div>
	                <div class="hue-slider" id="hueSlider">
	                    <div class="hue-indicator" id="hueIndicator" style="left: 0%;"></div>
	                </div>
	                <div style="display: flex; align-items: center; gap: 10px;">
	                    <div style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid #dee2e6; background-color: ${themeColor}; flex-shrink: 0;" id="colorPreview"></div>
	                    <input type="text" id="hexInput" value="${themeColor}" 
	                           style="flex: 1; padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px; text-transform: uppercase;"
	                           maxlength="7" placeholder="#FF0000">
	                    <button id="applyColorBtn" style="padding: 6px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;">Done</button>
	                </div>
	            </div>
	        </div>
	        <button id="checkboxOptionsBtn">Checkbox Options</button>
	        <div class="checkbox-menu" id="checkboxMenu">
	            <h3>Checkbox Actions</h3>
	            <button id="clearChecksBtn">Clear All Checks</button>
	            <button id="autoRefreshBtn">
	                ${autoRefreshEnabled ? `✓ Auto-refresh (${autoRefreshTime})` : 'Auto-refresh Daily'}
	            </button>
	        </div>
	    </div>
	</div>
	<h1>
	    <span class="editable-icon" id="appIconContainer" style="display: inline-block; position: relative; margin-right: 8px;">
	        <span class="icon" id="appIconSpan" style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${appIcon && appIcon !== "​" ? '1' : '0.3'};">${
	            (() => {
	                const hasIconContent = appIcon && appIcon !== "​";
	                if (hasIconContent) {
	                    if (appIcon.startsWith('svg:')) {
	                        const iconData = JSON.parse(appIcon.substring(4));
	                        return `<span style="display: inline-flex; width: 28px; height: 28px; background: ${iconData.bg}; border-radius: 6px; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
	                    } else {
	                        return appIcon;
	                    }
	                } else {
	                    return editMode ? "+" : "​";
	                }
	            })()
	        }</span>
	        ${editMode && appIcon && appIcon !== "​" ? '<span class="emoji-remove-btn" id="removeAppIconBtn">×</span>' : ''}
	    </span>
	    <span class="${editMode ? 'editable' : ''}" id="appTitleSpan" contenteditable="${editMode}">
	        ${appTitle}
	    </span>
	</h1>
	<p class="${editMode ? 'editable' : ''}" id="appSubtitleSpan" contenteditable="${editMode}">${appSubtitle}</p>
`;
	
    // Add event listeners after HTML is rendered
    const guideMenuBtn = document.getElementById('guideMenuBtn');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const createGuideBtn = document.getElementById('createGuideBtn');
    const logoutBtn = document.getElementById('logoutBtn');
    const saveBtn = document.getElementById('saveBtn');
    const menuBtn = document.getElementById('menuBtn');
    const editModeMenuBtn = document.getElementById('editModeMenuBtn');
    const duplicateGuideBtn = document.getElementById('duplicateGuideBtn');
    const deleteGuideBtn = document.getElementById('deleteGuideBtn');
    const toggleColorBtn = document.getElementById('toggleColorBtn');
	const applyColorBtn = document.getElementById('applyColorBtn');
    const appIconSpan = document.getElementById('appIconSpan');
    const removeAppIconBtn = document.getElementById('removeAppIconBtn');
    const headerImageBtn = document.getElementById('headerImageBtn');
    const uploadHeaderImageBtn = document.getElementById('uploadHeaderImageBtn');
    const removeHeaderImageBtn = document.getElementById('removeHeaderImageBtn');
    const headerImageInput = document.getElementById('headerImageInput');
	const wallpaperBtn = document.getElementById('wallpaperBtn');
	const uploadWallpaperBtn = document.getElementById('uploadWallpaperBtn');
	const removeWallpaperBtn = document.getElementById('removeWallpaperBtn');
	const wallpaperInput = document.getElementById('wallpaperInput');
	const checkboxOptionsBtn = document.getElementById('checkboxOptionsBtn');
	const clearChecksBtn = document.getElementById('clearChecksBtn');
	const autoRefreshBtn = document.getElementById('autoRefreshBtn');
	// Back button handler
    setTimeout(() => {
        const backBtn = document.getElementById('headerBackBtn');
    if (backBtn) {
        backBtn.addEventListener('click', () => {
            // Go back to home page
            document.querySelector('.container').style.display = 'none';
			document.body.classList.remove('viewing-guide');
            const homePage = document.getElementById('homePage');
            if (homePage) {
                homePage.classList.add('active');
                populateHomePage();
            }
            
            localStorage.setItem('currentPage', 'guides');
            
            // Update bottom nav
            document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
            document.querySelectorAll('.bottom-nav-item')[0]?.classList.add('active');
            
            // Hide back button
            backBtn.style.display = 'none';
        });
    }
		}, 100);
	
  	if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);
    if (saveBtn) saveBtn.addEventListener('click', saveAndExitEdit);
	if (menuBtn) menuBtn.addEventListener('click', toggleMenu);
	if (editModeMenuBtn) editModeMenuBtn.addEventListener('click', toggleEditMode);
	if (duplicateGuideBtn) duplicateGuideBtn.addEventListener('click', duplicateGuide);
	if (deleteGuideBtn) deleteGuideBtn.addEventListener('click', deleteGuide);
	if (toggleColorBtn) toggleColorBtn.addEventListener('click', toggleColorPicker);
	if (clearChecksBtn) clearChecksBtn.addEventListener('click', clearAllChecks);
	if (autoRefreshBtn) autoRefreshBtn.addEventListener('click', toggleAutoRefresh);
	if (applyColorBtn) applyColorBtn.addEventListener('click', applyCustomColor);
	
    // Header image event listeners
    if (headerImageBtn) {
	    headerImageBtn.addEventListener('click', (e) => {
	        e.stopPropagation();
	        const imageMenu = document.getElementById('headerImageMenu');
	        const colorMenu = document.getElementById('colorPickerMenu');
	        const checkboxMenu = document.getElementById('checkboxMenu');
	        const uploadBtn = document.getElementById('uploadHeaderImageBtn');
	        const removeBtn = document.getElementById('removeHeaderImageBtn');
	        
	        if (colorMenu) colorMenu.classList.remove('show');
	        if (checkboxMenu) checkboxMenu.classList.remove('show');
	        
	        // Update button visibility based on current state
	        if (headerImage) {
	            if (uploadBtn) uploadBtn.style.display = 'none';
	            if (removeBtn) removeBtn.style.display = 'block';
	        } else {
	            if (uploadBtn) uploadBtn.style.display = 'block';
	            if (removeBtn) removeBtn.style.display = 'none';
	        }
	        
	        if (imageMenu) {
	            imageMenu.classList.toggle('show');
	        }
	    });
	}

    if (uploadHeaderImageBtn) {
        uploadHeaderImageBtn.addEventListener('click', () => {
            headerImageInput.click();
        });
    }

    if (headerImageInput) {
	    headerImageInput.addEventListener('change', (e) => {
	        const file = e.target.files[0];
	        if (file) {
	            console.log('File selected:', file.name);
	            const reader = new FileReader();
	            reader.onload = (event) => {
	                headerImage = event.target.result;
	                console.log('Image loaded, length:', headerImage.length);
	                saveHeaderImage();
	                console.log('Save called');
	                renderHeader();
	                setTimeout(() => applyHeaderImage(), 100); // Give header time to render
	                document.getElementById('headerImageMenu').classList.remove('show');
	                document.getElementById('dropdownMenu').classList.remove('show');
	            };
	            reader.readAsDataURL(file);
	        }
	    });
	}

    if (removeHeaderImageBtn) {
	    removeHeaderImageBtn.addEventListener('click', async () => {
	        if (await customConfirm('Remove header background image?')) {
	            headerImage = null;
	            saveHeaderImage();
	            applyHeaderImage();
	            document.getElementById('headerImageMenu').classList.remove('show');
	            document.getElementById('dropdownMenu').classList.remove('show');
	            renderHeader(); 
	        }
	    });
	}


// Wallpaper button click handler
if (wallpaperBtn) {
    wallpaperBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const wallpaperMenu = document.getElementById('wallpaperMenu');
        const colorMenu = document.getElementById('colorPickerMenu');
        const checkboxMenu = document.getElementById('checkboxMenu');
        const headerImageMenu = document.getElementById('headerImageMenu');
        const uploadBtn = document.getElementById('uploadWallpaperBtn');
        const removeBtn = document.getElementById('removeWallpaperBtn');
        
        if (colorMenu) colorMenu.classList.remove('show');
        if (checkboxMenu) checkboxMenu.classList.remove('show');
        if (headerImageMenu) headerImageMenu.classList.remove('show');
        
        // Update button visibility based on current state
        if (wallpaperUrl) {
            if (uploadBtn) uploadBtn.style.display = 'none';
            if (removeBtn) removeBtn.style.display = 'block';
        } else {
            if (uploadBtn) uploadBtn.style.display = 'block';
            if (removeBtn) removeBtn.style.display = 'none';
        }
        
        if (wallpaperMenu) {
            wallpaperMenu.classList.toggle('show');
        }
    });
}

if (uploadWallpaperBtn) {
    uploadWallpaperBtn.addEventListener('click', () => {
        wallpaperInput.click();
    });
}

if (wallpaperInput) {
    wallpaperInput.addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
            console.log('Wallpaper file selected:', file.name);
            const reader = new FileReader();
            reader.onload = (event) => {
                wallpaperUrl = event.target.result;
                console.log('Wallpaper loaded, length:', wallpaperUrl.length);
                saveWallpaper();
                applyWallpaper();
                document.getElementById('wallpaperMenu').classList.remove('show');
                document.getElementById('dropdownMenu').classList.remove('show');
            };
            reader.readAsDataURL(file);
        }
    });
}


if (removeWallpaperBtn) {
    removeWallpaperBtn.addEventListener('click', async () => {
        if (await customConfirm('Remove wallpaper?')) {
            wallpaperUrl = '';
            saveWallpaper();
            applyWallpaper();
            document.getElementById('wallpaperMenu').classList.remove('show');
            document.getElementById('dropdownMenu').classList.remove('show');
        }
    });
}
	
    // App icon editing
    if (editMode && appIconSpan) {
        appIconSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            editAppIcon(appIconSpan);
        });
    }
    if (removeAppIconBtn) {
        removeAppIconBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            appIcon = '​';
            saveHeader();
        });
    }
    
    // Color option clicks
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            selectColor(option.dataset.color);
        });
    });

	// Checkbox options button and menu
if (checkboxOptionsBtn) {
    checkboxOptionsBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        const checkboxMenu = document.getElementById('checkboxMenu');
        const colorMenu = document.getElementById('colorPickerMenu');
        
        // Close color picker if open
        if (colorMenu) colorMenu.classList.remove('show');
        
        if (checkboxMenu) {
            checkboxMenu.classList.toggle('show');
        }
    });
}

// Clear checks button
if (clearChecksBtn) {
    clearChecksBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        clearAllChecks();
        const checkboxMenu = document.getElementById('checkboxMenu');
        const dropdownMenu = document.getElementById('dropdownMenu');
        if (checkboxMenu) checkboxMenu.classList.remove('show');
        if (dropdownMenu) dropdownMenu.classList.remove('show');
    });
}

// Auto-refresh button
if (autoRefreshBtn) {
    autoRefreshBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        toggleAutoRefresh();
        const checkboxMenu = document.getElementById('checkboxMenu');
        const dropdownMenu = document.getElementById('dropdownMenu');
        if (checkboxMenu) checkboxMenu.classList.remove('show');
        if (dropdownMenu) dropdownMenu.classList.remove('show');
    });
}
    
	// Dynamic styles and theme application...
	    const isLight = isLightColor(themeColor);
	    if (isLight) {
	        const style = document.createElement('style');
	        style.id = 'dynamic-header-style';
	        const existingStyle = document.getElementById('dynamic-header-style');
	        if (existingStyle) existingStyle.remove();
	        
	        style.textContent = `
	            .header .editable:focus { 
	                outline: 2px solid #2c3e50 !important; 
	                background: rgba(255, 255, 255, 0.5) !important; 
	                color: #2c3e50 !important; 
	            }
	            .header .editable:hover { 
	                background: rgba(0, 0, 0, 0.1) !important; 
	            }
	        `;
	        document.head.appendChild(style);
	    } else {
	        const existingStyle = document.getElementById('dynamic-header-style');
	        if (existingStyle) existingStyle.remove();
	    }

    applyTheme();
    

    // Add double-click edit for header (only when not in edit mode)
    if (!editMode) {
        const h1 = header.querySelector('h1');
        const spans = h1 ? h1.querySelectorAll('span') : [];
        const headerTitle = spans.length > 0 ? spans[spans.length - 1] : null;
        const headerSubtitle = header.querySelector('p');
        
        if (headerTitle) {
            headerTitle.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                e.preventDefault();
                enableQuickEditHeader(headerTitle, 'title');
            });
        }
        
        if (headerSubtitle) {
            headerSubtitle.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                e.preventDefault();
                enableQuickEditHeader(headerSubtitle, 'subtitle');
            });
        }
    }

    if (editMode) {
        setTimeout(() => {
            const saveBtn = document.getElementById('saveBtn');
            const menuBtn = document.getElementById('menuBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            if (menuBtn) menuBtn.style.display = 'none';
        }, 0);
    }
    
    if (editMode) {
        const editableTitle = header.querySelector('#appTitleSpan');
        const editableSubtitle = header.querySelector('#appSubtitleSpan');
        
        if (editableTitle) {
            editableTitle.addEventListener('blur', (e) => {
                appTitle = e.target.textContent.trim();
                saveHeader();
            });
        }
        if (editableSubtitle) {
            editableSubtitle.addEventListener('blur', (e) => {
                appSubtitle = e.target.textContent.trim();
                saveHeader();
            });
        }
    }
    
}

let homeSelectMode = false;
let selectedGuides = new Set();

async function populateHomePage() {
    if (!currentUser) return;
    
    // Exit select mode when re-populating
    if (homeSelectMode) {
        toggleSelectMode();
    }
    
    // Populate collections first
    await populateCollections();
    
    const guidesSnapshot = await get(ref(database, `users/${currentUser.uid}/guides`));
    const guides = guidesSnapshot.val() || {};
    const guidesList = document.getElementById('homeGuidesList');
    
    if (!guidesList) return;
    
    // Convert guides to array
    let guidesArray = Object.keys(guides).map(id => ({
        id: id,
        title: guides[id].appTitle || 'Untitled',
        subtitle: guides[id].appSubtitle || 'No description',
        icon: guides[id].appIcon || '📄',
        color: guides[id].themeColor || '#3498db',
        collectionId: guides[id].collectionId || null,
        templateType: guides[id].templateType || 'all'
    }));
    
    // Filter by selected collection
    if (selectedCollection) {
        guidesArray = guidesArray.filter(g => g.collectionId === selectedCollection);
    }
    
    // Filter by selected template type
    if (selectedFilter !== 'all') {
        guidesArray = guidesArray.filter(g => g.templateType === selectedFilter);
    }
    
    guidesList.innerHTML = '';
    
    if (guidesArray.length === 0) {
        guidesList.innerHTML = `
            <div class="home-empty">
                <div class="home-empty-icon">📚</div>
                <div class="home-empty-text">No guides found</div>
                <div class="home-empty-subtext">${selectedCollection ? 'This collection is empty' : 'Create your first guide to get started'}</div>
            </div>
        `;
        return;
    }
    
    // Render guides
    guidesArray.forEach(guide => {
        const item = createGuideElement(guide, false);
        guidesList.appendChild(item);
    });
    
    // Search button functionality
    const homeSearchBtn = document.getElementById('homeSearchBtn');
    const homeSearchOverlay = document.getElementById('homeSearchOverlay');
    const homeSearchClose = document.getElementById('homeSearchClose');
    const homeSearchInputFull = document.getElementById('homeSearchInputFull');
    const homeSearchResults = document.getElementById('homeSearchResults');
    
    if (homeSearchBtn && homeSearchOverlay) {
        // Remove old listeners by cloning
        const newSearchBtn = homeSearchBtn.cloneNode(true);
        homeSearchBtn.parentNode.replaceChild(newSearchBtn, homeSearchBtn);
        
        newSearchBtn.addEventListener('click', () => {
            homeSearchOverlay.classList.add('show');
            homeSearchInputFull.focus();
        });
    }
    
    if (homeSearchClose) {
        const newCloseBtn = homeSearchClose.cloneNode(true);
        homeSearchClose.parentNode.replaceChild(newCloseBtn, homeSearchClose);
        
        newCloseBtn.addEventListener('click', () => {
            homeSearchOverlay.classList.remove('show');
            if (homeSearchInputFull) homeSearchInputFull.value = '';
            if (homeSearchResults) homeSearchResults.innerHTML = '';
        });
    }
    
    if (homeSearchInputFull) {
        const newSearchInput = homeSearchInputFull.cloneNode(true);
        homeSearchInputFull.parentNode.replaceChild(newSearchInput, homeSearchInputFull);
        
        newSearchInput.addEventListener('input', async (e) => {
            const searchTerm = e.target.value.toLowerCase().trim();
            
            if (!searchTerm) {
                homeSearchResults.innerHTML = '';
                return;
            }
            
            if (!currentUser) return;
            
            // Search through all guides
            const guidesSnapshot = await get(ref(database, `users/${currentUser.uid}/guides`));
            const guides = guidesSnapshot.val() || {};
            
            let results = [];
            
            Object.keys(guides).forEach(guideId => {
                const guide = guides[guideId];
                const guideTitle = guide.appTitle || '';
                const guideSubtitle = guide.appSubtitle || '';
                
                // Search in guide title and subtitle
                if (guideTitle.toLowerCase().includes(searchTerm) || 
                    guideSubtitle.toLowerCase().includes(searchTerm)) {
                    results.push({
                        type: 'guide',
                        id: guideId,
                        title: guideTitle,
                        subtitle: guideSubtitle,
                        icon: guide.appIcon || '📄',
                        color: guide.themeColor || '#3498db'
                    });
                }
                
                // Search in categories and items
                const categories = guide.categories || [];
                categories.forEach((cat, catIndex) => {
                    cat.skills?.forEach((skill, skillIndex) => {
                        skill.items?.forEach((item, itemIndex) => {
                            if (item.toLowerCase().includes(searchTerm)) {
                                results.push({
                                    type: 'item',
                                    id: guideId,
                                    title: item,
                                    subtitle: `${guideTitle} > ${cat.name} > ${skill.title}`,
                                    icon: skill.icon || '📝',
                                    color: guide.themeColor || '#3498db',
                                    location: {
                                        catIndex,
                                        skillIndex,
                                        itemIndex
                                    }
                                });
                            }
                        });
                    });
                });
            });
            
            // Display results
            if (results.length === 0) {
                homeSearchResults.innerHTML = '<div style="padding: 40px 20px; text-align: center; color: #9ca3af;">No results found</div>';
            } else {
                homeSearchResults.innerHTML = results.map(result => `
                    <div class="search-result-item" data-guide-id="${result.id}" style="padding: 12px 0; border-bottom: 1px solid #f3f4f6; cursor: pointer; display: flex; align-items: center; gap: 12px;">
                        <div style="width: 36px; height: 36px; border-radius: 8px; background: linear-gradient(135deg, ${result.color}dd, ${result.color}); display: flex; align-items: center; justify-content: center; font-size: 18px; flex-shrink: 0;">
                            ${result.icon}
                        </div>
                        <div style="flex: 1; min-width: 0;">
                            <div style="font-size: 14px; font-weight: 500; color: #2c3e50; margin-bottom: 2px;">${result.title}</div>
                            <div style="font-size: 12px; color: #9ca3af;">${result.subtitle}</div>
                        </div>
                    </div>
                `).join('');
                
                // Add click handlers
                document.querySelectorAll('.search-result-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const guideId = item.dataset.guideId;
                        switchGuide(guideId);
                        homeSearchOverlay.classList.remove('show');
                        newSearchInput.value = '';
                        homeSearchResults.innerHTML = '';
                        
                        document.getElementById('homePage').classList.remove('active');
                        document.querySelector('.container').style.display = 'block';
                        document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
                        document.querySelectorAll('.bottom-nav-item')[0].classList.add('active');
                        
                        setTimeout(() => {
                            const backBtn = document.getElementById('headerBackBtn');
                            if (backBtn) backBtn.style.display = 'flex';
                        }, 100);
                    });
                });
            }
        });
    }

    // Create button functionality
    const homeCreateBtn = document.getElementById('homeCreateBtn');
    if (homeCreateBtn) {
        const newCreateBtn = homeCreateBtn.cloneNode(true);
        homeCreateBtn.parentNode.replaceChild(newCreateBtn, homeCreateBtn);
        
        newCreateBtn.addEventListener('click', () => {
            createNewGuide();
        });
    }
    
    // Menu button
    const menuBtn = document.getElementById('homeMenuBtn');
    const dropdownMenu = document.getElementById('homeDropdownMenu');
    const selectMenuBtn = document.getElementById('homeSelectMenuBtn');
    const createCollectionMenuBtn = document.getElementById('homeCreateCollectionMenuBtn');

    if (menuBtn && dropdownMenu) {
        const newMenuBtn = menuBtn.cloneNode(true);
        menuBtn.parentNode.replaceChild(newMenuBtn, menuBtn);
        
        newMenuBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            dropdownMenu.classList.toggle('show');
            
            // Update select button text
            if (selectMenuBtn) {
                selectMenuBtn.innerHTML = homeSelectMode 
                    ? `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>Cancel`
                    : `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>Select`;
            }
        });
    }

    if (selectMenuBtn) {
        const newSelectBtn = selectMenuBtn.cloneNode(true);
        selectMenuBtn.parentNode.replaceChild(newSelectBtn, selectMenuBtn);
        
        newSelectBtn.addEventListener('click', () => {
            toggleSelectMode();
            dropdownMenu.classList.remove('show');
        });
    }

    if (createCollectionMenuBtn) {
        const newCollectionBtn = createCollectionMenuBtn.cloneNode(true);
        createCollectionMenuBtn.parentNode.replaceChild(newCollectionBtn, createCollectionMenuBtn);
        
        newCollectionBtn.addEventListener('click', async () => {
            dropdownMenu.classList.remove('show');
            await createNewCollection();
        });
    }
    
    // Close menu when clicking outside (remove old listeners first)
    const closeMenuHandler = (e) => {
        const currentMenuBtn = document.getElementById('homeMenuBtn');
        const currentDropdown = document.getElementById('homeDropdownMenu');
        if (currentMenuBtn && currentDropdown && 
            !currentMenuBtn.contains(e.target) && !currentDropdown.contains(e.target)) {
            currentDropdown.classList.remove('show');
        }
    };
    
    // Remove old listener if it exists
    if (window.homeMenuCloseHandler) {
        document.removeEventListener('click', window.homeMenuCloseHandler);
    }
    
    // Add new listener and store reference
    window.homeMenuCloseHandler = closeMenuHandler;
    document.addEventListener('click', closeMenuHandler);

	// Filter navigation functionality
    document.querySelectorAll('.home-filter-item').forEach(item => {
        item.addEventListener('click', () => {
            selectedFilter = item.dataset.filter;
            
            // Update active state
            document.querySelectorAll('.home-filter-item').forEach(i => i.classList.remove('active'));
            item.classList.add('active');
            
            populateHomePage();
        });
    });
}  
	
function createGuideElement(guide, isInFolder) {
    const item = document.createElement('div');
    item.className = isInFolder ? 'home-folder-guide-item' : 'home-guide-item';
    item.dataset.guideId = guide.id;
    
    if (guide.id === currentGuideId && !isInFolder) {
        item.classList.add('current');
    }
    
    // Handle icon display
    let iconDisplay = guide.icon;
    if (guide.icon && guide.icon.startsWith('svg:')) {
        try {
            const iconData = JSON.parse(guide.icon.substring(4));
            iconDisplay = `<svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg>`;
        } catch (e) {
            iconDisplay = guide.icon;
        }
    }
    
    const checkboxClass = isInFolder ? 'home-folder-guide-checkbox' : 'home-guide-checkbox';
    const iconClass = isInFolder ? 'home-folder-guide-icon' : 'home-guide-icon';
    const titleClass = isInFolder ? 'home-folder-guide-title' : '';
    
    if (isInFolder) {
        item.innerHTML = `
            <div class="${checkboxClass}"></div>
            <div class="${iconClass}" style="background: linear-gradient(135deg, ${guide.color}dd, ${guide.color})">
                ${iconDisplay}
            </div>
            <div class="${titleClass}">${guide.title}</div>
        `;
    } else {
        item.innerHTML = `
            <div class="${checkboxClass}"></div>
            <div class="${iconClass}" style="background: linear-gradient(135deg, ${guide.color}dd, ${guide.color})">
                ${iconDisplay}
            </div>
            <div class="home-guide-info">
                <div class="home-guide-title">${guide.title}</div>
                <div class="home-guide-meta">${guide.subtitle}</div>
            </div>
            <svg class="home-guide-arrow" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="9 18 15 12 9 6"></polyline>
            </svg>
        `;
    }
    
    const checkbox = item.querySelector(`.${checkboxClass}`);
    
    // Long press support
    let longPressTimer;
    let longPressTriggered = false;
    
    item.addEventListener('touchstart', (e) => {
        longPressTriggered = false;
        longPressTimer = setTimeout(() => {
            longPressTriggered = true;
            if (!homeSelectMode) {
                toggleSelectMode();
            }
            toggleGuideSelection(guide.id, checkbox);
        }, 500);
    });
    
    item.addEventListener('touchend', () => {
        clearTimeout(longPressTimer);
    });
    
    item.addEventListener('touchmove', () => {
        clearTimeout(longPressTimer);
    });
    
    item.addEventListener('mousedown', (e) => {
        longPressTriggered = false;
        longPressTimer = setTimeout(() => {
            longPressTriggered = true;
            if (!homeSelectMode) {
                toggleSelectMode();
            }
            toggleGuideSelection(guide.id, checkbox);
        }, 500);
    });
    
    item.addEventListener('mouseup', () => {
        clearTimeout(longPressTimer);
    });
    
    item.addEventListener('mouseleave', () => {
        clearTimeout(longPressTimer);
    });
    
    item.addEventListener('click', (e) => {
        if (longPressTriggered) {
            e.preventDefault();
            e.stopPropagation();
            return;
        }
        
		if (homeSelectMode) {
		    e.stopPropagation();
		    toggleGuideSelection(guide.id, checkbox);
		} else {
		    switchGuide(guide.id);
		    localStorage.setItem('currentPage', 'guides');
		    document.getElementById('homePage').classList.remove('active');
		    document.querySelector('.container').style.display = 'block';
		    document.body.classList.add('viewing-guide');  
		    document.querySelectorAll('.bottom-nav-item').forEach(nav => nav.classList.remove('active'));
		    document.querySelectorAll('.bottom-nav-item')[0].classList.add('active');
		    
		    // Show back button
		    setTimeout(() => {
		        const backBtn = document.getElementById('headerBackBtn');
		        if (backBtn) {
		            backBtn.style.display = 'flex';
		        }
		    }, 100);
		}
		});
		
		return item;
		}
		
function toggleSelectMode() {
    homeSelectMode = !homeSelectMode;
    selectedGuides.clear();
    
    const actionsBar = document.getElementById('homeActionsBar');
    const guidesList = document.getElementById('homeGuidesList');
    const selectMenuBtn = document.getElementById('homeSelectMenuBtn');
    
    if (homeSelectMode) {
    // Entering select mode
    if (selectMenuBtn) {
        selectMenuBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>Cancel`;
    }
    if (actionsBar) {
        actionsBar.classList.add('show');
    }
    
    // Add select mode to all guide items (both regular and folder guides)
    if (guidesList) {
        const items = guidesList.querySelectorAll('.home-guide-item, .home-folder-guide-item');
        const checkboxes = guidesList.querySelectorAll('.home-guide-checkbox, .home-folder-guide-checkbox');
        
        console.log('Found items:', items.length);
        console.log('Found checkboxes:', checkboxes.length);
        
        items.forEach((item, index) => {
            console.log(`Item ${index} classes before:`, item.className);  // ← ADD THIS
            item.classList.add('select-mode');
            console.log(`Item ${index} classes after:`, item.className);   // ← ADD THIS
        });
        
        checkboxes.forEach((cb, index) => {
            console.log(`Checkbox ${index} classes:`, cb.className);  // ← ADD THIS
            cb.classList.add('show');
        });
    }
    } else {
        // Exiting select mode
        if (selectMenuBtn) {
            selectMenuBtn.innerHTML = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 11l3 3L22 4"></path><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path></svg>Select`;
        }
        if (actionsBar) {
            actionsBar.classList.remove('show');
        }
        
        // Remove select mode from all guide items
        if (guidesList) {
            const items = guidesList.querySelectorAll('.home-guide-item, .home-folder-guide-item');
            const checkboxes = guidesList.querySelectorAll('.home-guide-checkbox, .home-folder-guide-checkbox');
            
            items.forEach(item => item.classList.remove('select-mode'));
            checkboxes.forEach(cb => {
                cb.classList.remove('show', 'checked');
            });
        }
    }
}

function toggleGuideSelection(guideId, checkbox) {
    if (selectedGuides.has(guideId)) {
        selectedGuides.delete(guideId);
        checkbox.classList.remove('checked');
    } else {
        selectedGuides.add(guideId);
        checkbox.classList.add('checked');
    }
}


// Reuse these same handlers for drawer items
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.guideId || this.dataset.catIndex);

    // Create and insert a placeholder element
    placeholder = document.createElement('div');
    placeholder.className = 'guide-placeholder';
    placeholder.style.height = `${this.offsetHeight}px`;
    placeholder.style.border = '2px dashed #aaa';
    placeholder.style.borderRadius = '6px';
    placeholder.style.margin = '4px 0';
    this.parentNode.insertBefore(placeholder, this.nextSibling);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.guide-item').forEach(item => item.classList.remove('drag-over'));
    
    // Remove placeholder
    if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
    }
    placeholder = null;
    draggedElement = null;
}

function handleDragEnter(e) {
    e.preventDefault();
    if (!draggedElement || this === draggedElement) return;

    const parent = this.parentNode;
    const items = Array.from(parent.querySelectorAll('.guide-item'));
    const draggedIndex = items.indexOf(draggedElement);
    const targetIndex = items.indexOf(this);

    // Move placeholder visually
    if (draggedIndex < targetIndex) {
        parent.insertBefore(placeholder, this.nextSibling);
    } else {
        parent.insertBefore(placeholder, this);
    }
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.stopPropagation();
    if (!placeholder || !draggedElement || !currentUser) return false;

    const parent = placeholder.parentNode;
    parent.insertBefore(draggedElement, placeholder);
    placeholder.remove();

    // Save new order to Firebase
    const newOrder = Array.from(parent.querySelectorAll('.guide-item'))
        .map(item => item.dataset.guideId);
    set(ref(database, `users/${currentUser.uid}/guideOrder`), newOrder).then(() => {
        console.log('Guide order saved');
    });

    draggedElement.classList.remove('dragging');
    draggedElement = null;
    placeholder = null;

    return false;
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}


function saveAndExitEdit() {
    editMode = false;
    document.body.classList.remove('edit-mode-active');
    
    // Hide save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.style.display = 'none';
    }
    
    renderHeader();
    renderTabs();
    renderContent();
}
		
function showEmojiPicker(target, callback) {
    const existingInput = document.querySelector('.emoji-input-field');
    if (existingInput) {
        existingInput.remove();
        return;
    }
    
    const inputWrapper = document.createElement('div');
    inputWrapper.style.position = 'fixed';
    inputWrapper.style.top = '50%';
    inputWrapper.style.left = '50%';
    inputWrapper.style.transform = 'translate(-50%, -50%)';
    inputWrapper.style.background = 'white';
    inputWrapper.style.padding = '20px';
    inputWrapper.style.borderRadius = '12px';
    inputWrapper.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
    inputWrapper.style.zIndex = '10000';
    inputWrapper.style.maxWidth = '500px';
    inputWrapper.style.maxHeight = '80vh';
    inputWrapper.style.overflowY = 'auto';
    inputWrapper.className = 'emoji-input-field';
    
    // Prevent clicks inside from bubbling
    inputWrapper.addEventListener('click', (e) => e.stopPropagation());
    
    // Tabs
    const tabContainer = document.createElement('div');
    tabContainer.style.display = 'flex';
    tabContainer.style.gap = '10px';
    tabContainer.style.marginBottom = '15px';
    tabContainer.style.borderBottom = '2px solid #e0e0e0';
    
    const emojiTab = document.createElement('button');
    emojiTab.textContent = '😀 Emoji';
    emojiTab.style.flex = '1';
    emojiTab.style.padding = '10px';
    emojiTab.style.border = 'none';
    emojiTab.style.background = 'none';
    emojiTab.style.cursor = 'pointer';
    emojiTab.style.borderBottom = '3px solid #3498db';
    emojiTab.style.fontWeight = 'bold';
    emojiTab.style.color = '#3498db';
    
    const iconTab = document.createElement('button');
    iconTab.textContent = '🎨 Icons';
    iconTab.style.flex = '1';
    iconTab.style.padding = '10px';
    iconTab.style.border = 'none';
    iconTab.style.background = 'none';
    iconTab.style.cursor = 'pointer';
    iconTab.style.color = '#666';
    
    tabContainer.appendChild(emojiTab);
    tabContainer.appendChild(iconTab);
    inputWrapper.appendChild(tabContainer);
    
    // Content containers
    const emojiContent = document.createElement('div');
    const iconContent = document.createElement('div');
    iconContent.style.display = 'none';
    
    // Emoji input section
    const label = document.createElement('div');
    label.textContent = 'Paste or type emoji:';
    label.style.marginBottom = '10px';
    label.style.fontSize = '14px';
    label.style.color = '#2c3e50';
    emojiContent.appendChild(label);
    
    const input = document.createElement('input');
    input.type = 'text';
    input.maxLength = 20;
    input.style.fontSize = '32px';
    input.style.width = '100%';
    input.style.textAlign = 'center';
    input.style.border = '2px solid #3498db';
    input.style.borderRadius = '8px';
    input.style.padding = '10px';
    input.style.outline = 'none';
    input.placeholder = '✅';
    
    input.addEventListener('input', (e) => {
        const value = e.target.value;
        const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(\u200D(\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*(\p{Emoji_Modifier})?/gu;
        const matches = value.match(emojiRegex);
        
        if (matches && matches.length > 0) {
            e.target.value = matches[0];
        } else if (value.length > 0) {
            e.target.value = '';
        }
    });
    
    emojiContent.appendChild(input);
    
    // Icon grid
    const iconGrid = document.createElement('div');
    iconGrid.style.display = 'grid';
    iconGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(60px, 1fr))';
    iconGrid.style.gap = '10px';
    iconGrid.style.maxHeight = '300px';
    iconGrid.style.overflowY = 'auto';
    
    svgIcons.forEach(icon => {
        const iconBtn = document.createElement('button');
        iconBtn.style.width = '60px';
        iconBtn.style.height = '60px';
        iconBtn.style.borderRadius = '8px';
        iconBtn.style.border = '2px solid transparent';
        iconBtn.style.cursor = 'pointer';
        iconBtn.style.backgroundColor = icon.bg;
        iconBtn.style.display = 'flex';
        iconBtn.style.alignItems = 'center';
        iconBtn.style.justifyContent = 'center';
        iconBtn.style.transition = 'all 0.2s';
        iconBtn.title = icon.name;
        
        iconBtn.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="${icon.path}"/></svg>`;
        
        iconBtn.addEventListener('mouseover', () => {
            iconBtn.style.transform = 'scale(1.1)';
            iconBtn.style.borderColor = '#3498db';
        });
        iconBtn.addEventListener('mouseout', () => {
            iconBtn.style.transform = 'scale(1)';
            iconBtn.style.borderColor = 'transparent';
        });
        
        iconBtn.addEventListener('click', () => {
            // Store as SVG data
            callback(`svg:${JSON.stringify({name: icon.name, bg: icon.bg, path: icon.path})}`);
            inputWrapper.remove();
        });
        
        iconGrid.appendChild(iconBtn);
    });
    
    iconContent.appendChild(iconGrid);
    
    inputWrapper.appendChild(emojiContent);
    inputWrapper.appendChild(iconContent);
    
    // Tab switching
    emojiTab.addEventListener('click', () => {
        emojiTab.style.borderBottom = '3px solid #3498db';
        emojiTab.style.fontWeight = 'bold';
        emojiTab.style.color = '#3498db';
        iconTab.style.borderBottom = 'none';
        iconTab.style.fontWeight = 'normal';
        iconTab.style.color = '#666';
        emojiContent.style.display = 'block';
        iconContent.style.display = 'none';
    });
    
    iconTab.addEventListener('click', () => {
        iconTab.style.borderBottom = '3px solid #3498db';
        iconTab.style.fontWeight = 'bold';
        iconTab.style.color = '#3498db';
        emojiTab.style.borderBottom = 'none';
        emojiTab.style.fontWeight = 'normal';
        emojiTab.style.color = '#666';
        iconContent.style.display = 'block';
        emojiContent.style.display = 'none';
    });
    
    // Buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '15px';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.gap = '10px';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Confirm';
    confirmBtn.style.flex = '1';
    confirmBtn.style.padding = '8px';
    confirmBtn.style.background = '#27ae60';
    confirmBtn.style.color = 'white';
    confirmBtn.style.border = 'none';
    confirmBtn.style.borderRadius = '6px';
    confirmBtn.style.cursor = 'pointer';
    confirmBtn.addEventListener('click', () => {
        if (input.value) {
            callback(input.value);
        }
        inputWrapper.remove();
    });
    buttonContainer.appendChild(confirmBtn);
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.flex = '1';
    cancelBtn.style.padding = '8px';
    cancelBtn.style.background = '#95a5a6';
    cancelBtn.style.color = 'white';
    cancelBtn.style.border = 'none';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.addEventListener('click', () => inputWrapper.remove());
    buttonContainer.appendChild(cancelBtn);
    
    emojiContent.appendChild(buttonContainer);
    
    document.body.appendChild(inputWrapper);
    input.focus();
    
    setTimeout(() => {
        document.addEventListener('click', function closeInput(e) {
            if (!inputWrapper.contains(e.target)) {
                inputWrapper.remove();
                document.removeEventListener('click', closeInput);
            }
        });
    }, 100);
}

	
function saveCategories() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/categories`), categories);
}
// Save checked items to Firebase
function saveCheckedItems() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/checkedItems`), checkedItems);
}

// Save auto-refresh settings to Firebase
function saveAutoRefreshSettings() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/autoRefreshEnabled`), autoRefreshEnabled);
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/autoRefreshTime`), autoRefreshTime);
}

function saveSkillReminders() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/skillReminders`), skillReminders);
}
	
function checkAndAutoRefresh(lastRefreshDate) {
    if (!autoRefreshEnabled || !currentUser) return;
    
    const now = new Date();
    const today = now.toDateString();
    
    // If we already refreshed today, don't do it again
    if (lastRefreshDate === today) return;
    
    // Parse the refresh time (format: "HH:MM")
    const [hours, minutes] = autoRefreshTime.split(':').map(Number);
    const refreshTime = new Date();
    refreshTime.setHours(hours, minutes, 0, 0);
    
    // If current time is past the refresh time and we haven't refreshed today
    if (now >= refreshTime && lastRefreshDate !== today) {
        // Clear all checked items
        checkedItems = {};
        saveCheckedItems();
        
        // Mark that we refreshed today
        set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`), today);
        
        // Re-render to show unchecked items
        renderContent();
    }
}

async function clearAllChecks() {
    if (await customConfirm('This will clear all checkmarks. This cannot be undone.', 'Clear All Checks')) {
        checkedItems = {};
        saveCheckedItems();
        const today = new Date().toDateString();
        set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`), today);
        renderContent();
    }
}

async function toggleAutoRefresh() {
    const enabled = await customConfirm(
    autoRefreshEnabled 
        ? 'This will disable the automatic daily refresh.' 
        : `This will clear all checkmarks at ${autoRefreshTime} each day.`,
    autoRefreshEnabled ? 'Disable Auto-Refresh' : 'Enable Auto-Refresh'
);

if (enabled) {
    if (!autoRefreshEnabled) {
        const time = await customPrompt('Enter time in 24-hour format', autoRefreshTime, 'Set Refresh Time');
            if (time && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
                autoRefreshTime = time;
                autoRefreshEnabled = true;
            } else {
                await customAlert('Please use HH:MM format (e.g., 09:00 or 23:30)', 'Invalid Time Format');
                return;
            }
        } else {
            autoRefreshEnabled = false;
        }
        saveAutoRefreshSettings();
        renderHeader(); // Update menu display
    }
}

function renderTabs() { 
    const navTabs = document.getElementById('navTabs'); 
    navTabs.innerHTML = ''; 
    
    categories.forEach((cat, i) => { 
        const tabWrapper = document.createElement('div');
        tabWrapper.className = 'tab-wrapper';
        
        const tab = document.createElement('button'); 
        tab.className = 'nav-tab' + (i === activeTabIndex ? ' active' : ''); 

        // Make tabs draggable when NOT in edit mode
        if (!editMode) {
            tab.draggable = true;
            tab.dataset.catIndex = i;
            tab.style.cursor = 'grab';
        }
        
        // Make tab editable in edit mode
        if (editMode) {
            const hasTabIcon = cat.icon && cat.icon !== "​";
            let tabIconToShow;
            if (hasTabIcon) {
                if (cat.icon.startsWith('svg:')) {
                    const iconData = JSON.parse(cat.icon.substring(4));
                    tabIconToShow = `<span style="display: inline-flex; width: 20px; height: 20px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
                } else {
                    tabIconToShow = cat.icon;
                }
            } else {
                tabIconToShow = "+";
            }

            tab.innerHTML = `
                <span class="editable-icon" style="display: inline-block; position: relative;">
                    <span class="tab-icon" data-cat-index="${i}" style="opacity: ${hasTabIcon ? '1' : '0.3'};">${tabIconToShow}</span>
                    ${hasTabIcon ? `<span class="emoji-remove-btn" data-cat-index="${i}">×</span>` : ''}
                </span>
                <span class="tab-name editable" contenteditable="true">${cat.name}</span>
            `;
            
            // Add event listeners for edit mode
            const tabIcon = tab.querySelector('.tab-icon');
            if (tabIcon) {
                tabIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const catIndex = parseInt(tabIcon.dataset.catIndex);
                    editCategoryIcon(catIndex, tabIcon);
                });
            }
            
            const removeIconBtn = tab.querySelector('.emoji-remove-btn');
            if (removeIconBtn) {
                removeIconBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const catIndex = parseInt(e.target.dataset.catIndex);
                    categories[catIndex].icon = '';
                    saveCategories();
                    renderTabs();
                    renderContent();
                });
            }
            
            const nameSpan = tab.querySelector('.tab-name');
            if (nameSpan) {
                // Enable text selection for editing
                nameSpan.style.userSelect = 'text';
                nameSpan.style.webkitUserSelect = 'text';
                nameSpan.style.cursor = 'text';
                
                nameSpan.addEventListener('blur', (e) => {
                    categories[i].name = e.target.textContent.trim();
                    saveCategories();
                });
                nameSpan.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        e.target.blur();
                    }
                });
                nameSpan.addEventListener('click', (e) => {
                    e.stopPropagation();
                });
                nameSpan.addEventListener('focus', (e) => {
                    e.stopPropagation();
                });
            }
            
            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('editable') && !e.target.classList.contains('editable-icon')) {
                    switchTab(i);
                }
            });
            
        } else {
            // Need to render SVG icons properly
            let displayIcon = cat.icon;
            if (cat.icon && cat.icon.startsWith('svg:')) {
                const iconData = JSON.parse(cat.icon.substring(4));
                displayIcon = `<span style="display: inline-flex; width: 20px; height: 20px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
            }
            tab.innerHTML = `<span class="tab-icon-display">${displayIcon}</span> <span class="tab-name-display">${cat.name}</span>`;
            
            const nameSpan = tab.querySelector('.tab-name-display');
            
            // Use a timeout to distinguish single click from double click
            let clickTimer = null;
            let clickCount = 0;
            let isEditing = false;
            
            tab.addEventListener('click', function(e) {
                // Ignore clicks while editing
                if (isEditing) {
                    e.stopPropagation();
                    return;
                }
                
                // Ignore clicks if the name span is contenteditable
                if (nameSpan && nameSpan.contentEditable === 'true') {
                    e.stopPropagation();
                    return;
                }
                
                // Ignore clicks on the icon
                if (e.target.closest('.tab-icon-display')) {
                    return;
                }
                
                clickCount++;
                
                if (clickCount === 1) {
                    clickTimer = setTimeout(() => {
                        // Single click - switch tab
                        if (!isEditing) {
                            switchTab(i);
                        }
                        clickCount = 0;
                    }, 250);
                } else if (clickCount === 2) {
                    // Double click - edit
                    clearTimeout(clickTimer);
                    clickCount = 0;
                    e.stopPropagation();
                    e.preventDefault();
                    if (nameSpan) {
                        isEditing = true;
                        enableQuickEdit(nameSpan, i, null, null);
                        
                        // Monitor when editing ends
                        const observer = new MutationObserver(() => {
                            if (nameSpan.contentEditable === 'false') {
                                isEditing = false;
                                observer.disconnect();
                            }
                        });
                        observer.observe(nameSpan, { attributes: true, attributeFilter: ['contenteditable'] });
                        
                        // Backup: also check on blur
                        nameSpan.addEventListener('blur', function resetEditing() {
                            setTimeout(() => {
                                isEditing = false;
                            }, 100);
                            nameSpan.removeEventListener('blur', resetEditing);
                        }, { once: true });
                    }
                }
            });
        }
        
        tabWrapper.appendChild(tab);
        
        if (editMode) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-tab-btn';
            deleteBtn.textContent = '×';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCategory(i);
            });
            tabWrapper.appendChild(deleteBtn);
        }
        
        navTabs.appendChild(tabWrapper); 
    }); 
    
    if (editMode) {
        const addCategoryBtn = document.createElement('button');
        addCategoryBtn.className = 'nav-tab add-category-tab';
        addCategoryBtn.textContent = '+';
        addCategoryBtn.addEventListener('click', addCategory);
        navTabs.appendChild(addCategoryBtn);
    }
    
    // Preserve Done button state if in edit mode
    if (editMode) {
        setTimeout(() => {
            const saveBtn = document.getElementById('saveBtn');
            const menuBtn = document.getElementById('menuBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            if (menuBtn) menuBtn.style.display = 'none';
        }, 0);
    }
	
}
		
function toggleBulletStyle(catIndex, skillIndex) {
    const currentStyle = categories[catIndex].skills[skillIndex].bulletStyle || 'checkbox';
    const styles = ['checkbox', 'number', 'square', 'circle', 'none'];
    const currentIndex = styles.indexOf(currentStyle);
    const nextIndex = (currentIndex + 1) % styles.length;
    
    categories[catIndex].skills[skillIndex].bulletStyle = styles[nextIndex];
    saveCategories();
    renderContent();
}

function duplicateSkill(catIndex, skillIndex) {
    const originalSkill = categories[catIndex].skills[skillIndex];
    const duplicatedSkill = JSON.parse(JSON.stringify(originalSkill)); // Deep copy
    duplicatedSkill.title = duplicatedSkill.title + ' (Copy)';
    
    categories[catIndex].skills.splice(skillIndex + 1, 0, duplicatedSkill);
    saveCategories();
    renderContent();
}

function toggleSkillReminder(catIndex, skillIndex) {
    const key = `${catIndex}-${skillIndex}`;
    if (!skillReminders[key]) {
        skillReminders[key] = { enabled: true, items: {} };
    } else {
        skillReminders[key].enabled = !skillReminders[key].enabled;
    }
    saveSkillReminders();
    renderContent();
}

function showReminderPicker(catIndex, skillIndex, itemIndex) {
    const key = `${catIndex}-${skillIndex}`;
    const existingTime = skillReminders[key]?.items?.[itemIndex] || '09:00';
    
    const picker = document.createElement('div');
    picker.className = 'reminder-time-picker show';
    picker.innerHTML = `
        <h3>Set Reminder</h3>
        <input type="time" id="reminderTimeInput" value="${existingTime}">
        <div class="button-group">
            <button class="cancel-reminder">Cancel</button>
            <button class="save-reminder">Save</button>
        </div>
        ${skillReminders[key]?.items?.[itemIndex] ? '<button class="delete-reminder">Delete Reminder</button>' : ''}
    `;
    
    document.body.appendChild(picker);
    
    picker.querySelector('.cancel-reminder').addEventListener('click', () => {
        picker.remove();
    });
    
    picker.querySelector('.save-reminder').addEventListener('click', () => {
        const time = document.getElementById('reminderTimeInput').value;
        if (!skillReminders[key]) {
            skillReminders[key] = { enabled: true, items: {} };
        }
        skillReminders[key].items[itemIndex] = time;
        saveSkillReminders();
        renderContent();
        picker.remove();
    });
    
    const deleteBtn = picker.querySelector('.delete-reminder');
    if (deleteBtn) {
        deleteBtn.addEventListener('click', () => {
            if (skillReminders[key]?.items?.[itemIndex]) {
                delete skillReminders[key].items[itemIndex];
                saveSkillReminders();
                renderContent();
            }
            picker.remove();
        });
    }
}


function renderContent() { 
    const contentArea = document.getElementById('contentArea'); 
    contentArea.innerHTML = ''; 
    contentArea.className = 'content-area' + (editMode ? ' edit-mode' : ''); 
    
    categories.forEach((cat, catIndex) => { 
        const catDiv = document.createElement('div'); 
        catDiv.className = 'category' + (catIndex === activeTabIndex ? ' active' : '');
        
        const grid = document.createElement('div'); 
        grid.className = 'skill-grid' + (layoutMode === 'horizontal' ? ' horizontal' : ''); 
        
        cat.skills.forEach((skill, skillIndex) => { 
            const card = document.createElement('div'); 
            card.className = 'skill-card';
            // Set border color based on theme
            const isLight = isLightColor(themeColor);
            card.style.borderLeftColor = isLight ? 'var(--secondary-color)' : 'var(--primary-color)';
            card.dataset.catIndex = catIndex;
            card.dataset.skillIndex = skillIndex; 
            
            const titleDiv = document.createElement('div'); 
            titleDiv.className = 'skill-title';
            
            // Add double-click to edit (only when not in edit mode)
            if (!editMode) {
                titleDiv.addEventListener('dblclick', (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    // Find the text span (last child that's not an icon)
                    const spans = titleDiv.querySelectorAll('span');
                    const titleSpan = spans[spans.length - 1]; // Get last span (the text)
                    if (titleSpan && !titleSpan.classList.contains('editable-icon') && !titleSpan.classList.contains('icon')) {
                        enableQuickEdit(titleSpan, catIndex, skillIndex);
                    }
                });
            }
            titleDiv.style.display = 'flex';
            titleDiv.style.alignItems = 'center';
            
            const hasIcon = skill.icon && skill.icon !== "​";
            let iconToShow;
            if (hasIcon) {
                if (skill.icon.startsWith('svg:')) {
                    const iconData = JSON.parse(skill.icon.substring(4));
                    iconToShow = `<span style="display: inline-flex; width: 24px; height: 24px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
                } else {
                    iconToShow = skill.icon;
                }
            } else {
                iconToShow = editMode ? "+" : "​";
            }
            
            titleDiv.innerHTML += `
                <span class="editable-icon" style="display: inline-block; position: relative; margin-right: 8px;">
                    <span class="icon" data-cat-index="${catIndex}" data-skill-index="${skillIndex}" style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${hasIcon ? '1' : '0.3'};">${iconToShow}</span>
                    ${editMode && hasIcon ? `<span class="emoji-remove-btn" data-cat-index="${catIndex}" data-skill-index="${skillIndex}">×</span>` : ''}
                </span>
                <span class="${editMode ? 'editable' : ''}" contenteditable="${editMode}">${skill.title}</span>
            `;

            // Add event listeners after creating the titleDiv
            if (editMode) {
                const iconSpan = titleDiv.querySelector('.icon');
                if (iconSpan) {
                    iconSpan.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const catIdx = parseInt(e.target.dataset.catIndex);
                        const skillIdx = parseInt(e.target.dataset.skillIndex);
                        editSkillIcon(catIdx, skillIdx, e.target);
                    });
                    iconSpan.addEventListener('dblclick', (e) => {
                        e.stopPropagation();
                    });
                }
                
                const removeIconBtn = titleDiv.querySelector('.emoji-remove-btn');
                if (removeIconBtn) {
                    removeIconBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const catIdx = parseInt(e.target.dataset.catIndex);
                        const skillIdx = parseInt(e.target.dataset.skillIndex);
                        categories[catIdx].skills[skillIdx].icon = '​';
                        saveCategories();
                        renderContent();
                    });
                }
            }                                     
                          
            if (editMode) {
                const editableSpan = titleDiv.querySelector('.editable');
                if (editableSpan) {
                    editableSpan.addEventListener('blur', (e) => { 
                        categories[catIndex].skills[skillIndex].title = e.target.textContent.trim(); 
                        saveCategories();
                    }); 
                }
            }
            
            card.appendChild(titleDiv);
            
            // Add control buttons (available always, shown on double-tap or in edit mode)
            const controlsContainer = document.createElement('div');
            controlsContainer.className = 'skill-card-controls';
            
            // Bullet toggle button
            const bulletStyle = skill.bulletStyle || 'checkbox';
            const bulletIcons = {
                'checkbox': '☑',
                'number': '#',
                'square': '■',
                'circle': '●',
                'none': '—'
            };
            const toggleBtn = document.createElement('button');
            toggleBtn.className = 'skill-control-btn';
            toggleBtn.textContent = bulletIcons[bulletStyle];
            toggleBtn.title = 'Change bullet style';
            toggleBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleBulletStyle(catIndex, skillIndex);
            });
            
            // Duplicate button
            const duplicateBtn = document.createElement('button');
            duplicateBtn.className = 'skill-control-btn';
            duplicateBtn.innerHTML = '⧉';
            duplicateBtn.style.fontSize = '13px';
            duplicateBtn.title = 'Duplicate card';
           duplicateBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                duplicateSkill(catIndex, skillIndex);
                // Don't auto-hide - let user continue interacting
            });
            
            // Delete button
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'skill-control-btn delete-control';
            deleteBtn.innerHTML = '×';
            deleteBtn.title = 'Delete card';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteSkill(catIndex, skillIndex);
                // Don't need to hide - card is being deleted anyway
            });

			// Reminder toggle button
			const reminderKey = `${catIndex}-${skillIndex}`;
			const reminderEnabled = skillReminders[reminderKey]?.enabled || false;
			const reminderBtn = document.createElement('button');
			reminderBtn.className = `skill-control-btn reminder-toggle-btn ${reminderEnabled ? 'active' : ''}`;
			reminderBtn.innerHTML = '🔔';
			reminderBtn.title = 'Toggle Reminders';
			reminderBtn.addEventListener('click', (e) => {
			    e.stopPropagation();
			    toggleSkillReminder(catIndex, skillIndex);
			});
			
            // Add in order: bullet, duplicate, reminder, delete (left to right)
			controlsContainer.appendChild(deleteBtn);
			controlsContainer.appendChild(reminderBtn);
			controlsContainer.appendChild(duplicateBtn);
			controlsContainer.appendChild(toggleBtn);
            
            card.appendChild(controlsContainer);
            
            // Add a visible menu button when not in edit mode
            if (!editMode) {
                const menuBtn = document.createElement('button');
                menuBtn.className = 'skill-control-btn';
                menuBtn.innerHTML = '⋮';
                menuBtn.style.position = 'absolute';
                menuBtn.style.top = '8px';
                menuBtn.style.right = '8px';
                menuBtn.style.opacity = '0.3';
                menuBtn.style.fontSize = '24px';
                menuBtn.style.zIndex = '5';
                menuBtn.style.background = 'white';
                menuBtn.style.borderRadius = '4px';
                menuBtn.style.padding = '6px 10px';
                menuBtn.style.border = 'none';
                menuBtn.style.cursor = 'pointer';
                menuBtn.title = 'Card options';
                
                let hideTimeout;
                
                const startHideTimer = () => {
                    if (hideTimeout) clearTimeout(hideTimeout);
                    hideTimeout = setTimeout(() => {
                        controlsContainer.classList.remove('show');
                    }, 10000);
                };
                
                menuBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const isShowing = controlsContainer.classList.contains('show');
                    
                    // Hide all other open controls first
                    document.querySelectorAll('.skill-card-controls.show').forEach(c => {
                        if (c !== controlsContainer) c.classList.remove('show');
                    });
                    
                    controlsContainer.classList.toggle('show');
                    
                    // Start timer if showing
                    if (!isShowing) {
                        startHideTimer();
                    } else {
                        if (hideTimeout) clearTimeout(hideTimeout);
                    }
                });
                
                // Reset timeout on any interaction with the controls
				[toggleBtn, duplicateBtn, reminderBtn, deleteBtn].forEach(btn => {
				    btn.addEventListener('click', () => {
				        startHideTimer();
				    });
				});
                
                card.appendChild(menuBtn);
                
                // Hide controls when clicking outside
                document.addEventListener('click', (e) => {
                    if (!card.contains(e.target) && controlsContainer.classList.contains('show')) {
                        controlsContainer.classList.remove('show');
                    }
                });
            }
            
            skill.items.forEach((item, itemIndex) => { 
                const itemId = `${catIndex}-${skillIndex}-${itemIndex}`; 
                const checkItem = document.createElement('div'); 
                checkItem.className = 'checklist-item' + (checkedItems[itemId] ? ' checked' : '');
                checkItem.dataset.catIndex = catIndex;
                checkItem.dataset.skillIndex = skillIndex;
                checkItem.dataset.itemIndex = itemIndex;
                
                // Make draggable when NOT in edit mode
                if (!editMode) {
                    checkItem.draggable = true;
                    checkItem.style.cursor = 'grab';
                }
                
                // Render appropriate bullet based on style
                const bulletStyle = skill.bulletStyle || 'checkbox';
                let bulletElement;
                
                if (bulletStyle === 'checkbox') {
                    bulletElement = document.createElement('div');
                    bulletElement.className = 'checkbox';
                } else if (bulletStyle === 'number') {
                    bulletElement = document.createElement('div');
                    bulletElement.className = 'bullet-number';
                    bulletElement.textContent = itemIndex + 1;
                } else if (bulletStyle === 'square') {
                    bulletElement = document.createElement('div');
                    bulletElement.className = 'bullet-square';
                    bulletElement.textContent = '■';
                } else if (bulletStyle === 'circle') {
                    bulletElement = document.createElement('div');
                    bulletElement.className = 'bullet-circle';
                    bulletElement.textContent = '●';
                } else if (bulletStyle === 'none') {
                    bulletElement = document.createElement('div');
                    bulletElement.className = 'bullet-none';
                }
                
                checkItem.appendChild(bulletElement);
                
                // Only checkbox/bullet triggers the check, not the whole item
                if (!editMode) {
                    bulletElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleCheck(itemId);
                    });
                    bulletElement.style.cursor = 'pointer';
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = 'checklist-text' + (editMode ? ' editable' : '');
                textDiv.contentEditable = editMode;
                textDiv.textContent = item;

				// Add reminder icon if reminders are enabled for this skill
				const reminderKey = `${catIndex}-${skillIndex}`;
				if (skillReminders[reminderKey]?.enabled) {
				    const hasReminder = skillReminders[reminderKey]?.items?.[itemIndex];
				    const reminderIcon = document.createElement('span');
				    reminderIcon.className = `reminder-icon ${hasReminder ? 'has-reminder' : ''}`;
				    reminderIcon.innerHTML = '🔔';
				    reminderIcon.title = hasReminder ? `Reminder: ${hasReminder}` : 'Set reminder';
				    reminderIcon.dataset.catIndex = catIndex;
				    reminderIcon.dataset.skillIndex = skillIndex;
				    reminderIcon.dataset.itemIndex = itemIndex;
				    reminderIcon.addEventListener('click', (e) => {
				        e.stopPropagation();
				        showReminderPicker(catIndex, skillIndex, itemIndex);
				    });
				    textDiv.appendChild(reminderIcon);
				}
                checkItem.appendChild(textDiv);

				// Add click zone on right end to add new item below (only when NOT in edit mode)
                if (!editMode) {
                    const addZone = document.createElement('div');
                    addZone.style.position = 'absolute';
                    addZone.style.right = '0';
                    addZone.style.top = '0';
                    addZone.style.width = '50px';
                    addZone.style.height = '100%';
                    addZone.style.cursor = 'pointer';
                    addZone.style.display = 'flex';
                    addZone.style.alignItems = 'center';
                    addZone.style.justifyContent = 'center';
                    addZone.style.opacity = '0';
                    addZone.style.transition = 'opacity 0.2s';
                    addZone.innerHTML = '+';
                    addZone.style.fontSize = '20px';
                    addZone.style.color = 'var(--primary-color)';
                    
                    addZone.addEventListener('mouseenter', () => {
                        addZone.style.opacity = '0.5';
                    });
                    addZone.addEventListener('mouseleave', () => {
                        addZone.style.opacity = '0';
                    });
                    
                    addZone.addEventListener('click', (e) => {
                        e.stopPropagation();
                        categories[catIndex].skills[skillIndex].items.splice(itemIndex + 1, 0, "New item");
                        saveCategories();
                        renderContent();
                    });
                    
                    checkItem.appendChild(addZone);
                    checkItem.style.position = 'relative';
                }
				
                // Add double-click to edit (only when not in edit mode)
                if (!editMode) {
                    textDiv.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const parent = this.closest('.checklist-item');
                        if (parent && parent.onclick) {
                            parent.onclick = null; // Temporarily disable click
                        }
                        enableQuickEdit(this, catIndex, skillIndex, itemIndex);
                    });
                }
                
                if (editMode) {
                    const deleteItemBtn = document.createElement('button');
                    deleteItemBtn.className = 'delete-btn';
                    deleteItemBtn.textContent = '×';
                    deleteItemBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteItem(catIndex, skillIndex, itemIndex);
                    });
                    checkItem.appendChild(deleteItemBtn);
                    
                    textDiv.addEventListener('blur', (e) => { 
                        categories[catIndex].skills[skillIndex].items[itemIndex] = e.target.textContent.trim(); 
                        saveCategories();
                    }); 
                }
                
                card.appendChild(checkItem); 
            }); 
            
            const addItemBtn = document.createElement('button'); 
            addItemBtn.className = 'add-item-btn'; 
            addItemBtn.textContent = '+ Add Item'; 
            addItemBtn.addEventListener('click', () => addItem(catIndex, skillIndex));
            card.appendChild(addItemBtn); 
            
            // Add click zone at center bottom to add card below (only when NOT in edit mode)
            if (!editMode) {
                const addCardZone = document.createElement('div');
                addCardZone.style.position = 'absolute';
                addCardZone.style.bottom = '0';
                addCardZone.style.left = '50%';
                addCardZone.style.transform = 'translateX(-50%)';
                addCardZone.style.width = '80px';
                addCardZone.style.height = '40px';
                addCardZone.style.cursor = 'pointer';
                addCardZone.style.display = 'flex';
                addCardZone.style.alignItems = 'center';
                addCardZone.style.justifyContent = 'center';
                addCardZone.style.opacity = '0';
                addCardZone.style.transition = 'opacity 0.2s';
                addCardZone.style.zIndex = '5';
                addCardZone.innerHTML = '+';
                addCardZone.style.fontSize = '28px';
                addCardZone.style.color = 'var(--primary-color)';
                addCardZone.style.fontWeight = 'bold';
                
                // Touch/hover events
                addCardZone.addEventListener('mouseenter', () => {
                    addCardZone.style.opacity = '0.7';
                    addCardZone.style.background = 'rgba(255,255,255,0.95)';
                    addCardZone.style.borderRadius = '12px 12px 0 0';
                    addCardZone.style.boxShadow = '0 -2px 8px rgba(0,0,0,0.1)';
                });
                addCardZone.addEventListener('mouseleave', () => {
                    addCardZone.style.opacity = '0';
                    addCardZone.style.background = '';
                    addCardZone.style.boxShadow = '';
                });
                
                // Touch support for mobile
                addCardZone.addEventListener('touchstart', (e) => {
                    e.stopPropagation();
                    addCardZone.style.opacity = '0.7';
                    addCardZone.style.background = 'rgba(255,255,255,0.95)';
                    addCardZone.style.borderRadius = '12px 12px 0 0';
                    addCardZone.style.boxShadow = '0 -2px 8px rgba(0,0,0,0.1)';
                });
                
                addCardZone.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const newSkill = {
                        title: "New Skill",
                        icon: "✨",
                        items: ["New item - click to edit"]
                    };
                    categories[catIndex].skills.splice(skillIndex + 1, 0, newSkill);
                    saveCategories();
                    renderContent();
                });
                
                card.appendChild(addCardZone);
                card.style.position = 'relative'; // Ensure card has position for absolute child
            }
            
                      
            grid.appendChild(card); 
        }); 
        
        catDiv.appendChild(grid); 
        
        const addSkillBtn = document.createElement('button'); 
        addSkillBtn.className = 'add-skill-btn'; 
        addSkillBtn.textContent = '+ Add New Card'; 
        addSkillBtn.addEventListener('click', () => addSkill(catIndex));
        catDiv.appendChild(addSkillBtn); 
        
        contentArea.appendChild(catDiv); 
    }); 
    
    // Preserve Done button state if in edit mode
    if (editMode) {
        setTimeout(() => {
            const saveBtn = document.getElementById('saveBtn');
            const menuBtn = document.getElementById('menuBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            if (menuBtn) menuBtn.style.display = 'none';
        }, 0);
    }
	// Reapply wallpaper after rendering content
	    setTimeout(() => applyWallpaper(), 50);
}
	
function switchTab(index) { 
    activeTabIndex = index; 
    renderTabs();
    const cats = document.querySelectorAll('.category'); 
    cats.forEach((cat, i) => cat.classList.toggle('active', i === activeTabIndex)); 
    
    // Scroll the active tab to center
    setTimeout(() => {
        const activeTab = document.querySelector('.nav-tab.active');
        const navTabs = document.getElementById('navTabs');
        
        if (activeTab && navTabs) {
            const tabRect = activeTab.getBoundingClientRect();
            const navRect = navTabs.getBoundingClientRect();
            
            // Calculate the scroll position to center the tab
            const scrollLeft = activeTab.offsetLeft - (navRect.width / 2) + (tabRect.width / 2);
            
            // Smooth scroll to center
            navTabs.scrollTo({
                left: scrollLeft,
                behavior: 'smooth'
            });
        }
    }, 50); // Small delay to ensure tab is rendered
}

function toggleCheck(itemId) { 
    if (editMode) return; 
    
    // Store expanded state before re-render
    const expandedCards = [];
    document.querySelectorAll('.skill-card.expanded').forEach(card => {
        expandedCards.push({
            catIndex: card.dataset.catIndex,
            skillIndex: card.dataset.skillIndex
        });
    });
    
    checkedItems[itemId] = !checkedItems[itemId]; 
    saveCheckedItems();
    renderContent(); 
    
    // Restore expanded state after re-render
    expandedCards.forEach(({catIndex, skillIndex}) => {
        const card = document.querySelector(`.skill-card[data-cat-index="${catIndex}"][data-skill-index="${skillIndex}"]`);
        if (card) card.classList.add('expanded');
    });
}

function toggleEditMode() { 
    const menu = document.getElementById('dropdownMenu');
    if (menu) menu.classList.remove('show'); 
    
    editMode = !editMode; 
    
    // Toggle class on body to hide/show floating button
    if (editMode) {
        document.body.classList.add('edit-mode-active');
    } else {
        document.body.classList.remove('edit-mode-active');
    }
    
    // Hide/show floating layout button
    const floatingBtn = document.getElementById('layoutBtn');
    if (floatingBtn) {
        floatingBtn.style.display = editMode ? 'none' : 'flex';
    }
    
    renderHeader();
    renderTabs();
    renderContent();
    
    // Toggle between Done button and 3-dots menu
    const saveBtn = document.getElementById('saveBtn');
    const menuBtn = document.getElementById('menuBtn');
    if (saveBtn && menuBtn) {
        if (editMode) {
            saveBtn.style.display = 'block';
            menuBtn.style.display = 'none';
        } else {
            saveBtn.style.display = 'none';
            menuBtn.style.display = 'block';
        }
    }
}

function enableQuickEdit(element, catIndex, skillIndex, itemIndex = null) {
    if (editMode) return;
    
    const originalText = element.textContent.trim();
    const parentItem = element.closest('.checklist-item');
    
    // Prevent checkbox toggle during editing
    if (parentItem) {
        parentItem.style.pointerEvents = 'none';
    }
    
    element.contentEditable = true;
    element.style.background = 'white';
    element.style.outline = '2px solid var(--primary-color)';
    element.style.borderRadius = '4px';
    element.style.padding = '4px 8px';
    element.style.userSelect = 'text';
    element.style.webkitUserSelect = 'text';
    
    // Focus and select all text
    setTimeout(() => {
        element.focus();
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }, 10);
    
    function saveEdit() {
        const newText = element.textContent.trim();
        element.contentEditable = false;
        element.style.background = '';
        element.style.outline = '';
        element.style.padding = '';
        element.style.userSelect = '';
        element.style.webkitUserSelect = '';
        
        if (parentItem) {
            parentItem.style.pointerEvents = '';
        }
        
        if (newText && newText !== originalText) {
            if (itemIndex !== null) {
                categories[catIndex].skills[skillIndex].items[itemIndex] = newText;
            } else if (skillIndex !== null) {
                categories[catIndex].skills[skillIndex].title = newText;
            } else {
                categories[catIndex].name = newText;
            }
            saveCategories();
            setTimeout(() => {
                renderTabs();
                renderContent();
            }, 0);
        } else if (!newText) {
            element.textContent = originalText;
        }
        
        element.removeEventListener('blur', saveEdit);
        element.removeEventListener('keydown', keyHandler);
    }
    
    const keyHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalText;
            element.blur();
        }
    };
    
    element.addEventListener('blur', saveEdit);
    element.addEventListener('keydown', keyHandler);
}

function enableQuickEditHeader(element, type) {
    if (editMode) return;
    
    const originalText = element.textContent.trim();
    
    element.contentEditable = true;
    element.style.outline = '2px solid white';
    element.style.borderRadius = '4px';
    element.style.padding = '4px 8px';
    element.style.background = 'rgba(255, 255, 255, 0.2)';
    
    setTimeout(() => {
        element.focus();
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }, 10);
    
    function saveEdit() {
        const newText = element.textContent.trim();
        element.contentEditable = false;
        element.style.outline = '';
        element.style.padding = '';
        element.style.background = '';
        
        if (newText && newText !== originalText) {
            if (type === 'title') {
                appTitle = newText;
            } else {
                appSubtitle = newText;
            }
            saveHeader();
        } else if (!newText) {
            element.textContent = originalText;
        }
        
        element.removeEventListener('blur', saveEdit);
        element.removeEventListener('keydown', keyHandler);
    }
    
    const keyHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalText;
            element.blur();
        }
    };
    
    element.addEventListener('blur', saveEdit);
    element.addEventListener('keydown', keyHandler);
}

function editAppIcon(el) {
    showEmojiPicker(el, (emoji) => {
        appIcon = emoji;
        saveHeader();
    });
}

function addSkill(catIndex) { 
    categories[catIndex].skills.push({ 
        title: "New Skill", 
        icon: "✨", 
        items: ["New item - click to edit"] 
    }); 
    saveCategories();
    renderContent();
    
}

function editSkillIcon(catIndex, skillIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].skills[skillIndex].icon = emoji;
        saveCategories();
        renderContent();
    });
}

async function deleteSkill(catIndex, skillIndex) { 
    if (await customConfirm('Are you sure you want to delete this card?')) { 
        categories[catIndex].skills.splice(skillIndex, 1); 
        saveCategories();
        renderContent();
        
    } 
}

async function deleteItem(catIndex, skillIndex, itemIndex) {
    if (await customConfirm('Are you sure you want to delete this item?')) {
        categories[catIndex].skills[skillIndex].items.splice(itemIndex, 1); 
        saveCategories();
        renderContent();
        
    }
}

function addItem(catIndex, skillIndex) { 
    categories[catIndex].skills[skillIndex].items.push("New item"); 
    saveCategories();
    renderContent(); 
}

function addCategory() {
    categories.push({
        name: "New Category",
        icon: "📌",
        skills: [
            {
                title: "New Skill",
                icon: "✨",
                items: ["New item - click to edit"]
            }
        ]
    });
    activeTabIndex = categories.length - 1;
    saveCategories();
    renderTabs();
    renderContent();
}

function editCategoryIcon(catIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].icon = emoji;
        saveCategories();
        renderTabs();
        renderContent();
    });
}
	
function toggleLayout() {
    if (!currentUser) return;
    if (layoutMode === 'vertical') {
        layoutMode = 'horizontal';
    } else {
        layoutMode = 'vertical';
    }
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/layoutMode`), layoutMode);
    renderContent();
    updateLayoutButton();
    
}

function updateLayoutButton() {
    const btn = document.getElementById('layoutBtn');
    if (btn) {
        if (layoutMode === 'vertical') {
            btn.innerHTML = '<div style="display: flex; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to horizontal scrolling';
        } else {
            btn.innerHTML = '<div style="display: flex; flex-direction: column; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to vertical grid';
        }
        btn.style.opacity = '0.2';
    }
}

async function deleteCategory(catIndex) {
    if (await customConfirm('Are you sure you want to delete this category?', 'Delete Category')) {
        categories.splice(catIndex, 1);
        if (activeTabIndex >= categories.length) {
            activeTabIndex = Math.max(0, categories.length - 1);
        }
        saveCategories();
        renderTabs();
        renderContent();
    }
}

	// Close menus when clicking outside
	document.addEventListener('click', (e) => {
	    const menu = document.getElementById('dropdownMenu');
	    const colorMenu = document.getElementById('colorPickerMenu');
	    const floatingBtn = document.getElementById('layoutBtn');
	    
	    // Don't close dropdown if clicking inside color picker
	    if (colorMenu && colorMenu.contains(e.target)) {
	        return; // Keep everything open when interacting with color picker
	    }

	// Close checkbox menu if clicking outside
		const checkboxMenu = document.getElementById('checkboxMenu');
		const checkboxOptionsBtn = document.getElementById('checkboxOptionsBtn');
		if (checkboxMenu && !checkboxMenu.contains(e.target) && !checkboxOptionsBtn?.contains(e.target)) {
		    checkboxMenu.classList.remove('show');
		}
    
    // Close dropdown menu if clicking outside
	if (menu && !menu.contains(e.target)) {
	    menu.classList.remove('show');
	    if (colorMenu) colorMenu.classList.remove('show');
	    // Only show floating button if drawer is also closed
	    const guideMenu = document.getElementById('guideDropdown');
	    if (floatingBtn && guideMenu && !guideMenu.classList.contains('show')) {  
	        floatingBtn.style.display = 'flex';
	    }
	}
    
    const guideMenu = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    
    // Don't close drawer if clicking inside it or on the hamburger button
    if (guideMenu && !guideMenu.contains(e.target) && !e.target.classList.contains('guide-menu-btn')) {
        if (guideMenu.classList.contains('show')) {
            closeDrawer();
        }
    }
	// Close logout menu if clicking outside
    const logoutMenu = document.getElementById('logoutMenu');
    if (logoutMenu && !logoutMenu.contains(e.target) && !e.target.closest('#logoutBtn')) {
        logoutMenu.classList.remove('show');
    }
});

// Check for auto-refresh when page becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && currentUser) {
        get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`)).then((snapshot) => {
            checkAndAutoRefresh(snapshot.val());
        });
    }
});

// Also check every hour while page is open
setInterval(() => {
    if (currentUser) {
        get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`)).then((snapshot) => {
            checkAndAutoRefresh(snapshot.val());
        });
    }
}, 60 * 60 * 1000);

// Wait for DOM to load before attaching login screen listeners
window.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('loginBtn');
    const googleBtn = document.getElementById('googleBtn');
    const signupBtn = document.getElementById('signupBtn');
    const loginPassword = document.getElementById('loginPassword');
    const layoutBtn = document.getElementById('layoutBtn');
    
    // NEW: Sign-up screen listeners
    const signupSubmitBtn = document.getElementById('signupSubmitBtn');
    const googleSignupBtn = document.getElementById('googleSignupBtn');
    const backToLoginBtn = document.getElementById('backToLoginBtn');
    const signupPassword = document.getElementById('signupPassword');
    const signupPasswordConfirm = document.getElementById('signupPasswordConfirm');
    
    if (loginBtn) {
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            login(email, password);
        });
    }
    
    if (googleBtn) {
        googleBtn.addEventListener('click', () => {
            loginWithGoogle();
        });
    }
    
    if (signupBtn) {
        signupBtn.addEventListener('click', () => {
            showSignup();
        });
    }
    
    // NEW: Sign-up button handlers
    if (signupSubmitBtn) {
        signupSubmitBtn.addEventListener('click', processSignup);
    }
    
    if (googleSignupBtn) {
        googleSignupBtn.addEventListener('click', loginWithGoogle);
    }
    
    if (backToLoginBtn) {
        backToLoginBtn.addEventListener('click', backToLogin);
    }
    
    if (loginPassword) {
        loginPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                login(email, password);
            }
        });
    }
    
    // NEW: Enter key support for sign-up
    if (signupPasswordConfirm) {
        signupPasswordConfirm.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processSignup();
            }
        });
    }
    
    if (layoutBtn) {
        layoutBtn.addEventListener('click', toggleLayout);
    }
});


// Bottom Navigation Handler
document.addEventListener('DOMContentLoaded', () => {
    const bottomNavItems = document.querySelectorAll('.bottom-nav-item');
    const homePage = document.getElementById('homePage');
    const templatesPage = document.getElementById('templatesPage');
    const profilePage = document.getElementById('profilePage');
    const settingsPage = document.getElementById('settingsPage');
    const mainContainer = document.querySelector('.container');
    
    // Home page event listeners
    const homeCreateFolderBtn = document.getElementById('homeCreateFolderBtn');
    if (homeCreateFolderBtn) {
        homeCreateFolderBtn.addEventListener('click', async () => {
            const folderName = await customPrompt('Enter folder name:', 'New Folder', 'Create Folder');
            if (folderName) {
                createNewFolder(folderName);
            }
        });
    }
    
    // Profile page event listeners
    const profileSwitchAccountBtn = document.getElementById('profileSwitchAccountBtn');
    const profileLogoutBtn = document.getElementById('profileLogoutBtn');
    const profileDeleteAccountBtn = document.getElementById('profileDeleteAccountBtn');
    
    if (profileSwitchAccountBtn) {
        profileSwitchAccountBtn.addEventListener('click', async () => {
            if (await customConfirm('Switch to a different account? You will be logged out.', 'Switch Account', 'Switch')) {
                logout();
            }
        });
    }
    
    if (profileLogoutBtn) {
        profileLogoutBtn.addEventListener('click', async () => {
            if (await customConfirm('Are you sure you want to log out?', 'Logout', 'Logout')) {
                logout();
            }
        });
    }
    
    if (profileDeleteAccountBtn) {
        profileDeleteAccountBtn.addEventListener('click', async () => {
            if (await customConfirm('WARNING: This will permanently delete your account and ALL your data. This cannot be undone!', 'Delete Account', 'Delete')) {
                const confirmation = await customPrompt('Type "DELETE" to confirm:', '', 'Confirm Deletion');
                if (confirmation === 'DELETE') {
                    deleteAccount();
                }
            }
        });
    }
    
    // Settings page event listeners
    const settingsBackupBtn = document.getElementById('settingsBackupBtn');
    if (settingsBackupBtn) {
        settingsBackupBtn.addEventListener('click', async () => {
            await backupContent();
        });
    }
    
    // Templates page event listeners
    const templateCustomBtn = document.getElementById('templateCustomBtn');
    if (templateCustomBtn) {
        templateCustomBtn.addEventListener('click', () => {
            createNewGuide();
        });
    }
    
    // Handle template preset clicks
    document.querySelectorAll('.template-preset-item').forEach(item => {
        item.addEventListener('click', () => {
            const template = item.dataset.template;
            createGuideFromTemplate(template);
        });
    });
    
    bottomNavItems.forEach((item) => {
        item.addEventListener('click', () => {
            const page = item.dataset.page;
            
            // Save current page to localStorage
            localStorage.setItem('currentPage', page);
            
            // Remove active class from all items
            bottomNavItems.forEach(nav => nav.classList.remove('active'));
            // Add active class to clicked item
            item.classList.add('active');
            
            // Hide all pages
            mainContainer.style.display = 'none';
            if (homePage) homePage.classList.remove('active');
            if (templatesPage) templatesPage.classList.remove('active');
            if (profilePage) profilePage.classList.remove('active');
            if (settingsPage) settingsPage.classList.remove('active');
            
            if (page === 'guides') {
                // Show home page
                if (homePage) {
                    homePage.classList.add('active');
                    populateHomePage();
                }
            } else if (page === 'templates') {
                // Show templates page
                if (templatesPage) {
                    templatesPage.classList.add('active');
                }
            } else if (page === 'profile') {
                // Show profile page
                if (profilePage) {
                    profilePage.classList.add('active');
                    const profileEmail = document.getElementById('profileEmail');
                    if (profileEmail && currentUser) {
                        profileEmail.textContent = currentUser.email;
                    }
                }
            } else if (page === 'settings') {
                // Show settings page
                if (settingsPage) {
                    settingsPage.classList.add('active');
                }
            }
        });
    });
});


document.getElementById('homeMoveBtn')?.addEventListener('click', async () => {
    if (selectedGuides.size === 0) {
        await customAlert('Please select at least one guide', 'No Selection');
        return;
    }
    
    const collectionsSnapshot = await get(ref(database, `users/${currentUser.uid}/collections`));
    const collections = collectionsSnapshot.val() || {};
    const collectionsArray = Object.keys(collections).map(id => ({
        id: id,
        name: collections[id].name
    }));
    
    if (collectionsArray.length === 0) {
        await customAlert('No collections available. Create a collection first.', 'No Collections');
        return;
    }
    
    // Show collection selection dialog
    const collectionOptions = collectionsArray.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
    const overlay = document.createElement('div');
    overlay.className = 'custom-dialog-overlay';
    
    const dialog = document.createElement('div');
    dialog.className = 'custom-dialog';
    dialog.innerHTML = `
        <div class="custom-dialog-title">Move to Collection</div>
        <div class="custom-dialog-message">Select a collection for ${selectedGuides.size} guide${selectedGuides.size > 1 ? 's' : ''}</div>
        <select id="collectionSelect" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; margin-bottom: 16px;">
            <option value="">Remove from collection</option>
            ${collectionOptions}
        </select>
        <div class="custom-dialog-buttons">
            <button class="custom-dialog-button" data-result="cancel">Cancel</button>
            <button class="custom-dialog-button primary" data-result="ok">Move</button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    setTimeout(() => overlay.classList.add('show'), 10);
    
    const closeDialog = async (result) => {
        if (result === 'ok') {
            const collectionId = document.getElementById('collectionSelect').value;
            
            for (const guideId of selectedGuides) {
                if (collectionId) {
                    await set(ref(database, `users/${currentUser.uid}/guides/${guideId}/collectionId`), collectionId);
                } else {
                    await remove(ref(database, `users/${currentUser.uid}/guides/${guideId}/collectionId`));
                }
            }
            
            toggleSelectMode();
            populateHomePage();
        }
        
        overlay.classList.remove('show');
        setTimeout(() => document.body.removeChild(overlay), 200);
    };
    
    dialog.querySelectorAll('.custom-dialog-button').forEach(btn => {
        btn.addEventListener('click', () => closeDialog(btn.dataset.result));
    });
});
	
// Delete selected guides
document.getElementById('homeDeleteBtn')?.addEventListener('click', async () => {
    if (selectedGuides.size === 0) {
        await customAlert('Please select at least one guide', 'No Selection');
        return;
    }
    
    if (await customConfirm(`Delete ${selectedGuides.size} guide${selectedGuides.size > 1 ? 's' : ''}? This cannot be undone.`, 'Delete Guides', 'Delete')) {
        const deletePromises = [];
        selectedGuides.forEach(guideId => {
            deletePromises.push(remove(ref(database, `users/${currentUser.uid}/guides/${guideId}`)));
        });
        
        await Promise.all(deletePromises);
        
        toggleSelectMode();
        populateHomePage();
        await customAlert('Guides deleted successfully!', 'Success');
    }
});	

async function backupContent() {
    if (!currentUser) return;
    
    try {
        // Get all user data
        const snapshot = await get(ref(database, `users/${currentUser.uid}`));
        const userData = snapshot.val();
        
        if (!userData) {
            await customAlert('No data to backup', 'Backup');
            return;
        }
        
        // Create JSON blob
        const dataStr = JSON.stringify(userData, null, 2);
        const dataBlob = new Blob([dataStr], { type: 'application/json' });
        
        // Create download link
        const url = URL.createObjectURL(dataBlob);
        const link = document.createElement('a');
        link.href = url;
        link.download = `notebook-backup-${Date.now()}.json`;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        URL.revokeObjectURL(url);
        
        await customAlert('Backup downloaded successfully!', 'Backup Complete');
    } catch (error) {
        await customAlert('Failed to create backup: ' + error.message, 'Backup Failed');
    }
}

		// Profile name editing
    const profileNameTitle = document.getElementById('profileNameTitle');
    if (profileNameTitle) {
        profileNameTitle.addEventListener('click', () => {
            profileNameTitle.contentEditable = 'true';
            profileNameTitle.focus();
            // Select all text
            const range = document.createRange();
            range.selectNodeContents(profileNameTitle);
            const sel = window.getSelection();
            sel.removeAllRanges();
            sel.addRange(range);
        });
        
        profileNameTitle.addEventListener('blur', () => {
            profileNameTitle.contentEditable = 'false';
            const newName = profileNameTitle.textContent.trim() || 'Enter Name';
            profileNameTitle.textContent = newName;
            
            // Save to Firebase
            if (currentUser) {
                set(ref(database, `users/${currentUser.uid}/profileName`), newName);
            }
        });
        
        profileNameTitle.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                profileNameTitle.blur();
            }
        });
    }
    
    // Load profile name when showing profile page
    if (profilePage && currentUser) {
        get(ref(database, `users/${currentUser.uid}/profileName`)).then((snapshot) => {
            if (snapshot.exists() && profileNameTitle) {
                profileNameTitle.textContent = snapshot.val();
            }
        });
    }

		// Settings restore from backup
    const settingsRestoreBtn = document.getElementById('settingsRestoreBtn');
    const restoreFileInput = document.getElementById('restoreFileInput');
    
    if (settingsRestoreBtn && restoreFileInput) {
        settingsRestoreBtn.addEventListener('click', () => {
            restoreFileInput.click();
        });
        
        restoreFileInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const backupData = JSON.parse(text);
                
                if (await customConfirm('This will restore all data from the backup file. Your current data will be replaced. Continue?', 'Restore Backup', 'Restore')) {
                    // Upload to Firebase
                    await set(ref(database, `users/${currentUser.uid}`), backupData);
                    await customAlert('Backup restored successfully! Refreshing...', 'Restore Complete');
                    window.location.reload();
                }
            } catch (error) {
                await customAlert('Failed to restore backup: ' + error.message, 'Restore Failed');
            }
            
            // Reset file input
	            restoreFileInput.value = '';
	        });
	    }
	
</script>
<button class="floating-layout-btn" id="layoutBtn" onclick="toggleLayout()" title="Switch layout" style="opacity: 0;"></button>
<div class="home-page" id="homePage">
    <div class="home-container">
        <div class="home-header">
            <h1 class="home-title">Notebook</h1>
            <div class="home-header-actions">
                <button class="home-header-icon-btn" id="homeSearchBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="11" cy="11" r="8"></circle>
                        <path d="m21 21-4.35-4.35"></path>
                    </svg>
                </button>
                <button class="home-header-icon-btn" id="homeCreateBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="12" y1="5" x2="12" y2="19"></line>
                        <line x1="5" y1="12" x2="19" y2="12"></line>
                    </svg>
                </button>
                <button class="home-header-icon-btn" id="homeMenuBtn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="1"></circle>
                        <circle cx="12" cy="5" r="1"></circle>
                        <circle cx="12" cy="19" r="1"></circle>
                    </svg>
                </button>
            </div>
        </div>
        
        <div class="home-divider"></div>
        
        <div class="home-collections-nav" id="homeCollectionsNav">
            <!-- Collections will be populated here dynamically -->
        </div>
        
        <div class="home-divider"></div>
        
        <div class="home-filter-nav">
            <div class="home-filter-item active" data-filter="all">All files</div>
            <div class="home-filter-item" data-filter="short-notes">Short notes</div>
            <div class="home-filter-item" data-filter="reminders">Reminders</div>
            <div class="home-filter-item" data-filter="routines">Routines</div>
            <div class="home-filter-item" data-filter="trackers">Trackers</div>
            <div class="home-filter-item" data-filter="journals">Journals</div>
        </div>
        
        <div class="home-guides-list" id="homeGuidesList">
            <!-- Guides will be populated here -->
        </div>
    </div>
    
    <div class="home-search-overlay" id="homeSearchOverlay">
        <div class="home-search-container">
            <div class="home-search-header">
                <input type="text" class="home-search-input-full" id="homeSearchInputFull" placeholder="Search guides..." autofocus>
                <button class="home-search-close" id="homeSearchClose">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="18" y1="6" x2="6" y2="18"></line>
                        <line x1="6" y1="6" x2="18" y2="18"></line>
                    </svg>
                </button>
            </div>
            <div class="home-search-results" id="homeSearchResults">
                <!-- Search results will appear here -->
            </div>
        </div>
    </div>
    
    <div class="home-actions-bar" id="homeActionsBar">
        <button class="home-action-move" id="homeMoveBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            Move to Collection
        </button>
        <button class="home-action-delete" id="homeDeleteBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"></polyline>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
            </svg>
            Delete
        </button>
    </div>
    
    <div class="home-dropdown-menu" id="homeDropdownMenu">
        <button id="homeSelectMenuBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 11l3 3L22 4"></path>
                <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"></path>
            </svg>
            Select
        </button>
        <button id="homeCreateCollectionMenuBtn">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"></path>
            </svg>
            Create Collection
        </button>
    </div>
</div>
<div class="templates-page" id="templatesPage">
    <div class="templates-container">
        <div class="templates-header">
            <h1 class="templates-title">Templates</h1>
        </div>
        
        <div class="home-divider"></div>
        
        <div class="templates-presets">
            <div class="template-preset-item" data-template="short-notes">
                <svg class="template-preset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                    <polyline points="14 2 14 8 20 8"></polyline>
                </svg>
                <span>Short notes</span>
            </div>
            <div class="template-preset-item" data-template="reminders">
                <svg class="template-preset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"></path>
                    <path d="M13.73 21a2 2 0 0 1-3.46 0"></path>
                </svg>
                <span>Reminders</span>
            </div>
            <div class="template-preset-item" data-template="trackers">
                <svg class="template-preset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
                </svg>
                <span>Trackers</span>
            </div>
            <div class="template-preset-item" data-template="routines">
                <svg class="template-preset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="23 4 23 10 17 10"></polyline>
                    <polyline points="1 20 1 14 7 14"></polyline>
                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
                </svg>
                <span>Routines</span>
            </div>
            <div class="template-preset-item" data-template="journals">
                <svg class="template-preset-icon" width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M4 19.5A2.5 2.5 0 0 1 6.5 17H20"></path>
                    <path d="M6.5 2H20v20H6.5A2.5 2.5 0 0 1 4 19.5v-15A2.5 2.5 0 0 1 6.5 2z"></path>
                </svg>
                <span>Journals</span>
            </div>
        </div>
        
        <div class="home-divider"></div>
        
        <div class="templates-custom">
            <button class="template-custom-btn" id="templateCustomBtn">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="12" y1="5" x2="12" y2="19"></line>
                    <line x1="5" y1="12" x2="19" y2="12"></line>
                </svg>
                <span>Create custom template</span>
            </button>
        </div>
    </div>
</div>

<div class="profile-page" id="profilePage">
    <div class="profile-container">
        <div class="profile-header">
            <h1 class="profile-title editable" id="profileNameTitle" contenteditable="false">Enter Name</h1>
        </div>
        
        <div class="home-divider" style="margin: 20px 0;"></div>
        
        <div class="profile-info-section">
            <div class="profile-label">Email</div>
            <div class="profile-value" id="profileEmail">user@example.com</div>
        </div>
        
        <div class="home-divider" style="margin: 20px 0;"></div>
        
        <div class="profile-actions">
            <button class="profile-action-item" id="profileSwitchAccountBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                    <circle cx="8.5" cy="7" r="4"></circle>
                    <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
                <span>Switch account</span>
            </button>
            <button class="profile-action-item" id="profileLogoutBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                    <polyline points="16 17 21 12 16 7"></polyline>
                    <line x1="21" y1="12" x2="9" y2="12"></line>
                </svg>
                <span>Logout</span>
            </button>
            <button class="profile-action-item danger" id="profileDeleteAccountBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <polyline points="3 6 5 6 21 6"></polyline>
                    <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                </svg>
                <span>Delete account</span>
            </button>
        </div>
    </div>
</div>

		<div class="settings-page" id="settingsPage">
    <div class="settings-container">
        <div class="settings-header">
            <h1 class="settings-title">Settings</h1>
        </div>
        
        <div class="home-divider" style="margin: 20px 0;"></div>
        
        <div class="settings-actions">
            <button class="settings-action-item" id="settingsBackupBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="7 10 12 15 17 10"></polyline>
                    <line x1="12" y1="15" x2="12" y2="3"></line>
                </svg>
                <span>Download backup</span>
            </button>
            <button class="settings-action-item" id="settingsRestoreBtn">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                    <polyline points="17 8 12 3 7 8"></polyline>
                    <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
                <span>Upload from backup</span>
            </button>
        </div>
    </div>
    <input type="file" id="restoreFileInput" accept=".json" style="display: none;">
</div>
<div class="bottom-nav">
    <div class="bottom-nav-item active" data-page="guides">
        <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
        <span>Home</span>
    </div>
    <div class="bottom-nav-item" data-page="templates">
	    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"></rect><rect x="14" y="3" width="7" height="7"></rect><rect x="14" y="14" width="7" height="7"></rect><rect x="3" y="14" width="7" height="7"></rect></svg>
	    <span>Templates</span>
	</div>
    <div class="bottom-nav-item" data-page="profile">
	    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round">
	        <circle cx="12" cy="7" r="4"></circle>
	        <path d="M5.5 21c0-3.5 2.9-6.5 6.5-6.5s6.5 3 6.5 6.5"></path>
	    </svg>
	    <span>Profile</span>
	</div>
	<div class="bottom-nav-item" data-page="settings">
	    <svg viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"></circle><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path></svg>
	    <span>Settings</span>
	</div>
</div>
</body>
</html>





























