<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
	<meta name="mobile-web-app-capable" content="yes">
    <title>Personal Notebook</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
		@import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
		body { font-family: -apple-system, BlinkMacSystemFont, 'Inter', 'SF Pro Display', 'Segoe UI', system-ui, sans-serif; background: #f0f2f5; min-height: 100vh; padding: 0; margin: 0; overscroll-behavior: none; -webkit-tap-highlight-color: transparent; touch-action: pan-y; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-user-select: none; }
		.add-category-tab { background: #f59e0b !important; color: white !important; font-weight: bold; border-bottom: none !important; padding: 15px 20px !important; font-size: 18px !important; }
		.add-category-tab:hover { background: #d97706 !important; }
		.add-item-btn { background: #10b981; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 15px; font-size: 13px; font-weight: 500; display: none; width: 100%; transition: all 0.2s ease; }
		.add-item-btn:hover { background: #059669; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3); }
		.add-skill-btn { background: #8b5cf6; color: white; padding: 12px 24px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; width: auto; margin: 20px auto; transition: all 0.2s ease; display: none; }
		.add-skill-btn:hover { background: #7c3aed; transform: translateY(-1px); box-shadow: 0 2px 8px rgba(139, 92, 246, 0.3); }
		.category { display: none; }
		.category.active { display: block; }
		.checkbox { width: 20px; height: 20px; border: 2px solid #d0d7de; border-radius: 5px; flex-shrink: 0; margin-top: 2px; cursor: pointer; transition: all 0.2s ease; background: white; }
		.checkbox:hover { border-color: var(--primary-color, #3498db); }
		.checklist-item { display: flex; align-items: flex-start; gap: 14px; padding: 14px 12px; background: #f8f9fa; margin-bottom: 8px; border-radius: 12px; cursor: default; transition: all 0.2s ease; border: 1px solid transparent; position: relative; -webkit-tap-highlight-color: transparent; will-change: transform; }
		.checklist-item:active { transform: scale(0.98); background: #e8f4f8; }
		.checklist-item.checked { opacity: 0.7; }
		.checklist-item.checked .checkbox { background: var(--secondary-color, #27ae60); border-color: var(--secondary-color, #27ae60); position: relative; }
		.checklist-item.checked .checkbox:after { content: "âœ“"; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }
		.checklist-item:hover { background: #e8f4f8; border-color: var(--primary-color, #3498db); }
		.checklist-text { flex: 1; font-size: 14px; line-height: 1.5; color: #495057; }
		.collapse-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s ease; width: 20px; height: 20px; display: none; }
		.collapse-btn:hover { background: #ecf0f1; transform: scale(1.1); }
		.collapse-btn svg { width: 100%; height: 100%; stroke: #95a5a6; transition: stroke 0.2s ease; }
		.collapse-btn:hover svg { stroke: #2c3e50; }
		.color-option { width: 32px; height: 32px; border-radius: 6px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s ease; flex-shrink: 0; }
		.color-option:hover { transform: scale(1.1); border-color: #2c3e50; }
		.color-option.selected { border-color: #2c3e50; border-width: 3px; }
		.color-options { display: flex; flex-wrap: wrap; gap: 8px; }
		.color-picker-menu { display: none; background: #f8f9fa; border-radius: 0; padding: 15px; margin: 0; position: relative; box-shadow: none; width: 100%; border-top: 1px solid #e9ecef; }
		.color-picker-menu h3 { margin: 0 0 10px 0; font-size: 12px; color: #6c757d; font-weight: normal; }
		.color-picker-menu.show { display: block; }
		.color-picker-canvas { position: relative; width: 100%; height: 200px; border-radius: 8px; cursor: crosshair; margin-bottom: 10px; background: linear-gradient(to bottom, rgba(0,0,0,0) 0%, rgba(0,0,0,1) 100%), linear-gradient(to right, rgba(255,255,255,1) 0%, rgba(255,255,255,0) 100%); }
		.hue-slider { width: 100%; height: 20px; border-radius: 10px; background: linear-gradient(to right, #ff0000 0%, #ffff00 17%, #00ff00 33%, #00ffff 50%, #0000ff 67%, #ff00ff 83%, #ff0000 100%); cursor: pointer; position: relative; margin-bottom: 15px; }
		.picker-indicator { position: absolute; width: 16px; height: 16px; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 4px rgba(0,0,0,0.5); pointer-events: none; transform: translate(-50%, -50%); }
		.hue-indicator { position: absolute; width: 8px; height: 24px; background: white; border: 2px solid #2c3e50; border-radius: 4px; top: 50%; transform: translate(-50%, -50%); pointer-events: none; }
		.container { max-width: 100%; width: 100%; margin: 0; padding: 0; background: #f0f2f5; border-radius: 0; box-shadow: none; overflow: visible; opacity: 0; transition: opacity 0.3s ease-in-out; min-height: 100vh; }
		.container.loaded { opacity: 1; }
		.content-area { padding: 0 12px 80px; background: transparent; min-height: calc(100vh - 250px); }
		.delete-btn { position: absolute; top: 8px; right: 8px; width: 24px; height: 24px; background: transparent; color: #6b7280; border: none; border-radius: 6px; font-size: 18px; font-weight: normal; display: none; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 10; transition: all 0.2s ease; padding: 0; }
		.delete-btn:hover { background: rgba(220, 38, 38, 0.1); color: #dc2626; transform: scale(1.1); }
		.delete-tab-btn { width: 22px; height: 22px; background: transparent; color: #9ca3af; border: none; border-radius: 50%; font-size: 18px; font-weight: 600; margin-left: 6px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; padding: 0; }
		.delete-tab-btn:hover { background: #fee2e2; color: #dc2626; transform: scale(1.05); }
		.drawer-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
		.drawer-backdrop.show { opacity: 1; visibility: visible; }
		.drawer-header { padding: 20px 16px 15px; border-bottom: 2px solid #2c3e50; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 16px; }
		.dropdown-menu { display: none; position: absolute; top: 45px; right: 0; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.12); min-width: 200px; z-index: 1000; overflow-y: auto; max-height: calc(100vh - 80px); border: 1px solid #e8eaed; }
		.dropdown-menu button { width: 100%; padding: 14px 20px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; color: #1f2937; transition: background 0.2s; font-weight: 500; }
		.dropdown-menu button:hover { background: #f3f4f6; }
		.dropdown-menu button:first-child { border-radius: 8px 8px 0 0; }
		.dropdown-menu button:last-child { border-radius: 0 0 8px 8px; }
		.dropdown-menu.show { display: block; }
		.edit-btn { background: none; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 28px; font-weight: 600; transition: all 0.3s ease; line-height: 1; }
		.edit-btn:hover { opacity: 0.7; }
		.edit-mode .add-item-btn { display: block; }
		.edit-mode .add-skill-btn { display: block; }
		.edit-mode .delete-btn { display: inline-flex; }
		.edit-mode-active .floating-layout-btn { display: none; }
		.edit-toggle { position: absolute; top: 10px; right: 10px; }
		.editable { cursor: text; padding: 2px 4px; border-radius: 4px; transition: all 0.2s ease; }
		.editable:hover { background: rgba(52, 152, 219, 0.1); }
		.editable:focus { outline: 2px solid var(--primary-color, #3498db); background: white; }
		.emoji-picker { position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 8px; display: grid; grid-template-columns: repeat(8, 30px); gap: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto; }
		.emoji-picker button { font-size: 20px; background: none; border: none; cursor: pointer; transition: transform 0.2s; }
		.emoji-picker button:hover { transform: scale(1.2); }
		.emoji-remove-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #e74c3c; color: white; border: 2px solid white; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 10; transition: all 0.2s ease; }
		.emoji-remove-btn:hover { background: #c0392b; transform: scale(1.1); }
		.editable-icon { position: relative; display: inline-block; }
		.floating-layout-btn { position: fixed; bottom: max(env(safe-area-inset-bottom), 24px); right: 24px; width: 56px; height: 56px; border-radius: 50%; background-color: var(--secondary-color); opacity: 0.9; color: white; font-size: 24px; border: none; box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2); cursor: pointer; transition: all 0.3s ease; z-index: 999; display: flex; align-items: center; justify-content: center; -webkit-tap-highlight-color: transparent; }
		.floating-layout-btn:active { transform: scale(0.9); }
		.floating-layout-btn:hover { transform: scale(1.05); box-shadow: 0 6px 20px rgba(0, 0, 0, 0.3); opacity: 1; }
		.guide-dropdown { position: fixed; top: 0; left: 0; height: 100vh; width: 85%; max-width: 320px; background: rgba(237, 239, 240, 1); box-shadow: 2px 0 20px rgba(0,0,0,0.2); z-index: 2000; max-height: 100vh; overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); padding-top: max(env(safe-area-inset-top), 0); padding-bottom: 140px; scrollbar-width: none; -ms-overflow-style: none; will-change: transform; }
		.guide-dropdown::-webkit-scrollbar { display: none; }
		.guide-dropdown button { width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
		.guide-dropdown button:hover { background: #f8f9fa; }
		.guide-dropdown button:last-child { border-bottom: none; }
		.guide-dropdown .current-guide { background: rgba(25, 118, 210, 0.1); font-weight: 700; color: var(--primary-color, #1976d2); font-size: 15px; }
		.guide-dropdown.show { transform: translateX(0); }
		.guide-menu-btn { position: absolute; top: 10px; left: 10px; background: none; color: white; border: none; padding: 8px; cursor: pointer; font-size: 24px; font-weight: 600; transition: all 0.3s ease; line-height: 1; z-index: 10; }
		.guide-menu-btn:hover { opacity: 0.7; }
		.header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: max(env(safe-area-inset-top), 20px) 20px 20px; text-align: center; position: relative; box-shadow: 0 2px 12px rgba(0,0,0,0.15); border-radius: 0 0 20px 20px; }
		.header h1 { font-size: 24px; margin-bottom: 6px; font-weight: 700; letter-spacing: -0.5px; }
		.header p { opacity: 0.95; font-size: 13px; font-weight: 400; }
		.header .editable:focus { outline: 2px solid #fff; background: rgba(255, 255, 255, 0.2); color: #fff; }
		.header .editable-icon { cursor: pointer; margin-right: 8px; font-size: 24px; }
		.header-wrapper { position: sticky; top: 0; z-index: 100; background: transparent; padding-bottom: 8px; }
		.nav-tab { padding: 12px 20px; cursor: pointer; border: none; background: none; font-size: 15px; font-weight: 500; color: #5f6368; transition: all 0.3s ease; white-space: nowrap; border-radius: 12px 12px 0 0; flex-shrink: 0; position: relative; margin: 0 4px; -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; -webkit-tap-highlight-color: transparent; }
		.nav-tab:hover { color: var(--primary-color); background: rgba(52, 152, 219, 0.1); }
		.nav-tab.active { color: var(--tab-active-color, var(--primary-color)); background: white; font-weight: 600; box-shadow: 0 -4px 12px rgba(0,0,0,0.1), 0 2px 8px rgba(0,0,0,0.06); z-index: 10; }
		.nav-tab * { -webkit-user-select: none; -moz-user-select: none; -ms-user-select: none; user-select: none; pointer-events: none; }
		.nav-tab { pointer-events: auto; }
		.nav-tab .tab-icon { margin-right: 5px; cursor: pointer; }
		.nav-tab .tab-name { cursor: text; }
		.nav-tab .tab-name:hover { background: rgba(255, 255, 255, 0.1); padding: 2px 4px; border-radius: 4px; }
		.nav-tab .tab-name:focus { outline: 2px solid var(--primary-color, #3498db); background: white; color: #2c3e50; padding: 2px 4px; border-radius: 4px; }
		.nav-tabs { display: flex; background: white; border-bottom: none; overflow-x: auto; overflow-y: hidden; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: none; position: sticky; top: 0; left: 0; right: 0; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.08); border-radius: 0 0 16px 16px; padding: 8px 8px 0; margin-bottom: 12px; }
		.nav-tabs::-webkit-scrollbar { display: none; }
		.nav-tabs::-webkit-scrollbar-track { background: transparent; }
		.nav-tabs::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; min-width: 10px; max-width: 10px; }
		.nav-tabs::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
		.save-btn { position: absolute; top: 5px; right: 5px; background: transparent; color: white; border: 1px solid rgba(255, 255, 255, 0.3); padding: 6px 16px; cursor: pointer; font-size: 14px; font-weight: 600; border-radius: 6px; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.2), 0 1px 2px rgba(255, 255, 255, 0.1); transition: all 0.2s ease; display: none; z-index: 10; text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3); }
		.save-btn:hover { background: rgba(255, 255, 255, 0.1); box-shadow: inset 0 2px 6px rgba(0, 0, 0, 0.3), 0 1px 2px rgba(255, 255, 255, 0.2); }
		.save-btn:active { box-shadow: inset 0 3px 8px rgba(0, 0, 0, 0.4); transform: translateY(1px); }
		.skill-card { background: white; border-radius: 0; padding: 24px; border-left: 4px solid var(--primary-color); border-bottom: 1px solid #e8eaed; box-shadow: 0 4px 8px var(--shadow-color); transition: all 0.3s ease; position: relative; margin-bottom: 16px; }
		.skill-card:hover { transform: translateY(-2px); box-shadow: 0 4px 20px rgba(0,0,0,0.12); }
		.skill-card.expanded .collapse-btn { display: block; }
		.skill-grid { display: flex; flex-direction: column; gap: 32px; margin-top: 0; padding: 16px 0 0 0; transition: all 0.3s ease; }
		.skill-grid.headings { display: flex; flex-direction: column; gap: 12px; padding: 20px 16px; }
		.skill-grid.headings .skill-card { padding: 15px 20px; border-left: 4px solid var(--secondary-color, #3498db); border-radius: 8px; background: white; border-bottom: 1px solid #e8eaed; cursor: pointer; position: relative; box-shadow: 0 1px 3px rgba(0,0,0,0.06); }
		.skill-grid.headings .skill-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
		.skill-grid.headings .skill-card.expanded .checklist-item { display: flex; }
		.skill-grid.headings .checklist-item { display: none; }
		.skill-grid.headings .add-item-btn { display: none !important; }
		.skill-grid.horizontal { display: flex; flex-direction: row; overflow-x: auto; overflow-y: hidden; scroll-snap-type: none; padding: 30px; gap: 32px; }
		.skill-grid.horizontal .skill-card { min-width: 300px; max-width: 300px; scroll-snap-align: start; flex-shrink: 0; border-radius: 12px; border-bottom: 1px solid #e8eaed; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
		.skill-title { font-size: 17px; font-weight: 600; color: #1f2937; margin-bottom: 16px; letter-spacing: -0.2px; line-height: 1.4; }
		.tab-wrapper { display: flex; align-items: center; gap: 5px; }
		.checklist-item:has(.delete-btn:hover) { background: #fee2e2 !important; border-color: #fca5a5 !important; }
		.skill-card:has(> .skill-title .delete-btn:hover) { background: #fee2e2 !important; border-left-color: #dc2626 !important; }
		.tab-wrapper:has(.delete-tab-btn:hover) .nav-tab { background: #fee2e2 !important; color: #dc2626 !important; border-color: #fca5a5 !important; }
		@keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
		@media (max-width: 768px) { .skill-grid { grid-template-columns: 1fr; } }
		@supports (-webkit-touch-callout: none) { /* iOS specific - use native emoji keyboard */ input[type="text"].emoji-input {  font-size: 32px; } }
    	@supports (-webkit-overflow-scrolling: touch) { body { overscroll-behavior-y: contain; } }
		.guide-item { cursor: move; }
		.guide-item.dragging { opacity: 0.5; }
		.guide-item.drag-over { border-top: 3px solid var(--primary-color, #3498db); }
		.drag-handle { position: absolute; left: 8px; top: 0; bottom: 0; display: flex; align-items: center; cursor: grab; padding: 0 4px; color: rgba(0, 0, 0, 0.15); font-size: 16px; line-height: 1; user-select: none; transition: all 0.2s; font-weight: normal; text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.8); letter-spacing: -2px; }
		.drag-handle:hover { color: rgba(0, 0, 0, 0.25); text-shadow: 1px 1px 1px rgba(255, 255, 255, 0.9); }
		.drag-handle:active { cursor: grabbing; }
		.skill-card.dragging { opacity: 0.5; background: #f3f4f6; }
		.skill-card.drag-over { border-top: 3px solid var(--primary-color, #3498db); }
		.checklist-item .bullet-number { width: 20px; height: 20px; border-radius: 50%; background: #d1d5db; color: white; font-size: 11px; font-weight: bold; display: flex; align-items: center; justify-content: center; flex-shrink: 0; margin-top: 2px; }
		.checklist-item .bullet-square { flex-shrink: 0; margin-top: 2px; font-size: 20px; line-height: 1; color: var(--primary-color, #3498db); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
		.checklist-item .bullet-circle { flex-shrink: 0; margin-top: 2px; font-size: 20px; line-height: 1; color: var(--primary-color, #3498db); width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; }
		.checklist-item .bullet-none { width: 0px; height: 20px; flex-shrink: 0; margin-top: 2px; }
		.checklist-item.dragging { opacity: 0.5; background: #f3f4f6; }
		.checklist-item.drag-over { border-top: 3px solid var(--primary-color); }
		.checklist-text[contenteditable="true"],
		.skill-title span[contenteditable="true"],
		.tab-name-display[contenteditable="true"] {user-select: text !important; -webkit-user-select: text !important;   cursor: text !important;}
		.skill-card-controls { position: absolute; top: 0; right: 0; display: flex; gap: 8px; align-items: center; padding: 4px 4px 4px 8px; background: transparent; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; }
		.skill-card-controls.show { opacity: 1; pointer-events: auto; }
		.edit-mode .skill-card-controls { opacity: 1; pointer-events: auto; }
		.skill-control-btn { background: none; border: none; color: var(--primary-color, #3498db); opacity: 0.4; cursor: pointer; padding: 0; width: 20px; height: 20px; display: flex; align-items: center; justify-content: center; font-size: 18px; transition: all 0.2s ease; font-weight: normal; }
		.skill-control-btn:hover { color: #6b7280; transform: scale(1.1); }
		.skill-control-btn.delete-control:hover {color: #dc2626;}
		.drawer-footer { position: fixed; bottom: 0; left: 0; width: 85%; max-width: 320px; height: 60px; background: rgba(237,239,240,0.7); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); display: flex; align-items: center; justify-content: flex-end; padding: 0 20px; padding-bottom: max(env(safe-area-inset-bottom),0); z-index: 2001; box-shadow: 0 -4px 12px rgba(0,0,0,0.03); transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4,0.0,0.2,1); }
		.guide-dropdown.show ~ .drawer-footer { transform: translateX(0); }
		.drawer-create-icon { background: none; border: none; cursor: pointer; padding: 0; margin: 0; transition: all 0.2s ease; display: flex; align-items: center; justify-content: center; opacity: 0.5; }
		.drawer-create-icon:hover { opacity: 0.8; transform: scale(1.05); }
		.drawer-create-icon:active { opacity: 1; transform: scale(0.98); }
		.drawer-create-icon svg { stroke: #2c3e50; width: 22px; height: 22px; filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1)); }
		.logout-menu { position: fixed; bottom: 80px; left: 20px; background: white; border-radius: 12px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); display: none; z-index: 2002; overflow: hidden; min-width: 180px; }
		.logout-menu.show { display: block; }
		.logout-menu button { width: 100%; padding: 14px 20px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; font-weight: 500; transition: background 0.2s; display: flex; align-items: center; gap: 10px; }
		.logout-menu button:hover { background: #f3f4f6; }
		.logout-menu button:first-child { color: #1f2937; border-bottom: 1px solid #e5e7eb; }
		.logout-menu button:last-child { color: #dc2626; }
/* Hide all scrollbars but keep scroll functionality */
		* { scrollbar-width: none; -ms-overflow-style: none; }
		*::-webkit-scrollbar { display: none; }
		#loginScreen { opacity: 0; transition: opacity 0.3s ease-in-out; }
		#loginScreen.show { opacity: 1; }
		.expand-btn { width: 20px; height: 20px; background: none; border: none; cursor: pointer; padding: 0; display: flex; align-items: center; justify-content: center; transition: all 0.2s ease; margin-left: 4px; }
		.expand-btn:hover { transform: scale(1.1); }
		.expand-btn svg { width: 16px; height: 16px; stroke: #95a5a6; transition: stroke 0.2s ease; }
		.expand-btn:hover svg { stroke: #2c3e50; }
		.skill-card-controls { position: absolute; top: 4px; right: 4px; display: flex; gap: 4px; align-items: center; padding: 4px; background: transparent; opacity: 0; pointer-events: none; transition: opacity 0.3s ease; z-index: 10; }

		
	</style>
    </head>
<body>
    <div id="loginScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Welcome Back</h2>
        
        <input type="email" id="loginEmail" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="loginPassword" placeholder="Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <button id="loginBtn" style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Login</button>
        
        <button id="googleBtn" style="width: 100%; padding: 14px; background: white; color: #333; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Continue with Google
        </button>
        
        <div style="text-align: center; margin-top: 20px;">
            <span style="color: #666;">Don't have an account?</span>
            <button id="signupBtn" style="background: none; border: none; color: #667eea; font-weight: 600; cursor: pointer; margin-left: 5px;">Sign Up</button>
        </div>
    </div>
</div>
    <div id="signupScreen" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100vh; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); align-items: center; justify-content: center; z-index: 9999;">
    <div style="background: white; padding: 40px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
        <h2 style="text-align: center; margin-bottom: 30px; color: #333;">Create Account</h2>
        
        <input type="email" id="signupEmail" placeholder="Email" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="signupPassword" placeholder="Password (min 6 characters)" style="width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <input type="password" id="signupPasswordConfirm" placeholder="Confirm Password" style="width: 100%; padding: 12px; margin-bottom: 20px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; box-sizing: border-box;">
        
        <button id="signupSubmitBtn" style="width: 100%; padding: 14px; background: #667eea; color: white; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px;">Create Account</button>
        
        <button id="googleSignupBtn" style="width: 100%; padding: 14px; background: white; color: #333; border: 1px solid #ddd; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; margin-bottom: 15px; display: flex; align-items: center; justify-content: center; gap: 10px;">
            <svg width="18" height="18" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
            Sign up with Google
        </button>
        
        <div style="text-align: center; margin-top: 20px;">
            <span style="color: #666;">Already have an account?</span>
            <button id="backToLoginBtn" style="background: none; border: none; color: #667eea; font-weight: 600; cursor: pointer; margin-left: 5px;">Login</button>
        </div>
    </div>
</div>
    <div class="container" id="app" style="display: none;">
    <div class="header-wrapper">
        <div class="header">
            <div class="edit-toggle"><button class="edit-btn" id="editModeBtn" onclick="toggleEditMode()">Edit</button></div>
            <h1>ðŸ““ Personal Notebook</h1>
            <p>note description</p>
        </div>
        <div class="nav-tabs" id="navTabs"></div>
    </div>
    <div class="content-area" id="contentArea"></div>
</div>
<script type="module">
	import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
	import { getDatabase, ref, set, get, update, remove, onValue, child } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
	import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
	
	// Initialize Firebase
	const firebaseConfig = {
	  apiKey: "AIzaSyA5k5pOZjWTrV3b1f51-aWH2AgDUY-p5hE",
	  authDomain: "life-akuk095.firebaseapp.com",
	  databaseURL: "https://life-akuk095-default-rtdb.europe-west1.firebasedatabase.app",
	  projectId: "life-akuk095",
	  storageBucket: "life-akuk095.firebasestorage.app",
	  messagingSenderId: "80383828301",
	  appId: "1:80383828301:web:7c001b7375f63fc5055704",
	};
	
	const app = initializeApp(firebaseConfig);
	const database = getDatabase(app);
	const auth = getAuth(app);
	let currentUser = null;
	let currentGuideId = localStorage.getItem('currentGuideId') || "defaultGuide";
	// Default data structure
	let categories = [
	    {
	        name: "Helping you started", 
	        icon: "â„ï¸", 
	        skills: [
	            {
	                title: "First steps", 
	                icon: "ðŸµ", 
					bulletStyle: "checkbox",
	                items: ["Create your first note", "Click on the 3 dots on top right for more actions", "Edit, duplicate or delete note"]
	            }
	        ]
	    },
	    {
        name: "Do more", 
        icon: "ðŸ‰", 
        skills: [
            {
                title: "Keep it Simple Stupid (KISS)", 
                icon: "ðŸœ", 
                items: ["Write a note, journal or recipe", "Choose a theme", "Click on the hamburger menu to see all your notes"]
            }
        ]
    }
];
// Check if user is logged in
onAuthStateChanged(auth, (user) => {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    const appContainer = document.getElementById('app');
    
    if (user) {
        currentUser = user;
        
        // Hide both auth screens
        loginScreen.classList.remove('show');
        signupScreen.classList.remove('show');
        
        setTimeout(() => {
            loginScreen.style.display = 'none';
            signupScreen.style.display = 'none';
            appContainer.style.display = 'block';
            setTimeout(() => appContainer.classList.add('show'), 10);
        }, 300);
        
        loadUserData(user.uid);
    } else {
        currentUser = null;
        appContainer.classList.remove('show');
        appContainer.style.display = 'none';
        
        // Show login screen
        loginScreen.style.display = 'flex';
        setTimeout(() => loginScreen.classList.add('show'), 10);
    }
});


let checkedItems = {};
let editMode = false;
let activeTabIndex = 0;
let appIcon = "ðŸ““"; 
let appTitle = "Welcome to your own Personal Notebook";
let appSubtitle = "Jot down thoughts, capture ideas, and organise your mind â€” all in one place.";
let themeColor = '#607d8b'; // Default grey
let layoutMode = 'vertical'; // 'vertical', 'horizontal', or 'headings'
let autoRefreshEnabled = false;
let autoRefreshTime = "00:00"; // Default midnight
let expandedCards = {};
const guideCategories = [
    { name: 'Habits', icon: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm-1-13h2v6h-2zm0 8h2v2h-2z' },
    { name: 'Notes', icon: 'M14 2H6c-1.1 0-1.99.9-1.99 2L4 20c0 1.1.89 2 1.99 2H18c1.1 0 2-.9 2-2V8l-6-6zm2 16H8v-2h8v2zm0-4H8v-2h8v2zm-3-5V3.5L18.5 9H13z' },
    { name: 'To-Do', icon: 'M9 11l3 3L22 4M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11'},
    { name: 'Tracking', icon: 'M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z' },
    { name: 'Recipes', icon: 'M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z' },
    { name: 'Goals', icon: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' },
    { name: 'Journaling', icon: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm2 14H7v-2h7v2zm3-4H7v-2h10v2zm0-4H7V7h10v2z' }
];
// Drag and drop state
let draggedCard = null;
let draggedCatIndex = null;
let draggedSkillIndex = null;
let draggedElement = null;
let placeholder = null;
let darkMode = false;
		
const colorThemes = [
    { name: 'Soft Cream', primary: '#F5F7D9', secondary: '#E1E3C1' },
	{ name: 'Warm Sand', primary: '#E5D4B0', secondary: '#DAC898' },
	{ name: 'Dusty Rose', primary: '#C9A0A0', secondary: '#A88080' },
    { name: 'Rose Clay', primary: '#D98C8C', secondary: '#A96565' },
	{ name: 'Elegant Burgundy', primary: '#8B4359', secondary: '#6B3349' },
    { name: 'Deep Teal', primary: '#4A7C7E', secondary: '#355E60' },
	{ name: 'Forest Deep', primary: '#3A5A4A', secondary: '#22342D' },
	{ name: 'Elegant Navy', primary: '#1E3A5F', secondary: '#2C5F8D' },
    { name: 'Ocean Blue', primary: '#5B8FA3', secondary: '#407084' },
    { name: 'Stormy Blue', primary: '#6A8CA5', secondary: '#456274' },
	{ name: 'Slate Blue', primary: '#6B7C93', secondary: '#4A5F7F' },
    { name: 'Steel Blue', primary: '#607D8B', secondary: '#455A64' },
	{ name: 'Charcoal', primary: '#5C6B73', secondary: '#3D4A52' },
	{ name: 'Dark', primary: '#0A0A0A', secondary: '#000000' }
];

		const svgIcons = [
    { name: 'Night', bg: '#6B7C9E', path: 'M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9 9-4.03 9-9c0-.46-.04-.92-.1-1.36-.98 1.37-2.58 2.26-4.4 2.26-2.98 0-5.4-2.42-5.4-5.4 0-1.81.89-3.42 2.26-4.4-.44-.06-.9-.1-1.36-.1z' },
    { name: 'Water', bg: '#5B8FA3', path: 'M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z' },
    { name: 'Location', bg: '#7C9B6E', path: 'M12 2C8 2 5 5.13 5 9c0 5 7 13 7 13s7-8 7-13c0-3.87-3-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z' },
    
    // Productivity
    { name: 'Reading', bg: '#9B7C6E', path: 'M21 5c-1.11-.35-2.33-.5-3.5-.5-1.95 0-4.05.4-5.5 1.5-1.45-1.1-3.55-1.5-5.5-1.5S2.45 4.9 1 6v14.65c0 .25.25.5.5.5.1 0 .15-.05.25-.05C3.1 20.45 5.05 20 6.5 20c1.95 0 4.05.4 5.5 1.5 1.35-.85 3.8-1.5 5.5-1.5 1.65 0 3.35.3 4.75 1.05.1.05.15.05.25.05.25 0 .5-.25.5-.5V6c-.6-.45-1.25-.75-2-1zm0 13.5c-1.1-.35-2.3-.5-3.5-.5-1.7 0-4.15.65-5.5 1.5V8c1.35-.85 3.8-1.5 5.5-1.5 1.2 0 2.4.15 3.5.5v11.5z' },
    { name: 'Planning', bg: '#7B8B9E', path: 'M9 11H7v2h2v-2zm4 0h-2v2h2v-2zm4 0h-2v2h2v-2zm2-7h-1V2h-2v2H8V2H6v2H5c-1.11 0-1.99.9-1.99 2L3 20c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 16H5V9h14v11z' },
    { name: 'Focus', bg: '#9E7B7C', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm0-12c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z' },
    { name: 'Goals', bg: '#7C9E8B', path: 'M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z' },
    
    // Learning & Growth
    { name: 'Study', bg: '#6E7C9B', path: 'M5 13.18v4L12 21l7-3.82v-4L12 17l-7-3.82zM12 3L1 9l11 6 9-4.91V17h2V9L12 3z' },
    { name: 'Gift', bg: '#9B8B6E', path: 'M20 6h-2.18c.11-.31.18-.65.18-1 0-1.66-1.34-3-3-3-1.05 0-1.96.54-2.5 1.35l-.5.67-.5-.68C10.96 2.54 10.05 2 9 2 7.34 2 6 3.34 6 5c0 .35.07.69.18 1H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-5-2c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zM9 4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm11 15H4v-2h16v2zm0-5H4V8h5.08L7 10.83 8.62 12 11 8.76l1-1.36 1 1.36L15.38 12 17 10.83 14.92 8H20v6z' },
    { name: 'Research', bg: '#9E8B7C', path: 'M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z' },
    { name: 'Skills', bg: '#7C8B9E', path: 'M22.7 19l-9.1-9.1c.9-2.3.4-5-1.5-6.9-2-2-5-2.4-7.4-1.3L9 6 6 9 1.6 4.7C.4 7.1.9 10.1 2.9 12.1c1.9 1.9 4.6 2.4 6.9 1.5l9.1 9.1c.4.4 1 .4 1.4 0l2.3-2.3c.5-.4.5-1.1.1-1.4z' },
    
    // Work & Career
    { name: 'Work', bg: '#6B7C8B', path: 'M20 6h-4V4c0-1.11-.89-2-2-2h-4c-1.11 0-2 .89-2 2v2H4c-1.11 0-1.99.89-1.99 2L2 19c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V8c0-1.11-.89-2-2-2zm-6 0h-4V4h4v2z' },
    { name: 'Meeting', bg: '#8B7C99', path: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z' },
    { name: 'Email', bg: '#7B9E8B', path: 'M20 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 4l-8 5-8-5V6l8 5 8-5v2z' },
    { name: 'Call', bg: '#9E7B8B', path: 'M6.62 10.79c1.44 2.83 3.76 5.14 6.59 6.59l2.2-2.2c.27-.27.67-.36 1.02-.24 1.12.37 2.33.57 3.57.57.55 0 1 .45 1 1V20c0 .55-.45 1-1 1-9.39 0-17-7.61-17-17 0-.55.45-1 1-1h3.5c.55 0 1 .45 1 1 0 1.25.2 2.45.57 3.57.11.35.03.74-.25 1.02l-2.2 2.2z' },
    { name: 'Presentation', bg: '#7C9B8B', path: 'M21 3H3c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h5v2h8v-2h5c1.1 0 1.99-.9 1.99-2L23 5c0-1.1-.9-2-2-2zm0 14H3V5h18v12z' },
    
    // Social & Relationships
    { name: 'Family', bg: '#9B7C8B', path: 'M16 4c0-1.11.89-2 2-2s2 .89 2 2-.89 2-2 2-2-.89-2-2zm4 18v-6h2.5l-2.54-7.63C19.68 7.55 18.92 7 18.06 7h-.12c-.86 0-1.62.55-1.9 1.37L13.5 16H16v6h4zM5.5 6c1.11 0 2-.89 2-2s-.89-2-2-2-2 .89-2 2 .89 2 2 2zm2 16v-7H9V9c0-1.1-.9-2-2-2H4c-1.1 0-2 .9-2 2v6h1.5v7h4z' },
    { name: 'Friends', bg: '#7B8B9E', path: 'M16 11c1.66 0 2.99-1.34 2.99-3S17.66 5 16 5c-1.66 0-3 1.34-3 3s1.34 3 3 3zm-8 0c1.66 0 2.99-1.34 2.99-3S9.66 5 8 5C6.34 5 5 6.34 5 8s1.34 3 3 3zm0 2c-2.33 0-7 1.17-7 3.5V19h14v-2.5c0-2.33-4.67-3.5-7-3.5zm8 0c-.29 0-.62.02-.97.05 1.16.84 1.97 1.97 1.97 3.45V19h6v-2.5c0-2.33-4.67-3.5-7-3.5z' },
    { name: 'Communication', bg: '#8B9E7C', path: 'M20 2H4c-1.1 0-1.99.9-1.99 2L2 22l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zM6 9h12v2H6V9zm8 5H6v-2h8v2zm4-6H6V6h12v2z' },
    { name: 'Date', bg: '#9E7B7C', path: 'M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z' },
    { name: 'Community', bg: '#7C9E9B', path: 'M12 12.75c1.63 0 3.07.39 4.24.9 1.08.48 1.76 1.56 1.76 2.73V18H6v-1.61c0-1.18.68-2.26 1.76-2.73 1.17-.52 2.61-.91 4.24-.91zM4 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm1.13 1.1c-.37-.06-.74-.1-1.13-.1-.99 0-1.93.21-2.78.58C.48 14.9 0 15.62 0 16.43V18h4.5v-1.61c0-.83.23-1.61.63-2.29zM20 13c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zm4 3.43c0-.81-.48-1.53-1.22-1.85-.85-.37-1.79-.58-2.78-.58-.39 0-.76.04-1.13.1.4.68.63 1.46.63 2.29V18H24v-1.57zM12 6c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3z' },
    
    // Finance
    { name: 'Budget', bg: '#7B9B8B', path: 'M11.8 10.9c-2.27-.59-3-1.2-3-2.15 0-1.09 1.01-1.85 2.7-1.85 1.78 0 2.44.85 2.5 2.1h2.21c-.07-1.72-1.12-3.3-3.21-3.81V3h-3v2.16c-1.94.42-3.5 1.68-3.5 3.61 0 2.31 1.91 3.46 4.7 4.13 2.5.6 3 1.48 3 2.41 0 .69-.49 1.79-2.7 1.79-2.06 0-2.87-.92-2.98-2.1h-2.2c.12 2.19 1.76 3.42 3.68 3.83V21h3v-2.15c1.95-.37 3.5-1.5 3.5-3.55 0-2.84-2.43-3.81-4.7-4.4z' },
    { name: 'Investment', bg: '#6B8B9E', path: 'M16 6l2.29 2.29-4.88 4.88-4-4L2 16.59 3.41 18l6-6 4 4 6.3-6.29L22 12V6z' },
    { name: 'Shopping', bg: '#9B7B8B', path: 'M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z' },
    { name: 'Bills', bg: '#7C8B7B', path: 'M20 4H4c-1.11 0-1.99.89-1.99 2L2 18c0 1.11.89 2 2 2h16c1.11 0 2-.89 2-2V6c0-1.11-.89-2-2-2zm0 14H4v-6h16v6zm0-10H4V6h16v2z' },
    
    // Home & Living
    { name: 'Cleaning', bg: '#7B9E9B', path: 'M16 11h-1V3c0-1.1-.9-2-2-2h-2c-1.1 0-2 .9-2 2v8H8c-2.76 0-5 2.24-5 5v7h18v-7c0-2.76-2.24-5-5-5zm3 10h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3h-2v-3c0-.55-.45-1-1-1s-1 .45-1 1v3H9v-3c0-.55-.45-1-1-1s-1 .45-1 1v3H5v-5c0-1.65 1.35-3 3-3h8c1.65 0 3 1.35 3 3v5z' },
    { name: 'Cooking', bg: '#9B8B7C', path: 'M8.1 13.34l2.83-2.83L3.91 3.5c-1.56 1.56-1.56 4.09 0 5.66l4.19 4.18zm6.78-1.81c1.53.71 3.68.21 5.27-1.38 1.91-1.91 2.28-4.65.81-6.12-1.46-1.46-4.2-1.1-6.12.81-1.59 1.59-2.09 3.74-1.38 5.27L3.7 19.87l1.41 1.41L12 14.41l6.88 6.88 1.41-1.41L13.41 13l1.47-1.47z' },
    { name: 'Gardening', bg: '#7C9B7C', path: 'M12 22c4.97 0 9-4.03 9-9-4.97 0-9 4.03-9 9zM5.6 10.25c0 1.38 1.12 2.5 2.5 2.5.53 0 1.01-.16 1.42-.44l-.02.19c0 1.38 1.12 2.5 2.5 2.5s2.5-1.12 2.5-2.5l-.02-.19c.4.28.89.44 1.42.44 1.38 0 2.5-1.12 2.5-2.5 0-1-.59-1.85-1.43-2.25.84-.4 1.43-1.25 1.43-2.25 0-1.38-1.12-2.5-2.5-2.5-.53 0-1.01.16-1.42.44l.02-.19C14.5 2.12 13.38 1 12 1S9.5 2.12 9.5 3.5l.02.19c-.4-.28-.89-.44-1.42-.44-1.38 0-2.5 1.12-2.5 2.5 0 1 .59 1.85 1.43 2.25-.84.4-1.43 1.25-1.43 2.25zM12 5.5c1.38 0 2.5 1.12 2.5 2.5s-1.12 2.5-2.5 2.5S9.5 9.38 9.5 8s1.12-2.5 2.5-2.5zM3 13c0 4.97 4.03 9 9 9 0-4.97-4.03-9-9-9z' },
    { name: 'Laundry', bg: '#6B7C9B', path: 'M9.17 16.83L14.83 11.17L13.41 9.76L9.17 14L7.76 12.59L6.34 14L9.17 16.83M18 2.01L6 2C4.89 2 4 2.89 4 4V20C4 21.1 4.89 22 6 22H18C19.1 22 20 21.1 20 20V4C20 2.89 19.1 2.01 18 2.01M18 20H6L6.01 4H18V20Z' },
    { name: 'Organization', bg: '#9E7B9B', path: 'M10 3H4c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 8H4V5h6v6zm10-8h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm0 8h-6V5h6v6zM10 13H4c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2zm0 8H4v-6h6v6zm10-8h-6c-1.1 0-2 .9-2 2v6c0 1.1.9 2 2 2h6c1.1 0 2-.9 2-2v-6c0-1.1-.9-2-2-2zm0 8h-6v-6h6v6z' },
    
    // Transportation
    { name: 'Driving', bg: '#8B7C99', path: 'M18.92 6.01C18.72 5.42 18.16 5 17.5 5h-11c-.66 0-1.21.42-1.42 1.01L3 12v8c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-1h12v1c0 .55.45 1 1 1h1c.55 0 1-.45 1-1v-8l-2.08-5.99zM6.5 16c-.83 0-1.5-.67-1.5-1.5S5.67 13 6.5 13s1.5.67 1.5 1.5S7.33 16 6.5 16zm11 0c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zM5 11l1.5-4.5h11L19 11H5z' },
    { name: 'Walking', bg: '#8B9E7C', path: 'M13.5 5.5c1.1 0 2-.9 2-2s-.9-2-2-2-2 .9-2 2 .9 2 2 2zM9.8 8.9L7 23h2.1l1.8-8 2.1 2v6h2v-7.5l-2.1-2 .6-3C14.8 12 16.8 13 19 13v-2c-1.9 0-3.5-1-4.3-2.4l-1-1.6c-.4-.6-1-1-1.7-1-.3 0-.5.1-.8.1L6 8.3V13h2V9.6l1.8-.7z' },
    { name: 'Public Transit', bg: '#9B7C7C', path: 'M12 2c-4 0-8 .5-8 4v9.5C4 17.43 5.57 19 7.5 19L6 20.5v.5h2l2-2h4l2 2h2v-.5L16.5 19c1.93 0 3.5-1.57 3.5-3.5V6c0-3.5-4-4-8-4zm0 2c3.51 0 4.96.48 5.57 1H6.43c.61-.52 2.06-1 5.57-1zM7.5 17c-.83 0-1.5-.67-1.5-1.5S6.67 14 7.5 14s1.5.67 1.5 1.5S8.33 17 7.5 17zm3.5-6H6V8h5v3zm5.5 6c-.83 0-1.5-.67-1.5-1.5s.67-1.5 1.5-1.5 1.5.67 1.5 1.5-.67 1.5-1.5 1.5zm1.5-6h-5V8h5v3z' },
    { name: 'Travel', bg: '#7C9B9E', path: 'M21 16v-2l-8-5V3.5c0-.83-.67-1.5-1.5-1.5S10 2.67 10 3.5V9l-8 5v2l8-2.5V19l-2 1.5V22l3.5-1 3.5 1v-1.5L13 19v-5.5l8 2.5z' },
    
    // Entertainment & Hobbies
    { name: 'Music', bg: '#9E7B9B', path: 'M12 3v10.55c-.59-.34-1.27-.55-2-.55-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4V7h4V3h-6z' },
    { name: 'Gaming', bg: '#7B8B9E', path: 'M21.58 16.09l-1.09-7.66C20.21 6.46 18.52 5 16.53 5H7.47C5.48 5 3.79 6.46 3.51 8.43l-1.09 7.66C2.2 17.63 3.39 19 4.94 19c.68 0 1.32-.27 1.8-.75L9 16h6l2.25 2.25c.48.48 1.13.75 1.8.75 1.56 0 2.75-1.37 2.53-2.91zM11 11H9v2H8v-2H6v-1h2V8h1v2h2v1zm4-1c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm2 3c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1z' },
    { name: 'Movies', bg: '#9B8B7C', path: 'M18 4l2 4h-3l-2-4h-2l2 4h-3l-2-4H8l2 4H7L5 4H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V4h-4z' },
    { name: 'Photography', bg: '#7C9E9B', path: 'M9 2L7.17 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2h-3.17L15 2H9zm3 15c-2.76 0-5-2.24-5-5s2.24-5 5-5 5 2.24 5 5-2.24 5-5 5z' },
    { name: 'Art', bg: '#9E8B9B', path: 'M12 3c-4.97 0-9 4.03-9 9s4.03 9 9 9c.83 0 1.5-.67 1.5-1.5 0-.39-.15-.74-.39-1.01-.23-.26-.38-.61-.38-.99 0-.83.67-1.5 1.5-1.5H16c2.76 0 5-2.24 5-5 0-4.42-4.03-8-9-8zm-5.5 9c-.83 0-1.5-.67-1.5-1.5S5.67 9 6.5 9 8 9.67 8 10.5 7.33 12 6.5 12zm3-4C8.67 8 8 7.33 8 6.5S8.67 5 9.5 5s1.5.67 1.5 1.5S10.33 8 9.5 8zm5 0c-.83 0-1.5-.67-1.5-1.5S13.67 5 14.5 5s1.5.67 1.5 1.5S15.33 8 14.5 8zm3 4c-.83 0-1.5-.67-1.5-1.5S16.67 9 17.5 9s1.5.67 1.5 1.5-.67 1.5-1.5 1.5z' },
    
    // Self-Care & Wellness
    { name: 'Yoga', bg: '#7C9B9E', path: 'M12 2c1.1 0 2 .9 2 2s-.9 2-2 2-2-.9-2-2 .9-2 2-2zm9 7h-6v13h-2v-6h-2v6H9V9H3V7h18v2z' },
    { name: 'Skincare', bg: '#9E8B8B', path: 'M12 2C9.24 2 7 4.24 7 7c0 1.77.94 3.31 2.34 4.16L8.5 13h7l-.84-1.84C16.06 10.31 17 8.77 17 7c0-2.76-2.24-5-5-5zm0 8c-1.66 0-3-1.34-3-3s1.34-3 3-3 3 1.34 3 3-1.34 3-3 3zm-1 4h2v8h-2v-8z' },
    
    // Mind & Creativity
    { name: 'Journal', bg: '#9E9B8B', path: 'M19 3h-4.18C14.4 1.84 13.3 1 12 1c-1.3 0-2.4.84-2.82 2H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 4c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1.4c0-2 4-3.1 6-3.1s6 1.1 6 3.1V19z' },
    { name: 'Drawing', bg: '#7C8B9B', path: 'M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z' },
    { name: 'Brainstorm', bg: '#9B9E7C', path: 'M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7z' },
    { name: 'Ideas', bg: '#9E7C8B', path: 'M9 21c0 .5.4 1 1 1h4c.6 0 1-.5 1-1v-1H9v1zm3-19C8.1 2 5 5.1 5 9c0 2.4 1.2 4.5 3 5.7V17c0 .5.4 1 1 1h6c.6 0 1-.5 1-1v-2.3c1.8-1.3 3-3.4 3-5.7 0-3.9-3.1-7-7-7zm2.85 11.1l-.85.6V16h-4v-2.3l-.85-.6C7.8 12.16 7 10.63 7 9c0-2.76 2.24-5 5-5s5 2.24 5 5c0 1.63-.8 3.16-2.15 4.1z' },
    
    // Digital Life
    { name: 'Video Call', bg: '#9B8B9E', path: 'M17 10.5V7c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v10c0 .55.45 1 1 1h12c.55 0 1-.45 1-1v-3.5l4 4v-11l-4 4z' },
    { name: 'World', bg: '#8B7C9E', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.95-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z' },
  
    // Nature & Environment
    { name: 'Outdoors', bg: '#7B9B7C', path: 'M14 6l-3.75 5 2.85 3.8-1.6 1.2C9.81 13.75 7 10 7 10l-6 8h22L14 6z' },
    
    // Time Management
    { name: 'Time', bg: '#8B7C9B', path: 'M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm.5-13H11v6l5.25 3.15.75-1.23-4.5-2.67z' },
    { name: 'Timer', bg: '#7B8B8B', path: 'M15 1H9v2h6V1zm-4 13h2V8h-2v6zm8.03-6.61l1.42-1.42c-.43-.51-.9-.99-1.41-1.41l-1.42 1.42C16.07 4.74 14.12 4 12 4c-4.97 0-9 4.03-9 9s4.02 9 9 9 9-4.03 9-9c0-2.12-.74-4.07-1.97-5.61zM12 20c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z' },
    { name: 'Routine', bg: '#9B9E8B', path: 'M12 2C6.5 2 2 6.5 2 12s4.5 10 10 10 10-4.5 10-10S17.5 2 12 2zm4.2 14.2L11 13V7h1.5v5.2l4.5 2.7-.8 1.3z' },
    { name: 'Morning', bg: '#9E9B7B', path: 'M6.76 4.84l-1.8-1.79-1.41 1.41 1.79 1.79 1.42-1.41zM4 10.5H1v2h3v-2zm9-9.95h-2V3.5h2V.55zm7.45 3.91l-1.41-1.41-1.79 1.79 1.41 1.41 1.79-1.79zM20 10.5v2h3v-2h-3zm-8-5c-3.31 0-6 2.69-6 6s2.69 6 6 6 6-2.69 6-6-2.69-6-6-6zm-1 16.95h2V19.5h-2v2.95z' },
    
    // Health Tracking
    { name: 'Weight', bg: '#8B7C9E', path: 'M20.57 14.86L22 13.43 20.57 12 17 15.57 8.43 7 12 3.43 10.57 2 9.14 3.43 7.71 2 5.57 4.14 4.14 2.71 2.71 4.14l1.43 1.43L2 7.71l1.43 1.43L2 10.57 3.43 12 7 8.43 15.57 17 12 20.57 13.43 22l1.43-1.43L16.29 22l2.14-2.14 1.43 1.43 1.43-1.43-1.43-1.43L22 16.29z' },
    { name: 'Mood', bg: '#7C9E9E', path: 'M11.99 2C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2zM12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8zm3.5-9c.83 0 1.5-.67 1.5-1.5S16.33 8 15.5 8 14 8.67 14 9.5s.67 1.5 1.5 1.5zm-7 0c.83 0 1.5-.67 1.5-1.5S9.33 8 8.5 8 7 8.67 7 9.5 7.67 11 8.5 11zm3.5 6.5c2.33 0 4.31-1.46 5.11-3.5H6.89c.8 2.04 2.78 3.5 5.11 3.5z' },
    
    // Food & Nutrition
    { name: 'Coffee', bg: '#8B7C8B', path: 'M2 21h18v-2H2v2zm2-8h14v-2H4v2zm18.5-5H20V4h1.5c.83 0 1.5.67 1.5 1.5v1c0 .83-.67 1.5-1.5 1.5zM4 4h14v4c0 2.21-1.79 4-4 4H8c-2.21 0-4-1.79-4-4V4z' },
    
    // Mental Health
    { name: 'Abort', bg: '#7C8B8B', path: 'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8 0-1.85.63-3.55 1.69-4.9L16.9 18.31C15.55 19.37 13.85 20 12 20zm6.31-3.1L7.1 5.69C8.45 4.63 10.15 4 12 4c4.42 0 8 3.58 8 8 0 1.85-.63 3.55-1.69 4.9z' },
    
    // Miscellaneous Life Actions
    { name: 'Thumbs-up', bg: '#9E9B9E', path: 'M2 20h2c.55 0 1-.45 1-1v-9c0-.55-.45-1-1-1H2v11zm19.83-7.12c.11-.25.17-.52.17-.8V11c0-1.1-.9-2-2-2h-5.5l.92-4.65c.05-.22.02-.46-.08-.66-.23-.45-.52-.86-.88-1.22L14 2 7.59 8.41C7.21 8.79 7 9.3 7 9.83v7.84C7 18.95 8.05 20 9.34 20h8.11c.7 0 1.36-.37 1.72-.97l2.66-6.15z' },
    { name: 'Sleep', bg: '#8B9E8B', path: 'M7 14c1.66 0 3-1.34 3-3S8.66 8 7 8s-3 1.34-3 3 1.34 3 3 3zm0-4c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm12-3h-8v8H3V5H1v15h2v-3h18v3h2v-9c0-2.21-1.79-4-4-4z' },
    { name: 'Connect', bg: '#9E7C9E', path: 'M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1zM8 13h8v-2H8v2zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5z' }
  ];


// Skill card drag start
document.addEventListener('dragstart', (e) => {
    if (e.target.classList.contains('skill-card') && !editMode && layoutMode === 'headings') {
        draggedCard = e.target;
        draggedCatIndex = parseInt(e.target.dataset.catIndex);
        draggedSkillIndex = parseInt(e.target.dataset.skillIndex);
        e.target.classList.add('dragging');
        e.dataTransfer.effectAllowed = 'move';
        
        const rect = e.target.getBoundingClientRect();
        const offsetX = e.clientX - rect.left;
        const offsetY = e.clientY - rect.top;
        e.dataTransfer.setDragImage(e.target, offsetX, offsetY);
    }
    
    // Tab drag start
    if (e.target.classList.contains('nav-tab') && !editMode && e.target.draggable) {
        draggedTab = e.target;
        draggedTabIndex = parseInt(e.target.dataset.catIndex);
        e.target.style.opacity = '0.5';
        e.dataTransfer.effectAllowed = 'move';
    }
});

// Combined drag end
document.addEventListener('dragend', (e) => {
    if (e.target.classList.contains('skill-card')) {
        e.target.classList.remove('dragging');
        document.querySelectorAll('.skill-card').forEach(card => {
            card.classList.remove('drag-over');
        });
        draggedCard = null;
    }
    
    if (e.target.classList.contains('nav-tab')) {
        e.target.style.opacity = '';
        document.querySelectorAll('.nav-tab').forEach(tab => {
            tab.style.borderLeft = '';
        });
        draggedTab = null;
    }
});

// Combined drag over
document.addEventListener('dragover', (e) => {
    e.preventDefault();
    
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            e.dataTransfer.dropEffect = 'move';
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            e.dataTransfer.dropEffect = 'move';
        }
    }
});

// Combined drag enter
document.addEventListener('dragenter', (e) => {
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            target.classList.add('drag-over');
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            target.style.borderLeft = '3px solid var(--primary-color)';
        }
    }
});

// Combined drag leave
document.addEventListener('dragleave', (e) => {
    // Skill cards
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target) {
            target.classList.remove('drag-over');
        }
    }
    
    // Tabs
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target) {
            target.style.borderLeft = '';
        }
    }
});

// Combined drop
document.addEventListener('drop', (e) => {
    e.preventDefault();
    
    // Skill cards drop
    if (draggedCard) {
        const target = e.target.closest('.skill-card');
        if (target && target !== draggedCard && target.dataset.catIndex === draggedCard.dataset.catIndex) {
            const targetCatIndex = parseInt(target.dataset.catIndex);
            const targetSkillIndex = parseInt(target.dataset.skillIndex);
            
            const [movedSkill] = categories[draggedCatIndex].skills.splice(draggedSkillIndex, 1);
            categories[targetCatIndex].skills.splice(targetSkillIndex, 0, movedSkill);
            
            saveCategories();
            renderContent();
        }
    }
    
    // Tabs drop
    if (draggedTab) {
        const target = e.target.closest('.nav-tab');
        if (target && target !== draggedTab && target.draggable) {
            const targetIndex = parseInt(target.dataset.catIndex);
            
            const [movedCategory] = categories.splice(draggedTabIndex, 1);
            categories.splice(targetIndex, 0, movedCategory);
            
            if (activeTabIndex === draggedTabIndex) {
                activeTabIndex = targetIndex;
            } else if (draggedTabIndex < activeTabIndex && targetIndex >= activeTabIndex) {
                activeTabIndex--;
            } else if (draggedTabIndex > activeTabIndex && targetIndex <= activeTabIndex) {
                activeTabIndex++;
            }
            
            saveCategories();
            renderTabs();
            renderContent();
        }
    }
});

		
function loadUserData(userId) {
    // Hide container initially
    document.querySelector('.container').classList.remove('loaded');
    
    // Check if guide exists for this user
    get(ref(database, `users/${userId}/guides/${currentGuideId}`)).then((snapshot) => {
        if (!snapshot.exists()) {
            set(ref(database, `users/${userId}/guides/${currentGuideId}`), {
                appTitle, appSubtitle, appIcon, categories, checkedItems, themeColor
            });
        }
    });
    
    // Use Promise.all to wait for all data to load
    Promise.all([
        get(ref(database, `users/${userId}/guides/${currentGuideId}/categories`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/checkedItems`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/appTitle`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/appSubtitle`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/appIcon`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/themeColor`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/layoutMode`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/expandedCards`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/autoRefreshEnabled`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/autoRefreshTime`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/lastRefreshDate`)),
        get(ref(database, `users/${userId}/guides/${currentGuideId}/darkMode`))
    ]).then(([categoriesSnap, checkedSnap, titleSnap, subtitleSnap, iconSnap, themeSnap, layoutSnap, expandedSnap, autoRefreshEnabledSnap, autoRefreshTimeSnap, lastRefreshSnap, darkModeSnap]) => {
        
        // Load categories
        if (categoriesSnap.val()) {
            categories = categoriesSnap.val();
        }
        
        // Load checked items
        if (checkedSnap.val()) {
            checkedItems = checkedSnap.val();
        }
        
        // Load app title
        if (titleSnap.val()) {
            appTitle = titleSnap.val();
        }
        
        // Load app subtitle
        if (subtitleSnap.val()) {
            appSubtitle = subtitleSnap.val();
        }
        
        // Load app icon
        if (iconSnap.val() !== null) {
            appIcon = iconSnap.val();
        }
        
        // Load theme color
        if (themeSnap.val()) {
            themeColor = themeSnap.val();
        } else {
            themeColor = '#607d8b';
        }
        
        // Load layout mode
        if (layoutSnap.val()) {
            layoutMode = layoutSnap.val();
        }
        
        // Load expanded cards
        if (expandedSnap.val()) {
            expandedCards = expandedSnap.val();
        }
        
        // Load auto-refresh settings
        if (autoRefreshEnabledSnap.val() !== null) {
            autoRefreshEnabled = autoRefreshEnabledSnap.val();
        }
        if (autoRefreshTimeSnap.val()) {
            autoRefreshTime = autoRefreshTimeSnap.val();
        }
        
        // Load dark mode
        if (darkModeSnap.val() !== null) {
            darkMode = darkModeSnap.val();
        }
        
        // Check if we need to auto-refresh
        checkAndAutoRefresh(lastRefreshSnap.val());
        
        // Apply theme
        applyTheme();
        applyDarkMode();
        
        // Render everything
        renderHeader();
        renderTabs();
        renderContent();
        applyDarkMode();
        updateLayoutButton();
        
        // Show container with fade-in effect
        document.querySelector('.container').classList.add('loaded');
    });
}

function switchGuide(id) {
    currentGuideId = id;
    localStorage.setItem('currentGuideId', id);
    // Reset to default theme before loading
    themeColor = '#607d8b';
    loadUserData(currentUser.uid);
}
function applyTheme() {
    const theme = colorThemes.find(t => t.primary === themeColor);
    let primaryColor, secondaryColor;
    
    if (theme) {
        // Use preset theme
        primaryColor = theme.primary;
        secondaryColor = theme.secondary;
    } else {
        // Custom color - calculate darker shade
        primaryColor = themeColor;
        const hex = themeColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
    }
    
    // Determine if the theme is light
    const isLight = isLightColor(primaryColor);
    
    // For light themes, make secondary much darker for better contrast
    if (isLight) {
        const hex = primaryColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, Math.floor(r * 0.7));
        const darkerG = Math.max(0, Math.floor(g * 0.7));
        const darkerB = Math.max(0, Math.floor(b * 0.7));
        
        secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
    }
    
    // Set CSS variables
    document.documentElement.style.setProperty('--primary-color', primaryColor);
    document.documentElement.style.setProperty('--secondary-color', secondaryColor);
	// Set shadow with secondary color at 30% opacity
const hex = secondaryColor.replace('#', '');
const r = parseInt(hex.substr(0, 2), 16);
const g = parseInt(hex.substr(2, 2), 16);
const b = parseInt(hex.substr(4, 2), 16);
document.documentElement.style.setProperty('--shadow-color', `rgba(${r}, ${g}, ${b}, 0.3)`);
    
    // Set tab active color - use secondary for light themes
    document.documentElement.style.setProperty('--tab-active-color', isLight ? secondaryColor : primaryColor);

	// Set save button color - use secondary for light themes
    document.documentElement.style.setProperty('--save-btn-color', isLight ? secondaryColor : primaryColor);
	
    // Apply background gradient
    document.body.style.background = `linear-gradient(135deg, ${secondaryColor}CC 0%, ${primaryColor}CC 100%)`;
    
    // Apply header styling with adjusted text color
    const header = document.querySelector('.header');
    if (header) {
        header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${primaryColor} 100%)`;
        header.style.color = isLight ? '#2c3e50' : 'white';
        
        // Adjust all text elements in header
        const headerTexts = header.querySelectorAll('h1, p, .editable');
        headerTexts.forEach(el => {
            el.style.color = isLight ? '#2c3e50' : 'white';
        });
        
        // Adjust button colors in header
        const headerButtons = header.querySelectorAll('.edit-btn, .guide-menu-btn');
        headerButtons.forEach(btn => {
            btn.style.color = isLight ? '#2c3e50' : 'white';
        });
    }
    
    // Adjust floating button
    const floatingBtn = document.getElementById('layoutBtn');
    if (floatingBtn) {
        floatingBtn.style.backgroundColor = secondaryColor;
    }
}

function toggleColorPicker(e) {
    e.stopPropagation();
    const picker = document.getElementById('colorPickerMenu');
    picker.classList.toggle('show');
    
    if (picker.classList.contains('show')) {
        setTimeout(() => initColorPicker(), 10);
    }
}

function selectColor(color) {
    themeColor = color;
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/themeColor`), themeColor);
    applyTheme();
    renderHeader();
    
    // Close both color picker and dropdown menu
    document.getElementById('colorPickerMenu').classList.remove('show');
    document.getElementById('dropdownMenu').classList.remove('show');
}

function initColorPicker() {
    const canvas = document.getElementById('colorCanvas');
    const hueSlider = document.getElementById('hueSlider');
    const canvasIndicator = document.getElementById('canvasIndicator');
    const hueIndicator = document.getElementById('hueIndicator');
    const hexInput = document.getElementById('hexInput');
    const colorPreview = document.getElementById('colorPreview');
    
    if (!canvas || !hueSlider) return;
    
    let currentHue = 0;
    let currentSaturation = 100;
    let currentLightness = 50;
    
    // Convert current themeColor to HSL
    const rgb = hexToRgb(themeColor);
    if (rgb) {
        const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
        currentHue = hsl.h;
        currentSaturation = hsl.s;
        currentLightness = hsl.l;
        
        // Set initial positions
        hueIndicator.style.left = (currentHue / 360 * 100) + '%';
        
		// Calculate correct canvas position based on HSL
        // X-axis: Saturation (0 = left/white, 100 = right/full color)
        // Y-axis: Brightness (0 = top/bright, 100 = bottom/dark)
        const xPos = currentSaturation;
        const yPos = (1 - (currentLightness / 100)) * 100;
        
        canvasIndicator.style.left = Math.max(0, Math.min(100, xPos)) + '%';
        canvasIndicator.style.top = Math.max(0, Math.min(100, yPos)) + '%';
        canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
    }
    
// Hue slider interaction
function updateHue(clientX) {
        const rect = hueSlider.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const huePercent = (x / rect.width) * 100;
        currentHue = (huePercent / 100) * 360;
        
        hueIndicator.style.left = huePercent + '%';
        canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
        updateColor();
    }
    
    let hueActive = false;
    
    // Mouse events for hue slider
    hueSlider.addEventListener('mousedown', (e) => {
        hueActive = true;
        updateHue(e.clientX);
    });
    
    // Touch events for hue slider
    hueSlider.addEventListener('touchstart', (e) => {
        e.preventDefault();
        hueActive = true;
        updateHue(e.touches[0].clientX);
    });
    
    // Canvas interaction
    let canvasActive = false;
    
    function updateCanvas(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const x = Math.max(0, Math.min(clientX - rect.left, rect.width));
        const y = Math.max(0, Math.min(clientY - rect.top, rect.height));
        
        const xPercent = (x / rect.width) * 100;
        const yPercent = (y / rect.height) * 100;
        
        currentSaturation = xPercent;
        currentLightness = 50 - (yPercent - 50) * (50 / 50);
        
        canvasIndicator.style.left = xPercent + '%';
        canvasIndicator.style.top = yPercent + '%';
        updateColor();
    }
    
    // Mouse events for canvas
    canvas.addEventListener('mousedown', (e) => {
        canvasActive = true;
        updateCanvas(e.clientX, e.clientY);
    });
    
    // Touch events for canvas
    canvas.addEventListener('touchstart', (e) => {
        e.preventDefault();
        canvasActive = true;
        updateCanvas(e.touches[0].clientX, e.touches[0].clientY);
    });
    
    // Global mouse move and up
    document.addEventListener('mousemove', (e) => {
        if (hueActive) updateHue(e.clientX);
        if (canvasActive) updateCanvas(e.clientX, e.clientY);
    });
    
    document.addEventListener('mouseup', () => {
        hueActive = false;
        canvasActive = false;
    });
    
    // Global touch move and end
    document.addEventListener('touchmove', (e) => {
        if (hueActive) {
            e.preventDefault();
            updateHue(e.touches[0].clientX);
        }
        if (canvasActive) {
            e.preventDefault();
            updateCanvas(e.touches[0].clientX, e.touches[0].clientY);
        }
    }, { passive: false });
    
    document.addEventListener('touchend', () => {
        hueActive = false;
        canvasActive = false;
    });
    
    function updateColor() {
        const color = hslToHex(currentHue, currentSaturation, currentLightness);
        hexInput.value = color;
        colorPreview.style.backgroundColor = color;
    }
    
    // Hex input
    hexInput.addEventListener('input', (e) => {
        let value = e.target.value;
        if (!value.startsWith('#')) value = '#' + value;
        
        if (/^#[0-9A-Fa-f]{6}$/.test(value)) {
            colorPreview.style.backgroundColor = value;
            const rgb = hexToRgb(value);
            if (rgb) {
                const hsl = rgbToHsl(rgb.r, rgb.g, rgb.b);
                currentHue = hsl.h;
                currentSaturation = hsl.s;
                currentLightness = hsl.l;
                
                hueIndicator.style.left = (currentHue / 360 * 100) + '%';
                canvasIndicator.style.left = currentSaturation + '%';
                canvasIndicator.style.top = (100 - currentLightness * 2) + '%';
                canvas.style.backgroundColor = `hsl(${currentHue}, 100%, 50%)`;
            }
        }
    });
    
    hexInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
            applyCustomColor();
        }
    });
}

// Helper functions
function hexToRgb(hex) {
    const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
    return result ? {
        r: parseInt(result[1], 16),
        g: parseInt(result[2], 16),
        b: parseInt(result[3], 16)
    } : null;
}

function rgbToHsl(r, g, b) {
    r /= 255; g /= 255; b /= 255;
    const max = Math.max(r, g, b), min = Math.min(r, g, b);
    let h, s, l = (max + min) / 2;
    
    if (max === min) {
        h = s = 0;
    } else {
        const d = max - min;
        s = l > 0.5 ? d / (2 - max - min) : d / (max + min);
        switch (max) {
            case r: h = ((g - b) / d + (g < b ? 6 : 0)) / 6; break;
            case g: h = ((b - r) / d + 2) / 6; break;
            case b: h = ((r - g) / d + 4) / 6; break;
        }
    }
    
    return { h: h * 360, s: s * 100, l: l * 100 };
}

function hslToHex(h, s, l) {
    s /= 100; l /= 100;
    const c = (1 - Math.abs(2 * l - 1)) * s;
    const x = c * (1 - Math.abs((h / 60) % 2 - 1));
    const m = l - c / 2;
    let r = 0, g = 0, b = 0;
    
    if (h >= 0 && h < 60) { r = c; g = x; b = 0; }
    else if (h >= 60 && h < 120) { r = x; g = c; b = 0; }
    else if (h >= 120 && h < 180) { r = 0; g = c; b = x; }
    else if (h >= 180 && h < 240) { r = 0; g = x; b = c; }
    else if (h >= 240 && h < 300) { r = x; g = 0; b = c; }
    else if (h >= 300 && h < 360) { r = c; g = 0; b = x; }
    
    const toHex = (n) => {
        const hex = Math.round((n + m) * 255).toString(16);
        return hex.length === 1 ? '0' + hex : hex;
    };
    
    return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
}

function isLightColor(hex) {
    const rgb = hexToRgb(hex);
    if (!rgb) return false;
    
    // Calculate relative luminance
    const luminance = (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    return luminance > 0.6; // Returns true if color is light
}


function selectCustomColor(color) {
    // Find the closest matching theme or create a gradient
    const selectedTheme = colorThemes.find(t => t.primary === color);
    
    if (selectedTheme) {
        themeColor = selectedTheme.primary;
        applyTheme();
    } else {
        // Create a custom theme with a slightly darker shade for secondary
        themeColor = color;
        
        // Calculate a darker secondary color
        const hex = color.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        const secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
        
        // Update CSS variables directly for custom color
        document.documentElement.style.setProperty('--primary-color', color);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        
        // Update backgrounds
        document.body.style.background = `linear-gradient(135deg, ${secondaryColor}CC 0%, ${color}CC 100%)`;
        const header = document.querySelector('.header');
        if (header) {
            header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${color} 100%)`;
        }
    }
    
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/themeColor`), themeColor);
}


function applyCustomColor() {
    const hexInput = document.getElementById('hexInput');
    const color = hexInput.value;
    
    if (/^#[0-9A-Fa-f]{6}$/.test(color)) {
        selectCustomColor(color);
        // Close the color picker
        document.getElementById('colorPickerMenu').classList.remove('show');
        document.getElementById('dropdownMenu').classList.remove('show');
    } else {
        alert('Please enter a valid color code (e.g., #FF0000)');
    }
}
		
function createNewGuide() {
    if (!currentUser) return;
    const name = prompt("Enter a name for this new guide:");
    if (!name) return;
    
    // Show category selection
    const categoryList = guideCategories.map((cat, i) => `${i + 1}. ${cat.name}`).join('\n');
    const selection = prompt(`Select a category:\n\n${categoryList}\n\nEnter the number (1-${guideCategories.length}):`, '2');
    
    let selectedCategory = 'Notes'; // Default
    if (selection && !isNaN(selection)) {
        const index = parseInt(selection) - 1;
        if (index >= 0 && index < guideCategories.length) {
            selectedCategory = guideCategories[index].name;
        }
    }
    
    const id = `guide_${Date.now()}`;
    const newGuide = {
        appTitle: name,
        appSubtitle: "Click to edit subtitle",
        appIcon: "ðŸ“˜",
        category: selectedCategory,
        categories: [
            {
                name: "New Category",
                icon: "ðŸ“Œ",
                skills: [
                    { title: "New Skill", icon: "âœ¨", items: ["New item - click to edit"] }
                ]
            }
        ],
        checkedItems: {},
        themeColor: themeColor
    };
    set(ref(database, `users/${currentUser.uid}/guides/${id}`), newGuide).then(() => {
        currentGuideId = id;
        localStorage.setItem('currentGuideId', id);
        loadUserData(currentUser.uid);
    });
}

function changeGuideCategory() {
    if (!currentUser) return;
    
    const categoryList = guideCategories.map((cat, i) => `${i + 1}. ${cat.name}`).join('\n');
    const selection = prompt(`Select a category:\n\n${categoryList}\n\nEnter the number (1-${guideCategories.length}):`, '2');
    
    if (selection && !isNaN(selection)) {
        const index = parseInt(selection) - 1;
        if (index >= 0 && index < guideCategories.length) {
            const newCategory = guideCategories[index].name;
            set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/category`), newCategory);
            populateGuideDropdown();
            alert(`Category changed to: ${newCategory}`);
        }
    }
}
		
function closeDrawer() {
    const dropdown = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    const footer = document.getElementById('drawerFooter');
    const floatingBtn = document.getElementById('layoutBtn');
    
    dropdown.classList.remove('show');
    backdrop.classList.remove('show');
    dropdown.style.transform = '';
    backdrop.style.opacity = '';
    if (footer) footer.style.transform = ''; // Reset footer transform
    document.body.style.overflow = '';
    if (floatingBtn) floatingBtn.style.display = 'flex';
}

// Touch swipe to close drawer
let touchStartX = 0;
let touchCurrentX = 0;
let isDragging = false;

// Define handlers outside so they can be referenced
let handleDrawerTouchStart, handleDrawerTouchMove, handleDrawerTouchEnd;

function initDrawerSwipe() {
    const drawer = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    
    if (!drawer || !backdrop) return;
    
    // Remove old listeners if they exist
    if (handleDrawerTouchStart) {
        drawer.removeEventListener('touchstart', handleDrawerTouchStart);
        drawer.removeEventListener('touchmove', handleDrawerTouchMove);
        drawer.removeEventListener('touchend', handleDrawerTouchEnd);
    }
    
    // Touch start
    handleDrawerTouchStart = function(e) {
        // Allow swiping from anywhere on the drawer
        const footer = document.getElementById('drawerFooter');
        
        touchStartX = e.touches[0].clientX;
        touchCurrentX = touchStartX;
        isDragging = true;
        drawer.style.transition = 'none';
        if (footer) footer.style.transition = 'none';
    };
    
    // Touch move
    handleDrawerTouchMove = function(e) {
        if (!isDragging) return;
        
        touchCurrentX = e.touches[0].clientX;
        const deltaX = touchCurrentX - touchStartX;
        const footer = document.getElementById('drawerFooter');
        
        if (deltaX < 0) {
            drawer.style.transform = `translateX(${deltaX}px)`;
            if (footer) footer.style.transform = `translateX(${deltaX}px)`;
            
            const maxDrag = drawer.offsetWidth;
            const opacity = 1 - (Math.abs(deltaX) / maxDrag);
            backdrop.style.opacity = opacity;
        }
    };
    
    // Touch end
    handleDrawerTouchEnd = function(e) {
        if (!isDragging) return;
        
        const deltaX = touchCurrentX - touchStartX;
        const threshold = drawer.offsetWidth * 0.3;
        const footer = document.getElementById('drawerFooter');
        
        drawer.style.transition = 'transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';
        if (footer) footer.style.transition = 'transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1)';
        backdrop.style.transition = 'opacity 0.3s ease';
        
        if (Math.abs(deltaX) > threshold) {
            closeDrawer();
        } else {
            drawer.style.transform = 'translateX(0)';
            if (footer) footer.style.transform = 'translateX(0)';
            backdrop.style.opacity = '1';
        }
        
        isDragging = false;
    };
    
    drawer.addEventListener('touchstart', handleDrawerTouchStart, { passive: true });
    drawer.addEventListener('touchmove', handleDrawerTouchMove, { passive: true });
    drawer.addEventListener('touchend', handleDrawerTouchEnd);
    
    backdrop.addEventListener('touchstart', (e) => {
        closeDrawer();
    });
}

// Swipe to delete checklist items
let itemTouchStartX = 0;
let itemTouchCurrentX = 0;
let isItemDragging = false;
let currentSwipedItem = null;

document.addEventListener('touchstart', (e) => {
    const item = e.target.closest('.checklist-item');
    if (!item || editMode) return;
    
    // Don't interfere with checkbox clicks
    if (e.target.closest('.checkbox') || e.target.closest('.bullet-number') || 
        e.target.closest('.bullet-square') || e.target.closest('.bullet-circle')) {
        return;
    }
    
    itemTouchStartX = e.touches[0].clientX;
    itemTouchCurrentX = itemTouchStartX;
    isItemDragging = true;
    currentSwipedItem = item;
    item.style.transition = 'none';
}, { passive: true });

document.addEventListener('touchmove', (e) => {
    if (!isItemDragging || !currentSwipedItem) return;
    
    itemTouchCurrentX = e.touches[0].clientX;
    const deltaX = itemTouchCurrentX - itemTouchStartX;
    
    // Only allow swiping left (negative delta)
    if (deltaX < 0) {
        currentSwipedItem.style.transform = `translateX(${deltaX}px)`;
        
        // Show delete button background as user swipes
        const maxSwipe = 100;
        const swipeProgress = Math.min(Math.abs(deltaX) / maxSwipe, 1);
        currentSwipedItem.style.background = `linear-gradient(90deg, #f8f9fa ${100 - (swipeProgress * 100)}%, #fee2e2 100%)`;
    }
});

document.addEventListener('touchend', (e) => {
    if (!isItemDragging || !currentSwipedItem) return;
    
    const deltaX = itemTouchCurrentX - itemTouchStartX;
    const threshold = 80; // Swipe 80px to delete
    
    currentSwipedItem.style.transition = 'all 0.3s ease';
    
    if (deltaX < 0 && Math.abs(deltaX) > threshold) {
        // Delete the item with animation
        currentSwipedItem.style.transform = 'translateX(-100%)';
        currentSwipedItem.style.opacity = '0';
        
        // Get the data immediately before animation
        const catIndex = parseInt(currentSwipedItem.dataset.catIndex);
        const skillIndex = parseInt(currentSwipedItem.dataset.skillIndex);
        const itemIndex = parseInt(currentSwipedItem.dataset.itemIndex);
        
        setTimeout(() => {
            // Delete the item
            if (!isNaN(catIndex) && !isNaN(skillIndex) && !isNaN(itemIndex)) {
                categories[catIndex].skills[skillIndex].items.splice(itemIndex, 1);
                saveCategories();
                renderContent();
            }
        }, 300);
    } else {
        // Snap back
        currentSwipedItem.style.transform = 'translateX(0)';
        currentSwipedItem.style.background = '#f8f9fa';
    }
    
    isItemDragging = false;
    currentSwipedItem = null;
});

function toggleGuideMenu(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    const floatingBtn = document.getElementById('layoutBtn');
    
    const isShowing = dropdown.classList.contains('show');
    
    if (isShowing) {
        // Close drawer
        dropdown.classList.remove('show');
        backdrop.classList.remove('show');
        document.body.style.overflow = '';
        if (floatingBtn) floatingBtn.style.display = 'flex';
    } else {
        // Open drawer
        dropdown.classList.add('show');
        backdrop.classList.add('show');
        dropdown.style.transform = 'translateX(0)';
        backdrop.style.opacity = '1';
        const footer = document.getElementById('drawerFooter');
        if (footer) footer.style.transform = 'translateX(0)';
        document.body.style.overflow = 'hidden';
        if (floatingBtn) floatingBtn.style.display = 'none';
        
        // Initialize swipe after drawer is open
        setTimeout(() => initDrawerSwipe(), 100);
    }
    
    // Close other menus
    const otherMenu = document.getElementById('dropdownMenu');
    if (otherMenu) otherMenu.classList.remove('show');
}

function toggleMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById('dropdownMenu');
    const floatingBtn = document.getElementById('layoutBtn');
    const isCurrentlyShown = menu.classList.contains('show');
    
    menu.classList.toggle('show');
    
    // Hide/show floating button based on menu state
    if (floatingBtn) {
        if (menu.classList.contains('show')) {
            floatingBtn.style.display = 'none';
        } else {
            floatingBtn.style.display = 'flex';
        }
    }
    
    // Close other menus
    const guideMenu = document.getElementById('guideDropdown');
    if (guideMenu) guideMenu.classList.remove('show');
    
    // If we just closed it, trigger a re-render to reset button state
    if (isCurrentlyShown) {
        // Force button to lose focus
        e.target.blur();
    }
}

// Authentication functions
function login(email, password) {
    signInWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            loadUserData(currentUser.uid);
        })
        .catch((error) => {
            alert('Login failed: ' + error.message);
        });
}

function signup(email, password) {
    createUserWithEmailAndPassword(auth, email, password)
        .then((userCredential) => {
            currentUser = userCredential.user;
            loadUserData(currentUser.uid);
        })
        .catch((error) => {
            alert('Signup failed: ' + error.message);
        });
}

function loginWithGoogle() {
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({
        prompt: 'select_account'
    });
    signInWithPopup(auth, provider)
        .then((result) => {
            currentUser = result.user;
            loadUserData(currentUser.uid);
        })
        .catch((error) => {
            console.error('Google login error:', error);
            alert('Google login failed: ' + error.message);
        });
}

function logout() {
    signOut(auth).then(() => {
        currentUser = null;
        categories = [];
    });
}

function showSignup() {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    
    loginScreen.classList.remove('show');
    setTimeout(() => {
        loginScreen.style.display = 'none';
        signupScreen.style.display = 'flex';
        setTimeout(() => signupScreen.classList.add('show'), 10);
    }, 300);
}
function processSignup() {
    const email = document.getElementById('signupEmail').value;
    const password = document.getElementById('signupPassword').value;
    const confirmPassword = document.getElementById('signupPasswordConfirm').value;
    
    if (!email || !password) {
        alert('Please enter email and password');
        return;
    }
    
    if (password.length < 6) {
        alert('Password must be at least 6 characters long');
        return;
    }
    
    if (password !== confirmPassword) {
        alert('Passwords do not match');
        return;
    }
    
    signup(email, password);
}

function backToLogin() {
    const loginScreen = document.getElementById('loginScreen');
    const signupScreen = document.getElementById('signupScreen');
    
    signupScreen.classList.remove('show');
    setTimeout(() => {
        signupScreen.style.display = 'none';
        loginScreen.style.display = 'flex';
        setTimeout(() => loginScreen.classList.add('show'), 10);
    }, 300);
}
function duplicateGuide() {
    if (!currentUser) return;
    const timestamp = Date.now();
    const newId = `${currentGuideId}_copy_${timestamp}`;
    
    get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}`)).then((snapshot) => {
        const data = snapshot.val();
        if (data.appTitle) {
            data.appTitle = data.appTitle + ' (Copy)';
        }
        // Make sure category is preserved
        if (!data.category) {
            data.category = 'Notes';
        }
        set(ref(database, `users/${currentUser.uid}/guides/${newId}`), data).then(() => {
            currentGuideId = newId;
            localStorage.setItem('currentGuideId', newId);
            loadUserData(currentUser.uid);
        });
    });
}

function deleteGuide() {
    if (!currentUser) return;
    if (currentGuideId === 'defaultGuide') {
        alert("Cannot delete the default guide!");
        return;
    }
    if (confirm("Delete this entire guide? This cannot be undone.")) {
        remove(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}`));
        currentGuideId = 'defaultGuide';
        localStorage.setItem('currentGuideId', 'defaultGuide');
        loadUserData(currentUser.uid);
    }
}

function deleteAccount() {
    if (!currentUser) return;
    
    const confirmation = prompt('âš ï¸ WARNING: This will permanently delete your account and ALL your data.\n\nType "DELETE" to confirm:');
    
    if (confirmation === 'DELETE') {
        const finalConfirm = confirm('Are you absolutely sure? This cannot be undone!');
        
        if (finalConfirm) {
            // Delete all user data from database
            remove(ref(database, `users/${currentUser.uid}`))
                .then(() => {
                    // Delete the user account
                    return currentUser.delete();
                })
                .then(() => {
                    alert('Your account has been deleted.');
                    closeDrawer();
                })
                .catch((error) => {
                    if (error.code === 'auth/requires-recent-login') {
                        alert('For security, please log out and log back in, then try deleting your account again.');
                    } else {
                        alert('Error deleting account: ' + error.message);
                    }
                });
        }
    }
}

	
function saveHeader() {
  if (!currentUser) return;
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appTitle`), appTitle);
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appSubtitle`), appSubtitle);
  set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/appIcon`), appIcon);
  renderHeader();
  populateGuideDropdown();
}

function renderHeader() {
    const header = document.querySelector('.header');
    
    // Generate color options HTML
    let colorOptionsHTML = '';
    colorThemes.forEach(theme => {
        const isSelected = theme.primary === themeColor ? 'selected' : '';
        colorOptionsHTML += `
            <div class="color-option ${isSelected}" 
                 style="background: linear-gradient(135deg, ${theme.secondary} 0%, ${theme.primary} 100%);"
                 data-color="${theme.primary}"
                 title="${theme.name}">
            </div>
        `;
    });
    
    header.innerHTML = `
<button class="guide-menu-btn" id="guideMenuBtn">â˜°</button>
<div id="drawerBackdrop" class="drawer-backdrop"></div>
<div class="guide-dropdown" id="guideDropdown">
    <div class="drawer-header">
    <svg viewBox="0 0 28 28" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" style="width: 20px; height: 20px; margin-right: 8px; display: inline-block; vertical-align: middle;">
        <rect x="2" y="2" width="10.5" height="10.5" rx="1"></rect>
        <rect x="16" y="5" width="7" height="7" rx="1"></rect>
        <rect x="3.6" y="16" width="8.4" height="8.4" rx="1"></rect>
        <rect x="16" y="16" width="7" height="7" rx="1"></rect>
    </svg>
    My Notebook
</div>
</div>
<div class="drawer-footer" id="drawerFooter">
    <button id="logoutMenuBtn" style="background: none; border: none; cursor: pointer; padding: 0; margin-right: auto; opacity: 0.5; transition: opacity 0.2s;">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="#dc2626" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
            <polyline points="16 17 21 12 16 7"></polyline>
            <line x1="21" y1="12" x2="9" y2="12"></line>
        </svg>
    </button>
    
    <!-- Logout popup menu -->
    <div class="logout-menu" id="logoutMenu">
        <button id="logoutBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
                <polyline points="16 17 21 12 16 7"></polyline>
                <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            Logout
        </button>
        <button id="deleteAccountBtn">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M3 6h18"></path>
                <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"></path>
                <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"></path>
                <line x1="10" y1="11" x2="10" y2="17"></line>
                <line x1="14" y1="11" x2="14" y2="17"></line>
            </svg>
            Delete Account
        </button>
    </div>
    
    <button class="drawer-create-icon" id="createGuideBtn">
        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path>
        </svg>
    </button>
</div>
<div class="edit-toggle">
    <button class="save-btn" id="saveBtn" style="display: none;">Done</button>
    <button class="edit-btn" id="menuBtn" style="display: block;">â‹®</button>
<div class="dropdown-menu" id="dropdownMenu">
    <button id="editModeMenuBtn">Edit</button>
    <button id="duplicateGuideBtn">Duplicate</button>
    <button id="deleteGuideBtn">Delete</button>
	<button id="moveCategoryBtn">Move</button>
	<button id="toggleColorBtn">Theme</button>
	<button id="toggleDarkModeBtn">${darkMode ? 'â˜€ï¸ Light Mode' : 'ðŸŒ™ Dark Mode'}</button>
	<div class="color-picker-menu" id="colorPickerMenu">
	    <h3>Preset Themes</h3>
	    <div class="color-options" id="colorOptionsContainer" style="margin-bottom: 15px;">
	        ${colorOptionsHTML}
	    </div>
	    <h3>Custom Color</h3>
	    <div style="margin-bottom: 15px;">
	        <div id="colorCanvas" class="color-picker-canvas" style="background-color: hsl(0, 100%, 50%);">
	            <div class="picker-indicator" id="canvasIndicator" style="left: 100%; top: 0%;"></div>
	        </div>
	        <div class="hue-slider" id="hueSlider">
	            <div class="hue-indicator" id="hueIndicator" style="left: 0%;"></div>
	        </div>
	        <div style="display: flex; align-items: center; gap: 10px;">
	            <div style="width: 32px; height: 32px; border-radius: 6px; border: 2px solid #dee2e6; background-color: ${themeColor}; flex-shrink: 0;" id="colorPreview"></div>
	            <input type="text" id="hexInput" value="${themeColor}" 
	                   style="flex: 1; padding: 6px 8px; border: 1px solid #dee2e6; border-radius: 4px; font-family: monospace; font-size: 12px; text-transform: uppercase;"
	                   maxlength="7" placeholder="#FF0000">
	            <button id="applyColorBtn" style="padding: 6px 16px; background: #27ae60; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; font-weight: 600; white-space: nowrap;">Done</button>
	        </div>
	    </div>
	</div>
	    <button id="clearChecksBtn">Clear all checks</button>
	    <button id="autoRefreshBtn">
	        ${autoRefreshEnabled ? `âœ“ Auto-refresh (${autoRefreshTime})` : 'Auto-refresh daily'}
	    </button>
	</div>
</div>
</div>
		<div class="dropdown-menu" id="categoryMenu" style="display: none;">
		    <button data-category="Habits">Habits</button>
		    <button data-category="Notes">Notes</button>
		    <button data-category="To-Do">To-Do</button>
		    <button data-category="Tracking">Tracking</button>
		    <button data-category="Recipes">Recipes</button>
		    <button data-category="Goals">Goals</button>
		    <button data-category="Journaling">Journaling</button>
		    <button data-category="Other">Other</button>
		</div>
<h1>
    <span class="editable-icon" id="appIconContainer" style="display: inline-block; position: relative; margin-right: 8px;">
        <span class="icon" id="appIconSpan" style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${appIcon && appIcon !== "â€‹" ? '1' : '0.3'};">${
            (() => {
                const hasIconContent = appIcon && appIcon !== "â€‹";
                if (hasIconContent) {
                    if (appIcon.startsWith('svg:')) {
                        const iconData = JSON.parse(appIcon.substring(4));
                        return `<span style="display: inline-flex; width: 28px; height: 28px; background: ${iconData.bg}; border-radius: 6px; align-items: center; justify-content: center;"><svg width="20" height="20" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
                    } else {
                        return appIcon;
                    }
                } else {
                    return editMode ? "+" : "â€‹";
                }
            })()
        }</span>
        ${editMode && appIcon && appIcon !== "â€‹" ? '<span class="emoji-remove-btn" id="removeAppIconBtn">Ã—</span>' : ''}
    </span>
    <span class="${editMode ? 'editable' : ''}" id="appTitleSpan" contenteditable="${editMode}">
        ${appTitle}
    </span>
</h1>
<p class="${editMode ? 'editable' : ''}" id="appSubtitleSpan" contenteditable="${editMode}">${appSubtitle}</p>
    `;

    // Add event listeners after HTML is rendered
    const guideMenuBtn = document.getElementById('guideMenuBtn');
    const drawerBackdrop = document.getElementById('drawerBackdrop');
    const createGuideBtn = document.getElementById('createGuideBtn');
    const logoutBtn = document.getElementById('logoutMenuBtn');  // Changed from 'logoutBtn' to match new ID
	const logoutMenu = document.getElementById('logoutMenu');
	const logoutConfirmBtn = document.getElementById('logoutBtn');  // The actual logout button inside menu
	const deleteAccountBtn = document.getElementById('deleteAccountBtn');
    const saveBtn = document.getElementById('saveBtn');
    const menuBtn = document.getElementById('menuBtn');
    const editModeMenuBtn = document.getElementById('editModeMenuBtn');
    const duplicateGuideBtn = document.getElementById('duplicateGuideBtn');
    const deleteGuideBtn = document.getElementById('deleteGuideBtn');
    const moveCategoryBtn = document.getElementById('moveCategoryBtn');
    const toggleColorBtn = document.getElementById('toggleColorBtn');
    const toggleDarkModeBtn = document.getElementById('toggleDarkModeBtn');
    const clearChecksBtn = document.getElementById('clearChecksBtn');
    const autoRefreshBtn = document.getElementById('autoRefreshBtn');
    const applyColorBtn = document.getElementById('applyColorBtn');
    const appIconSpan = document.getElementById('appIconSpan');
    const removeAppIconBtn = document.getElementById('removeAppIconBtn');

	if (logoutBtn) { logoutBtn.addEventListener('click', (e) => { e.stopPropagation(); logoutMenu.classList.toggle('show'); });}
	if (logoutConfirmBtn) {logoutConfirmBtn.addEventListener('click', () => { logout(); logoutMenu.classList.remove('show'); closeDrawer(); });}
	if (deleteAccountBtn) { deleteAccountBtn.addEventListener('click', () => {logoutMenu.classList.remove('show'); deleteAccount(); });}
	if (guideMenuBtn) guideMenuBtn.addEventListener('click', toggleGuideMenu);
	if (drawerBackdrop) drawerBackdrop.addEventListener('click', closeDrawer);
	if (createGuideBtn) { createGuideBtn.addEventListener('click', () => { createNewGuide(); closeDrawer();}); }
	if (saveBtn) saveBtn.addEventListener('click', saveAndExitEdit);
	if (menuBtn) menuBtn.addEventListener('click', toggleMenu);
	if (editModeMenuBtn) editModeMenuBtn.addEventListener('click', toggleEditMode);
	if (duplicateGuideBtn) duplicateGuideBtn.addEventListener('click', duplicateGuide);
	if (deleteGuideBtn) deleteGuideBtn.addEventListener('click', deleteGuide);
	if (moveCategoryBtn) {
	    moveCategoryBtn.addEventListener('click', (e) => {
	        e.stopPropagation();
	        const mainMenu = document.getElementById('dropdownMenu');
	        const categoryMenu = document.getElementById('categoryMenu');
	        
	        // Position category menu at same location as main menu
	        const rect = mainMenu.getBoundingClientRect();
	        categoryMenu.style.top = rect.top + 'px';
	        categoryMenu.style.right = (window.innerWidth - rect.right) + 'px';
	        
	        mainMenu.classList.remove('show');
	        categoryMenu.classList.add('show');
	    });
	}
	
	// Add click handlers for category buttons
	document.querySelectorAll('#categoryMenu button').forEach(btn => {
	    btn.addEventListener('click', (e) => {
	        e.stopPropagation();
	        const newCategory = btn.dataset.category;
	        if (currentUser) {
	            set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/category`), newCategory);
	            document.getElementById('categoryMenu').classList.remove('show');
	            populateGuideDropdown();
	            alert(`Moved to: ${newCategory}`);
	        }
	    });
	});
	if (toggleColorBtn) toggleColorBtn.addEventListener('click', toggleColorPicker);
	if (toggleDarkModeBtn) toggleDarkModeBtn.addEventListener('click', toggleDarkMode);
	if (clearChecksBtn) clearChecksBtn.addEventListener('click', clearAllChecks);
	if (autoRefreshBtn) autoRefreshBtn.addEventListener('click', toggleAutoRefresh);
	if (applyColorBtn) applyColorBtn.addEventListener('click', applyCustomColor);


    
    // App icon editing
    if (editMode && appIconSpan) {
        appIconSpan.addEventListener('click', (e) => {
            e.stopPropagation();
            editAppIcon(appIconSpan);
        });
    }
    if (removeAppIconBtn) {
        removeAppIconBtn.addEventListener('click', (e) => {
            e.stopPropagation();
            appIcon = 'â€‹';
            saveHeader();
        });
    }
    
    // Color option clicks
    const colorOptions = document.querySelectorAll('.color-option');
    colorOptions.forEach(option => {
        option.addEventListener('click', () => {
            selectColor(option.dataset.color);
        });
    });
    
	// Dynamic styles and theme application...
	    const isLight = isLightColor(themeColor);
	    if (isLight) {
	        const style = document.createElement('style');
	        style.id = 'dynamic-header-style';
	        const existingStyle = document.getElementById('dynamic-header-style');
	        if (existingStyle) existingStyle.remove();
	        
	        style.textContent = `
	            .header .editable:focus { 
	                outline: 2px solid #2c3e50 !important; 
	                background: rgba(255, 255, 255, 0.5) !important; 
	                color: #2c3e50 !important; 
	            }
	            .header .editable:hover { 
	                background: rgba(0, 0, 0, 0.1) !important; 
	            }
	        `;
	        document.head.appendChild(style);
	    } else {
	        const existingStyle = document.getElementById('dynamic-header-style');
	        if (existingStyle) existingStyle.remove();
	    }

    applyTheme();
    populateGuideDropdown();

    // Add double-click edit for header (only when not in edit mode)
    if (!editMode) {
        const h1 = header.querySelector('h1');
        const spans = h1 ? h1.querySelectorAll('span') : [];
        const headerTitle = spans.length > 0 ? spans[spans.length - 1] : null;
        const headerSubtitle = header.querySelector('p');
        
        if (headerTitle) {
            headerTitle.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                e.preventDefault();
                enableQuickEditHeader(headerTitle, 'title');
            });
        }
        
        if (headerSubtitle) {
            headerSubtitle.addEventListener('dblclick', (e) => {
                e.stopPropagation();
                e.preventDefault();
                enableQuickEditHeader(headerSubtitle, 'subtitle');
            });
        }
    }

    if (editMode) {
        setTimeout(() => {
            const saveBtn = document.getElementById('saveBtn');
            const menuBtn = document.getElementById('menuBtn');
            if (saveBtn) saveBtn.style.display = 'block';
            if (menuBtn) menuBtn.style.display = 'none';
        }, 0);
    }
    
    if (editMode) {
        const editableTitle = header.querySelector('#appTitleSpan');
        const editableSubtitle = header.querySelector('#appSubtitleSpan');
        
        if (editableTitle) {
            editableTitle.addEventListener('blur', (e) => {
                appTitle = e.target.textContent.trim();
                saveHeader();
            });
        }
        if (editableSubtitle) {
            editableSubtitle.addEventListener('blur', (e) => {
                appSubtitle = e.target.textContent.trim();
                saveHeader();
            });
        }
    }
    
    if (!editMode) {
        setTimeout(() => initDrawerSwipe(), 100);
    }
}

function populateGuideDropdown() {
    if (!currentUser) return;
    
    get(ref(database, `users/${currentUser.uid}/guides`)).then((snapshot) => {
        const guides = snapshot.val() || {};
        const dropdown = document.getElementById('guideDropdown');
        
        // Keep header, clear only list
        const header = dropdown.querySelector('.drawer-header');
        dropdown.innerHTML = '';
        if (header) dropdown.appendChild(header);
        
        // Group guides by category
		const groupedGuides = {};
		guideCategories.forEach(cat => groupedGuides[cat.name] = []);
		groupedGuides['Other'] = [];
		
		for (let id in guides) {
		    const guide = guides[id];
		    const category = guide.category || 'Other';
		    if (!groupedGuides[category]) {
		        groupedGuides['Uncategorized'].push({id, guide});
		    } else {
		        groupedGuides[category].push({id, guide});
		    }
		}
        
        // Render each category group
		const categoryNames = guideCategories.map(cat => cat.name).concat(['Other']);
		categoryNames.forEach(categoryName => {
		    const guidesInCategory = groupedGuides[categoryName];
		    if (guidesInCategory.length === 0) return;
		    
		    // Add category header with icon
		    const categoryHeader = document.createElement('div');
		    categoryHeader.style.padding = '16px 16px 8px';
		    categoryHeader.style.fontSize = '22px';
		    categoryHeader.style.fontWeight = 'bold';
		    categoryHeader.style.color = '#9ca3af';
		    categoryHeader.style.textTransform = 'uppercase';
		    categoryHeader.style.letterSpacing = '0.5px';
		    categoryHeader.style.display = 'flex';
		    categoryHeader.style.alignItems = 'center';
		    categoryHeader.style.gap = '8px';
		    
		    // Find the category icon
		    const categoryData = guideCategories.find(cat => cat.name === categoryName);
		    if (categoryData) {
		        const iconSvg = `<svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="#9ca3af" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="${categoryData.icon}"/></svg>`;
		        categoryHeader.innerHTML = iconSvg + `<span>${categoryName}</span>`;
		    } else {
		        categoryHeader.textContent = categoryName;
		    }
		    dropdown.appendChild(categoryHeader);
		    
		    // Add guides in this category
		    guidesInCategory.forEach(({id, guide}) => {
                const title = guide.appTitle || id;
                const icon = guide.appIcon || 'ðŸ“„';
                const guideTheme = guide.themeColor || '#3498db';
                
                const btn = document.createElement('button');
                btn.className = 'guide-item';
                btn.dataset.guideId = id;
                btn.style.borderLeft = `4px solid ${guideTheme}`;
                btn.style.background = `linear-gradient(90deg, ${guideTheme}15 0%, transparent 100%)`;
                btn.style.display = 'flex';
                btn.style.alignItems = 'center';
                btn.style.justifyContent = 'space-between';
                btn.style.margin = '2px 0';
                btn.style.padding = '8px 12px 8px 20px';
                
                const nameSpan = document.createElement('span');
                if (icon.startsWith('svg:')) {
                    const iconData = JSON.parse(icon.substring(4));
                    nameSpan.innerHTML = `<span style="display: inline-flex; width: 18px; height: 18px; background: ${iconData.bg}; border-radius: 3px; align-items: center; justify-content: center; margin-right: 8px;"><svg width="12" height="12" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span> ${title}`;
                } else {
                    nameSpan.textContent = `${icon} ${title}`;
                }
                btn.appendChild(nameSpan);
                
                if (editMode && id !== 'defaultGuide') {
                    const delBtn = document.createElement('span');
                    delBtn.textContent = 'del';
                    delBtn.style.background = '#e74c3c';
                    delBtn.style.color = '#f8f9fa';
                    delBtn.style.padding = '4px 10px';
                    delBtn.style.borderRadius = '6px';
                    delBtn.style.fontSize = '12px';
                    delBtn.style.fontWeight = 'bold';
                    delBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        if (confirm(`Delete guide "${title}"? This cannot be undone.`)) {
                            remove(ref(database, `users/${currentUser.uid}/guides/${id}`));
                            if (currentGuideId === id) {
                                currentGuideId = 'defaultGuide';
                                loadUserData(currentUser.uid);
                            } else {
                                populateGuideDropdown();
                            }
                        }
                    });
                    btn.appendChild(delBtn);
                }
                
                btn.addEventListener('click', (e) => {
                    if (!e.target.textContent.includes('del')) {
                        switchGuide(id);
                        closeDrawer();
                    }
                });
                
                if (id === currentGuideId) {
                    btn.classList.add('current-guide');
                    const isLight = isLightColor(guideTheme);
                    btn.style.color = isLight ? 'var(--secondary-color)' : guideTheme;
                    btn.style.fontWeight = '700';
                    btn.style.fontSize = '15px';
                    btn.style.background = `linear-gradient(90deg, ${guideTheme}35 0%, transparent 100%)`;
                    const iconElement = nameSpan.querySelector('span') || nameSpan.childNodes[0];
                    if (iconElement) {
                        if (icon.startsWith('svg:')) {
                            iconElement.style.transform = 'scale(1.15)';
                        } else {
                            nameSpan.style.fontSize = '16px';
                        }
                    }
                }

                // Enable drag-and-drop when NOT in edit mode
                if (!editMode) {
                    btn.draggable = true;
                    btn.style.cursor = 'grab';
                    btn.addEventListener('dragstart', handleDragStart.bind(btn));
                    btn.addEventListener('dragend', handleDragEnd.bind(btn));
                    btn.addEventListener('dragenter', handleDragEnter.bind(btn));
                    btn.addEventListener('dragover', handleDragOver.bind(btn));
                    btn.addEventListener('drop', handleDrop.bind(btn));
                    btn.addEventListener('dragleave', handleDragLeave.bind(btn));
                }

                dropdown.appendChild(btn);
            });
        });
    });
}

// Drag and drop for category tabs
let draggedTab = null;
let draggedTabIndex = null;

// Reuse these same handlers for drawer items
function handleDragStart(e) {
    draggedElement = this;
    this.classList.add('dragging');
    e.dataTransfer.effectAllowed = 'move';
    e.dataTransfer.setData('text/plain', this.dataset.guideId || this.dataset.catIndex);

    // Create and insert a placeholder element
    placeholder = document.createElement('div');
    placeholder.className = 'guide-placeholder';
    placeholder.style.height = `${this.offsetHeight}px`;
    placeholder.style.border = '2px dashed #aaa';
    placeholder.style.borderRadius = '6px';
    placeholder.style.margin = '4px 0';
    this.parentNode.insertBefore(placeholder, this.nextSibling);
}

function handleDragEnd(e) {
    this.classList.remove('dragging');
    document.querySelectorAll('.guide-item').forEach(item => item.classList.remove('drag-over'));
    
    // Remove placeholder
    if (placeholder && placeholder.parentNode) {
        placeholder.parentNode.removeChild(placeholder);
    }
    placeholder = null;
    draggedElement = null;
}

function handleDragEnter(e) {
    e.preventDefault();
    if (!draggedElement || this === draggedElement) return;

    const parent = this.parentNode;
    const items = Array.from(parent.querySelectorAll('.guide-item'));
    const draggedIndex = items.indexOf(draggedElement);
    const targetIndex = items.indexOf(this);

    // Move placeholder visually
    if (draggedIndex < targetIndex) {
        parent.insertBefore(placeholder, this.nextSibling);
    } else {
        parent.insertBefore(placeholder, this);
    }
}

function handleDragOver(e) {
    e.preventDefault();
}

function handleDrop(e) {
    e.stopPropagation();
    if (!placeholder || !draggedElement || !currentUser) return false;

    const parent = placeholder.parentNode;
    parent.insertBefore(draggedElement, placeholder);
    placeholder.remove();

    // Save new order to Firebase
    const newOrder = Array.from(parent.querySelectorAll('.guide-item'))
        .map(item => item.dataset.guideId);
    set(ref(database, `users/${currentUser.uid}/guideOrder`), newOrder).then(() => {
        console.log('Guide order saved');
    });

    draggedElement.classList.remove('dragging');
    draggedElement = null;
    placeholder = null;

    return false;
}

function handleDragLeave(e) {
    this.classList.remove('drag-over');
}


function saveAndExitEdit() {
    editMode = false;
    document.body.classList.remove('edit-mode-active');
    
    // Hide save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.style.display = 'none';
    }
    
    renderHeader();
    renderTabs();
    renderContent();
}
		
function showEmojiPicker(target, callback) {
    const existingInput = document.querySelector('.emoji-input-field');
    if (existingInput) {
        existingInput.remove();
        return;
    }
    
    const inputWrapper = document.createElement('div');
    inputWrapper.style.position = 'fixed';
    inputWrapper.style.top = '50%';
    inputWrapper.style.left = '50%';
    inputWrapper.style.transform = 'translate(-50%, -50%)';
    inputWrapper.style.background = 'white';
    inputWrapper.style.padding = '20px';
    inputWrapper.style.borderRadius = '12px';
    inputWrapper.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
    inputWrapper.style.zIndex = '10000';
    inputWrapper.style.maxWidth = '500px';
    inputWrapper.style.maxHeight = '80vh';
    inputWrapper.style.overflowY = 'auto';
    inputWrapper.className = 'emoji-input-field';
    
    // Prevent clicks inside from bubbling
    inputWrapper.addEventListener('click', (e) => e.stopPropagation());
    
    // Tabs
    const tabContainer = document.createElement('div');
    tabContainer.style.display = 'flex';
    tabContainer.style.gap = '10px';
    tabContainer.style.marginBottom = '15px';
    tabContainer.style.borderBottom = '2px solid #e0e0e0';
    
    const emojiTab = document.createElement('button');
    emojiTab.textContent = 'ðŸ˜€ Emoji';
    emojiTab.style.flex = '1';
    emojiTab.style.padding = '10px';
    emojiTab.style.border = 'none';
    emojiTab.style.background = 'none';
    emojiTab.style.cursor = 'pointer';
    emojiTab.style.borderBottom = '3px solid #3498db';
    emojiTab.style.fontWeight = 'bold';
    emojiTab.style.color = '#3498db';
    
    const iconTab = document.createElement('button');
    iconTab.textContent = 'ðŸŽ¨ Icons';
    iconTab.style.flex = '1';
    iconTab.style.padding = '10px';
    iconTab.style.border = 'none';
    iconTab.style.background = 'none';
    iconTab.style.cursor = 'pointer';
    iconTab.style.color = '#666';
    
    tabContainer.appendChild(emojiTab);
    tabContainer.appendChild(iconTab);
    inputWrapper.appendChild(tabContainer);
    
    // Content containers
    const emojiContent = document.createElement('div');
    const iconContent = document.createElement('div');
    iconContent.style.display = 'none';
    
    // Emoji input section
    const label = document.createElement('div');
    label.textContent = 'Paste or type emoji:';
    label.style.marginBottom = '10px';
    label.style.fontSize = '14px';
    label.style.color = '#2c3e50';
    emojiContent.appendChild(label);
    
    const input = document.createElement('input');
    input.type = 'text';
    input.maxLength = 20;
    input.style.fontSize = '32px';
    input.style.width = '100%';
    input.style.textAlign = 'center';
    input.style.border = '2px solid #3498db';
    input.style.borderRadius = '8px';
    input.style.padding = '10px';
    input.style.outline = 'none';
    input.placeholder = 'âœ…';
    
    input.addEventListener('input', (e) => {
        const value = e.target.value;
        const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)(\u200D(\p{Emoji_Presentation}|\p{Emoji}\uFE0F))*(\p{Emoji_Modifier})?/gu;
        const matches = value.match(emojiRegex);
        
        if (matches && matches.length > 0) {
            e.target.value = matches[0];
        } else if (value.length > 0) {
            e.target.value = '';
        }
    });
    
    emojiContent.appendChild(input);
    
    // Icon grid
    const iconGrid = document.createElement('div');
    iconGrid.style.display = 'grid';
    iconGrid.style.gridTemplateColumns = 'repeat(auto-fill, minmax(60px, 1fr))';
    iconGrid.style.gap = '10px';
    iconGrid.style.maxHeight = '300px';
    iconGrid.style.overflowY = 'auto';
    
    svgIcons.forEach(icon => {
        const iconBtn = document.createElement('button');
        iconBtn.style.width = '60px';
        iconBtn.style.height = '60px';
        iconBtn.style.borderRadius = '8px';
        iconBtn.style.border = '2px solid transparent';
        iconBtn.style.cursor = 'pointer';
        iconBtn.style.backgroundColor = icon.bg;
        iconBtn.style.display = 'flex';
        iconBtn.style.alignItems = 'center';
        iconBtn.style.justifyContent = 'center';
        iconBtn.style.transition = 'all 0.2s';
        iconBtn.title = icon.name;
        
        iconBtn.innerHTML = `<svg width="32" height="32" viewBox="0 0 24 24" fill="white"><path d="${icon.path}"/></svg>`;
        
        iconBtn.addEventListener('mouseover', () => {
            iconBtn.style.transform = 'scale(1.1)';
            iconBtn.style.borderColor = '#3498db';
        });
        iconBtn.addEventListener('mouseout', () => {
            iconBtn.style.transform = 'scale(1)';
            iconBtn.style.borderColor = 'transparent';
        });
        
        iconBtn.addEventListener('click', () => {
            // Store as SVG data
            callback(`svg:${JSON.stringify({name: icon.name, bg: icon.bg, path: icon.path})}`);
            inputWrapper.remove();
        });
        
        iconGrid.appendChild(iconBtn);
    });
    
    iconContent.appendChild(iconGrid);
    
    inputWrapper.appendChild(emojiContent);
    inputWrapper.appendChild(iconContent);
    
    // Tab switching
    emojiTab.addEventListener('click', () => {
        emojiTab.style.borderBottom = '3px solid #3498db';
        emojiTab.style.fontWeight = 'bold';
        emojiTab.style.color = '#3498db';
        iconTab.style.borderBottom = 'none';
        iconTab.style.fontWeight = 'normal';
        iconTab.style.color = '#666';
        emojiContent.style.display = 'block';
        iconContent.style.display = 'none';
    });
    
    iconTab.addEventListener('click', () => {
        iconTab.style.borderBottom = '3px solid #3498db';
        iconTab.style.fontWeight = 'bold';
        iconTab.style.color = '#3498db';
        emojiTab.style.borderBottom = 'none';
        emojiTab.style.fontWeight = 'normal';
        emojiTab.style.color = '#666';
        iconContent.style.display = 'block';
        emojiContent.style.display = 'none';
    });
    
    // Buttons
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '15px';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.gap = '10px';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Confirm';
    confirmBtn.style.flex = '1';
    confirmBtn.style.padding = '8px';
    confirmBtn.style.background = '#27ae60';
    confirmBtn.style.color = 'white';
    confirmBtn.style.border = 'none';
    confirmBtn.style.borderRadius = '6px';
    confirmBtn.style.cursor = 'pointer';
    confirmBtn.addEventListener('click', () => {
        if (input.value) {
            callback(input.value);
        }
        inputWrapper.remove();
    });
    buttonContainer.appendChild(confirmBtn);
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.flex = '1';
    cancelBtn.style.padding = '8px';
    cancelBtn.style.background = '#95a5a6';
    cancelBtn.style.color = 'white';
    cancelBtn.style.border = 'none';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.addEventListener('click', () => inputWrapper.remove());
    buttonContainer.appendChild(cancelBtn);
    
    emojiContent.appendChild(buttonContainer);
    
    document.body.appendChild(inputWrapper);
    input.focus();
    
    setTimeout(() => {
        document.addEventListener('click', function closeInput(e) {
            if (!inputWrapper.contains(e.target)) {
                inputWrapper.remove();
                document.removeEventListener('click', closeInput);
            }
        });
    }, 100);
}

	
function saveCategories() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/categories`), categories);
}
// Save checked items to Firebase
function saveCheckedItems() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/checkedItems`), checkedItems);
}

// Save auto-refresh settings to Firebase
function saveAutoRefreshSettings() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/autoRefreshEnabled`), autoRefreshEnabled);
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/autoRefreshTime`), autoRefreshTime);
}

function checkAndAutoRefresh(lastRefreshDate) {
    if (!autoRefreshEnabled || !currentUser) return;
    
    const now = new Date();
    const today = now.toDateString();
    
    // If we already refreshed today, don't do it again
    if (lastRefreshDate === today) return;
    
    // Parse the refresh time (format: "HH:MM")
    const [hours, minutes] = autoRefreshTime.split(':').map(Number);
    const refreshTime = new Date();
    refreshTime.setHours(hours, minutes, 0, 0);
    
    // If current time is past the refresh time and we haven't refreshed today
    if (now >= refreshTime && lastRefreshDate !== today) {
        // Clear all checked items
        checkedItems = {};
        saveCheckedItems();
        
        // Mark that we refreshed today
        set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`), today);
        
        // Re-render to show unchecked items
        renderContent();
    }
}

function clearAllChecks() {
    if (confirm('Clear all checkmarks? This cannot be undone.')) {
        checkedItems = {};
        saveCheckedItems();
        const today = new Date().toDateString();
        set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`), today);
        renderContent();
    }
}

function toggleAutoRefresh() {
    const enabled = confirm(
        autoRefreshEnabled 
            ? 'Disable automatic daily refresh?' 
            : `Enable automatic daily refresh at ${autoRefreshTime}?\n\nThis will clear all checkmarks at the specified time each day.`
    );
    
    if (enabled) {
        if (!autoRefreshEnabled) {
            const time = prompt('Enter refresh time (HH:MM format, 24-hour):', autoRefreshTime);
            if (time && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
                autoRefreshTime = time;
                autoRefreshEnabled = true;
            } else {
                alert('Invalid time format. Please use HH:MM (e.g., 09:00 or 23:30)');
                return;
            }
        } else {
            autoRefreshEnabled = false;
        }
        saveAutoRefreshSettings();
        renderHeader(); // Update menu display
    }
}

function toggleDarkMode() {
    darkMode = !darkMode;
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/darkMode`), darkMode);
    applyDarkMode();
    renderHeader();
}

function applyDarkMode() {
    if (darkMode) {
        // Dark mode styles
        document.body.style.background = 'linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%)';
        document.documentElement.style.setProperty('--bg-color', '#1e1e1e');
        document.documentElement.style.setProperty('--card-bg', '#2a2a2a');
        document.documentElement.style.setProperty('--text-color', '#e0e0e0');
        document.documentElement.style.setProperty('--text-secondary', '#b0b0b0');
        document.documentElement.style.setProperty('--border-color', '#3a3a3a');
        document.documentElement.style.setProperty('--hover-bg', '#333333');
        document.documentElement.style.setProperty('--item-bg', '#252525');
        
        // Update content area
        const contentArea = document.getElementById('contentArea');
        if (contentArea) contentArea.style.background = '#1e1e1e';
        
        // Update skill cards
        document.querySelectorAll('.skill-card').forEach(card => {
            card.style.background = '#2a2a2a';
            card.style.color = '#e0e0e0';
            card.style.borderBottom = '1px solid #3a3a3a';
        });
        
        // Update checklist items
        document.querySelectorAll('.checklist-item').forEach(item => {
            item.style.background = '#252525';
            item.style.color = '#e0e0e0';
        });
        
        // Update nav tabs
        document.querySelector('.nav-tabs').style.background = '#2a2a2a';
        document.querySelector('.nav-tabs').style.borderBottom = '1px solid #3a3a3a';
        
        // Update drawer
        const drawer = document.getElementById('guideDropdown');
        if (drawer) drawer.style.background = '#2a2a2a';
        
    } else {
        // Light mode styles
        document.body.style.background = 'linear-gradient(135deg, var(--secondary-color)CC 0%, var(--primary-color)CC 100%)';
        document.documentElement.style.setProperty('--bg-color', '#f8f9fa');
        document.documentElement.style.setProperty('--card-bg', '#ffffff');
        document.documentElement.style.setProperty('--text-color', '#1f2937');
        document.documentElement.style.setProperty('--text-secondary', '#495057');
        document.documentElement.style.setProperty('--border-color', '#e8eaed');
        document.documentElement.style.setProperty('--hover-bg', '#e8f4f8');
        document.documentElement.style.setProperty('--item-bg', '#f8f9fa');
        
        // Update content area
        const contentArea = document.getElementById('contentArea');
        if (contentArea) contentArea.style.background = '#f8f9fa';
        
        // Update skill cards
        document.querySelectorAll('.skill-card').forEach(card => {
            card.style.background = 'white';
            card.style.color = '#1f2937';
            card.style.borderBottom = '1px solid #e8eaed';
        });
        
        // Update checklist items
        document.querySelectorAll('.checklist-item').forEach(item => {
            item.style.background = '#f8f9fa';
            item.style.color = '#495057';
        });
        
        // Update nav tabs
        document.querySelector('.nav-tabs').style.background = 'white';
        document.querySelector('.nav-tabs').style.borderBottom = '1px solid #e8eaed';
        
        // Update drawer
        const drawer = document.getElementById('guideDropdown');
        if (drawer) drawer.style.background = '#edeff0';
    }
}

function renderTabs() { 
    const navTabs = document.getElementById('navTabs'); 
    navTabs.innerHTML = ''; 
    
    categories.forEach((cat, i) => { 
        const tabWrapper = document.createElement('div');
        tabWrapper.className = 'tab-wrapper';
        
        const tab = document.createElement('button'); 
        tab.className = 'nav-tab' + (i === activeTabIndex ? ' active' : ''); 

		// Make tabs draggable in edit mode
		if (!editMode) {
		    tab.draggable = true;
		    tab.dataset.catIndex = i;
		    tab.style.cursor = 'grab';
		}
		
        // Make tab editable in edit mode
        if (editMode) {
            const hasTabIcon = cat.icon && cat.icon !== "â€‹";
			let tabIconToShow;
			if (hasTabIcon) {
			    if (cat.icon.startsWith('svg:')) {
			        const iconData = JSON.parse(cat.icon.substring(4));
			        tabIconToShow = `<span style="display: inline-flex; width: 20px; height: 20px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
			    } else {
			        tabIconToShow = cat.icon;
			    }
			} else {
			    tabIconToShow = "+";
			}

			tab.innerHTML = `
			    <span class="editable-icon" style="display: inline-block; position: relative;">
			        <span class="tab-icon" data-cat-index="${i}" style="opacity: ${hasTabIcon ? '1' : '0.3'};">${tabIconToShow}</span>
			        ${hasTabIcon ? `<span class="emoji-remove-btn" data-cat-index="${i}">Ã—</span>` : ''}
			    </span>
			    <span class="tab-name editable" contenteditable="true">${cat.name}</span>
			`;
            
            // Add event listeners for edit mode
            const tabIcon = tab.querySelector('.tab-icon');
            if (tabIcon) {
                tabIcon.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const catIndex = parseInt(e.target.dataset.catIndex);
                    editCategoryIcon(catIndex, e.target);
                });
            }
            
            const removeIconBtn = tab.querySelector('.emoji-remove-btn');
            if (removeIconBtn) {
                removeIconBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const catIndex = parseInt(e.target.dataset.catIndex);
                    categories[catIndex].icon = 'â€‹';
                    saveCategories();
                    renderTabs();
                    renderContent();
                });
            }
            
            const nameSpan = tab.querySelector('.tab-name');
            nameSpan.addEventListener('blur', (e) => {
                categories[i].name = e.target.textContent.trim();
                saveCategories();
            });
            nameSpan.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
            nameSpan.addEventListener('click', (e) => {
                e.stopPropagation();
            });
            
            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('editable') && !e.target.classList.contains('editable-icon')) {
                    switchTab(i);
                }
            });
	        } else {
		    // Need to render SVG icons properly
		    let displayIcon = cat.icon;
		    if (cat.icon && cat.icon.startsWith('svg:')) {
		        const iconData = JSON.parse(cat.icon.substring(4));
		        displayIcon = `<span style="display: inline-flex; width: 20px; height: 20px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="14" height="14" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
		    }
		    tab.innerHTML = `<span class="tab-icon-display">${displayIcon}</span> <span class="tab-name-display">${cat.name}</span>`;
		    
		    // Make tabs draggable
		    tab.draggable = true;
		    tab.dataset.catIndex = i;
		    
		    const nameSpan = tab.querySelector('.tab-name-display');
		    const iconSpan = tab.querySelector('.tab-icon-display');
		    
		    // Single click switches tab (but not on name/icon spans)
		    tab.addEventListener('click', function(e) {
		        // Don't switch if clicking directly on name or icon for editing
		        if (e.target === nameSpan || nameSpan.contains(e.target) ||
		            e.target === iconSpan || iconSpan.contains(e.target)) {
		            return;
		        }
		        switchTab(i);
		    });
		    
		    // Double-click on name to edit
		    if (nameSpan) {
		        nameSpan.addEventListener('dblclick', function(e) {
		            e.stopPropagation();
		            e.preventDefault();
		            // Temporarily disable dragging
		            tab.draggable = false;
		            enableQuickEdit(this, i, null, null);
		            // Re-enable dragging after edit
		            setTimeout(() => {
		                tab.draggable = true;
		            }, 100);
		        });
		    }
		    
		    // Double-click on icon to edit
		    if (iconSpan) {
		        iconSpan.addEventListener('dblclick', function(e) {
		            e.stopPropagation();
		            e.preventDefault();
		            tab.draggable = false;
		            editCategoryIcon(i, this);
		            setTimeout(() => {
		                tab.draggable = true;
		            }, 100);
		        });
		    }
		}
        
        tabWrapper.appendChild(tab);
        
        if (editMode) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-tab-btn';
            deleteBtn.textContent = 'Ã—';
            deleteBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                deleteCategory(i);
            });
            tabWrapper.appendChild(deleteBtn);
        }
        
        navTabs.appendChild(tabWrapper); 
    }); 
    
    if (editMode) {
        const addCategoryBtn = document.createElement('button');
        addCategoryBtn.className = 'nav-tab add-category-tab';
        addCategoryBtn.textContent = '+';
        addCategoryBtn.addEventListener('click', addCategory);
        navTabs.appendChild(addCategoryBtn);
    }
	// Preserve Done button state if in edit mode
	if (editMode) {
	    setTimeout(() => {
	        const saveBtn = document.getElementById('saveBtn');
	        const menuBtn = document.getElementById('menuBtn');
	        if (saveBtn) saveBtn.style.display = 'block';
	        if (menuBtn) menuBtn.style.display = 'none';
	    }, 0);
	}
}
		
function toggleBulletStyle(catIndex, skillIndex) {
    const currentStyle = categories[catIndex].skills[skillIndex].bulletStyle || 'checkbox';
    const styles = ['checkbox', 'number', 'square', 'circle', 'none'];
    const currentIndex = styles.indexOf(currentStyle);
    const nextIndex = (currentIndex + 1) % styles.length;
    
    categories[catIndex].skills[skillIndex].bulletStyle = styles[nextIndex];
    saveCategories();
    renderContent();
}

function duplicateSkill(catIndex, skillIndex) {
    const originalSkill = categories[catIndex].skills[skillIndex];
    const duplicatedSkill = JSON.parse(JSON.stringify(originalSkill)); // Deep copy
    duplicatedSkill.title = duplicatedSkill.title + ' (Copy)';
    
    categories[catIndex].skills.splice(skillIndex + 1, 0, duplicatedSkill);
    saveCategories();
    renderContent();
}
		
function renderContent() { 
	    const contentArea = document.getElementById('contentArea'); 
	    contentArea.innerHTML = ''; 
	    contentArea.className = 'content-area' + (editMode ? ' edit-mode' : ''); 
    
    categories.forEach((cat, catIndex) => { 
       const catDiv = document.createElement('div'); 
        catDiv.className = 'category' + (catIndex === activeTabIndex ? ' active' : '');
        
        const grid = document.createElement('div'); 
			grid.className = 'skill-grid' + (layoutMode === 'horizontal' ? ' horizontal' : '');
        
        cat.skills.forEach((skill, skillIndex) => { 
            const card = document.createElement('div'); 
			card.className = 'skill-card';
			// Set border color based on theme
			const isLight = isLightColor(themeColor);
			card.style.borderLeftColor = isLight ? 'var(--secondary-color)' : 'var(--primary-color)';
            card.dataset.catIndex = catIndex;
            card.dataset.skillIndex = skillIndex; 
            
            const titleDiv = document.createElement('div'); 
			titleDiv.className = 'skill-title';
			
			// Add double-click to edit (only when not in edit mode)
			if (!editMode) {
			    titleDiv.addEventListener('dblclick', (e) => {
			        e.stopPropagation();
			        e.preventDefault();
			        // Find the text span (last child that's not an icon)
			        const spans = titleDiv.querySelectorAll('span');
			        const titleSpan = spans[spans.length - 1]; // Get last span (the text)
			        if (titleSpan && !titleSpan.classList.contains('editable-icon') && !titleSpan.classList.contains('icon')) {
			            enableQuickEdit(titleSpan, catIndex, skillIndex);
			        }
			    });
			}
			titleDiv.style.display = 'flex';
			titleDiv.style.alignItems = 'center';
			
			// Make draggable in headings mode without the handle
			if (!editMode && layoutMode === 'headings') {
			    card.draggable = true;
			    card.dataset.catIndex = catIndex;
			    card.dataset.skillIndex = skillIndex;
			    card.style.cursor = 'grab';
			}
			
			const hasIcon = skill.icon && skill.icon !== "â€‹";
			let iconToShow;
			if (hasIcon) {
			    if (skill.icon.startsWith('svg:')) {
			        const iconData = JSON.parse(skill.icon.substring(4));
			        iconToShow = `<span style="display: inline-flex; width: 24px; height: 24px; background: ${iconData.bg}; border-radius: 4px; align-items: center; justify-content: center;"><svg width="16" height="16" viewBox="0 0 24 24" fill="white"><path d="${iconData.path}"/></svg></span>`;
			    } else {
			        iconToShow = skill.icon;
			    }
			} else {
			    iconToShow = editMode ? "+" : "â€‹";
			}
			
			titleDiv.innerHTML += `
   				<span class="editable-icon" style="display: inline-block; position: relative; margin-right: 8px;">
			       <span class="icon" data-cat-index="${catIndex}" data-skill-index="${skillIndex}" style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${hasIcon ? '1' : '0.3'};">${iconToShow}</span>
			       ${editMode && hasIcon ? `<span class="emoji-remove-btn" data-cat-index="${catIndex}" data-skill-index="${skillIndex}">Ã—</span>` : ''}
			   </span>
			   <span class="${editMode ? 'editable' : ''}" contenteditable="${editMode}">${skill.title}</span>
			`;

			// Add event listeners after creating the titleDiv
			if (editMode) {
			    const iconSpan = titleDiv.querySelector('.icon');
			    if (iconSpan) {
			        iconSpan.addEventListener('click', (e) => {
			            e.stopPropagation();
			            const catIdx = parseInt(e.target.dataset.catIndex);
			            const skillIdx = parseInt(e.target.dataset.skillIndex);
			            editSkillIcon(catIdx, skillIdx, e.target);
			        });
			        iconSpan.addEventListener('dblclick', (e) => {
			            e.stopPropagation();
			        });
			    }
			    
			    const removeIconBtn = titleDiv.querySelector('.emoji-remove-btn');
			    if (removeIconBtn) {
			        removeIconBtn.addEventListener('click', (e) => {
			            e.stopPropagation();
			            const catIdx = parseInt(e.target.dataset.catIndex);
			            const skillIdx = parseInt(e.target.dataset.skillIndex);
			            categories[catIdx].skills[skillIdx].icon = 'â€‹';
			            saveCategories();
			            renderContent();
			        });
			    }
			}

			// Add collapse button for headings mode
				if (layoutMode === 'headings' && !editMode) {
				    const collapseBtn = document.createElement('button');
				    collapseBtn.className = 'collapse-btn';
				    collapseBtn.innerHTML = `
				        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				            <polyline points="4 14 10 14 10 20"></polyline>
				            <polyline points="20 10 14 10 14 4"></polyline>
				            <line x1="14" y1="10" x2="21" y2="3"></line>
				            <line x1="3" y1="21" x2="10" y2="14"></line>
				        </svg>
				    `;
				    collapseBtn.addEventListener('click', (e) => {
				        e.stopPropagation();
				        card.classList.remove('expanded');
				        const cardId = `${catIndex}-${skillIndex}`;
				        delete expandedCards[cardId];
				        saveExpandedCards();
				    });
				    titleDiv.appendChild(collapseBtn);
				}
                                      
                          
            if (editMode) {
                const editableSpan = titleDiv.querySelector('.editable');
                if (editableSpan) {
                    editableSpan.addEventListener('blur', (e) => { 
                        categories[catIndex].skills[skillIndex].title = e.target.textContent.trim(); 
                        saveCategories();
                    }); 
                }
            }
            
            card.appendChild(titleDiv);
            

				// Add control buttons in top right
					const controlsContainer = document.createElement('div');
					controlsContainer.className = 'skill-card-controls';
					
					// Expand/Collapse button (always visible in vertical mode)
					if (layoutMode === 'vertical' && !editMode) {
					    const cardId = `${catIndex}-${skillIndex}`;
					    const isExpanded = expandedCards[cardId];
					    
					    const expandCollapseBtn = document.createElement('button');
					    expandCollapseBtn.className = 'expand-btn';
					    expandCollapseBtn.innerHTML = isExpanded ? `
					        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					            <polyline points="4 14 10 14 10 20"></polyline>
					            <polyline points="20 10 14 10 14 4"></polyline>
					            <line x1="14" y1="10" x2="21" y2="3"></line>
					            <line x1="3" y1="21" x2="10" y2="14"></line>
					        </svg>
					    ` : `
					        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
					            <polyline points="15 3 21 3 21 9"></polyline>
					            <polyline points="9 21 3 21 3 15"></polyline>
					            <line x1="21" y1="3" x2="14" y2="10"></line>
					            <line x1="3" y1="21" x2="10" y2="14"></line>
					        </svg>
					    `;
					    expandCollapseBtn.style.opacity = '1';
					    expandCollapseBtn.style.pointerEvents = 'auto';
					    expandCollapseBtn.addEventListener('click', (e) => {
					        e.stopPropagation();
					        const cardId = `${catIndex}-${skillIndex}`;
					        if (expandedCards[cardId]) {
					            card.classList.remove('expanded');
					            delete expandedCards[cardId];
					        } else {
					            card.classList.add('expanded');
					            expandedCards[cardId] = true;
					        }
					        saveExpandedCards();
					        renderContent();
					    });
					    controlsContainer.appendChild(expandCollapseBtn);
					}
					
					// Bullet toggle button
					const bulletStyle = skill.bulletStyle || 'checkbox';
					const bulletIcons = {
					    'checkbox': 'â˜‘',
					    'number': '#',
					    'square': 'â– ',
					    'circle': 'â—',
					    'none': 'â€”'
					};
					const toggleBtn = document.createElement('button');
					toggleBtn.className = 'skill-control-btn';
					toggleBtn.textContent = bulletIcons[bulletStyle];
					toggleBtn.title = 'Change bullet style';
					toggleBtn.addEventListener('click', (e) => {
					    e.stopPropagation();
					    toggleBulletStyle(catIndex, skillIndex);
					});
					
					// Duplicate button
					const duplicateBtn = document.createElement('button');
					duplicateBtn.className = 'skill-control-btn';
					duplicateBtn.innerHTML = 'â§‰';
					duplicateBtn.style.fontSize = '13px';
					duplicateBtn.title = 'Duplicate card';
					duplicateBtn.addEventListener('click', (e) => {
					    e.stopPropagation();
					    duplicateSkill(catIndex, skillIndex);
					});
					
					// Delete button
					const deleteBtn = document.createElement('button');
					deleteBtn.className = 'skill-control-btn delete-control';
					deleteBtn.innerHTML = 'Ã—';
					deleteBtn.title = 'Delete card';
					deleteBtn.addEventListener('click', (e) => {
					    e.stopPropagation();
					    deleteSkill(catIndex, skillIndex);
					});
					
					// Add in order: expand/collapse (if vertical), bullet, duplicate, delete
					controlsContainer.appendChild(toggleBtn);
					controlsContainer.appendChild(duplicateBtn);
					controlsContainer.appendChild(deleteBtn);
					
					card.appendChild(controlsContainer);
			
			
			// Add double-tap to reveal controls when not in edit mode
			if (!editMode) {
			    let lastTap = 0;
			    const topRightArea = document.createElement('div');
			    topRightArea.style.position = 'absolute';
			    topRightArea.style.top = '0';
			    topRightArea.style.right = '0';
			    topRightArea.style.width = '80px';
			    topRightArea.style.height = '40px';
			    topRightArea.style.cursor = 'pointer';
			    topRightArea.style.zIndex = '5';
			    
			    topRightArea.addEventListener('touchend', (e) => {
			        const currentTime = new Date().getTime();
			        const tapGap = currentTime - lastTap;
			        
			        if (tapGap < 300 && tapGap > 0) {
			            // Double tap detected
			            e.preventDefault();
			            const controls = card.querySelector('.skill-card-controls');
			            if (controls) {
			                controls.classList.toggle('show');
			                
			                // Auto-hide after 5 seconds
			                if (controls.classList.contains('show')) {
			                    setTimeout(() => {
			                        controls.classList.remove('show');
			                    }, 5000);
			                }
			            }
			        }
			        lastTap = currentTime;
			    });
			    
			    card.appendChild(topRightArea);
			}
            skill.items.forEach((item, itemIndex) => { 
                const itemId = `${catIndex}-${skillIndex}-${itemIndex}`; 
                const checkItem = document.createElement('div'); 
                checkItem.className = 'checklist-item' + (checkedItems[itemId] ? ' checked' : '');
                checkItem.dataset.catIndex = catIndex;
                checkItem.dataset.skillIndex = skillIndex;
                checkItem.dataset.itemIndex = itemIndex;
				
                // Make draggable in edit mode
                if (!editMode) {
                    checkItem.draggable = true;
                    checkItem.dataset.catIndex = catIndex;
                    checkItem.dataset.skillIndex = skillIndex;
                    checkItem.dataset.itemIndex = itemIndex;
                    checkItem.style.cursor = 'grab';
                }
                
                // Render appropriate bullet based on style
				const bulletStyle = skill.bulletStyle || 'checkbox';
				let bulletElement;
				
				if (bulletStyle === 'checkbox') {
				    bulletElement = document.createElement('div');
				    bulletElement.className = 'checkbox';
				} else if (bulletStyle === 'number') {
				    bulletElement = document.createElement('div');
				    bulletElement.className = 'bullet-number';
				    bulletElement.textContent = itemIndex + 1;
				} else if (bulletStyle === 'square') {
				    bulletElement = document.createElement('div');
				    bulletElement.className = 'bullet-square';
				    bulletElement.textContent = 'â– ';
				} else if (bulletStyle === 'circle') {
				    bulletElement = document.createElement('div');
				    bulletElement.className = 'bullet-circle';
				    bulletElement.textContent = 'â—';
				} else if (bulletStyle === 'none') {
				    bulletElement = document.createElement('div');
				    bulletElement.className = 'bullet-none';
				}
				
				checkItem.appendChild(bulletElement);
                
                // Only checkbox/bullet triggers the check, not the whole item
                if (!editMode) {
                    bulletElement.addEventListener('click', (e) => {
                        e.stopPropagation();
                        toggleCheck(itemId);
                    });
                    bulletElement.style.cursor = 'pointer';
                }
                
                const textDiv = document.createElement('div');
                textDiv.className = 'checklist-text' + (editMode ? ' editable' : '');
                textDiv.contentEditable = editMode;
                textDiv.textContent = item;
                checkItem.appendChild(textDiv);
                
                // Add double-click to edit (only when not in edit mode)
                if (!editMode) {
                    textDiv.addEventListener('dblclick', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        const parent = this.closest('.checklist-item');
                        if (parent && parent.onclick) {
                            parent.onclick = null; // Temporarily disable click
                        }
                        enableQuickEdit(this, catIndex, skillIndex, itemIndex);
                    });
                }
                
                if (editMode) {
				    const deleteItemBtn = document.createElement('button');
				    deleteItemBtn.className = 'delete-btn';
				    deleteItemBtn.textContent = 'Ã—';
				    deleteItemBtn.addEventListener('click', (e) => {
				        e.stopPropagation();
				        deleteItem(catIndex, skillIndex, itemIndex);
				    });
				    checkItem.appendChild(deleteItemBtn);
                    
                    textDiv.addEventListener('blur', (e) => { 
                        categories[catIndex].skills[skillIndex].items[itemIndex] = e.target.textContent.trim(); 
                        saveCategories();
                    }); 
                }
                
                card.appendChild(checkItem); 
            }); 
            
            const addItemBtn = document.createElement('button'); 
            addItemBtn.className = 'add-item-btn'; 
            addItemBtn.textContent = '+ Add Item'; 
            addItemBtn.addEventListener('click', () => addItem(catIndex, skillIndex));
            card.appendChild(addItemBtn); 
            
            grid.appendChild(card); 
			// Add click handler for headings mode
			// Restore expanded state in vertical mode
				if (layoutMode === 'vertical' && !editMode) {
				    const cardId = `${catIndex}-${skillIndex}`;
				    if (expandedCards[cardId]) {
				        card.classList.add('expanded');
				    } else {
				        // Collapse by default - hide items
				        const items = card.querySelectorAll('.checklist-item');
				        if (items && items.length > 0) {
				            items.forEach(item => {
				                item.style.display = 'none';
				            });
				        }
				        const addItemBtn = card.querySelector('.add-item-btn');
				        if (addItemBtn) addItemBtn.style.display = 'none';
				    }
				}
        }); 
        
        catDiv.appendChild(grid); 
        
        const addSkillBtn = document.createElement('button'); 
        addSkillBtn.className = 'add-skill-btn'; 
        addSkillBtn.textContent = '+ Add New Card'; 
        addSkillBtn.addEventListener('click', () => addSkill(catIndex));
        catDiv.appendChild(addSkillBtn); 
        
        contentArea.appendChild(catDiv); 
    }); 
	// Preserve Done button state if in edit mode
if (editMode) {
    setTimeout(() => {
        const saveBtn = document.getElementById('saveBtn');
        const menuBtn = document.getElementById('menuBtn');
        if (saveBtn) saveBtn.style.display = 'block';
        if (menuBtn) menuBtn.style.display = 'none';
    }, 0);
}
applyDarkMode();}

function switchTab(index) { 
    activeTabIndex = index; 
    renderTabs();
    const cats = document.querySelectorAll('.category'); 
    cats.forEach((cat, i) => cat.classList.toggle('active', i === activeTabIndex)); 
}

function toggleCheck(itemId) { 
    if (editMode) return; 
    
    // Store expanded state before re-render
    const expandedCards = [];
    document.querySelectorAll('.skill-card.expanded').forEach(card => {
        expandedCards.push({
            catIndex: card.dataset.catIndex,
            skillIndex: card.dataset.skillIndex
        });
    });
    
    checkedItems[itemId] = !checkedItems[itemId]; 
    saveCheckedItems();
    renderContent(); 
    
    // Restore expanded state after re-render
    expandedCards.forEach(({catIndex, skillIndex}) => {
        const card = document.querySelector(`.skill-card[data-cat-index="${catIndex}"][data-skill-index="${skillIndex}"]`);
        if (card) card.classList.add('expanded');
    });
}

function toggleEditMode() { 
    const menu = document.getElementById('dropdownMenu');
    if (menu) menu.classList.remove('show'); 
    
    editMode = !editMode; 
    
    // Toggle class on body to hide/show floating button
    if (editMode) {
        document.body.classList.add('edit-mode-active');
    } else {
        document.body.classList.remove('edit-mode-active');
    }
    
    // Hide/show floating layout button
    const floatingBtn = document.getElementById('layoutBtn');
    if (floatingBtn) {
        floatingBtn.style.display = editMode ? 'none' : 'flex';
    }
    
    renderHeader();
    renderTabs();
    renderContent();
    
    // Toggle between Done button and 3-dots menu
    const saveBtn = document.getElementById('saveBtn');
    const menuBtn = document.getElementById('menuBtn');
    if (saveBtn && menuBtn) {
        if (editMode) {
            saveBtn.style.display = 'block';
            menuBtn.style.display = 'none';
        } else {
            saveBtn.style.display = 'none';
            menuBtn.style.display = 'block';
        }
    }
}

function enableQuickEdit(element, catIndex, skillIndex, itemIndex = null) {
    if (editMode) return;
    
    const originalText = element.textContent.trim();
    const parentItem = element.closest('.checklist-item');
    const parentTab = element.closest('.nav-tab');
    
    // Prevent checkbox toggle during editing
    if (parentItem) {
        parentItem.style.pointerEvents = 'none';
    }
    
    // Disable tab dragging during editing
    if (parentTab) {
        parentTab.draggable = false;
    }
    
    element.contentEditable = true;
    element.style.background = 'white';
    element.style.outline = '2px solid var(--primary-color)';
    element.style.borderRadius = '4px';
    element.style.padding = '4px 8px';
    element.style.userSelect = 'text';
    element.style.webkitUserSelect = 'text';
    
    // Focus and select all text
    setTimeout(() => {
        element.focus();
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }, 10);
    
    function saveEdit() {
        const newText = element.textContent.trim();
        element.contentEditable = false;
        element.style.background = '';
        element.style.outline = '';
        element.style.padding = '';
        element.style.userSelect = '';
        element.style.webkitUserSelect = '';
        
        if (parentItem) {
            parentItem.style.pointerEvents = '';
        }
        
        // Re-enable tab dragging
        if (parentTab) {
            parentTab.draggable = true;
        }
        
        if (newText && newText !== originalText) {
            if (itemIndex !== null) {
                categories[catIndex].skills[skillIndex].items[itemIndex] = newText;
            } else if (skillIndex !== null) {
                categories[catIndex].skills[skillIndex].title = newText;
            } else {
                categories[catIndex].name = newText;
            }
            saveCategories();
            setTimeout(() => {
                renderTabs();
                renderContent();
            }, 0);
        } else if (!newText) {
            element.textContent = originalText;
        }
        
        element.removeEventListener('blur', saveEdit);
        element.removeEventListener('keydown', keyHandler);
    }
    
    const keyHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalText;
            element.blur();
        }
    };
    
    element.addEventListener('blur', saveEdit);
    element.addEventListener('keydown', keyHandler);
}

function enableQuickEditHeader(element, type) {
    if (editMode) return;
    
    const originalText = element.textContent.trim();
    
    element.contentEditable = true;
    element.style.outline = '2px solid white';
    element.style.borderRadius = '4px';
    element.style.padding = '4px 8px';
    element.style.background = 'rgba(255, 255, 255, 0.2)';
    
    setTimeout(() => {
        element.focus();
        const range = document.createRange();
        range.selectNodeContents(element);
        const selection = window.getSelection();
        selection.removeAllRanges();
        selection.addRange(range);
    }, 10);
    
    function saveEdit() {
        const newText = element.textContent.trim();
        element.contentEditable = false;
        element.style.outline = '';
        element.style.padding = '';
        element.style.background = '';
        
        if (newText && newText !== originalText) {
            if (type === 'title') {
                appTitle = newText;
            } else {
                appSubtitle = newText;
            }
            saveHeader();
        } else if (!newText) {
            element.textContent = originalText;
        }
        
        element.removeEventListener('blur', saveEdit);
        element.removeEventListener('keydown', keyHandler);
    }
    
    const keyHandler = (e) => {
        if (e.key === 'Enter') {
            e.preventDefault();
            element.blur();
        } else if (e.key === 'Escape') {
            element.textContent = originalText;
            element.blur();
        }
    };
    
    element.addEventListener('blur', saveEdit);
    element.addEventListener('keydown', keyHandler);
}

function editAppIcon(el) {
    showEmojiPicker(el, (emoji) => {
        appIcon = emoji;
        saveHeader();
    });
}

// Save expanded cards to Firebase
function saveExpandedCards() {
    if (!currentUser) return;
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/expandedCards`), expandedCards);
}

function addSkill(catIndex) { 
    categories[catIndex].skills.push({ 
        title: "New Skill", 
        icon: "âœ¨", 
        items: ["New item - click to edit"] 
    }); 
    saveCategories();
    renderContent(); 
}

function editSkillIcon(catIndex, skillIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].skills[skillIndex].icon = emoji;
        saveCategories();
        renderContent();
    });
}

function deleteSkill(catIndex, skillIndex) { 
    if (confirm('Delete this skill?')) { 
        categories[catIndex].skills.splice(skillIndex, 1); 
        saveCategories();
        renderContent(); 
    } 
}

function deleteItem(catIndex, skillIndex, itemIndex) { 
    categories[catIndex].skills[skillIndex].items.splice(itemIndex, 1); 
    saveCategories();
    renderContent(); 
}

function addItem(catIndex, skillIndex) { 
    categories[catIndex].skills[skillIndex].items.push("New item"); 
    saveCategories();
    renderContent(); 
}

function addCategory() {
    categories.push({
        name: "New Category",
        icon: "ðŸ“Œ",
        skills: [
            {
                title: "New Skill",
                icon: "âœ¨",
                items: ["New item - click to edit"]
            }
        ]
    });
    activeTabIndex = categories.length - 1;
    saveCategories();
    renderTabs();
    renderContent();
}

function editCategoryIcon(catIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].icon = emoji;
        saveCategories();
        renderTabs();
        renderContent();
    });
}
	
function toggleLayout() {
    if (!currentUser) return;
    if (layoutMode === 'vertical') {
        layoutMode = 'horizontal';
    } else {
        layoutMode = 'vertical';
    }
    set(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/layoutMode`), layoutMode);
    renderContent();
    updateLayoutButton();
}

function updateLayoutButton() {
    const btn = document.getElementById('layoutBtn');
    if (btn) {
        if (layoutMode === 'vertical') {
            // Next: horizontal (show side-by-side icon)
            btn.innerHTML = '<div style="display: flex; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to horizontal scrolling';
        } else {
            // Next: vertical (show stacked rounded squares)
            btn.innerHTML = '<div style="display: flex; flex-direction: column; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to vertical grid';
        }
        btn.style.opacity = '0.2';
    }
}

function deleteCategory(catIndex) {
    if (confirm('Delete this entire category?')) {
        categories.splice(catIndex, 1);
        if (activeTabIndex >= categories.length) {
            activeTabIndex = Math.max(0, categories.length - 1);
        }
        saveCategories();
        renderTabs();
        renderContent();
    }
}

// Close menus when clicking outside
document.addEventListener('click', (e) => {
    const menu = document.getElementById('dropdownMenu');
    const categoryMenu = document.getElementById('categoryMenu');
    const colorMenu = document.getElementById('colorPickerMenu');
    const floatingBtn = document.getElementById('layoutBtn');
    const logoutMenu = document.getElementById('logoutMenu');
    const guideMenu = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');

    // Close logout menu when clicking outside
    if (logoutMenu && !logoutMenu.contains(e.target) && !e.target.closest('#logoutMenuBtn')) {
        logoutMenu.classList.remove('show');
    }

    // Don't close dropdown if clicking inside color picker
    if (colorMenu && colorMenu.contains(e.target)) {
        return;
    }

    // Close dropdown menu if clicking outside
    if (menu && !menu.contains(e.target)) {
        menu.classList.remove('show');
        if (categoryMenu) categoryMenu.classList.remove('show');
        if (colorMenu) colorMenu.classList.remove('show');
    }

    // Don't close drawer if clicking inside it or on the hamburger button
    if (guideMenu && !guideMenu.contains(e.target) && !e.target.closest('.guide-menu-btn')) {
        if (guideMenu.classList.contains('show')) {
            closeDrawer();
        }
    }
});


// Check for auto-refresh when page becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden && currentUser) {
        get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`)).then((snapshot) => {
            checkAndAutoRefresh(snapshot.val());
        });
    }
});

// Also check every hour while page is open
setInterval(() => {
    if (currentUser) {
        get(ref(database, `users/${currentUser.uid}/guides/${currentGuideId}/lastRefreshDate`)).then((snapshot) => {
            checkAndAutoRefresh(snapshot.val());
        });
    }
}, 60 * 60 * 1000);

// Wait for DOM to load before attaching login screen listeners
window.addEventListener('DOMContentLoaded', () => {
    const loginBtn = document.getElementById('loginBtn');
    const googleBtn = document.getElementById('googleBtn');
    const signupBtn = document.getElementById('signupBtn');
    const loginPassword = document.getElementById('loginPassword');
    const layoutBtn = document.getElementById('layoutBtn');
    
    // NEW: Sign-up screen listeners
    const signupSubmitBtn = document.getElementById('signupSubmitBtn');
    const googleSignupBtn = document.getElementById('googleSignupBtn');
    const backToLoginBtn = document.getElementById('backToLoginBtn');
    const signupPassword = document.getElementById('signupPassword');
    const signupPasswordConfirm = document.getElementById('signupPasswordConfirm');
    
    if (loginBtn) {
        loginBtn.addEventListener('click', () => {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            login(email, password);
        });
    }
    
    if (googleBtn) {
        googleBtn.addEventListener('click', () => {
            loginWithGoogle();
        });
    }
    
    if (signupBtn) {
        signupBtn.addEventListener('click', () => {
            showSignup();
        });
    }
    
    // NEW: Sign-up button handlers
    if (signupSubmitBtn) {
        signupSubmitBtn.addEventListener('click', processSignup);
    }
    
    if (googleSignupBtn) {
        googleSignupBtn.addEventListener('click', loginWithGoogle);
    }
    
    if (backToLoginBtn) {
        backToLoginBtn.addEventListener('click', backToLogin);
    }
    
    if (loginPassword) {
        loginPassword.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                login(email, password);
            }
        });
    }
    
    // NEW: Enter key support for sign-up
    if (signupPasswordConfirm) {
        signupPasswordConfirm.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                processSignup();
            }
        });
    }
    
    if (layoutBtn) {
        layoutBtn.addEventListener('click', toggleLayout);
    }
});
</script>
	<button class="floating-layout-btn" id="layoutBtn" onclick="toggleLayout()" title="Switch layout" style="opacity: 0;"></button>
</body>
</html>







