<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Essential Life Skills Guide</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
		body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: linear-gradient(135deg, rgba(44, 62, 80, 0.5) 0%, rgba(52, 152, 219, 0.2) 100%); min-height: 100vh; padding: 0; margin: 0; }
		.add-category-tab { background: #27ae60 !important; color: white !important; font-weight: bold; border-bottom: none !important; padding: 15px 20px !important; font-size: 18px !important; }
		.add-category-tab:hover { background: #229954 !important; }
		.add-item-btn { background: #27ae60; color: white; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; margin-top: 10px; font-size: 14px; font-weight: 600; display: none; width: 100%; }
		.add-item-btn:hover { background: #229954; }
		.add-skill-btn { background: var(--primary-color, #3498db); color: white; padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; width: calc(100% - 60px); margin: 20px 30px; transition: all 0.3s ease; display: none; }
		.add-skill-btn:hover { background: var(--secondary-color, #2980b9); }
		.category { display: none; }
		.category.active { display: block; }
		.checkbox { width: 20px; height: 20px; border: 2px solid var(--primary-color, #3498db); border-radius: 4px; flex-shrink: 0; margin-top: 2px; cursor: pointer; transition: all 0.3s ease; }
		.checklist-item { display: flex; align-items: flex-start; gap: 12px; padding: 12px; background: white; margin-bottom: 10px; border-radius: 8px; cursor: pointer; transition: all 0.3s ease; }
		.checklist-item.checked { opacity: 0.7; }
		.checklist-item.checked .checkbox { background: #27ae60; border-color: #27ae60; position: relative; }
		.checklist-item.checked .checkbox:after { content: "✓"; color: white; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); font-size: 14px; font-weight: bold; }
		.checklist-item:hover { background: #f0f7ff; }
		.checklist-text { flex: 1; font-size: 14px; line-height: 1.5; color: #495057; }
		.collapse-btn { position: absolute; top: 12px; right: 12px; background: none; border: none; cursor: pointer; padding: 4px; border-radius: 4px; transition: all 0.2s ease; width: 20px; height: 20px; display: none; }
		.collapse-btn:hover { background: #ecf0f1; transform: scale(1.1); }
		.collapse-btn svg { width: 100%; height: 100%; stroke: #95a5a6; transition: stroke 0.2s ease; }
		.collapse-btn:hover svg { stroke: #2c3e50; }
		.color-option { width: 40px; height: 40px; border-radius: 8px; border: 2px solid transparent; cursor: pointer; transition: all 0.2s ease; }
		.color-option:hover { transform: scale(1.1); border-color: #2c3e50; }
		.color-option.selected { border-color: #2c3e50; border-width: 3px; }
		.color-options { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding-right: 5px; }
		.color-picker-menu { display: none; background: white; border-radius: 8px; padding: 15px 20px 15px 15px; margin-top: 5px; position: fixed; right: 10px; top: 140px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1001; max-height: calc(100vh - 160px); overflow-y: auto; width: 200px; }
		.color-picker-menu h3 { margin: 0 0 10px 0; font-size: 14px; color: #2c3e50; }
		.color-picker-menu.show { display: block; }
		.container { max-width: 100%; width: 100%; margin: 0; padding: 0; background: transparent; border-radius: 0; box-shadow: none; overflow: visible; opacity: 0; transition: opacity 0.3s ease-in-out; }
		.container.loaded { opacity: 1; }
		.content-area { padding: 0 0 30px 0; }
		.delete-btn { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 18px; font-weight: bold; display: none; margin-left: 8px; flex-shrink: 0; transition: all 0.2s ease; line-height: 1; padding: 0; width: auto; height: auto; }
		.delete-btn:hover { color: #c0392b; transform: scale(1.2); }
		.delete-tab-btn { color: #e74c3c; background: none; border: none; cursor: pointer; font-size: 18px; font-weight: bold; margin-right: 10px; flex-shrink: 0; transition: all 0.2s ease; line-height: 1; padding: 0; width: auto; height: auto; }
		.delete-tab-btn:hover { color: #c0392b; transform: scale(1.2); }
		.drawer-backdrop { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.5); z-index: 1999; opacity: 0; visibility: hidden; transition: opacity 0.3s ease, visibility 0.3s ease; }
		.drawer-backdrop.show { opacity: 1; visibility: visible; }
		.drawer-header { padding: 20px 16px 15px; border-bottom: 2px solid #f0f0f0; margin-bottom: 10px; font-weight: bold; color: #2c3e50; font-size: 16px; }
		.dropdown-menu { display: none; position: absolute; top: 40px; right: 0; background: white; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); min-width: 150px; z-index: 1000; overflow: visible; }
		.dropdown-menu button { width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: background 0.2s; }
		.dropdown-menu button:first-child { border-radius: 8px 8px 0 0; }
		.dropdown-menu button:last-child { border-radius: 0 0 8px 8px; }
		.dropdown-menu button:hover { background: #f8f9fa; }
		.dropdown-menu.show { display: block; }
		.edit-btn { background: none; color: white; border: none; padding: 4px 8px; cursor: pointer; font-size: 28px; font-weight: 600; transition: all 0.3s ease; line-height: 1; }
		.edit-btn:hover { opacity: 0.7; }
		.edit-mode .add-item-btn { display: block; }
		.edit-mode .add-skill-btn { display: block; }
		.edit-mode .delete-btn { display: inline-flex; }
		.edit-mode-active .floating-layout-btn { display: none; }
		.edit-toggle { position: absolute; top: 10px; right: 10px; }
		.editable { cursor: text; padding: 2px 4px; border-radius: 4px; transition: all 0.2s ease; }
		.editable:hover { background: rgba(52, 152, 219, 0.1); }
		.editable:focus { outline: 2px solid var(--primary-color, #3498db); background: white; }
		.emoji-picker { position: absolute; background: white; border: 1px solid #ccc; border-radius: 8px; padding: 8px; display: grid; grid-template-columns: repeat(8, 30px); gap: 5px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; max-height: 300px; overflow-y: auto; }
		.emoji-picker button { font-size: 20px; background: none; border: none; cursor: pointer; transition: transform 0.2s; }
		.emoji-picker button:hover { transform: scale(1.2); }
		.emoji-remove-btn { position: absolute; top: -5px; right: -5px; width: 18px; height: 18px; background: #e74c3c; color: white; border: 2px solid white; border-radius: 50%; font-size: 12px; font-weight: bold; display: flex; align-items: center; justify-content: center; cursor: pointer; line-height: 1; z-index: 10; transition: all 0.2s ease; }
		.emoji-remove-btn:hover { background: #c0392b; transform: scale(1.1); }
		.editable-icon { position: relative; display: inline-block; }
		.floating-layout-btn { position: fixed; bottom: 25px; right: 25px; width: 60px; height: 60px; border-radius: 12px; background-color: var(--primary-color, #3498db); opacity: 0.2; color: white; font-size: 28px; border: none; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); cursor: pointer; transition: all 0.3s ease; z-index: 1000; display: flex; align-items: center; justify-content: center; }
		.floating-layout-btn:hover { transform: scale(1.1); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); opacity: 0.7; }
		.guide-dropdown { position: fixed; top: 0; left: 0; height: 100vh; width: 300px; background: rgba(237, 239, 240); box-shadow: 2px 0 12px rgba(0,0,0,0.15); z-index: 2000; max-height: 100vh; overflow-y: auto; transform: translateX(-100%); transition: transform 0.3s cubic-bezier(0.4, 0.0, 0.2, 1); padding-top: 0; }
		.guide-dropdown button { width: 100%; padding: 12px 16px; border: none; background: none; text-align: left; cursor: pointer; font-size: 14px; color: #2c3e50; transition: background 0.2s; border-bottom: 1px solid #f0f0f0; }
		.guide-dropdown button:hover { background: #f8f9fa; }
		.guide-dropdown button:last-child { border-bottom: none; }
		.guide-dropdown .current-guide { background: rgba(25, 118, 210, 0.2); font-weight: 600; color: #1976d2; }
		.guide-dropdown.show { transform: translateX(0); }
		.guide-menu-btn { position: absolute; top: 10px; left: 10px; background: none; color: white; border: none; padding: 8px; cursor: pointer; font-size: 24px; font-weight: 600; transition: all 0.3s ease; line-height: 1; z-index: 10; }
		.guide-menu-btn:hover { opacity: 0.7; }
		.header { background: linear-gradient(135deg, #2c3e50 0%, #3498db 100%); color: white; padding: 40px 30px; text-align: center; position: relative; }
		.header h1 { font-size: 32px; margin-bottom: 10px; }
		.header p { opacity: 0.9; font-size: 16px; }
		.header .editable:focus { outline: 2px solid #fff; background: rgba(255, 255, 255, 0.2); color: #fff; }
		.header .editable-icon { cursor: pointer; margin-right: 8px; font-size: 32px; }
		.header-wrapper { position: sticky; top: 0; z-index: 100; background: transparent; }
		.nav-tab { padding: 15px 25px; cursor: pointer; border: none; background: none; font-size: 15px; font-weight: 500; color: #6c757d; transition: all 0.3s ease; white-space: nowrap; border-bottom: 3px solid transparent; flex-shrink: 0; }
		.nav-tab.active { color: var(--primary-color, #3498db); border-bottom-color: var(--primary-color, #3498db); background: white; }
		.nav-tab .tab-icon { margin-right: 5px; cursor: pointer; }
		.nav-tab .tab-name { cursor: text; }
		.nav-tab .tab-name:hover { background: rgba(255, 255, 255, 0.1); padding: 2px 4px; border-radius: 4px; }
		.nav-tab .tab-name:focus { outline: 2px solid var(--primary-color, #3498db); background: white; color: #2c3e50; padding: 2px 4px; border-radius: 4px; }
		.nav-tabs { display: flex; background: #f8f9fa; border-bottom: 2px solid #dee2e6; overflow-x: auto; overflow-y: hidden; flex-wrap: nowrap; -webkit-overflow-scrolling: touch; scrollbar-width: thin; position: sticky; top: 0; left: 0; right: 0; z-index: 100; }
		.nav-tabs::-webkit-scrollbar { height: 4px; }
		.nav-tabs::-webkit-scrollbar-track { background: transparent; }
		.nav-tabs::-webkit-scrollbar-thumb { background: #cbd5e0; border-radius: 4px; }
		.nav-tabs::-webkit-scrollbar-thumb:hover { background: #a0aec0; }
		.save-btn { position: fixed; bottom: 25px; left: 50%; transform: translateX(-50%); background: var(--primary-color, #607d8b); opacity: 0.7; color: white; border: none; padding: 12px 24px; cursor: pointer; font-size: 16px; font-weight: 600; border-radius: 8px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3); transition: all 0.3s ease; display: none; z-index: 1000; }
		.save-btn:hover { opacity: 1; transform: translateX(-50%) translateY(-2px); box-shadow: 0 6px 16px rgba(0, 0, 0, 0.4); }
		.save-btn.show { display: block; animation: fadeIn 0.3s ease-in-out; }
		.skill-card { background: #f8f9fa; border-radius: 0; padding: 20px; border-left: 4px solid var(--primary-color, #3498db); border-bottom: 1px solid #e0e0e0; transition: all 0.3s ease; position: relative; }
		.skill-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
		.skill-card.expanded .collapse-btn { display: block; }
		.skill-grid { display: flex; flex-direction: column; gap: 15px; margin-top: 20px; padding: 0; transition: all 0.3s ease; }
		.skill-grid.headings { display: flex; flex-direction: column; gap: 12px; padding: 0 30px; }
		.skill-grid.headings .skill-card { padding: 15px 20px; border-left: 4px solid var(--primary-color, #3498db); border-radius: 8px; background: #f8f9fa; border-bottom: none; cursor: pointer; position: relative; }
		.skill-grid.headings .skill-card:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
		.skill-grid.headings .skill-card.expanded .checklist-item { display: flex; }
		.skill-grid.headings .checklist-item { display: none; }
		.skill-grid.headings .add-item-btn { display: none !important; }
		.skill-grid.horizontal { display: flex; flex-direction: row; overflow-x: auto; overflow-y: hidden; scroll-snap-type: none; padding: 0 30px 20px 30px; gap: 20px; }
		.skill-grid.horizontal .skill-card { min-width: 300px; max-width: 300px; scroll-snap-align: start; flex-shrink: 0; border-radius: 12px; border-bottom: none; }
		.skill-title { font-size: 18px; font-weight: 600; color: #2c3e50; margin-bottom: 12px; }
		.tab-wrapper { display: flex; align-items: center; gap: 5px; }
		@keyframes fadeIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
		@media (max-width: 768px) { .skill-grid { grid-template-columns: 1fr; } }
		@supports (-webkit-touch-callout: none) { /* iOS specific - use native emoji keyboard */ input[type="text"].emoji-input {  font-size: 32px; } }
    
	</style>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container">
		<div class="header-wrapper">
        	<div class="header">
            	<div class="edit-toggle"><button class="edit-btn" id="editModeBtn" onclick="toggleEditMode()">Edit</button></div>
            	<h1>📚 Essential Life Skills Guide</h1>
            <p>Fundamental knowledge everyone should have to navigate life successfully</p>
        </div>
        <div class="nav-tabs" id="navTabs"></div>
		</div>
        <div class="content-area" id="contentArea"></div>
    </div>
    <script>
// Initialize Firebase - REPLACE WITH YOUR CONFIG
const firebaseConfig = {
  apiKey: "AIzaSyA5k5pOZjWTrV3b1f51-aWH2AgDUY-p5hE",
  authDomain: "life-akuk095.firebaseapp.com",
  databaseURL: "https://life-akuk095-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "life-akuk095",
  storageBucket: "life-akuk095.firebasestorage.app",
  messagingSenderId: "80383828301",
  appId: "1:80383828301:web:7c001b7375f63fc5055704",
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();
let currentGuideId = "defaultGuide"; 
// Default data structure
let categories = [
    {
        name: "Health & Body", 
        icon: "💪", 
        skills: [
            {
                title: "Basic Hygiene", 
                icon: "🧼", 
                items: ["Brush teeth twice daily", "Shower regularly", "Wash hands before eating"]
            }
        ]
    },
    {
        name: "Daily Living", 
        icon: "🏡", 
        skills: [
            {
                title: "Household Basics", 
                icon: "🧹", 
                items: ["Do laundry", "Clean regularly", "Take out trash"]
            }
        ]
    }
];

let checkedItems = {};
let editMode = false;
let activeTabIndex = 0;
let appIcon = "📚"; 
let appTitle = "Essential Life Skills Guide";
let appSubtitle = "Fundamental knowledge everyone should have to navigate life successfully";
let themeColor = '#607d8b'; // Default grey
let layoutMode = 'vertical'; // 'vertical', 'horizontal', or 'headings'
let autoRefreshEnabled = false;
let autoRefreshTime = "00:00"; // Default midnight
let expandedCards = {};

		
const colorThemes = [
    // Calm (3 options)
    { name: 'Calm Blue', primary: '#5DADE2', secondary: '#85C1E2' },
    { name: 'Calm Sage', primary: '#A8DADC', secondary: '#88B5B7' },
    { name: 'Calm Lavender', primary: '#B4A7D6', secondary: '#9A8AC2' },
    
    // Warm (3 options)
    { name: 'Warm Coral', primary: '#FF6B6B', secondary: '#EE5A52' },
    { name: 'Warm Peach', primary: '#FFAB73', secondary: '#FF8C42' },
    { name: 'Warm Gold', primary: '#FFD93D', secondary: '#F4C430' },
    
    // Earthy (3 options)
    { name: 'Earthy Terracotta', primary: '#D4A574', secondary: '#B8956A' },
    { name: 'Earthy Olive', primary: '#8B9556', secondary: '#6B7346' },
    { name: 'Earthy Clay', primary: '#C97D60', secondary: '#A86B52' },
    
    // Energetic (3 options)
    { name: 'Energetic Orange', primary: '#FF8C42', secondary: '#FF6B35' },
    { name: 'Energetic Magenta', primary: '#EC4899', secondary: '#DB2777' },
    { name: 'Energetic Lime', primary: '#84CC16', secondary: '#65A30D' },
    
    // Elegant (3 options)
    { name: 'Elegant Navy', primary: '#1E3A5F', secondary: '#2C5F8D' },
    { name: 'Elegant Plum', primary: '#8B5A8C', secondary: '#6B4A6C' },
    { name: 'Elegant Burgundy', primary: '#8B4359', secondary: '#6B3349' },
    
    // Minimal (3 options)
    { name: 'Minimal Grey', primary: '#607D8B', secondary: '#455A64' },
    { name: 'Minimal Slate', primary: '#64748B', secondary: '#475569' },
    { name: 'Minimal Stone', primary: '#78716C', secondary: '#57534E' },
    
    // Playful (3 options)
    { name: 'Playful Pink', primary: '#FF6B9D', secondary: '#FF85B3' },
    { name: 'Playful Teal', primary: '#06B6D4', secondary: '#0891B2' },
    { name: 'Playful Purple', primary: '#A855F7', secondary: '#9333EA' },
    
    // Muted (3 options)
    { name: 'Muted Rose', primary: '#D4A5A5', secondary: '#B89090' },
    { name: 'Muted Teal', primary: '#81A8A4', secondary: '#6B8E8A' },
    { name: 'Muted Mauve', primary: '#B4A5B4', secondary: '#9A8A9A' },
    
    // Vintage (3 options)
    { name: 'Vintage Mustard', primary: '#D4A76A', secondary: '#B8915A' },
    { name: 'Vintage Teal', primary: '#5F9EA0', secondary: '#4A7E80' },
    { name: 'Vintage Rust', primary: '#B85C50', secondary: '#9A4C42' },
    
    // Dark (1 option)
    { name: 'Dark', primary: '#0A0A0A', secondary: '#000000' }
];
// Load data from Firebase on startup
function loadFromFirebase() {
    // Hide container initially
    document.querySelector('.container').classList.remove('loaded');
    
    database.ref(`guides/${currentGuideId}`).once('value', (snapshot) => {
        if (!snapshot.exists()) {
            database.ref(`guides/${currentGuideId}`).set({
                appTitle, appSubtitle, appIcon, categories, checkedItems, themeColor
            });
        }
    });

    // Use Promise.all to wait for all data to load
    Promise.all([
    database.ref(`guides/${currentGuideId}/categories`).once('value'),
    database.ref(`guides/${currentGuideId}/checkedItems`).once('value'),
    database.ref(`guides/${currentGuideId}/appTitle`).once('value'),
    database.ref(`guides/${currentGuideId}/appSubtitle`).once('value'),
    database.ref(`guides/${currentGuideId}/appIcon`).once('value'),
    database.ref(`guides/${currentGuideId}/themeColor`).once('value'),
    database.ref(`guides/${currentGuideId}/layoutMode`).once('value'),
    database.ref(`guides/${currentGuideId}/expandedCards`).once('value'),
    database.ref(`guides/${currentGuideId}/autoRefreshEnabled`).once('value'),
    database.ref(`guides/${currentGuideId}/autoRefreshTime`).once('value'),
    database.ref(`guides/${currentGuideId}/lastRefreshDate`).once('value')
]).then(([categoriesSnap, checkedSnap, titleSnap, subtitleSnap, iconSnap, themeSnap, layoutSnap, expandedSnap, autoRefreshEnabledSnap, autoRefreshTimeSnap, lastRefreshSnap]) => {
		
        // Load categories
        if (categoriesSnap.val()) {
            categories = categoriesSnap.val();
        }
        
        // Load checked items
        if (checkedSnap.val()) {
            checkedItems = checkedSnap.val();
        }
        
        // Load app title
        if (titleSnap.val()) {
            appTitle = titleSnap.val();
        }
        
        // Load app subtitle
        if (subtitleSnap.val()) {
            appSubtitle = subtitleSnap.val();
        }
        
        // Load app icon
        if (iconSnap.val() !== null) {
            appIcon = iconSnap.val();
        }
        
        // Load theme color
        if (themeSnap.val()) {
            themeColor = themeSnap.val();
        } else {
    		themeColor = '#607d8b'; // Default grey if no theme saved
		}
        
        // Load layout mode
        if (layoutSnap.val()) {
            layoutMode = layoutSnap.val();
        }
		// Load expanded cards
		if (expandedSnap.val()) {
		    expandedCards = expandedSnap.val();
		}
        // Load auto-refresh settings
		if (autoRefreshEnabledSnap.val() !== null) {
    		autoRefreshEnabled = autoRefreshEnabledSnap.val();
		}
		if (autoRefreshTimeSnap.val()) {
    		autoRefreshTime = autoRefreshTimeSnap.val();
		}

		// Check if we need to auto-refresh
		checkAndAutoRefresh(lastRefreshSnap.val());
        // Apply theme
        applyTheme();
        
        // Render everything
        renderHeader();
        renderTabs();
        renderContent();
        updateLayoutButton();
        
        // Show container with fade-in effect
        document.querySelector('.container').classList.add('loaded');
    });
}

function switchGuide(id) {
    currentGuideId = id;
    // Reset to default theme before loading
    themeColor = '#607d8b';
    loadFromFirebase();
}
function applyTheme() {
    const theme = colorThemes.find(t => t.primary === themeColor);
    
    if (theme) {
        // Use preset theme
        document.documentElement.style.setProperty('--primary-color', theme.primary);
        document.documentElement.style.setProperty('--secondary-color', theme.secondary);
        
        document.body.style.background = `linear-gradient(135deg, ${theme.secondary}CC 0%, ${theme.primary}CC 100%)`;
        
        const header = document.querySelector('.header');
        if (header) {
            header.style.background = `linear-gradient(135deg, ${theme.secondary} 0%, ${theme.primary} 100%)`;
        }
    } else {
        // Custom color - calculate darker shade
        const hex = themeColor.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        const secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
        
        document.documentElement.style.setProperty('--primary-color', themeColor);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        
        document.body.style.background = `linear-gradient(135deg, ${secondaryColor}CC 0%, ${themeColor}CC 100%)`;
        
        const header = document.querySelector('.header');
        if (header) {
            header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${themeColor} 100%)`;
        }
    }
}
function toggleColorPicker(e) {
    e.stopPropagation();
    const picker = document.getElementById('colorPickerMenu');
    picker.classList.toggle('show');
}

function selectColor(color) {
    themeColor = color;
    database.ref(`guides/${currentGuideId}/themeColor`).set(themeColor);
    applyTheme();
    renderHeader(); // Re-render to update selected color
    
    // Close both color picker and dropdown menu
    document.getElementById('colorPickerMenu').classList.remove('show');
    document.getElementById('dropdownMenu').classList.remove('show');
}

function selectCustomColor(color) {
    // Find the closest matching theme or create a gradient
    const selectedTheme = colorThemes.find(t => t.primary === color);
    
    if (selectedTheme) {
        themeColor = selectedTheme.primary;
    } else {
        // Create a custom theme with a slightly darker shade for secondary
        themeColor = color;
        
        // Calculate a darker secondary color
        const hex = color.replace('#', '');
        const r = parseInt(hex.substr(0, 2), 16);
        const g = parseInt(hex.substr(2, 2), 16);
        const b = parseInt(hex.substr(4, 2), 16);
        
        const darkerR = Math.max(0, r - 30);
        const darkerG = Math.max(0, g - 30);
        const darkerB = Math.max(0, b - 30);
        
        const secondaryColor = '#' + [darkerR, darkerG, darkerB]
            .map(x => x.toString(16).padStart(2, '0')).join('');
        
        // Temporarily add custom theme
        const customTheme = { name: 'Custom', primary: color, secondary: secondaryColor };
        
        // Update CSS variables directly for custom color
        document.documentElement.style.setProperty('--primary-color', color);
        document.documentElement.style.setProperty('--secondary-color', secondaryColor);
        
        // Update backgrounds
        document.body.style.background = `linear-gradient(135deg, ${secondaryColor}CC 0%, ${color}CC 100%)`;
        const header = document.querySelector('.header');
        if (header) {
            header.style.background = `linear-gradient(135deg, ${secondaryColor} 0%, ${color} 100%)`;
        }
    }
    
    database.ref(`guides/${currentGuideId}/themeColor`).set(themeColor);
    
    if (selectedTheme) {
        applyTheme();
        renderHeader();
    }
    
    // Close menus
    document.getElementById('colorPickerMenu').classList.remove('show');
    document.getElementById('dropdownMenu').classList.remove('show');
}
function createNewGuide() {
    const name = prompt("Enter a name for this new guide:");
    if (!name) return;
    const id = `guide_${Date.now()}`;
    const newGuide = {
        appTitle: name,
        appSubtitle: "Click to edit subtitle",
        appIcon: "📘",
        categories: [
            {
                name: "New Category",
                icon: "📌",
                skills: [
                    { title: "New Skill", icon: "✨", items: ["New item - click to edit"] }
                ]
            }
        ],
        checkedItems: {},
        themeColor: themeColor
    };
    database.ref(`guides/${id}`).set(newGuide).then(() => {
        currentGuideId = id;
        loadFromFirebase();
    });
}
function toggleGuideMenu(e) {
    e.stopPropagation();
    const dropdown = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    
    const isShowing = dropdown.classList.contains('show');
    
    if (isShowing) {
        // Close drawer
        dropdown.classList.remove('show');
        backdrop.classList.remove('show');
        document.body.style.overflow = ''; // Restore scrolling
    } else {
        // Open drawer
        dropdown.classList.add('show');
        backdrop.classList.add('show');
        document.body.style.overflow = 'hidden'; // Prevent background scroll
    }
    
    // Close other menus
    const otherMenu = document.getElementById('dropdownMenu');
    if (otherMenu) otherMenu.classList.remove('show');
}

function closeDrawer() {
    const dropdown = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    
    dropdown.classList.remove('show');
    backdrop.classList.remove('show');
    document.body.style.overflow = '';
}

function toggleMenu(e) {
    e.stopPropagation();
    const menu = document.getElementById('dropdownMenu');
    const isCurrentlyShown = menu.classList.contains('show');
    
    menu.classList.toggle('show');
    
    // Close other menus
    const guideMenu = document.getElementById('guideDropdown');
    if (guideMenu) guideMenu.classList.remove('show');
    
    // If we just closed it, trigger a re-render to reset button state
    if (isCurrentlyShown) {
        // Force button to lose focus
        e.target.blur();
    }
}

function duplicateGuide() {
    const timestamp = Date.now();
    const newId = `${currentGuideId}_copy_${timestamp}`;
    
    database.ref(`guides/${currentGuideId}`).once('value', (snapshot) => {
        const data = snapshot.val();
        if (data.appTitle) {
            data.appTitle = data.appTitle + ' (Copy)';
        }
        database.ref(`guides/${newId}`).set(data).then(() => {
            currentGuideId = newId;
            loadFromFirebase();
        });
    });
}

function deleteGuide() {
    if (currentGuideId === 'defaultGuide') {
        alert("Cannot delete the default guide!");
        return;
    }
    if (confirm("Delete this entire guide? This cannot be undone.")) {
        database.ref(`guides/${currentGuideId}`).remove();
        currentGuideId = 'defaultGuide';
        loadGuideList();
        loadFromFirebase();
    }
}
function saveHeader() {
  database.ref(`guides/${currentGuideId}/appTitle`).set(appTitle);
  database.ref(`guides/${currentGuideId}/appSubtitle`).set(appSubtitle);
  database.ref(`guides/${currentGuideId}/appIcon`).set(appIcon);
  renderHeader(); // Update display immediately
  populateGuideDropdown(); // Update drawer list
}


function renderHeader() {
    const header = document.querySelector('.header');
    
    // Generate color options HTML
    let colorOptionsHTML = '';
    colorThemes.forEach(theme => {
        const isSelected = theme.primary === themeColor ? 'selected' : '';
        colorOptionsHTML += `
            <div class="color-option ${isSelected}" 
                 style="background: linear-gradient(135deg, ${theme.secondary} 0%, ${theme.primary} 100%);"
                 onclick="selectColor('${theme.primary}')"
                 title="${theme.name}">
            </div>
        `;
    });
    
    header.innerHTML = `
<button class="guide-menu-btn" onclick="toggleGuideMenu(event)">☰</button>
<div id="drawerBackdrop" class="drawer-backdrop" onclick="closeDrawer()"></div>
<div class="guide-dropdown" id="guideDropdown">
    <div class="drawer-header">📚 My Guides</div>
</div>
<div class="edit-toggle">
    <button class="edit-btn" id="menuBtn" onclick="toggleMenu(event)">⋮</button>
<div class="dropdown-menu" id="dropdownMenu">
    <button onclick="createNewGuide()">Create new</button>
    <button onclick="toggleEditMode()">Edit</button>
    <button onclick="duplicateGuide()">Duplicate</button>
    <button onclick="deleteGuide()">Delete</button>
    <button onclick="toggleColorPicker(event)">Theme</button>
    <button onclick="clearAllChecks()">Clear all checks</button>
    <button onclick="toggleAutoRefresh()">
        ${autoRefreshEnabled ? `✓ Auto-refresh (${autoRefreshTime})` : 'Auto-refresh daily'}
    </button>
    <div class="color-picker-menu" id="colorPickerMenu">
        <h3>Choose Theme Color</h3>
        <div style="margin-bottom: 15px;">
            <label style="display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 5px;">Custom Color:</label>
            <input type="color" id="customColorPicker" value="${themeColor}" 
                   style="width: 100%; height: 40px; border: 2px solid #dee2e6; border-radius: 6px; cursor: pointer;"
                   onchange="selectCustomColor(this.value)">
        </div>
        <div style="border-top: 1px solid #dee2e6; padding-top: 10px; margin-top: 10px;">
            <label style="display: block; font-size: 12px; color: #7f8c8d; margin-bottom: 8px;">Preset Themes:</label>
            <div class="color-options">
                ${colorOptionsHTML}
            </div>
        </div>
    </div>
</div>
</div>
<h1>
    <span class="editable-icon" style="display: inline-block; position: relative;">
        <span class="icon" ${editMode ? 'onclick="editAppIcon(this)"' : ''} style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${appIcon && appIcon !== "​" ? '1' : '0.3'};">${appIcon && appIcon !== "​" ? appIcon : (editMode ? "➕" : "​")}</span>
        ${editMode && appIcon && appIcon !== "​" ? '<span class="emoji-remove-btn" onclick="event.stopPropagation(); appIcon = \'​\'; saveHeader();">×</span>' : ''}
    </span>
    <span class="${editMode ? 'editable' : ''}" contenteditable="${editMode}">
        ${appTitle}
    </span>
</h1>
<p class="${editMode ? 'editable' : ''}" contenteditable="${editMode}">${appSubtitle}</p>
    `;

    // Apply current theme
    applyTheme();

    // Populate guide dropdown
    populateGuideDropdown();

    if (editMode) {
        header.querySelector('h1 span.editable').addEventListener('blur', (e) => {
            appTitle = e.target.textContent.trim();
            saveHeader();
        });
        header.querySelector('p').addEventListener('blur', (e) => {
            appSubtitle = e.target.textContent.trim();
            saveHeader();
        });
    }
}
function populateGuideDropdown() {
    database.ref('guides').once('value', (snapshot) => {
        const guides = snapshot.val() || {};
        const dropdown = document.getElementById('guideDropdown');
        
        // Keep the header, clear only the guide list
        const header = dropdown.querySelector('.drawer-header');
        dropdown.innerHTML = '';
        if (header) dropdown.appendChild(header);
        
        for (let id in guides) {
            const title = guides[id].appTitle || id;
            const icon = guides[id].appIcon || '📄';
            const guideTheme = guides[id].themeColor || '#3498db';
            
            const btn = document.createElement('button');
            btn.style.borderLeft = `4px solid ${guideTheme}`;
            btn.style.background = `linear-gradient(90deg, ${guideTheme}15 0%, transparent 100%)`;
            btn.style.display = 'flex';
            btn.style.alignItems = 'center';
            btn.style.justifyContent = 'space-between';
            
            const nameSpan = document.createElement('span');
            nameSpan.textContent = `${icon} ${title}`;
            btn.appendChild(nameSpan);
            
            if (editMode && id !== 'defaultGuide') {
                const delBtn = document.createElement('span');
                delBtn.textContent = 'del';
                delBtn.style.background = '#e74c3c';
                delBtn.style.color = '#f8f9fa';
                delBtn.style.padding = '4px 10px';
                delBtn.style.borderRadius = '6px';
                delBtn.style.fontSize = '12px';
                delBtn.style.fontWeight = 'bold';
                delBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (confirm(`Delete guide "${title}"? This cannot be undone.`)) {
                        database.ref(`guides/${id}`).remove();
                        if (currentGuideId === id) {
                            currentGuideId = 'defaultGuide';
                            loadFromFirebase();
                        } else {
                            populateGuideDropdown();
                        }
                    }
                };
                btn.appendChild(delBtn);
            }
            
            btn.onclick = (e) => {
                if (!e.target.textContent.includes('del')) {
                    switchGuide(id);
                    closeDrawer();
                }
            };
            
            if (id === currentGuideId) {
                btn.classList.add('current-guide');
            }
            
            dropdown.appendChild(btn);
        }
        
        // Add create new guide button (only when not in edit mode)
        if (!editMode) {
            const createBtn = document.createElement('button');
            createBtn.textContent = '+ Create new guide';
            createBtn.style.borderLeft = '4px solid #3498db';
            createBtn.style.borderRight = '2px solid #3498db';
            createBtn.style.borderTop = 'none';
            createBtn.style.borderBottom = '1px solid #f0f0f0';
            createBtn.style.background = 'transparent';
            createBtn.style.color = '#3498db';
            createBtn.style.fontWeight = '600';
            createBtn.style.borderRadius = '0';
            createBtn.style.margin = '0';
            createBtn.onclick = () => {
                createNewGuide();
                closeDrawer();
            };
            dropdown.appendChild(createBtn);
        }
    });
}
function saveAndExitEdit() {
    editMode = false;
    document.body.classList.remove('edit-mode-active');
    
    // Hide save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.style.display = 'none';
    }
    
    renderHeader();
    renderTabs();
    renderContent();
}
function showEmojiPicker(target, callback) {
    const existingInput = document.querySelector('.emoji-input-field');
    if (existingInput) {
        existingInput.remove();
        return;
    }
    
    const inputWrapper = document.createElement('div');
    inputWrapper.style.position = 'fixed';
    inputWrapper.style.top = '50%';
    inputWrapper.style.left = '50%';
    inputWrapper.style.transform = 'translate(-50%, -50%)';
    inputWrapper.style.background = 'white';
    inputWrapper.style.padding = '20px';
    inputWrapper.style.borderRadius = '12px';
    inputWrapper.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
    inputWrapper.style.zIndex = '10000';
    inputWrapper.className = 'emoji-input-field';
    
    const label = document.createElement('div');
    label.textContent = 'Paste or type emoji:';
    label.style.marginBottom = '10px';
    label.style.fontSize = '14px';
    label.style.color = '#2c3e50';
    inputWrapper.appendChild(label);
    
	const input = document.createElement('input');
	input.type = 'text';
	input.maxLength = 4;
	input.style.fontSize = '32px';
	input.style.width = '80px';
	input.style.textAlign = 'center';
	input.style.border = '2px solid #3498db';
	input.style.borderRadius = '8px';
	input.style.padding = '10px';
	input.style.outline = 'none';
	input.placeholder = '✅';
	
	// Restrict to emoji only
	input.addEventListener('input', (e) => {
	    const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu;
	    const matches = e.target.value.match(emojiRegex);
	    if (matches) {
	        e.target.value = matches[0]; // Keep only first emoji
	    } else {
	        e.target.value = ''; // Clear if not emoji
	    }
	});
	
	inputWrapper.appendChild(input);
    
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '15px';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.gap = '10px';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Confirm';
    confirmBtn.style.flex = '1';
    confirmBtn.style.padding = '8px';
    confirmBtn.style.background = '#27ae60';
    confirmBtn.style.color = 'white';
    confirmBtn.style.border = 'none';
    confirmBtn.style.borderRadius = '6px';
    confirmBtn.style.cursor = 'pointer';
    confirmBtn.onclick = () => {
        if (input.value) {
            callback(input.value);
        }
        inputWrapper.remove();
    };
    buttonContainer.appendChild(confirmBtn);
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.flex = '1';
    cancelBtn.style.padding = '8px';
    cancelBtn.style.background = '#95a5a6';
    cancelBtn.style.color = 'white';
    cancelBtn.style.border = 'none';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.onclick = () => inputWrapper.remove();
    buttonContainer.appendChild(cancelBtn);
    
    inputWrapper.appendChild(buttonContainer);
    
    const hint = document.createElement('div');
    hint.style.marginTop = '10px';
    hint.style.fontSize = '11px';
    hint.style.color = '#7f8c8d';
    hint.style.textAlign = 'center';
    
    if (navigator.userAgent.includes('Windows')) {
        hint.textContent = 'Win + . to open emoji picker';
    } else if (navigator.userAgent.includes('Mac')) {
        hint.textContent = '⌘ + ^ + Space for emoji picker';
    } else {
        hint.textContent = 'Use your keyboard\'s emoji button';
    }
    inputWrapper.appendChild(hint);
    
    document.body.appendChild(inputWrapper);
    input.focus();
    
    // Close on outside click
    setTimeout(() => {
        document.addEventListener('click', function closeInput(e) {
            if (!inputWrapper.contains(e.target)) {
                inputWrapper.remove();
                document.removeEventListener('click', closeInput);
            }
        });
    }, 100);
}
// Save categories to Firebase
function saveCategories() {
    database.ref(`guides/${currentGuideId}/categories`).set(categories);
}

// Save checked items to Firebase
function saveCheckedItems() {
   database.ref(`guides/${currentGuideId}/checkedItems`).set(checkedItems)
}
		
// Save auto-refresh settings to Firebase
function saveAutoRefreshSettings() {
    database.ref(`guides/${currentGuideId}/autoRefreshEnabled`).set(autoRefreshEnabled);
    database.ref(`guides/${currentGuideId}/autoRefreshTime`).set(autoRefreshTime);
}

		function checkAndAutoRefresh(lastRefreshDate) {
    if (!autoRefreshEnabled) return;
    
    const now = new Date();
    const today = now.toDateString();
    
    // If we already refreshed today, don't do it again
    if (lastRefreshDate === today) return;
    
    // Parse the refresh time (format: "HH:MM")
    const [hours, minutes] = autoRefreshTime.split(':').map(Number);
    const refreshTime = new Date();
    refreshTime.setHours(hours, minutes, 0, 0);
    
    // If current time is past the refresh time and we haven't refreshed today
    if (now >= refreshTime && lastRefreshDate !== today) {
        // Clear all checked items
        checkedItems = {};
        saveCheckedItems();
        
        // Mark that we refreshed today
        database.ref(`guides/${currentGuideId}/lastRefreshDate`).set(today);
        
        // Re-render to show unchecked items
        renderContent();
    }
}

function clearAllChecks() {
    if (confirm('Clear all checkmarks? This cannot be undone.')) {
        checkedItems = {};
        saveCheckedItems();
        const today = new Date().toDateString();
        database.ref(`guides/${currentGuideId}/lastRefreshDate`).set(today);
        renderContent();
    }
}

function toggleAutoRefresh() {
    const enabled = confirm(
        autoRefreshEnabled 
            ? 'Disable automatic daily refresh?' 
            : `Enable automatic daily refresh at ${autoRefreshTime}?\n\nThis will clear all checkmarks at the specified time each day.`
    );
    
    if (enabled) {
        if (!autoRefreshEnabled) {
            const time = prompt('Enter refresh time (HH:MM format, 24-hour):', autoRefreshTime);
            if (time && /^([0-1]?[0-9]|2[0-3]):[0-5][0-9]$/.test(time)) {
                autoRefreshTime = time;
                autoRefreshEnabled = true;
            } else {
                alert('Invalid time format. Please use HH:MM (e.g., 09:00 or 23:30)');
                return;
            }
        } else {
            autoRefreshEnabled = false;
        }
        saveAutoRefreshSettings();
        renderHeader(); // Update menu display
    }
}
function renderTabs() { 
    const navTabs = document.getElementById('navTabs'); 
    navTabs.innerHTML = ''; 
    
    categories.forEach((cat, i) => { 
        const tabWrapper = document.createElement('div');
        tabWrapper.className = 'tab-wrapper';
        
        const tab = document.createElement('button'); 
        tab.className = 'nav-tab' + (i === activeTabIndex ? ' active' : ''); 
        
        // Make tab editable in edit mode
        if (editMode) {
            const hasTabIcon = cat.icon && cat.icon !== "​";
const tabIconToShow = hasTabIcon ? cat.icon : "➕";

tab.innerHTML = `
    <span class="editable-icon" onclick="event.stopPropagation(); editCategoryIcon(${i}, this)" style="display: inline-block; position: relative;">
        <span class="tab-icon" style="opacity: ${hasTabIcon ? '1' : '0.3'};">${tabIconToShow}</span>
        ${hasTabIcon ? `<span class="emoji-remove-btn" onclick="event.stopPropagation(); categories[${i}].icon = '​'; saveCategories(); renderTabs(); renderContent();">×</span>` : ''}
    </span>
    <span class="tab-name editable" contenteditable="true" onclick="event.stopPropagation()">${cat.name}</span>
`;
            
            // Save name when editing
            const nameSpan = tab.querySelector('.tab-name');
            nameSpan.addEventListener('blur', (e) => {
                categories[i].name = e.target.textContent.trim();
                saveCategories();
            });
            nameSpan.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    e.target.blur();
                }
            });
            
            // Click to switch tabs (but not when editing text)
            tab.addEventListener('click', (e) => {
                if (!e.target.classList.contains('editable') && !e.target.classList.contains('editable-icon')) {
                    switchTab(i);
                }
            });
        } else {
            tab.textContent = `${cat.icon} ${cat.name}`; 
            tab.onclick = () => switchTab(i);
        }
        
        tabWrapper.appendChild(tab);
        
        if (editMode) {
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'delete-tab-btn';
            deleteBtn.textContent = '×';
            deleteBtn.onclick = (e) => {
                e.stopPropagation();
                deleteCategory(i);
            };
            tabWrapper.appendChild(deleteBtn);
        }
        
        navTabs.appendChild(tabWrapper); 
    }); 
    
    if (editMode) {
        const addCategoryBtn = document.createElement('button');
        addCategoryBtn.className = 'nav-tab add-category-tab';
        addCategoryBtn.textContent = '+';
        addCategoryBtn.onclick = addCategory;
        navTabs.appendChild(addCategoryBtn);
    }
}

function renderContent() { 
    const contentArea = document.getElementById('contentArea'); 
    contentArea.innerHTML = ''; 
    contentArea.className = 'content-area' + (editMode ? ' edit-mode' : ''); 
    
    categories.forEach((cat, catIndex) => { 
       const catDiv = document.createElement('div'); 
        catDiv.className = 'category' + (catIndex === activeTabIndex ? ' active' : '');
        
        const grid = document.createElement('div'); 
        grid.className = 'skill-grid' + 
            (layoutMode === 'horizontal' ? ' horizontal' : '') + 
            (layoutMode === 'headings' ? ' headings' : ''); 
        
        cat.skills.forEach((skill, skillIndex) => { 
            const card = document.createElement('div'); 
            card.className = 'skill-card';
            card.dataset.catIndex = catIndex;
            card.dataset.skillIndex = skillIndex; 
            
            const titleDiv = document.createElement('div'); 
            titleDiv.className = 'skill-title'; 
            const iconDisplay = skill.icon && skill.icon !== "​" ? skill.icon : "​";
			const removeBtn = editMode && skill.icon && skill.icon !== "​" 
    			? `<span class="emoji-remove-btn" onclick="event.stopPropagation(); categories[${catIndex}].skills[${skillIndex}].icon = '​'; saveCategories(); renderContent();">×</span>` 
    			: '';

			const hasIcon = skill.icon && skill.icon !== "​";
const iconToShow = hasIcon ? skill.icon : (editMode ? "➕" : "​");

titleDiv.innerHTML = `
   <span class="editable-icon" style="display: inline-block; position: relative;">
       <span class="icon" ${editMode ? `onclick="editSkillIcon(${catIndex}, ${skillIndex}, this)"` : ''} style="cursor: ${editMode ? 'pointer' : 'default'}; opacity: ${hasIcon ? '1' : '0.3'};">${iconToShow}</span>
       ${editMode && hasIcon ? `<span class="emoji-remove-btn" onclick="event.stopPropagation(); categories[${catIndex}].skills[${skillIndex}].icon = '​'; saveCategories(); renderContent();">×</span>` : ''}
   </span>
   <span class="${editMode ? 'editable' : ''}" contenteditable="${editMode}">${skill.title}</span>
`;
			// Add collapse button for headings mode
				// Add collapse button for headings mode
				if (layoutMode === 'headings' && !editMode) {
				    const collapseBtn = document.createElement('button');
				    collapseBtn.className = 'collapse-btn';
				    collapseBtn.innerHTML = `
				        <svg viewBox="0 0 24 24" fill="none" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
				            <polyline points="4 14 10 14 10 20"></polyline>
				            <polyline points="20 10 14 10 14 4"></polyline>
				            <line x1="14" y1="10" x2="21" y2="3"></line>
				            <line x1="3" y1="21" x2="10" y2="14"></line>
				        </svg>
				    `;
				    collapseBtn.onclick = (e) => {
				        e.stopPropagation();
				        card.classList.remove('expanded');
				        const cardId = `${catIndex}-${skillIndex}`;
				        delete expandedCards[cardId];
				        saveExpandedCards();
				    };
				    titleDiv.appendChild(collapseBtn);
				}
            
            if (editMode) { 
                const deleteSkillBtn = document.createElement('button');
                deleteSkillBtn.className = 'delete-btn';
                deleteSkillBtn.textContent = '×';
                deleteSkillBtn.onclick = () => deleteSkill(catIndex, skillIndex);
                titleDiv.appendChild(deleteSkillBtn);
                
                titleDiv.querySelector('.editable').addEventListener('blur', (e) => { 
                    categories[catIndex].skills[skillIndex].title = e.target.textContent.trim(); 
                    saveCategories();
                }); 
            } 
            
            card.appendChild(titleDiv); 
            
            skill.items.forEach((item, itemIndex) => { 
                const itemId = `${catIndex}-${skillIndex}-${itemIndex}`; 
                const checkItem = document.createElement('div'); 
                checkItem.className = 'checklist-item' + (checkedItems[itemId] ? ' checked' : ''); 
                if (!editMode) checkItem.onclick = () => toggleCheck(itemId); 
                
                const checkbox = document.createElement('div');
                checkbox.className = 'checkbox';
                checkItem.appendChild(checkbox);
                
                const textDiv = document.createElement('div');
                textDiv.className = 'checklist-text' + (editMode ? ' editable' : '');
                textDiv.contentEditable = editMode;
                textDiv.textContent = item;
                checkItem.appendChild(textDiv);
                
                if (editMode) {
                    const deleteItemBtn = document.createElement('button');
                    deleteItemBtn.className = 'delete-btn';
                    deleteItemBtn.textContent = '×';
                    deleteItemBtn.onclick = () => deleteItem(catIndex, skillIndex, itemIndex);
                    checkItem.appendChild(deleteItemBtn);
                    
                    textDiv.addEventListener('blur', (e) => { 
                        categories[catIndex].skills[skillIndex].items[itemIndex] = e.target.textContent.trim(); 
                        saveCategories();
                    }); 
                }
                
                card.appendChild(checkItem); 
            }); 
            
            const addItemBtn = document.createElement('button'); 
            addItemBtn.className = 'add-item-btn'; 
            addItemBtn.textContent = '+ Add Item'; 
            addItemBtn.onclick = () => addItem(catIndex, skillIndex); 
            card.appendChild(addItemBtn); 
            
            grid.appendChild(card); 
			// Add click handler for headings mode
            // Add click handler for headings mode
			if (layoutMode === 'headings' && !editMode) {
			    const cardId = `${catIndex}-${skillIndex}`;
			    
			    // Restore expanded state if it was expanded before
			    if (expandedCards[cardId]) {
			        card.classList.add('expanded');
			    }
			    
			    card.addEventListener('click', function(e) {
			        // Don't toggle if clicking on checkbox or editable content
			        if (e.target.classList.contains('checkbox') || 
			            e.target.classList.contains('editable') ||
			            e.target.classList.contains('delete-btn')) {
			            return;
			        }
			        // Only expand, never collapse
			        this.classList.add('expanded');
			        expandedCards[cardId] = true;
			        saveExpandedCards();
			    });
			}
        }); 
        
        catDiv.appendChild(grid); 
        
        const addSkillBtn = document.createElement('button'); 
        addSkillBtn.className = 'add-skill-btn'; 
        addSkillBtn.textContent = '+ Add New Card'; 
        addSkillBtn.onclick = () => addSkill(catIndex); 
        catDiv.appendChild(addSkillBtn); 
        
        contentArea.appendChild(catDiv); 
    }); 
}

function switchTab(index) { 
    activeTabIndex = index; 
    renderTabs();
    const cats = document.querySelectorAll('.category'); 
    cats.forEach((cat, i) => cat.classList.toggle('active', i === activeTabIndex)); 
}

function toggleCheck(itemId) { 
    if (editMode) return; 
    
    // Store expanded state before re-render
    const expandedCards = [];
    document.querySelectorAll('.skill-card.expanded').forEach(card => {
        expandedCards.push({
            catIndex: card.dataset.catIndex,
            skillIndex: card.dataset.skillIndex
        });
    });
    
    checkedItems[itemId] = !checkedItems[itemId]; 
    saveCheckedItems();
    renderContent(); 
    
    // Restore expanded state after re-render
    expandedCards.forEach(({catIndex, skillIndex}) => {
        const card = document.querySelector(`.skill-card[data-cat-index="${catIndex}"][data-skill-index="${skillIndex}"]`);
        if (card) card.classList.add('expanded');
    });
}

function toggleEditMode() { 
    const menu = document.getElementById('dropdownMenu');
    if (menu) menu.classList.remove('show'); 
    
    editMode = !editMode; 
    
    // Toggle class on body to hide/show floating button
    if (editMode) {
        document.body.classList.add('edit-mode-active');
    } else {
        document.body.classList.remove('edit-mode-active');
    }
    
    // Show/hide save button
    const saveBtn = document.getElementById('saveBtn');
    if (saveBtn) {
        saveBtn.style.display = editMode ? 'block' : 'none';
    }
    
    renderHeader();
    renderTabs();
    renderContent(); 
}

function editAppIcon(el) {
    const existingInput = document.querySelector('.emoji-input-field');
    if (existingInput) {
        existingInput.remove();
        return;
    }
    
    const inputWrapper = document.createElement('div');
    inputWrapper.style.position = 'fixed';
    inputWrapper.style.top = '50%';
    inputWrapper.style.left = '50%';
    inputWrapper.style.transform = 'translate(-50%, -50%)';
    inputWrapper.style.background = 'white';
    inputWrapper.style.padding = '20px';
    inputWrapper.style.borderRadius = '12px';
    inputWrapper.style.boxShadow = '0 4px 20px rgba(0,0,0,0.3)';
    inputWrapper.style.zIndex = '10000';
    inputWrapper.className = 'emoji-input-field';
    
    const label = document.createElement('div');
    label.textContent = 'Paste or type emoji:';
    label.style.marginBottom = '10px';
    label.style.fontSize = '14px';
    label.style.color = '#2c3e50';
    inputWrapper.appendChild(label);
    
	const input = document.createElement('input');
	input.type = 'text';
	input.maxLength = 4;
	input.style.fontSize = '32px';
	input.style.width = '80px';
	input.style.textAlign = 'center';
	input.style.border = '2px solid #3498db';
	input.style.borderRadius = '8px';
	input.style.padding = '10px';
	input.style.outline = 'none';
	input.placeholder = '✅';
	
	// Restrict to emoji only
	input.addEventListener('input', (e) => {
	    const emojiRegex = /(\p{Emoji_Presentation}|\p{Emoji}\uFE0F)/gu;
	    const matches = e.target.value.match(emojiRegex);
	    if (matches) {
	        e.target.value = matches[0]; // Keep only first emoji
	    } else {
	        e.target.value = ''; // Clear if not emoji
	    }
	});
	
	inputWrapper.appendChild(input);
    
    const buttonContainer = document.createElement('div');
    buttonContainer.style.marginTop = '15px';
    buttonContainer.style.display = 'flex';
    buttonContainer.style.gap = '10px';
    
    const confirmBtn = document.createElement('button');
    confirmBtn.textContent = 'Confirm';
    confirmBtn.style.flex = '1';
    confirmBtn.style.padding = '8px';
    confirmBtn.style.background = '#27ae60';
    confirmBtn.style.color = 'white';
    confirmBtn.style.border = 'none';
    confirmBtn.style.borderRadius = '6px';
    confirmBtn.style.cursor = 'pointer';
    confirmBtn.onclick = () => {
        if (input.value) {
            appIcon = input.value;
            saveHeader();
        }
        inputWrapper.remove();
    };
    buttonContainer.appendChild(confirmBtn);
    
    const cancelBtn = document.createElement('button');
    cancelBtn.textContent = 'Cancel';
    cancelBtn.style.flex = '1';
    cancelBtn.style.padding = '8px';
    cancelBtn.style.background = '#95a5a6';
    cancelBtn.style.color = 'white';
    cancelBtn.style.border = 'none';
    cancelBtn.style.borderRadius = '6px';
    cancelBtn.style.cursor = 'pointer';
    cancelBtn.onclick = () => inputWrapper.remove();
    buttonContainer.appendChild(cancelBtn);
    
    inputWrapper.appendChild(buttonContainer);
    
    const hint = document.createElement('div');
    hint.style.marginTop = '10px';
    hint.style.fontSize = '11px';
    hint.style.color = '#7f8c8d';
    hint.style.textAlign = 'center';
    
    if (navigator.userAgent.includes('Windows')) {
        hint.textContent = 'Win + . to open emoji picker';
    } else if (navigator.userAgent.includes('Mac')) {
        hint.textContent = '⌘ + ^ + Space for emoji picker';
    } else {
        hint.textContent = 'Use your keyboard\'s emoji button';
    }
    inputWrapper.appendChild(hint);
    
    document.body.appendChild(inputWrapper);
    input.focus();
    
    // Close on outside click
    setTimeout(() => {
        document.addEventListener('click', function closeInput(e) {
            if (!inputWrapper.contains(e.target)) {
                inputWrapper.remove();
                document.removeEventListener('click', closeInput);
            }
        });
    }, 100);
}
		// Save expanded cards to Firebase
function saveExpandedCards() {
    database.ref(`guides/${currentGuideId}/expandedCards`).set(expandedCards);
}
function addSkill(catIndex) { 
    categories[catIndex].skills.push({ 
        title: "New Skill", 
        icon: "✨", 
        items: ["New item - click to edit"] 
    }); 
    saveCategories();
    renderContent(); 
}
function editSkillIcon(catIndex, skillIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].skills[skillIndex].icon = emoji;
        saveCategories();
        renderContent();
    });
}

function deleteSkill(catIndex, skillIndex) { 
    if (confirm('Delete this skill?')) { 
        categories[catIndex].skills.splice(skillIndex, 1); 
        saveCategories();
        renderContent(); 
    } 
}

function deleteItem(catIndex, skillIndex, itemIndex) { 
    categories[catIndex].skills[skillIndex].items.splice(itemIndex, 1); 
    saveCategories();
    renderContent(); 
}

function addItem(catIndex, skillIndex) { 
    categories[catIndex].skills[skillIndex].items.push("New item"); 
    saveCategories();
    renderContent(); 
}

function addCategory() {
    categories.push({
        name: "New Category",
        icon: "📌",
        skills: [
            {
                title: "New Skill",
                icon: "✨",
                items: ["New item - click to edit"]
            }
        ]
    });
    activeTabIndex = categories.length - 1;
    saveCategories();
    renderTabs();
    renderContent();
}

function editCategoryIcon(catIndex, el) {
    showEmojiPicker(el, (emoji) => {
        categories[catIndex].icon = emoji;
        saveCategories();
        renderTabs();
        renderContent();
    });
}
function toggleLayout() {
    if (layoutMode === 'vertical') {
        layoutMode = 'horizontal';
    } else if (layoutMode === 'horizontal') {
        layoutMode = 'headings';
    } else {
        layoutMode = 'vertical';
    }
    database.ref(`guides/${currentGuideId}/layoutMode`).set(layoutMode);
    renderContent();
    updateLayoutButton();
}

function updateLayoutButton() {
    const btn = document.getElementById('layoutBtn');
    if (btn) {
        // Show icon for NEXT layout (what it will change TO)
        if (layoutMode === 'vertical') {
            // Next: horizontal (show side-by-side icon)
            btn.innerHTML = '<div style="display: flex; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to horizontal scrolling';
        } else if (layoutMode === 'horizontal') {
            // Next: headings (show stacked rectangles with rounded edges)
            btn.innerHTML = '<div style="display: flex; flex-direction: column; gap: 2px;"><div style="width: 16px; height: 5px; background: white; border-radius: 2px;"></div><div style="width: 16px; height: 5px; background: white; border-radius: 2px;"></div></div>';
            btn.title = 'Switch to headings only';
        } else {
            // Next: vertical (show stacked rounded squares)
            btn.innerHTML = '<div style="display: flex; flex-direction: column; gap: 3px;"><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div><div style="width: 12px; height: 12px; background: white; border-radius: 3px;"></div></div>';
            btn.title = 'Switch to vertical grid';
        }
        btn.style.opacity = '0.2'; // Make visible after content is set
    }
}
function deleteCategory(catIndex) {
    if (confirm('Delete this entire category?')) {
        categories.splice(catIndex, 1);
        if (activeTabIndex >= categories.length) {
            activeTabIndex = Math.max(0, categories.length - 1);
        }
        saveCategories();
        renderTabs();
        renderContent();
    }
}
// Close menus when clicking outside
document.addEventListener('click', (e) => {
    const menu = document.getElementById('dropdownMenu');
    if (menu) menu.classList.remove('show');
    
    const guideMenu = document.getElementById('guideDropdown');
    const backdrop = document.getElementById('drawerBackdrop');
    
    // Don't close drawer if clicking inside it or on the hamburger button
    if (guideMenu && !guideMenu.contains(e.target) && !e.target.classList.contains('guide-menu-btn')) {
        if (guideMenu.classList.contains('show')) {
            closeDrawer();
        }
    }
    
    const colorMenu = document.getElementById('colorPickerMenu');
    if (colorMenu) colorMenu.classList.remove('show');
});

		// Check for auto-refresh when page becomes visible
document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
        database.ref(`guides/${currentGuideId}/lastRefreshDate`).once('value', (snapshot) => {
            checkAndAutoRefresh(snapshot.val());
        });
    }
});

// Also check every hour while page is open
setInterval(() => {
    database.ref(`guides/${currentGuideId}/lastRefreshDate`).once('value', (snapshot) => {
        checkAndAutoRefresh(snapshot.val());
    });
}, 60 * 60 * 1000); // Check every hour

		
// Load data when page loads
loadFromFirebase();

    </script>
	<button class="floating-layout-btn" id="layoutBtn" onclick="toggleLayout()" title="Switch layout" style="opacity: 0;"></button>
	<button class="save-btn" id="saveBtn" onclick="saveAndExitEdit()" style="display: none;">Save</button>

</body>
</html>

</body>
</html>






















